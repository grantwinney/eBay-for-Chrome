/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var SearchBox = {
    init: function () {
        $("[rel^=i18n],[title^=i18n]").i18n({ attributeNames: ["title"] });
        Sidebar.updateTooltips();
        this._addPlaceholder();
        this._addListeners();
    },
    _addPlaceholder: function () {
        $("#search-textbox").attr("placeholder", $.i18n.getString("sidebar.searchBar.empty"));
    },
    _addListeners: function () {
        var cache = {};
        var that = this;
        $("#search-placeholder-button").click(function () {
            $("#search-textbox").focus();
        });
        $("#search-textbox").blur(function () {
            if ($("#search-textbox").val() === "") {
                $("#search-placeholder-button").show();
                that._addPlaceholder();
            }
        });
        $("#search-textbox").focus(function () {
            that.showSearchContent(true);
        }).keyup(function (aEvent) {
            var textbox = $(this);
            if (aEvent.keyCode == 27) {
                textbox.val("");
            }
            if (textbox.val().length === 0) {
                textbox.autocomplete("close");
            }
        }).keydown(function (aEvent) {
            if (aEvent.keyCode == 13) {
                var selected = $(".ui-menu-item").hasClass("ui-state-focus");
                if (!selected) {
                    SearchBox.search(aEvent.originalEvent, "enter");
                }
                return false;
            }
        }).autocomplete({
            position: { my: "left-10 top+40", at: "left top" },
            minLength: 0,
            source: function (aRequest, aResponse) {
                if (aRequest.term === "") {
                    return;
                }
                var site = Site.siteIdForSite(Site.getHomeSite());
                AutoCompleteApi.getData(aRequest.term, site, function (aData) {
                    var respArray = new Array();
                    if (aData && aData.suggestions) {
                        $.each(aData.suggestions, function (aIndex, aItem) {
                            if (aItem.length > 0) {
                                respArray.push({ type: "search", text: aItem });
                                if (respArray.length == 1 && aData.categories) {
                                    $.each(aData.categories, function (aIndex, aCategory) {
                                        respArray.push({ type: "category", categoryId: aCategory[0],
                                            category: aCategory[1], text: aItem });
                                    });
                                }
                            }
                        });
                    }
                    cache[aRequest.term] = respArray;
                    if (aResponse && respArray.length > 0) {
                        aResponse(cache[aRequest.term]);
                    }
                });
            }.bind(this),
            focus: function (aEvent, aUi) {
                $("#search-textbox").val(aUi.item.text);
                return false;
            },
            select: function (aEvent, aUi) {
                $("#search-textbox").val(aUi.item.text);
                if (aUi.item.type == "search") {
                    this.search(aEvent.originalEvent, "suggestion");
                }
                else if (aUi.item.type == "category") {
                    this._searchInCategory(aUi.item.categoryId, aEvent.originalEvent);
                }
                return false;
            }.bind(this),
            create: function (aEvent, aUi) {
                $(".ui-autocomplete").attr("tabindex", "-1");
            }.bind(this),
            change: function (aEvent, aUi) {
                $(".ui-autocomplete").attr("tabindex", "-1");
            }.bind(this)
        }).autocomplete("instance")._renderItem = function (aUl, aItem) {
            if (aItem.text) {
                aItem.text = UtilityHelper.escapeHtml(aItem.text);
            }
            if (aItem.category) {
                aItem.category = UtilityHelper.escapeHtml(aItem.category);
            }
            var suggestionLabel = this._buildSuggestionLabel(aItem);
            var element = $("<li></li>");
            var label;
            label = "<a>";
            if (aItem.type == "search") {
                label += this._buildLabel(suggestionLabel);
            }
            else if (aItem.type == "category") {
                var categoryLabel = this._buildSearchInCategoryLabel($.i18n.getString("sidebar.searchBar.search.in.category", [aItem.category]));
                label += this._buildLabel(suggestionLabel + "<br>" + categoryLabel);
                element.attr("class", "search-suggestion-category-container");
            }
            label += "</a>";
            return element.append($(label)).appendTo(aUl);
        }.bind(this);
    },
    _buildLabel: function (aText) {
        return "<div class='search-suggestion'>" + aText + "</div>";
    },
    _buildSuggestionLabel: function (aItem) {
        return "<span class='search-suggestion-item'>" + aItem.text + "</span>";
    },
    _buildSearchInCategoryLabel: function (aCategory) {
        return "<span class='search-suggestion-category-item'>" + aCategory + "</span>";
    },
    search: function (aEvent, aFrom) {
        var account = Account.getAccount();
        var textbox = $("#search-textbox");
        var keywords = $.trim(textbox.val());
        if (!textbox.attr("empty") && keywords !== "") {
            var eventKey = account ? "SignedInExit" : "SignedOutExit";
            var eventLabel = "Go";
            if (aFrom == "suggestion") {
                eventLabel = "GoAutocomplete";
            }
            EventAnalytics.push({
                key: eventKey,
                action: "ClickSearch",
                label: eventLabel
            });
            RoverUrlHelper.performSearch(keywords, "searchBox", aEvent, "keyword");
            var userId = account.get("userId");
            var homeSite = Site.getHomeSite();
            RecentSearchMedsService.addRecentSearch(userId, homeSite, keywords);
        }
    },
    _searchInCategory: function (aCategoryId, aEvent) {
        var textbox = $("#search-textbox");
        var keywords = $.trim(textbox.val());
        RoverUrlHelper.performSearch(keywords, "searchBox", aEvent, "category", aCategoryId);
    },
    _keyUpListener: function (aEvent) {
        var textbox = $("#search-textbox");
        if (!textbox.is(":focus")) {
            var keycode = aEvent.keyCode;
            if ((keycode > 47 && keycode < 58) ||
                (keycode > 64 && keycode < 91) ||
                (keycode > 95 && keycode < 112) ||
                (keycode > 185 && keycode < 193) ||
                (keycode > 218 && keycode < 223)) {
                textbox.focus();
            }
        }
        if ($(aEvent.target).attr("class") == "search-close-button-container" && aEvent.keyCode == 13) {
            var eventKey = Account.getAccount() ? "SignedInExit" : "SignedOutExit";
            EventAnalytics.push({
                key: eventKey,
                action: "ClickSearch",
                label: "Cancel"
            });
            SearchBox.showSearchContent(false);
        }
    },
    _clickListener: function (aEvent) {
        aEvent.preventDefault();
        var element = $(aEvent.target);
        var elementId = element.attr("id");
        if (elementId == "search-close-button") {
            var eventKey = Account.getAccount() ? "SignedInExit" : "SignedOutExit";
            EventAnalytics.push({
                key: eventKey,
                action: "ClickSearch",
                label: "Cancel"
            });
            SearchBox.showSearchContent(false);
        }
        else if (elementId == "search-button" || element.parent().attr("id") == "search-button") {
            SearchBox.search(aEvent.originalEvent, "button");
        }
    },
    showSearchContent: function (aShow) {
        var account = Account.getAccount();
        if (aShow) {
            this._showSearchBox(true, function () {
                if (account) {
                    $("#signed-in-search-content").width("0").show().animate({ width: "100%" }, 0, function () {
                        $("#signed-in-content").hide();
                        $("#status-panel").hide();
                    });
                }
                SearchContent.show();
            }.bind(this));
        }
        else {
            SearchContent.hide();
            this._showSearchBox(false);
            if (account) {
                $("#signed-in-content").show();
                $("#signed-in-search-content").width("100%").animate({ width: "0" }, 45, function () {
                    $("#signed-in-search-content").hide();
                });
                var lastSelectedTab = $(".tab-item.active");
                lastSelectedTab.focus();
                if (lastSelectedTab && lastSelectedTab.attr("id") == "tab-notification") {
                    $("#status-panel").show();
                }
            }
        }
    },
    _showSearchBox: function (aShow, aCallback) {
        var that = this;
        var textboxContainer = $("#search-textbox-container");
        if (aShow) {
            if (!this._textboxWidth) {
                this._textboxWidth = textboxContainer.width();
            }
            if (!this._searchButtonWidth) {
                this._searchButtonWidth = 120;
            }
            $("#search-placeholder-button").hide();
            $("#search-textbox").removeAttr("placeholder");
            $("#search-textbox-container").removeClass("disconnected");
            textboxContainer.animate({ width: (this._textboxWidth - this._searchButtonWidth) }, "fast", function () {
                $("#search-buttons-container").show();
            });
            if (aCallback) {
                aCallback();
            }
            $(document).bind("click", that._clickListener);
            $(document).bind("keydown", that._keyUpListener);
        }
        else {
            $("#search-textbox").val("");
            $("#search-textbox-container").addClass("disconnected");
            that._addPlaceholder();
            $("#search-placeholder-button").show();
            $("#search-buttons-container").hide();
            textboxContainer.animate({ width: this._textboxWidth }, "fast");
            if (aCallback) {
                aCallback();
            }
            $(document).unbind("click", that._clickListener);
            $(document).unbind("keydown", that._keyUpListener);
        }
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoQm94LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vdWkvdmlldy9jb3JlL3NlYXJjaEJveC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUtILElBQUksU0FBUyxHQUFHO0lBRWQsSUFBSSxFQUFHO1FBRUwsQ0FBQyxDQUFDLDJCQUEyQixDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsY0FBYyxFQUFFLENBQUUsT0FBTyxDQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3JFLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUV6QixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxlQUFlLEVBQUc7UUFDaEIsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLENBQUM7SUFDeEYsQ0FBQztJQUVELGFBQWEsRUFBRztRQUVkLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNmLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztRQUVoQixDQUFDLENBQUMsNEJBQTRCLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDcEMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7UUFFSCxDQUFDLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFFeEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDdEMsQ0FBQyxDQUFDLDRCQUE0QixDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ3ZDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN6QixDQUFDO1FB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QUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQy9DLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNuRCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixDQUFDLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDN0IsQ0FBQyxDQUFDLDJCQUEyQixDQUFDLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ3hELElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN2QixDQUFDLENBQUMsNEJBQTRCLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN2QyxDQUFDLENBQUMsMkJBQTJCLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN0QyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ2hFLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2QsU0FBUyxFQUFFLENBQUM7WUFDZCxDQUFDO1lBQ0QsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ2pELENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNyRCxDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIENvcHlyaWdodCAoQykgMjAwNy0yMDE1IGVCYXkgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICovXG5cbi8qKlxuICogU2VhcmNoIEJveCBDbGFzcy5cbiAqL1xudmFyIFNlYXJjaEJveCA9IHtcblxuICBpbml0IDogZnVuY3Rpb24oKSB7XG4gICAgXG4gICAgJChcIltyZWxePWkxOG5dLFt0aXRsZV49aTE4bl1cIikuaTE4bih7IGF0dHJpYnV0ZU5hbWVzOiBbIFwidGl0bGVcIiBdIH0pO1xuICAgIFNpZGViYXIudXBkYXRlVG9vbHRpcHMoKTtcblxuICAgIHRoaXMuX2FkZFBsYWNlaG9sZGVyKCk7XG4gICAgdGhpcy5fYWRkTGlzdGVuZXJzKCk7XG4gIH0sXG5cbiAgX2FkZFBsYWNlaG9sZGVyIDogZnVuY3Rpb24oKSB7XG4gICAgJChcIiNzZWFyY2gtdGV4dGJveFwiKS5hdHRyKFwicGxhY2Vob2xkZXJcIiwgJC5pMThuLmdldFN0cmluZyhcInNpZGViYXIuc2VhcmNoQmFyLmVtcHR5XCIpKTtcbiAgfSxcblxuICBfYWRkTGlzdGVuZXJzIDogZnVuY3Rpb24oKSB7XG4gICAgXG4gICAgdmFyIGNhY2hlID0ge307XG4gICAgdmFyIHRoYXQgPSB0aGlzO1xuXG4gICAgJChcIiNzZWFyY2gtcGxhY2Vob2xkZXItYnV0dG9uXCIpLmNsaWNrKGZ1bmN0aW9uKCkge1xuICAgICAgJChcIiNzZWFyY2gtdGV4dGJveFwiKS5mb2N1cygpO1xuICAgIH0pO1xuXG4gICAgJChcIiNzZWFyY2gtdGV4dGJveFwiKS5ibHVyKGZ1bmN0aW9uKCkge1xuICAgICAgLy8gU2hvdyB0aGUgaWNvbiBhbmQgdGhlIHBsYWNlaG9sZGVyIG9ubHkgd2hlbiB0aGUgZmllbGQgaXMgZW1wdHlcbiAgICAgIGlmICgkKFwiI3NlYXJjaC10ZXh0Ym94XCIpLnZhbCgpID09PSBcIlwiKSB7XG4gICAgICAgICQoXCIjc2VhcmNoLXBsYWNlaG9sZGVyLWJ1dHRvblwiKS5zaG93KCk7XG4gICAgICAgIHRoYXQuX2FkZFBsYWNlaG9sZGVyKCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAkKFwiI3NlYXJjaC10ZXh0Ym94XCIpLmZvY3VzKGZ1bmN0aW9uKCkge1xuICAgICAgdGhhdC5zaG93U2VhcmNoQ29udGVudCh0cnVlKTtcbiAgICB9KS5rZXl1cChmdW5jdGlvbihhRXZlbnQpIHtcbiAgICAgIHZhciB0ZXh0Ym94ID0gJCh0aGlzKTtcblxuICAgICAgaWYgKGFFdmVudC5rZXlDb2RlID09IDI3KSB7XG4gICAgICAgIHRleHRib3gudmFsKFwiXCIpO1xuICAgICAgfVxuICAgICAgaWYgKHRleHRib3gudmFsKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRleHRib3guYXV0b2NvbXBsZXRlKFwiY2xvc2VcIik7XG4gICAgICB9XG4gICAgfSkua2V5ZG93bihmdW5jdGlvbihhRXZlbnQpIHtcbiAgICAgIGlmIChhRXZlbnQua2V5Q29kZSA9PSAxMykge1xuICAgICAgICAvL1BlcmZvcm0gc2VhcmNoIG9ubHkgaWYgYW4gYXV0b2NvbXBsZXRlIGl0ZW0gaXMgbm90IHNlbGVjdGVkXG4gICAgICAgIHZhciBzZWxlY3RlZCA9ICQoXCIudWktbWVudS1pdGVtXCIpLmhhc0NsYXNzKFwidWktc3RhdGUtZm9jdXNcIik7XG4gICAgICAgIGlmICghc2VsZWN0ZWQpIHtcbiAgICAgICAgICBTZWFyY2hCb3guc2VhcmNoKGFFdmVudC5vcmlnaW5hbEV2ZW50LCBcImVudGVyXCIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9KS5hdXRvY29tcGxldGUoe1xuICAgICAgcG9zaXRpb24gOiB7IG15OiBcImxlZnQtMTAgdG9wKzQwXCIsIGF0OiBcImxlZnQgdG9wXCIgfSxcbiAgICAgIG1pbkxlbmd0aCA6IDAsXG4gICAgICBzb3VyY2UgOiBmdW5jdGlvbihhUmVxdWVzdCwgYVJlc3BvbnNlKSB7XG4gICAgICAgIGlmIChhUmVxdWVzdC50ZXJtID09PSBcIlwiKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIHNpdGUgPSBTaXRlLnNpdGVJZEZvclNpdGUoU2l0ZS5nZXRIb21lU2l0ZSgpKTtcbiAgICAgICAgQXV0b0NvbXBsZXRlQXBpLmdldERhdGEoYVJlcXVlc3QudGVybSwgc2l0ZSwgZnVuY3Rpb24oYURhdGEpIHtcbiAgICAgICAgICB2YXIgcmVzcEFycmF5ID0gbmV3IEFycmF5KCk7XG4gICAgICAgICAgaWYgKGFEYXRhICYmIGFEYXRhLnN1Z2dlc3Rpb25zKSB7XG4gICAgICAgICAgICAkLmVhY2goYURhdGEuc3VnZ2VzdGlvbnMsIGZ1bmN0aW9uKGFJbmRleCwgYUl0ZW0pIHtcbiAgICAgICAgICAgICAgaWYgKGFJdGVtLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByZXNwQXJyYXkucHVzaCh7IHR5cGU6IFwic2VhcmNoXCIsIHRleHQ6IGFJdGVtIH0pO1xuICAgICAgICAgICAgICAgIGlmIChyZXNwQXJyYXkubGVuZ3RoID09IDEgJiYgYURhdGEuY2F0ZWdvcmllcykge1xuICAgICAgICAgICAgICAgICAgJC5lYWNoKGFEYXRhLmNhdGVnb3JpZXMsIGZ1bmN0aW9uKGFJbmRleCwgYUNhdGVnb3J5KSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3BBcnJheS5wdXNoKHsgdHlwZTogXCJjYXRlZ29yeVwiLCBjYXRlZ29yeUlkOiBhQ2F0ZWdvcnlbMF0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6IGFDYXRlZ29yeVsxXSwgdGV4dDogYUl0ZW0gfSk7XG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNhY2hlW2FSZXF1ZXN0LnRlcm1dID0gcmVzcEFycmF5O1xuICAgICAgICAgIGlmIChhUmVzcG9uc2UgJiYgcmVzcEFycmF5Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGFSZXNwb25zZShjYWNoZVthUmVxdWVzdC50ZXJtXSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0uYmluZCh0aGlzKSxcbiAgICAgIGZvY3VzIDogZnVuY3Rpb24oYUV2ZW50LCBhVWkpIHtcbiAgICAgICAgJChcIiNzZWFyY2gtdGV4dGJveFwiKS52YWwoYVVpLml0ZW0udGV4dCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0sXG4gICAgICBzZWxlY3QgOiBmdW5jdGlvbihhRXZlbnQsIGFVaSkge1xuICAgICAgICAkKFwiI3NlYXJjaC10ZXh0Ym94XCIpLnZhbChhVWkuaXRlbS50ZXh0KTtcblxuICAgICAgICBpZiAoYVVpLml0ZW0udHlwZSA9PSBcInNlYXJjaFwiKSB7XG4gICAgICAgICAgdGhpcy5zZWFyY2goYUV2ZW50Lm9yaWdpbmFsRXZlbnQsIFwic3VnZ2VzdGlvblwiKTtcbiAgICAgICAgfSBlbHNlIGlmIChhVWkuaXRlbS50eXBlID09IFwiY2F0ZWdvcnlcIikge1xuICAgICAgICAgIHRoaXMuX3NlYXJjaEluQ2F0ZWdvcnkoYVVpLml0ZW0uY2F0ZWdvcnlJZCwgYUV2ZW50Lm9yaWdpbmFsRXZlbnQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0uYmluZCh0aGlzKSxcbiAgICAgIGNyZWF0ZSA6IGZ1bmN0aW9uKGFFdmVudCwgYVVpKSB7XG4gICAgICAgICQoXCIudWktYXV0b2NvbXBsZXRlXCIpLmF0dHIoXCJ0YWJpbmRleFwiLCBcIi0xXCIpO1xuICAgICAgfS5iaW5kKHRoaXMpLFxuICAgICAgY2hhbmdlIDogZnVuY3Rpb24oYUV2ZW50LCBhVWkpIHtcbiAgICAgICAgJChcIi51aS1hdXRvY29tcGxldGVcIikuYXR0cihcInRhYmluZGV4XCIsIFwiLTFcIik7XG4gICAgICB9LmJpbmQodGhpcylcbiAgICB9KS5hdXRvY29tcGxldGUoXCJpbnN0YW5jZVwiKS5fcmVuZGVySXRlbSA9IGZ1bmN0aW9uKGFVbCwgYUl0ZW0pIHtcbiAgICAgIC8vWFhYOiBhcyBwZXIgQU1PIHJldmlldywgbGV0J3Mgc2FuaXRpemUgdGhlIHN0cmluZ3MgY29taW5nIGZyb20gdGhlIHNlcnZlcnMuXG4gICAgICBpZiAoYUl0ZW0udGV4dCkge1xuICAgICAgICBhSXRlbS50ZXh0ID0gVXRpbGl0eUhlbHBlci5lc2NhcGVIdG1sKGFJdGVtLnRleHQpO1xuICAgICAgfVxuICAgICAgaWYgKGFJdGVtLmNhdGVnb3J5KSB7XG4gICAgICAgIGFJdGVtLmNhdGVnb3J5ID0gVXRpbGl0eUhlbHBlci5lc2NhcGVIdG1sKGFJdGVtLmNhdGVnb3J5KTtcbiAgICAgIH1cblxuICAgICAgdmFyIHN1Z2dlc3Rpb25MYWJlbCA9IHRoaXMuX2J1aWxkU3VnZ2VzdGlvbkxhYmVsKGFJdGVtKTtcbiAgICAgIHZhciBlbGVtZW50ID0gJChcIjxsaT48L2xpPlwiKTtcbiAgICAgIHZhciBsYWJlbDtcblxuICAgICAgbGFiZWwgPSBcIjxhPlwiO1xuICAgICAgaWYgKGFJdGVtLnR5cGUgPT0gXCJzZWFyY2hcIikge1xuICAgICAgICBsYWJlbCArPSB0aGlzLl9idWlsZExhYmVsKHN1Z2dlc3Rpb25MYWJlbCk7XG4gICAgICB9IGVsc2UgaWYgKGFJdGVtLnR5cGUgPT0gXCJjYXRlZ29yeVwiKSB7XG4gICAgICAgIHZhciBjYXRlZ29yeUxhYmVsID1cbiAgICAgICAgICB0aGlzLl9idWlsZFNlYXJjaEluQ2F0ZWdvcnlMYWJlbCgkLmkxOG4uZ2V0U3RyaW5nKFxuICAgICAgICAgICAgXCJzaWRlYmFyLnNlYXJjaEJhci5zZWFyY2guaW4uY2F0ZWdvcnlcIiwgW2FJdGVtLmNhdGVnb3J5XSkpO1xuICAgICAgICBsYWJlbCArPSB0aGlzLl9idWlsZExhYmVsKFxuICAgICAgICAgIHN1Z2dlc3Rpb25MYWJlbCArIFwiPGJyPlwiICsgY2F0ZWdvcnlMYWJlbCk7XG4gICAgICAgICAgZWxlbWVudC5hdHRyKFwiY2xhc3NcIiwgXCJzZWFyY2gtc3VnZ2VzdGlvbi1jYXRlZ29yeS1jb250YWluZXJcIik7XG4gICAgICB9XG4gICAgICBsYWJlbCArPSBcIjwvYT5cIjtcblxuICAgICAgcmV0dXJuIGVsZW1lbnQuYXBwZW5kKCQobGFiZWwpKS5hcHBlbmRUbyhhVWwpO1xuICAgIH0uYmluZCh0aGlzKTtcbiAgfSxcblxuICBfYnVpbGRMYWJlbCA6IGZ1bmN0aW9uKGFUZXh0KSB7XG4gICAgXG4gICAgcmV0dXJuIFwiPGRpdiBjbGFzcz0nc2VhcmNoLXN1Z2dlc3Rpb24nPlwiICsgYVRleHQgKyBcIjwvZGl2PlwiO1xuICB9LFxuXG4gIF9idWlsZFN1Z2dlc3Rpb25MYWJlbCA6IGZ1bmN0aW9uKGFJdGVtKSB7XG4gICAgXG4gICAgcmV0dXJuIFwiPHNwYW4gY2xhc3M9J3NlYXJjaC1zdWdnZXN0aW9uLWl0ZW0nPlwiICsgYUl0ZW0udGV4dCArIFwiPC9zcGFuPlwiO1xuICB9LFxuXG4gIF9idWlsZFNlYXJjaEluQ2F0ZWdvcnlMYWJlbCA6IGZ1bmN0aW9uKGFDYXRlZ29yeSkge1xuICAgIFxuICAgIHJldHVybiBcIjxzcGFuIGNsYXNzPSdzZWFyY2gtc3VnZ2VzdGlvbi1jYXRlZ29yeS1pdGVtJz5cIiArIGFDYXRlZ29yeSArIFwiPC9zcGFuPlwiO1xuICB9LFxuXG4gIHNlYXJjaCA6IGZ1bmN0aW9uKGFFdmVudCwgYUZyb20pIHtcblxuICAgIHZhciBhY2NvdW50ID0gQWNjb3VudC5nZXRBY2NvdW50KCk7XG4gICAgdmFyIHRleHRib3ggPSAkKFwiI3NlYXJjaC10ZXh0Ym94XCIpO1xuICAgIHZhciBrZXl3b3JkcyA9ICQudHJpbSh0ZXh0Ym94LnZhbCgpKTtcbiAgICBpZiAoIXRleHRib3guYXR0cihcImVtcHR5XCIpICYmIGtleXdvcmRzICE9PSBcIlwiKSB7XG4gICAgICB2YXIgZXZlbnRLZXkgPSBhY2NvdW50ID8gXCJTaWduZWRJbkV4aXRcIiA6IFwiU2lnbmVkT3V0RXhpdFwiO1xuICAgICAgdmFyIGV2ZW50TGFiZWwgPSBcIkdvXCI7XG4gICAgICBpZiAoYUZyb20gPT0gXCJzdWdnZXN0aW9uXCIpIHtcbiAgICAgICAgZXZlbnRMYWJlbCA9IFwiR29BdXRvY29tcGxldGVcIjtcbiAgICAgIH1cbiAgICAgIEV2ZW50QW5hbHl0aWNzLnB1c2goe1xuICAgICAgICBrZXk6IGV2ZW50S2V5LFxuICAgICAgICBhY3Rpb246IFwiQ2xpY2tTZWFyY2hcIixcbiAgICAgICAgbGFiZWw6IGV2ZW50TGFiZWxcbiAgICAgIH0pO1xuICAgICAgUm92ZXJVcmxIZWxwZXIucGVyZm9ybVNlYXJjaChcbiAgICAgICAga2V5d29yZHMsIFwic2VhcmNoQm94XCIsIGFFdmVudCwgXCJrZXl3b3JkXCIpO1xuICAgICAgdmFyIHVzZXJJZCA9IGFjY291bnQuZ2V0KFwidXNlcklkXCIpO1xuICAgICAgdmFyIGhvbWVTaXRlID0gU2l0ZS5nZXRIb21lU2l0ZSgpO1xuICAgICAgUmVjZW50U2VhcmNoTWVkc1NlcnZpY2UuYWRkUmVjZW50U2VhcmNoKHVzZXJJZCwgaG9tZVNpdGUsIGtleXdvcmRzKTtcbiAgICB9XG4gIH0sXG5cbiAgX3NlYXJjaEluQ2F0ZWdvcnkgOiBmdW5jdGlvbihhQ2F0ZWdvcnlJZCwgYUV2ZW50KSB7XG4gICAgXG4gICAgdmFyIHRleHRib3ggPSAkKFwiI3NlYXJjaC10ZXh0Ym94XCIpO1xuICAgIHZhciBrZXl3b3JkcyA9ICQudHJpbSh0ZXh0Ym94LnZhbCgpKTtcbiAgICBSb3ZlclVybEhlbHBlci5wZXJmb3JtU2VhcmNoKFxuICAgICAga2V5d29yZHMsIFwic2VhcmNoQm94XCIsIGFFdmVudCwgXCJjYXRlZ29yeVwiLCBhQ2F0ZWdvcnlJZCk7XG4gIH0sXG5cbiAgX2tleVVwTGlzdGVuZXIgOiBmdW5jdGlvbihhRXZlbnQpIHtcbiAgICBcbiAgICB2YXIgdGV4dGJveCA9ICQoXCIjc2VhcmNoLXRleHRib3hcIik7XG5cbiAgICBpZiAoIXRleHRib3guaXMoXCI6Zm9jdXNcIikpIHtcbiAgICAgIHZhciBrZXljb2RlID0gYUV2ZW50LmtleUNvZGU7XG5cbiAgICAgIGlmICgoa2V5Y29kZSA+IDQ3ICYmIGtleWNvZGUgPCA1OCkgfHwgLy8gbnVtYmVyIGtleXNcbiAgICAgICAgICAoa2V5Y29kZSA+IDY0ICYmIGtleWNvZGUgPCA5MSkgfHwgLy8gbGV0dGVyIGtleXNcbiAgICAgICAgICAoa2V5Y29kZSA+IDk1ICYmIGtleWNvZGUgPCAxMTIpIHx8IC8vIG51bXBhZCBrZXlzXG4gICAgICAgICAgKGtleWNvZGUgPiAxODUgJiYga2V5Y29kZSA8IDE5MykgfHwgLy8gOz0sLS4vYCAoaW4gb3JkZXIpXG4gICAgICAgICAgKGtleWNvZGUgPiAyMTggJiYga2V5Y29kZSA8IDIyMykpIHsgLy8gW1xcXScgKGluIG9yZGVyKSkge1xuICAgICAgICB0ZXh0Ym94LmZvY3VzKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCQoYUV2ZW50LnRhcmdldCkuYXR0cihcImNsYXNzXCIpID09IFwic2VhcmNoLWNsb3NlLWJ1dHRvbi1jb250YWluZXJcIiAmJiBhRXZlbnQua2V5Q29kZSA9PSAxMykge1xuICAgICAgdmFyIGV2ZW50S2V5ID0gQWNjb3VudC5nZXRBY2NvdW50KCkgPyBcIlNpZ25lZEluRXhpdFwiIDogXCJTaWduZWRPdXRFeGl0XCI7XG4gICAgICBFdmVudEFuYWx5dGljcy5wdXNoKHtcbiAgICAgICAga2V5OiBldmVudEtleSxcbiAgICAgICAgYWN0aW9uOiBcIkNsaWNrU2VhcmNoXCIsXG4gICAgICAgIGxhYmVsOiBcIkNhbmNlbFwiXG4gICAgICB9KTtcbiAgICAgIFNlYXJjaEJveC5zaG93U2VhcmNoQ29udGVudChmYWxzZSk7XG4gICAgfVxuICB9LFxuXG4gIF9jbGlja0xpc3RlbmVyIDogZnVuY3Rpb24oYUV2ZW50KSB7XG4gICAgXG4gICAgLy8gUHJldmVudCBTYWZhcmkgZnJvbSBzZW5kaW5nIGRlZmF1bHQgcmVxdWVzdHNcbiAgICBhRXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgIHZhciBlbGVtZW50ID0gJChhRXZlbnQudGFyZ2V0KTtcbiAgICB2YXIgZWxlbWVudElkID0gZWxlbWVudC5hdHRyKFwiaWRcIik7XG5cbiAgICBpZiAoZWxlbWVudElkID09IFwic2VhcmNoLWNsb3NlLWJ1dHRvblwiKSB7XG4gICAgICB2YXIgZXZlbnRLZXkgPSBBY2NvdW50LmdldEFjY291bnQoKSA/IFwiU2lnbmVkSW5FeGl0XCIgOiBcIlNpZ25lZE91dEV4aXRcIjtcbiAgICAgIEV2ZW50QW5hbHl0aWNzLnB1c2goe1xuICAgICAgICBrZXk6IGV2ZW50S2V5LFxuICAgICAgICBhY3Rpb246IFwiQ2xpY2tTZWFyY2hcIixcbiAgICAgICAgbGFiZWw6IFwiQ2FuY2VsXCJcbiAgICAgIH0pO1xuICAgICAgU2VhcmNoQm94LnNob3dTZWFyY2hDb250ZW50KGZhbHNlKTtcbiAgICB9ICBlbHNlIGlmIChlbGVtZW50SWQgPT0gXCJzZWFyY2gtYnV0dG9uXCIgfHwgZWxlbWVudC5wYXJlbnQoKS5hdHRyKFwiaWRcIikgPT0gXCJzZWFyY2gtYnV0dG9uXCIpIHtcbiAgICAgIFNlYXJjaEJveC5zZWFyY2goYUV2ZW50Lm9yaWdpbmFsRXZlbnQsIFwiYnV0dG9uXCIpO1xuICAgIH1cbiAgfSxcblxuICBzaG93U2VhcmNoQ29udGVudCA6IGZ1bmN0aW9uKGFTaG93KSB7XG5cbiAgICB2YXIgYWNjb3VudCA9IEFjY291bnQuZ2V0QWNjb3VudCgpO1xuICAgIGlmIChhU2hvdykge1xuICAgICAgdGhpcy5fc2hvd1NlYXJjaEJveCh0cnVlLCBmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKGFjY291bnQpIHtcbiAgICAgICAgICAkKFwiI3NpZ25lZC1pbi1zZWFyY2gtY29udGVudFwiKS53aWR0aChcIjBcIikuc2hvdygpLmFuaW1hdGUoeyB3aWR0aDogXCIxMDAlXCIgfSwgMCwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAkKFwiI3NpZ25lZC1pbi1jb250ZW50XCIpLmhpZGUoKTtcbiAgICAgICAgICAgICQoXCIjc3RhdHVzLXBhbmVsXCIpLmhpZGUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBTZWFyY2hDb250ZW50LnNob3coKTtcbiAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIFNlYXJjaENvbnRlbnQuaGlkZSgpO1xuICAgICAgdGhpcy5fc2hvd1NlYXJjaEJveChmYWxzZSk7XG4gICAgICBpZiAoYWNjb3VudCkge1xuICAgICAgICAkKFwiI3NpZ25lZC1pbi1jb250ZW50XCIpLnNob3coKTtcbiAgICAgICAgJChcIiNzaWduZWQtaW4tc2VhcmNoLWNvbnRlbnRcIikud2lkdGgoXCIxMDAlXCIpLmFuaW1hdGUoeyB3aWR0aDogXCIwXCIgfSwgNDUsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICQoXCIjc2lnbmVkLWluLXNlYXJjaC1jb250ZW50XCIpLmhpZGUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdmFyIGxhc3RTZWxlY3RlZFRhYiA9ICQoXCIudGFiLWl0ZW0uYWN0aXZlXCIpO1xuICAgICAgICBsYXN0U2VsZWN0ZWRUYWIuZm9jdXMoKTtcbiAgICAgICAgaWYgKGxhc3RTZWxlY3RlZFRhYiAmJiBsYXN0U2VsZWN0ZWRUYWIuYXR0cihcImlkXCIpID09IFwidGFiLW5vdGlmaWNhdGlvblwiKSB7XG4gICAgICAgICAgJChcIiNzdGF0dXMtcGFuZWxcIikuc2hvdygpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIF9zaG93U2VhcmNoQm94IDogZnVuY3Rpb24oYVNob3csIGFDYWxsYmFjaykge1xuICAgIFxuICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICB2YXIgdGV4dGJveENvbnRhaW5lciA9ICQoXCIjc2VhcmNoLXRleHRib3gtY29udGFpbmVyXCIpO1xuXG4gICAgaWYgKGFTaG93KSB7XG4gICAgICBpZiAoIXRoaXMuX3RleHRib3hXaWR0aCkge1xuICAgICAgICB0aGlzLl90ZXh0Ym94V2lkdGggPSB0ZXh0Ym94Q29udGFpbmVyLndpZHRoKCk7XG4gICAgICB9XG4gICAgICBpZiAoIXRoaXMuX3NlYXJjaEJ1dHRvbldpZHRoKSB7XG4gICAgICAgIHRoaXMuX3NlYXJjaEJ1dHRvbldpZHRoID0gMTIwOyAvLyBkZWZhdWx0XG4gICAgICB9XG5cbiAgICAgICQoXCIjc2VhcmNoLXBsYWNlaG9sZGVyLWJ1dHRvblwiKS5oaWRlKCk7XG4gICAgICAkKFwiI3NlYXJjaC10ZXh0Ym94XCIpLnJlbW92ZUF0dHIoXCJwbGFjZWhvbGRlclwiKTtcbiAgICAgICQoXCIjc2VhcmNoLXRleHRib3gtY29udGFpbmVyXCIpLnJlbW92ZUNsYXNzKFwiZGlzY29ubmVjdGVkXCIpO1xuICAgICAgdGV4dGJveENvbnRhaW5lci5hbmltYXRlKHsgd2lkdGg6ICh0aGlzLl90ZXh0Ym94V2lkdGggLSB0aGlzLl9zZWFyY2hCdXR0b25XaWR0aCkgfSwgXCJmYXN0XCIsIGZ1bmN0aW9uKCkge1xuICAgICAgICAkKFwiI3NlYXJjaC1idXR0b25zLWNvbnRhaW5lclwiKS5zaG93KCk7XG4gICAgICB9KTtcbiAgICAgIGlmIChhQ2FsbGJhY2spIHtcbiAgICAgICAgYUNhbGxiYWNrKCk7XG4gICAgICB9XG4gICAgICAkKGRvY3VtZW50KS5iaW5kKFwiY2xpY2tcIiwgdGhhdC5fY2xpY2tMaXN0ZW5lcik7XG4gICAgICAkKGRvY3VtZW50KS5iaW5kKFwia2V5ZG93blwiLCB0aGF0Ll9rZXlVcExpc3RlbmVyKTtcbiAgICB9IGVsc2Uge1xuICAgICAgJChcIiNzZWFyY2gtdGV4dGJveFwiKS52YWwoXCJcIik7XG4gICAgICAkKFwiI3NlYXJjaC10ZXh0Ym94LWNvbnRhaW5lclwiKS5hZGRDbGFzcyhcImRpc2Nvbm5lY3RlZFwiKTtcbiAgICAgIHRoYXQuX2FkZFBsYWNlaG9sZGVyKCk7XG4gICAgICAkKFwiI3NlYXJjaC1wbGFjZWhvbGRlci1idXR0b25cIikuc2hvdygpO1xuICAgICAgJChcIiNzZWFyY2gtYnV0dG9ucy1jb250YWluZXJcIikuaGlkZSgpO1xuICAgICAgdGV4dGJveENvbnRhaW5lci5hbmltYXRlKHsgd2lkdGg6IHRoaXMuX3RleHRib3hXaWR0aCB9LCBcImZhc3RcIik7XG4gICAgICBpZiAoYUNhbGxiYWNrKSB7XG4gICAgICAgIGFDYWxsYmFjaygpO1xuICAgICAgfVxuICAgICAgJChkb2N1bWVudCkudW5iaW5kKFwiY2xpY2tcIiwgdGhhdC5fY2xpY2tMaXN0ZW5lcik7XG4gICAgICAkKGRvY3VtZW50KS51bmJpbmQoXCJrZXlkb3duXCIsIHRoYXQuX2tleVVwTGlzdGVuZXIpO1xuICAgIH1cbiAgfVxufTtcbiJdfQ==