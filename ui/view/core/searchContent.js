/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var SearchContent = {
    init: function () {
        ObserverHelper.addObserver(this, Topics.FAVORITE_SEARCHES_UPDATED);
        ObserverHelper.addObserver(this, Topics.FAVORITE_SEARCHES_REMOVED);
        ObserverHelper.addObserver(this, Topics.RECENT_SEARCHES_UPDATED);
        ObserverHelper.addObserver(this, Topics.RECENT_SEARCHES_REMOVED);
        this._addProcessedElements();
        this._addEventListeners();
        this.setTabAccessLabels();
        this.selectTab("search-tab-recent-searches");
        Sidebar.styleScroll("search-panel-container");
        Sidebar.updateTooltips();
        Sidebar.adjustTabIndex();
    },
    uninit: function () {
        ObserverHelper.removeObserver(this, Topics.FAVORITE_SEARCHES_UPDATED);
        ObserverHelper.removeObserver(this, Topics.FAVORITE_SEARCHES_REMOVED);
        ObserverHelper.removeObserver(this, Topics.RECENT_SEARCHES_UPDATED);
        ObserverHelper.removeObserver(this, Topics.RECENT_SEARCHES_REMOVED);
    },
    setTabAccessLabels: function () {
        $(".search-tab-recent-searches-access-label").text($.i18n.getString("tab.access.label", [1, 2]));
        $(".search-tab-followed-searches-access-label").text($.i18n.getString("tab.access.label", [2, 2]));
    },
    selectTabAccessLabel: function (tabId) {
        var index = 0;
        switch (tabId) {
            case 'search-tab-recent-searches':
                index = 1;
                break;
            case 'search-tab-followed-searches':
                index = 2;
                break;
        }
        var label = $.i18n.getString("tab.selected.access.label", [index, 2]);
        $("." + tabId + "-access-label").text(label);
    },
    show: function () {
        this._showRecentSearches();
        this._showFollowedSearches();
        $("#search").addClass("show-search");
    },
    hide: function () {
        var homeSite = Site.getHomeSite();
        this._clearRecentSearches(homeSite);
        this._clearFollowedSearches();
        $("#search").removeClass("show-search");
    },
    _isShown: function () {
        return $("#search").hasClass("show-search");
    },
    _addProcessedElements: function () {
        var text = $.i18n.getString('sidebar.followed.searches.empty.description');
        $("#followed-searches-empty-description").append(text);
    },
    _addEventListeners: function () {
        $("#search-panel-recent-searches-main").on("click", "> *", function (aEvent) {
            var target = $(aEvent.currentTarget);
            var object = target.data("search");
            EventAnalytics.push({
                key: "SignedInExit",
                action: "ClickSearch",
                label: "RecentSearch"
            });
            RoverUrlHelper.loadPage("search", "recentSearchClick", { query: object.get("searchString"),
                forceNewTab: true,
            }, aEvent);
        }.bind(this));
        $("#recent-searches-clear-link").click(function (aEvent) {
            EventAnalytics.push({
                key: "SignedInExit",
                action: "ClickSearch",
                label: "ClearRecentSearches"
            });
            this._clearRecentSearches();
            RecentSearchMedsService.clearRecentSearches(true);
        }.bind(this));
        $("#search-panel-followed-searches-main").on("click", "> *", function (aEvent) {
            var target = $(aEvent.currentTarget);
            var object = target.data("search");
            EventAnalytics.push({
                key: "SignedInExit",
                action: "ClickSearch",
                label: "SavedSearch"
            });
            RoverUrlHelper.loadPage("savedSearch", "favoriteSearchClick", { searchQuery: object.get("searchQuery"),
                forceNewTab: true
            }, aEvent);
        }.bind(this));
        $("#followed-searches-edit-link").click(function (aEvent) {
            EventAnalytics.push({
                key: "SignedInExit",
                action: "ClickSearch",
                label: "EditFollowedSearches"
            });
            RoverUrlHelper.loadPage("savedSearches", "favoriteSearchClick", null, aEvent);
        }.bind(this));
        $(".search-tab-item").bind("click", function (aEvent) {
            var target = $(aEvent.target);
            var tabId = target.attr("id");
            if (!tabId) {
                tabId = target.closest(".search-tab-item").attr("id");
            }
            EventAnalytics.push({
                key: "SignedInInternal",
                action: "ClickTabChange",
                label: Sidebar.getGATabTrackingName(tabId)
            });
            this.selectTab(tabId);
        }.bind(this));
    },
    selectTab: function (aTabId) {
        this.setTabAccessLabels();
        this.selectTabAccessLabel(aTabId);
        $(".search-tab-item").removeClass("active");
        $("#" + aTabId).addClass("active");
        var panelId = aTabId.replace(/^search-tab/, "search-panel") + "-content";
        $(".search-panel-content").removeClass("active");
        $("#" + panelId).addClass("active");
        Sidebar.scrollToTop("search-panel-container");
    },
    _createRecentSearchElement: function (aRecentText) {
        aRecentText = UtilityHelper.escapeHtml(aRecentText);
        var element = $("<div tabindex='0'></div>").addClass("search-content-block-item").addClass("recent-search-item").text(aRecentText);
        return $("<a></a>").attr("class", "search-content-block-item-link").attr({ "href": "#", "data-update-tooltip": "true" }).append(element);
    },
    _createFollowedSearchElement: function (aRecentText) {
        aRecentText = UtilityHelper.escapeHtml(aRecentText);
        var element = $("<div tabindex='0'></div>").addClass("search-content-block-item").addClass("followed-search-item").text(aRecentText);
        return $("<a></a>").attr("class", "search-content-block-item-link").attr({ "href": "#", "data-update-tooltip": "true" }).append(element);
    },
    _showRecentSearches: function () {
        var searches = RecentSearchMedsService.recentSearches;
        if ($.isEmptyObject(searches)) {
            this._clearRecentSearches();
        }
        else {
            $("#search-panel-recent-searches-main").empty();
            $.each(searches, function (aIndex, aSearch) {
                var element = this._createRecentSearchElement(aSearch.get("searchString"));
                element.data("search", aSearch.copy());
                $("#search-panel-recent-searches-main").append(element);
            }.bind(this));
            $("#search-panel-recent-searches-empty").hide();
            $("#search-panel-recent-searches-main,#recent-searches-clear-link").show();
            Sidebar.updateTooltips();
            Sidebar.adjustTabIndex();
            Sidebar.removeTabIndex();
        }
    },
    _clearRecentSearches: function () {
        $("#search-panel-recent-searches-main,#recent-searches-clear-link").hide();
        $("#search-panel-recent-searches-empty").show();
    },
    _showFollowedSearches: function () {
        var searches = FavoriteSearchService.favoriteSearches;
        if ($.isEmptyObject(searches)) {
            this._clearFollowedSearches();
        }
        else {
            $("#search-panel-followed-searches-main").empty();
            $.each(searches, function (aIndex, aSearch) {
                var element = this._createFollowedSearchElement(aSearch.get("searchName"));
                element.data("search", aSearch.copy());
                $("#search-panel-followed-searches-main").append(element);
            }.bind(this));
            $("#search-panel-followed-searches-empty").hide();
            $("#search-panel-followed-searches-main,#followed-searches-edit-link").show();
            Sidebar.updateTooltips();
            Sidebar.adjustTabIndex();
            Sidebar.removeTabIndex();
        }
    },
    _clearFollowedSearches: function () {
        $("#search-panel-followed-searches-main,#followed-searches-edit-link").hide();
        $("#search-panel-followed-searches-empty").show();
    },
    observe: function (aTopic, aData) {
        switch (aTopic) {
            case Topics.FAVORITE_SEARCHES_UPDATED:
                if (this._isShown()) {
                    this._showFollowedSearches();
                }
                break;
            case Topics.FAVORITE_SEARCHES_REMOVED:
                if (this._isShown()) {
                    this._clearFollowedSearches();
                }
                break;
            case Topics.RECENT_SEARCHES_UPDATED:
                if (this._isShown()) {
                    this._showRecentSearches();
                }
                break;
            case Topics.RECENT_SEARCHES_REMOVED:
                if (this._isShown()) {
                    this._clearRecentSearches();
                }
                break;
        }
    }
};
$(window).unload(function () { SearchContent.uninit(); });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoQ29udGVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3VpL3ZpZXcvY29yZS9zZWFyY2hDb250ZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBRUgsSUFBSSxhQUFhLEdBQUc7SUFFbEIsSUFBSSxFQUFHO1FBQ0wsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDbkUsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDbkUsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDakUsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFFakUsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO1FBQzdDLE9BQU8sQ0FBQyxXQUFXLENBQUMsd0JBQXdCLENBQUMsQ0FBQztRQUM5QyxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDekIsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRCxNQUFNLEVBQUc7UUFDUCxjQUFjLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUN0RSxjQUFjLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUN0RSxjQUFjLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUNwRSxj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QU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIENvcHlyaWdodCAoQykgMjAwNy0yMDE1IGVCYXkgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICovXG5cbnZhciBTZWFyY2hDb250ZW50ID0ge1xuXG4gIGluaXQgOiBmdW5jdGlvbigpIHtcbiAgICBPYnNlcnZlckhlbHBlci5hZGRPYnNlcnZlcih0aGlzLCBUb3BpY3MuRkFWT1JJVEVfU0VBUkNIRVNfVVBEQVRFRCk7XG4gICAgT2JzZXJ2ZXJIZWxwZXIuYWRkT2JzZXJ2ZXIodGhpcywgVG9waWNzLkZBVk9SSVRFX1NFQVJDSEVTX1JFTU9WRUQpO1xuICAgIE9ic2VydmVySGVscGVyLmFkZE9ic2VydmVyKHRoaXMsIFRvcGljcy5SRUNFTlRfU0VBUkNIRVNfVVBEQVRFRCk7XG4gICAgT2JzZXJ2ZXJIZWxwZXIuYWRkT2JzZXJ2ZXIodGhpcywgVG9waWNzLlJFQ0VOVF9TRUFSQ0hFU19SRU1PVkVEKTtcblxuICAgIHRoaXMuX2FkZFByb2Nlc3NlZEVsZW1lbnRzKCk7XG4gICAgdGhpcy5fYWRkRXZlbnRMaXN0ZW5lcnMoKTtcbiAgICB0aGlzLnNldFRhYkFjY2Vzc0xhYmVscygpO1xuICAgIHRoaXMuc2VsZWN0VGFiKFwic2VhcmNoLXRhYi1yZWNlbnQtc2VhcmNoZXNcIik7XG4gICAgU2lkZWJhci5zdHlsZVNjcm9sbChcInNlYXJjaC1wYW5lbC1jb250YWluZXJcIik7XG4gICAgU2lkZWJhci51cGRhdGVUb29sdGlwcygpO1xuICAgIFNpZGViYXIuYWRqdXN0VGFiSW5kZXgoKTtcbiAgfSxcblxuICB1bmluaXQgOiBmdW5jdGlvbigpIHtcbiAgICBPYnNlcnZlckhlbHBlci5yZW1vdmVPYnNlcnZlcih0aGlzLCBUb3BpY3MuRkFWT1JJVEVfU0VBUkNIRVNfVVBEQVRFRCk7XG4gICAgT2JzZXJ2ZXJIZWxwZXIucmVtb3ZlT2JzZXJ2ZXIodGhpcywgVG9waWNzLkZBVk9SSVRFX1NFQVJDSEVTX1JFTU9WRUQpO1xuICAgIE9ic2VydmVySGVscGVyLnJlbW92ZU9ic2VydmVyKHRoaXMsIFRvcGljcy5SRUNFTlRfU0VBUkNIRVNfVVBEQVRFRCk7XG4gICAgT2JzZXJ2ZXJIZWxwZXIucmVtb3ZlT2JzZXJ2ZXIodGhpcywgVG9waWNzLlJFQ0VOVF9TRUFSQ0hFU19SRU1PVkVEKTtcbiAgfSxcblxuICBzZXRUYWJBY2Nlc3NMYWJlbHM6IGZ1bmN0aW9uKCkge1xuICAgICQoXCIuc2VhcmNoLXRhYi1yZWNlbnQtc2VhcmNoZXMtYWNjZXNzLWxhYmVsXCIpLnRleHQoJC5pMThuLmdldFN0cmluZyhcInRhYi5hY2Nlc3MubGFiZWxcIiwgWzEsIDJdKSk7XG4gICAgJChcIi5zZWFyY2gtdGFiLWZvbGxvd2VkLXNlYXJjaGVzLWFjY2Vzcy1sYWJlbFwiKS50ZXh0KCQuaTE4bi5nZXRTdHJpbmcoXCJ0YWIuYWNjZXNzLmxhYmVsXCIsIFsyLCAyXSkpO1xuICB9LFxuXG4gIHNlbGVjdFRhYkFjY2Vzc0xhYmVsOiBmdW5jdGlvbih0YWJJZCkge1xuICAgIHZhciBpbmRleCA9IDA7XG4gICAgc3dpdGNoKHRhYklkKSB7XG4gICAgICBjYXNlICdzZWFyY2gtdGFiLXJlY2VudC1zZWFyY2hlcyc6IGluZGV4ID0gMTsgYnJlYWs7XG4gICAgICBjYXNlICdzZWFyY2gtdGFiLWZvbGxvd2VkLXNlYXJjaGVzJzogaW5kZXggPSAyOyBicmVhaztcbiAgICB9XG5cbiAgICB2YXIgbGFiZWwgPSAkLmkxOG4uZ2V0U3RyaW5nKFwidGFiLnNlbGVjdGVkLmFjY2Vzcy5sYWJlbFwiLCBbaW5kZXgsIDJdKTtcbiAgICAkKFwiLlwiICsgdGFiSWQgKyBcIi1hY2Nlc3MtbGFiZWxcIikudGV4dChsYWJlbCk7XG4gIH0sXG5cbiAgc2hvdyA6IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX3Nob3dSZWNlbnRTZWFyY2hlcygpO1xuICAgIHRoaXMuX3Nob3dGb2xsb3dlZFNlYXJjaGVzKCk7XG4gICAgJChcIiNzZWFyY2hcIikuYWRkQ2xhc3MoXCJzaG93LXNlYXJjaFwiKTtcbiAgfSxcblxuICBoaWRlIDogZnVuY3Rpb24oKSB7XG4gICAgdmFyIGhvbWVTaXRlID0gU2l0ZS5nZXRIb21lU2l0ZSgpO1xuICAgIHRoaXMuX2NsZWFyUmVjZW50U2VhcmNoZXMoaG9tZVNpdGUpO1xuICAgIHRoaXMuX2NsZWFyRm9sbG93ZWRTZWFyY2hlcygpO1xuICAgICQoXCIjc2VhcmNoXCIpLnJlbW92ZUNsYXNzKFwic2hvdy1zZWFyY2hcIik7XG4gIH0sXG5cbiAgX2lzU2hvd24gOiBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gJChcIiNzZWFyY2hcIikuaGFzQ2xhc3MoXCJzaG93LXNlYXJjaFwiKTtcbiAgfSxcblxuICBfYWRkUHJvY2Vzc2VkRWxlbWVudHMgOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgdGV4dCA9XG4gICAgICAkLmkxOG4uZ2V0U3RyaW5nKCdzaWRlYmFyLmZvbGxvd2VkLnNlYXJjaGVzLmVtcHR5LmRlc2NyaXB0aW9uJyk7XG4gICAgJChcIiNmb2xsb3dlZC1zZWFyY2hlcy1lbXB0eS1kZXNjcmlwdGlvblwiKS5hcHBlbmQodGV4dCk7XG4gIH0sXG5cbiAgX2FkZEV2ZW50TGlzdGVuZXJzIDogZnVuY3Rpb24oKSB7XG4gICAgJChcIiNzZWFyY2gtcGFuZWwtcmVjZW50LXNlYXJjaGVzLW1haW5cIikub24oXCJjbGlja1wiLCBcIj4gKlwiLCBmdW5jdGlvbihhRXZlbnQpIHtcbiAgICAgIHZhciB0YXJnZXQgPSAkKGFFdmVudC5jdXJyZW50VGFyZ2V0KTtcbiAgICAgIHZhciBvYmplY3QgPSB0YXJnZXQuZGF0YShcInNlYXJjaFwiKTtcbiAgICAgIEV2ZW50QW5hbHl0aWNzLnB1c2goe1xuICAgICAgICBrZXk6IFwiU2lnbmVkSW5FeGl0XCIsXG4gICAgICAgIGFjdGlvbjogXCJDbGlja1NlYXJjaFwiLFxuICAgICAgICBsYWJlbDogXCJSZWNlbnRTZWFyY2hcIlxuICAgICAgfSk7XG4gICAgICBSb3ZlclVybEhlbHBlci5sb2FkUGFnZShcInNlYXJjaFwiLCBcInJlY2VudFNlYXJjaENsaWNrXCIsXG4gICAgICAgIHsgcXVlcnkgOiBvYmplY3QuZ2V0KFwic2VhcmNoU3RyaW5nXCIpLFxuICAgICAgICAgIGZvcmNlTmV3VGFiIDogdHJ1ZSxcbiAgICAgICAgfSwgYUV2ZW50KTtcbiAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgJChcIiNyZWNlbnQtc2VhcmNoZXMtY2xlYXItbGlua1wiKS5jbGljayhmdW5jdGlvbihhRXZlbnQpIHtcbiAgICAgIEV2ZW50QW5hbHl0aWNzLnB1c2goe1xuICAgICAgICBrZXk6IFwiU2lnbmVkSW5FeGl0XCIsXG4gICAgICAgIGFjdGlvbjogXCJDbGlja1NlYXJjaFwiLFxuICAgICAgICBsYWJlbDogXCJDbGVhclJlY2VudFNlYXJjaGVzXCJcbiAgICAgIH0pO1xuICAgICAgdGhpcy5fY2xlYXJSZWNlbnRTZWFyY2hlcygpO1xuICAgICAgUmVjZW50U2VhcmNoTWVkc1NlcnZpY2UuY2xlYXJSZWNlbnRTZWFyY2hlcyh0cnVlKTtcbiAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgJChcIiNzZWFyY2gtcGFuZWwtZm9sbG93ZWQtc2VhcmNoZXMtbWFpblwiKS5vbihcImNsaWNrXCIsIFwiPiAqXCIsIGZ1bmN0aW9uKGFFdmVudCkge1xuICAgICAgdmFyIHRhcmdldCA9ICQoYUV2ZW50LmN1cnJlbnRUYXJnZXQpO1xuICAgICAgdmFyIG9iamVjdCA9IHRhcmdldC5kYXRhKFwic2VhcmNoXCIpO1xuICAgICAgRXZlbnRBbmFseXRpY3MucHVzaCh7XG4gICAgICAgIGtleTogXCJTaWduZWRJbkV4aXRcIixcbiAgICAgICAgYWN0aW9uOiBcIkNsaWNrU2VhcmNoXCIsXG4gICAgICAgIGxhYmVsOiBcIlNhdmVkU2VhcmNoXCJcbiAgICAgIH0pO1xuICAgICAgUm92ZXJVcmxIZWxwZXIubG9hZFBhZ2UoXCJzYXZlZFNlYXJjaFwiLCBcImZhdm9yaXRlU2VhcmNoQ2xpY2tcIixcbiAgICAgICAgeyBzZWFyY2hRdWVyeSA6IG9iamVjdC5nZXQoXCJzZWFyY2hRdWVyeVwiKSxcbiAgICAgICAgICBmb3JjZU5ld1RhYiA6IHRydWVcbiAgICAgICAgfSwgYUV2ZW50KTtcbiAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgJChcIiNmb2xsb3dlZC1zZWFyY2hlcy1lZGl0LWxpbmtcIikuY2xpY2soZnVuY3Rpb24oYUV2ZW50KSB7XG4gICAgICBFdmVudEFuYWx5dGljcy5wdXNoKHtcbiAgICAgICAga2V5OiBcIlNpZ25lZEluRXhpdFwiLFxuICAgICAgICBhY3Rpb246IFwiQ2xpY2tTZWFyY2hcIixcbiAgICAgICAgbGFiZWw6IFwiRWRpdEZvbGxvd2VkU2VhcmNoZXNcIlxuICAgICAgfSk7XG4gICAgICBSb3ZlclVybEhlbHBlci5sb2FkUGFnZShcbiAgICAgICAgXCJzYXZlZFNlYXJjaGVzXCIsIFwiZmF2b3JpdGVTZWFyY2hDbGlja1wiLCBudWxsLCBhRXZlbnQpO1xuICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICAkKFwiLnNlYXJjaC10YWItaXRlbVwiKS5iaW5kKFwiY2xpY2tcIiwgZnVuY3Rpb24oYUV2ZW50KSB7XG4gICAgICB2YXIgdGFyZ2V0ID0gJChhRXZlbnQudGFyZ2V0KTtcbiAgICAgIHZhciB0YWJJZCA9IHRhcmdldC5hdHRyKFwiaWRcIik7XG4gICAgICBpZiAoIXRhYklkKSB7XG4gICAgICAgIHRhYklkID0gdGFyZ2V0LmNsb3Nlc3QoXCIuc2VhcmNoLXRhYi1pdGVtXCIpLmF0dHIoXCJpZFwiKTtcbiAgICAgIH1cblxuICAgICAgRXZlbnRBbmFseXRpY3MucHVzaCh7XG4gICAgICAgIGtleTogXCJTaWduZWRJbkludGVybmFsXCIsXG4gICAgICAgIGFjdGlvbjogXCJDbGlja1RhYkNoYW5nZVwiLFxuICAgICAgICBsYWJlbDogU2lkZWJhci5nZXRHQVRhYlRyYWNraW5nTmFtZSh0YWJJZClcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLnNlbGVjdFRhYih0YWJJZCk7XG4gICAgfS5iaW5kKHRoaXMpKTtcbiAgfSxcblxuICBzZWxlY3RUYWIgOiBmdW5jdGlvbihhVGFiSWQpIHtcbiAgICBcbiAgICB0aGlzLnNldFRhYkFjY2Vzc0xhYmVscygpO1xuICAgIHRoaXMuc2VsZWN0VGFiQWNjZXNzTGFiZWwoYVRhYklkKTtcblxuICAgICQoXCIuc2VhcmNoLXRhYi1pdGVtXCIpLnJlbW92ZUNsYXNzKFwiYWN0aXZlXCIpO1xuICAgICQoXCIjXCIgKyBhVGFiSWQpLmFkZENsYXNzKFwiYWN0aXZlXCIpO1xuXG4gICAgdmFyIHBhbmVsSWQgPSBhVGFiSWQucmVwbGFjZSgvXnNlYXJjaC10YWIvLCBcInNlYXJjaC1wYW5lbFwiKSArIFwiLWNvbnRlbnRcIjtcbiAgICAkKFwiLnNlYXJjaC1wYW5lbC1jb250ZW50XCIpLnJlbW92ZUNsYXNzKFwiYWN0aXZlXCIpO1xuXG4gICAgJChcIiNcIiArIHBhbmVsSWQpLmFkZENsYXNzKFwiYWN0aXZlXCIpO1xuXG4gICAgU2lkZWJhci5zY3JvbGxUb1RvcChcInNlYXJjaC1wYW5lbC1jb250YWluZXJcIik7XG4gIH0sXG5cbiAgX2NyZWF0ZVJlY2VudFNlYXJjaEVsZW1lbnQgOiBmdW5jdGlvbihhUmVjZW50VGV4dCkge1xuICAgIFxuICAgIC8vWFhYOiBhcyBwZXIgQU1PIHJldmlldywgbGV0J3Mgc2FuaXRpemUgdGhlIHN0cmluZ3MgY29taW5nIGZyb20gdGhlIHNlcnZlcnMuXG4gICAgYVJlY2VudFRleHQgPSBVdGlsaXR5SGVscGVyLmVzY2FwZUh0bWwoYVJlY2VudFRleHQpO1xuICAgIHZhciBlbGVtZW50ID0gJChcIjxkaXYgdGFiaW5kZXg9JzAnPjwvZGl2PlwiKS5hZGRDbGFzcyhcInNlYXJjaC1jb250ZW50LWJsb2NrLWl0ZW1cIikuYWRkQ2xhc3MoXCJyZWNlbnQtc2VhcmNoLWl0ZW1cIikudGV4dChhUmVjZW50VGV4dCk7XG4gICAgcmV0dXJuICQoXCI8YT48L2E+XCIpLmF0dHIoXCJjbGFzc1wiLCBcInNlYXJjaC1jb250ZW50LWJsb2NrLWl0ZW0tbGlua1wiKS5hdHRyKHsgXCJocmVmXCIgOiBcIiNcIiwgXCJkYXRhLXVwZGF0ZS10b29sdGlwXCIgOiBcInRydWVcIiB9KS5hcHBlbmQoZWxlbWVudCk7XG4gIH0sXG5cbiAgX2NyZWF0ZUZvbGxvd2VkU2VhcmNoRWxlbWVudCA6IGZ1bmN0aW9uKGFSZWNlbnRUZXh0KSB7XG4gICAgXG4gICAgLy9YWFg6IGFzIHBlciBBTU8gcmV2aWV3LCBsZXQncyBzYW5pdGl6ZSB0aGUgc3RyaW5ncyBjb21pbmcgZnJvbSB0aGUgc2VydmVycy5cbiAgICBhUmVjZW50VGV4dCA9IFV0aWxpdHlIZWxwZXIuZXNjYXBlSHRtbChhUmVjZW50VGV4dCk7XG4gICAgdmFyIGVsZW1lbnQgPSAkKFwiPGRpdiB0YWJpbmRleD0nMCc+PC9kaXY+XCIpLmFkZENsYXNzKFwic2VhcmNoLWNvbnRlbnQtYmxvY2staXRlbVwiKS5hZGRDbGFzcyhcImZvbGxvd2VkLXNlYXJjaC1pdGVtXCIpLnRleHQoYVJlY2VudFRleHQpO1xuICAgIHJldHVybiAkKFwiPGE+PC9hPlwiKS5hdHRyKFwiY2xhc3NcIiwgXCJzZWFyY2gtY29udGVudC1ibG9jay1pdGVtLWxpbmtcIikuYXR0cih7IFwiaHJlZlwiIDogXCIjXCIsIFwiZGF0YS11cGRhdGUtdG9vbHRpcFwiIDogXCJ0cnVlXCIgfSkuYXBwZW5kKGVsZW1lbnQpO1xuICB9LFxuXG4gIF9zaG93UmVjZW50U2VhcmNoZXMgOiBmdW5jdGlvbigpIHtcbiAgICBcbiAgICB2YXIgc2VhcmNoZXMgPSBSZWNlbnRTZWFyY2hNZWRzU2VydmljZS5yZWNlbnRTZWFyY2hlcztcblxuICAgIGlmICgkLmlzRW1wdHlPYmplY3Qoc2VhcmNoZXMpKSB7XG4gICAgICB0aGlzLl9jbGVhclJlY2VudFNlYXJjaGVzKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICQoXCIjc2VhcmNoLXBhbmVsLXJlY2VudC1zZWFyY2hlcy1tYWluXCIpLmVtcHR5KCk7XG5cbiAgICAgICQuZWFjaChzZWFyY2hlcywgZnVuY3Rpb24oYUluZGV4LCBhU2VhcmNoKSB7XG4gICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fY3JlYXRlUmVjZW50U2VhcmNoRWxlbWVudChhU2VhcmNoLmdldChcInNlYXJjaFN0cmluZ1wiKSk7XG4gICAgICAgIGVsZW1lbnQuZGF0YShcInNlYXJjaFwiLCBhU2VhcmNoLmNvcHkoKSk7XG4gICAgICAgICQoXCIjc2VhcmNoLXBhbmVsLXJlY2VudC1zZWFyY2hlcy1tYWluXCIpLmFwcGVuZChlbGVtZW50KTtcbiAgICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICAgICQoXCIjc2VhcmNoLXBhbmVsLXJlY2VudC1zZWFyY2hlcy1lbXB0eVwiKS5oaWRlKCk7XG4gICAgICAkKFwiI3NlYXJjaC1wYW5lbC1yZWNlbnQtc2VhcmNoZXMtbWFpbiwjcmVjZW50LXNlYXJjaGVzLWNsZWFyLWxpbmtcIikuc2hvdygpO1xuICAgICAgU2lkZWJhci51cGRhdGVUb29sdGlwcygpO1xuICAgICAgU2lkZWJhci5hZGp1c3RUYWJJbmRleCgpO1xuICAgICAgU2lkZWJhci5yZW1vdmVUYWJJbmRleCgpO1xuICAgIH1cbiAgfSxcblxuICBfY2xlYXJSZWNlbnRTZWFyY2hlcyA6IGZ1bmN0aW9uKCkge1xuICAgIFxuICAgICQoXCIjc2VhcmNoLXBhbmVsLXJlY2VudC1zZWFyY2hlcy1tYWluLCNyZWNlbnQtc2VhcmNoZXMtY2xlYXItbGlua1wiKS5oaWRlKCk7XG4gICAgJChcIiNzZWFyY2gtcGFuZWwtcmVjZW50LXNlYXJjaGVzLWVtcHR5XCIpLnNob3coKTtcbiAgfSxcblxuICBfc2hvd0ZvbGxvd2VkU2VhcmNoZXMgOiBmdW5jdGlvbigpIHtcbiAgICBcbiAgICB2YXIgc2VhcmNoZXMgPSBGYXZvcml0ZVNlYXJjaFNlcnZpY2UuZmF2b3JpdGVTZWFyY2hlcztcblxuICAgIGlmICgkLmlzRW1wdHlPYmplY3Qoc2VhcmNoZXMpKSB7XG4gICAgICB0aGlzLl9jbGVhckZvbGxvd2VkU2VhcmNoZXMoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgJChcIiNzZWFyY2gtcGFuZWwtZm9sbG93ZWQtc2VhcmNoZXMtbWFpblwiKS5lbXB0eSgpO1xuXG4gICAgICAkLmVhY2goc2VhcmNoZXMsIGZ1bmN0aW9uKGFJbmRleCwgYVNlYXJjaCkge1xuICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuX2NyZWF0ZUZvbGxvd2VkU2VhcmNoRWxlbWVudChhU2VhcmNoLmdldChcInNlYXJjaE5hbWVcIikpO1xuICAgICAgICBlbGVtZW50LmRhdGEoXCJzZWFyY2hcIiwgYVNlYXJjaC5jb3B5KCkpO1xuICAgICAgICAkKFwiI3NlYXJjaC1wYW5lbC1mb2xsb3dlZC1zZWFyY2hlcy1tYWluXCIpLmFwcGVuZChlbGVtZW50KTtcbiAgICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICAgICQoXCIjc2VhcmNoLXBhbmVsLWZvbGxvd2VkLXNlYXJjaGVzLWVtcHR5XCIpLmhpZGUoKTtcbiAgICAgICQoXCIjc2VhcmNoLXBhbmVsLWZvbGxvd2VkLXNlYXJjaGVzLW1haW4sI2ZvbGxvd2VkLXNlYXJjaGVzLWVkaXQtbGlua1wiKS5zaG93KCk7XG4gICAgICBTaWRlYmFyLnVwZGF0ZVRvb2x0aXBzKCk7XG4gICAgICBTaWRlYmFyLmFkanVzdFRhYkluZGV4KCk7XG4gICAgICBTaWRlYmFyLnJlbW92ZVRhYkluZGV4KCk7XG4gICAgfVxuICB9LFxuXG4gIF9jbGVhckZvbGxvd2VkU2VhcmNoZXMgOiBmdW5jdGlvbigpIHtcbiAgICBcbiAgICAkKFwiI3NlYXJjaC1wYW5lbC1mb2xsb3dlZC1zZWFyY2hlcy1tYWluLCNmb2xsb3dlZC1zZWFyY2hlcy1lZGl0LWxpbmtcIikuaGlkZSgpO1xuICAgICQoXCIjc2VhcmNoLXBhbmVsLWZvbGxvd2VkLXNlYXJjaGVzLWVtcHR5XCIpLnNob3coKTtcbiAgfSxcblxuICBvYnNlcnZlIDogZnVuY3Rpb24oYVRvcGljLCBhRGF0YSkge1xuICAgIHN3aXRjaCAoYVRvcGljKSB7XG4gICAgICBjYXNlIFRvcGljcy5GQVZPUklURV9TRUFSQ0hFU19VUERBVEVEOlxuICAgICAgICBpZiAodGhpcy5faXNTaG93bigpKSB7XG4gICAgICAgICAgdGhpcy5fc2hvd0ZvbGxvd2VkU2VhcmNoZXMoKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgVG9waWNzLkZBVk9SSVRFX1NFQVJDSEVTX1JFTU9WRUQ6XG4gICAgICAgIGlmICh0aGlzLl9pc1Nob3duKCkpIHtcbiAgICAgICAgICB0aGlzLl9jbGVhckZvbGxvd2VkU2VhcmNoZXMoKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgVG9waWNzLlJFQ0VOVF9TRUFSQ0hFU19VUERBVEVEOlxuICAgICAgICBpZiAodGhpcy5faXNTaG93bigpKSB7XG4gICAgICAgICAgdGhpcy5fc2hvd1JlY2VudFNlYXJjaGVzKCk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRvcGljcy5SRUNFTlRfU0VBUkNIRVNfUkVNT1ZFRDpcbiAgICAgICAgaWYgKHRoaXMuX2lzU2hvd24oKSkge1xuICAgICAgICAgIHRoaXMuX2NsZWFyUmVjZW50U2VhcmNoZXMoKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cbn07XG5cbiQod2luZG93KS51bmxvYWQoZnVuY3Rpb24oKSB7IFNlYXJjaENvbnRlbnQudW5pbml0KCk7IH0pO1xuIl19