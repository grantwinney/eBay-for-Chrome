/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var MessagePanel = {
    _dismissTimeoutId: null,
    _delayInit: false,
    _TIMEOUT_DELETED_ITEMS: 8 * 1000,
    _TIMEOUT_BETA_ACTIONS: 30 * 1000,
    init: function () {
        this._addEventListeners();
        setTimeout(function () {
            this._delayInit = true;
            this._show();
        }.bind(this), 3000);
        ObserverHelper.addObserver(this, Topics.MESSAGE_PANEL_SHOW);
        ObserverHelper.addObserver(this, Topics.MESSAGE_PANEL_DISMISS);
    },
    uninit: function () {
        $("#message-panel-close-button-outer").unbind("click");
        $("#message-panel-message-body").unbind("click");
        var messagePanel = $("#message-panel");
        if (messagePanel.is(":visible")) {
            var messageObj = messagePanel.data("messageObject");
            MessagePanelService.dismissMessage(messageObj.type);
        }
        ObserverHelper.removeObserver(this, Topics.MESSAGE_PANEL_SHOW);
        ObserverHelper.removeObserver(this, Topics.MESSAGE_PANEL_DISMISS);
    },
    _addEventListeners: function () {
        $("#message-panel-message-body").click(function (aEvent) {
            if (aEvent.target.tagName.toLowerCase() == "a") {
                var data = $("#message-panel").data("messageObject");
                if ("url" in data) {
                    Site.openRawURL(data.url, aEvent);
                }
            }
        }.bind(this));
        $("#message-panel-action-button").click(function () {
            var messageObj = $("#message-panel").data("messageObject");
            if (messageObj.type == MessagePanelService.TYPE.ITEMS_DELETED) {
                switch (messageObj.data.itemType) {
                    case Item.TYPES.WATCHING:
                        PanelWatching.showDeletedItems();
                        break;
                    case Item.TYPES.WON:
                    case Item.TYPES.LOST:
                        PanelBuying.showDeletedItems();
                        break;
                    case Item.TYPES.SOLD:
                    case Item.TYPES.UNSOLD:
                        PanelSelling.showDeletedItems();
                        break;
                }
                this.dismiss();
            }
            else if (messageObj.type == MessagePanelService.TYPE.CONNECT_ERROR) {
                this.dismiss();
            }
        }.bind(this));
        $("#message-panel-close-button-outer").click(function () {
            this.dismiss();
        }.bind(this));
        $("#message-panel").hover(function () {
            this._clearDismissTimeout();
        }.bind(this), function () {
            this._setDismissTimeout();
        }.bind(this));
    },
    onTabChange: function () {
        if (this._delayInit) {
            this.dismiss(true);
        }
    },
    _clearDismissTimeout: function () {
        var panel = $("#message-panel");
        if (panel.is(":visible") && panel.data("messageObject").type ==
            MessagePanelService.TYPE.ITEMS_DELETED) {
            if (this._dismissTimeoutId) {
                clearTimeout(this._dismissTimeoutId);
                this._dismissTimeoutId = null;
            }
        }
    },
    _setDismissTimeout: function () {
        var panel = $("#message-panel");
        if (panel.is(":visible") && panel.data("messageObject").type ==
            MessagePanelService.TYPE.ITEMS_DELETED) {
            if (this._dismissTimeoutId) {
                clearTimeout(this._dismissTimeoutId);
            }
            this._dismissTimeoutId = setTimeout(function () {
                this._dismissTimeoutId = null;
                this.dismiss();
            }.bind(this), MessagePanel._TIMEOUT_DELETED_ITEMS);
        }
    },
    addMessage: function (aType, aObj) {
        MessagePanelService.addMessage(aType, aObj);
    },
    _show: function () {
        var messages = MessagePanelService.getMessages();
        if (messages.length === 0) {
            return;
        }
        var message = messages[0];
        var panel = $("#message-panel");
        if (panel.is(":visible") && panel.data("messageObject").type == message.type) {
            this._setDismissTimeout();
            return;
        }
        var messageBody = $("#message-panel-message-body");
        var actionButton = $("#message-panel-action-button-label");
        var dismissTime;
        var str;
        if (!panel.is(":visible")) {
            panel.slideDown("fast");
        }
        switch (message.type) {
            case MessagePanelService.TYPE.LEAVE_FEEDBACK:
                dismissTime = MessagePanel._TIMEOUT_BETA_ACTIONS;
                str = $.i18n.getString("message.leaveFeedback");
                message.url =
                    RoverUrlHelper.getUrl({ srcAreaName: "unwrappedLink", templateName: "appFeedback" });
                panel.removeClass("with-action-button");
                messageBody.append(this._convertStringToLink(str));
                panel.data("messageObject", message);
                break;
            case MessagePanelService.TYPE.BETA_APP_UPDATED:
                dismissTime = MessagePanel._TIMEOUT_BETA_ACTIONS;
                str = $.i18n.getString("message.betaAppUpdated");
                message.url =
                    RoverUrlHelper.getUrl({ srcAreaName: "unwrappedLink", templateName: "appFeedback" });
                panel.removeClass("with-action-button");
                messageBody.append(this._convertStringToLink(str));
                panel.data("messageObject", message);
                break;
            case MessagePanelService.TYPE.ITEMS_DELETED:
                dismissTime = MessagePanel._TIMEOUT_DELETED_ITEMS;
                var strKey = message.data.itemNum == 1 ? "message.itemDeleted.from" : "message.itemsDeleted.from";
                str = $.i18n.getString(strKey + message.data.itemType, [message.data.itemNum]);
                if (!panel.hasClass("with-action-button")) {
                    panel.addClass("with-action-button");
                }
                messageBody.text(str);
                panel.data("messageObject", message);
                actionButton.text($.i18n.getString("message.itemsDeleted.undo"));
                break;
            case MessagePanelService.TYPE.CONNECT_ERROR:
                str = $.i18n.getString("message.connectError");
                if (!panel.hasClass("with-action-button")) {
                    panel.addClass("with-action-button");
                }
                messageBody.text(str);
                panel.data("messageObject", message);
                actionButton.text($.i18n.getString("message.ok"));
                break;
        }
        if (dismissTime) {
            this._dismissTimeoutId = setTimeout(function () {
                this._dismissTimeoutId = null;
                this.dismiss();
            }.bind(this), dismissTime);
        }
    },
    _convertStringToLink: function (aString) {
        return aString.replace(/\[\d+ (.*?)\]/g, "<a href='#'>$1</a>");
    },
    dismiss: function (aTabChange, aSkipDeleting) {
        var panel = $("#message-panel");
        if (!panel.is(":visible")) {
            this._show();
            return;
        }
        var messageObj = panel.data("messageObject");
        var tabChangeDismissTypes = [
            MessagePanelService.TYPE.ITEMS_DELETED,
            MessagePanelService.TYPE.CONNECT_ERROR
        ];
        if (aTabChange && tabChangeDismissTypes.indexOf(messageObj.type) == -1) {
            return;
        }
        if (messageObj.type == MessagePanelService.TYPE.ITEMS_DELETED) {
            switch (messageObj.data.itemType) {
                case Item.TYPES.WATCHING:
                    if (!aSkipDeleting) {
                        PanelWatching.deleteItems();
                    }
                    break;
                case Item.TYPES.WON:
                case Item.TYPES.LOST:
                    PanelBuying.deleteItems();
                    break;
                case Item.TYPES.SOLD:
                case Item.TYPES.UNSOLD:
                    PanelSelling.deleteItems();
                    break;
            }
        }
        if (this._dismissTimeoutId) {
            clearTimeout(this._dismissTimeoutId);
            this._dismissTimeoutId = null;
        }
        MessagePanelService.dismissMessage(messageObj.type);
    },
    _hide: function () {
        if (MessagePanelService.getMessages().length > 0) {
            this._show();
        }
        else {
            var panel = $("#message-panel");
            if (panel.is(":visible")) {
                panel.slideUp("fast");
            }
        }
    },
    observe: function (aTopic, aData) {
        switch (aTopic) {
            case Topics.MESSAGE_PANEL_SHOW:
                if (this._delayInit) {
                    this._show();
                }
                break;
            case Topics.MESSAGE_PANEL_DISMISS:
                if (this._delayInit) {
                    this._hide();
                }
                break;
        }
    }
};
$(window).unload(function () { MessagePanel.uninit(); });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZVBhbmVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vdWkvdmlldy9jb3JlL21lc3NhZ2VQYW5lbC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQUVILElBQUksWUFBWSxHQUFHO0lBQ2pCLGlCQUFpQixFQUFHLElBQUk7SUFDeEIsVUFBVSxFQUFHLEtBQUs7SUFDbEIsc0JBQXNCLEVBQUcsQ0FBQyxHQUFHLElBQUk7SUFDakMscUJBQXFCLEVBQUcsRUFBRSxHQUFHLElBQUk7SUFFakMsSUFBSSxFQUFHO1FBQ0wsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFFMUIsVUFBVSxDQUFDO1lBQ1QsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7WUFDdkIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2YsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVwQixjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUM1RCxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMscUJBQXFCLENBQUMsQ0FBQztJQUNqRSxDQUFDO0lBRUQsTUFBTSxFQUFHO1FBQ1AsQ0FBQyxDQUFDLG1DQUFtQyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZELENBQUMsQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUdqRCxJQUFJLFlBQVksR0FBRyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN2QyxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoQyxJQUFJLFVBQVUsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ3BE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QztZQUNqRCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDZixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUNoQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN4QixDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRCxPQUFPLEVBQUcsVUFBUyxNQUFNLEVBQUUsS0FBSztRQUM5QixNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2YsS0FBSyxNQUFNLENBQUMsa0JBQWtCO2dCQUU1QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztvQkFDcEIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNmLENBQUM7Z0JBQ0QsS0FBSyxDQUFDO1lBQ1IsS0FBSyxNQUFNLENBQUMscUJBQXFCO2dCQUUvQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztvQkFDcEIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNmLENBQUM7Z0JBQ0QsS0FBSyxDQUFDO1FBQ1YsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFDO0FBRUYsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxjQUFhLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBDb3B5cmlnaHQgKEMpIDIwMDctMjAxNSBlQmF5IEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqL1xuXG52YXIgTWVzc2FnZVBhbmVsID0ge1xuICBfZGlzbWlzc1RpbWVvdXRJZCA6IG51bGwsXG4gIF9kZWxheUluaXQgOiBmYWxzZSxcbiAgX1RJTUVPVVRfREVMRVRFRF9JVEVNUyA6IDggKiAxMDAwLCAvLzggc2Vjb25kcyB0byBkaXNtaXNzIHRoZSBwYW5lbFxuICBfVElNRU9VVF9CRVRBX0FDVElPTlMgOiAzMCAqIDEwMDAsIC8vMzAgc2Vjb25kcyB0byBkaXNtaXNzIHRoZSBwYW5lbFxuXG4gIGluaXQgOiBmdW5jdGlvbigpIHtcbiAgICB0aGlzLl9hZGRFdmVudExpc3RlbmVycygpO1xuICAgIC8vIFhYWDogZGVsYXkgdG8gYXZvaWQgZXJyb3IgdG8gc2hvdyBhbmQgdGhlbiBoaWRlXG4gICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgIHRoaXMuX2RlbGF5SW5pdCA9IHRydWU7XG4gICAgICB0aGlzLl9zaG93KCk7XG4gICAgfS5iaW5kKHRoaXMpLCAzMDAwKTtcblxuICAgIE9ic2VydmVySGVscGVyLmFkZE9ic2VydmVyKHRoaXMsIFRvcGljcy5NRVNTQUdFX1BBTkVMX1NIT1cpO1xuICAgIE9ic2VydmVySGVscGVyLmFkZE9ic2VydmVyKHRoaXMsIFRvcGljcy5NRVNTQUdFX1BBTkVMX0RJU01JU1MpO1xuICB9LFxuXG4gIHVuaW5pdCA6IGZ1bmN0aW9uKCkge1xuICAgICQoXCIjbWVzc2FnZS1wYW5lbC1jbG9zZS1idXR0b24tb3V0ZXJcIikudW5iaW5kKFwiY2xpY2tcIik7XG4gICAgJChcIiNtZXNzYWdlLXBhbmVsLW1lc3NhZ2UtYm9keVwiKS51bmJpbmQoXCJjbGlja1wiKTtcblxuICAgIC8vIGRpc21pc3Mgd2UgYXJlIHNob3dpbmdcbiAgICB2YXIgbWVzc2FnZVBhbmVsID0gJChcIiNtZXNzYWdlLXBhbmVsXCIpO1xuICAgIGlmIChtZXNzYWdlUGFuZWwuaXMoXCI6dmlzaWJsZVwiKSkge1xuICAgICAgdmFyIG1lc3NhZ2VPYmogPSBtZXNzYWdlUGFuZWwuZGF0YShcIm1lc3NhZ2VPYmplY3RcIik7XG4gICAgICBNZXNzYWdlUGFuZWxTZXJ2aWNlLmRpc21pc3NNZXNzYWdlKG1lc3NhZ2VPYmoudHlwZSk7XG4gICAgfVxuXG4gICAgT2JzZXJ2ZXJIZWxwZXIucmVtb3ZlT2JzZXJ2ZXIodGhpcywgVG9waWNzLk1FU1NBR0VfUEFORUxfU0hPVyk7XG4gICAgT2JzZXJ2ZXJIZWxwZXIucmVtb3ZlT2JzZXJ2ZXIodGhpcywgVG9waWNzLk1FU1NBR0VfUEFORUxfRElTTUlTUyk7XG4gIH0sXG5cbiAgX2FkZEV2ZW50TGlzdGVuZXJzIDogZnVuY3Rpb24oKSB7XG4gICAgJChcIiNtZXNzYWdlLXBhbmVsLW1lc3NhZ2UtYm9keVwiKS5jbGljayhmdW5jdGlvbihhRXZlbnQpIHtcbiAgICAgIGlmIChhRXZlbnQudGFyZ2V0LnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSBcImFcIikge1xuICAgICAgICB2YXIgZGF0YSA9ICQoXCIjbWVzc2FnZS1wYW5lbFwiKS5kYXRhKFwibWVzc2FnZU9iamVjdFwiKTtcbiAgICAgICAgaWYgKFwidXJsXCIgaW4gZGF0YSkge1xuICAgICAgICAgIFNpdGUub3BlblJhd1VSTChkYXRhLnVybCwgYUV2ZW50KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0uYmluZCh0aGlzKSk7XG4gICAgJChcIiNtZXNzYWdlLXBhbmVsLWFjdGlvbi1idXR0b25cIikuY2xpY2soZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgbWVzc2FnZU9iaiA9ICQoXCIjbWVzc2FnZS1wYW5lbFwiKS5kYXRhKFwibWVzc2FnZU9iamVjdFwiKTtcblxuICAgICAgaWYgKG1lc3NhZ2VPYmoudHlwZSA9PSBNZXNzYWdlUGFuZWxTZXJ2aWNlLlRZUEUuSVRFTVNfREVMRVRFRCkge1xuICAgICAgICBzd2l0Y2ggKG1lc3NhZ2VPYmouZGF0YS5pdGVtVHlwZSkge1xuICAgICAgICAgIGNhc2UgSXRlbS5UWVBFUy5XQVRDSElORzpcbiAgICAgICAgICAgIFBhbmVsV2F0Y2hpbmcuc2hvd0RlbGV0ZWRJdGVtcygpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSBJdGVtLlRZUEVTLldPTjpcbiAgICAgICAgICBjYXNlIEl0ZW0uVFlQRVMuTE9TVDpcbiAgICAgICAgICAgIFBhbmVsQnV5aW5nLnNob3dEZWxldGVkSXRlbXMoKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgSXRlbS5UWVBFUy5TT0xEOlxuICAgICAgICAgIGNhc2UgSXRlbS5UWVBFUy5VTlNPTEQ6XG4gICAgICAgICAgICBQYW5lbFNlbGxpbmcuc2hvd0RlbGV0ZWRJdGVtcygpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kaXNtaXNzKCk7XG4gICAgICB9IGVsc2UgaWYgKG1lc3NhZ2VPYmoudHlwZSA9PSBNZXNzYWdlUGFuZWxTZXJ2aWNlLlRZUEUuQ09OTkVDVF9FUlJPUikge1xuICAgICAgICB0aGlzLmRpc21pc3MoKTtcbiAgICAgIH1cbiAgICB9LmJpbmQodGhpcykpO1xuICAgICQoXCIjbWVzc2FnZS1wYW5lbC1jbG9zZS1idXR0b24tb3V0ZXJcIikuY2xpY2soZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLmRpc21pc3MoKTtcbiAgICB9LmJpbmQodGhpcykpO1xuICAgICQoXCIjbWVzc2FnZS1wYW5lbFwiKS5ob3ZlcihmdW5jdGlvbigpIHtcbiAgICAgIHRoaXMuX2NsZWFyRGlzbWlzc1RpbWVvdXQoKTtcbiAgICB9LmJpbmQodGhpcyksIGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5fc2V0RGlzbWlzc1RpbWVvdXQoKTtcbiAgICB9LmJpbmQodGhpcykpO1xuICB9LFxuXG4gIG9uVGFiQ2hhbmdlIDogZnVuY3Rpb24oKSB7XG4gICAgLy8gdXNlIGRlbGF5IGluaXQgdG8gYXZvaWQgaXNzdWVzIGF0IHN0YXJ0dXBcbiAgICBpZiAodGhpcy5fZGVsYXlJbml0KSB7XG4gICAgICB0aGlzLmRpc21pc3ModHJ1ZSk7XG4gICAgfVxuICB9LFxuXG4gIF9jbGVhckRpc21pc3NUaW1lb3V0IDogZnVuY3Rpb24oKSB7XG4gICAgdmFyIHBhbmVsID0gJChcIiNtZXNzYWdlLXBhbmVsXCIpO1xuXG4gICAgaWYgKHBhbmVsLmlzKFwiOnZpc2libGVcIikgJiYgcGFuZWwuZGF0YShcIm1lc3NhZ2VPYmplY3RcIikudHlwZSA9PVxuICAgICAgICBNZXNzYWdlUGFuZWxTZXJ2aWNlLlRZUEUuSVRFTVNfREVMRVRFRCkge1xuICAgICAgLy8gcmVzZXQgdGhlIHRpbWVyIGlmIHNob3dpbmcgaXRlbXMgZGVsZXRlIG1lc3NhZ2U7XG4gICAgICBpZiAodGhpcy5fZGlzbWlzc1RpbWVvdXRJZCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fZGlzbWlzc1RpbWVvdXRJZCk7XG4gICAgICAgIHRoaXMuX2Rpc21pc3NUaW1lb3V0SWQgPSBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICBfc2V0RGlzbWlzc1RpbWVvdXQgOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgcGFuZWwgPSAkKFwiI21lc3NhZ2UtcGFuZWxcIik7XG5cbiAgICBpZiAocGFuZWwuaXMoXCI6dmlzaWJsZVwiKSAmJiBwYW5lbC5kYXRhKFwibWVzc2FnZU9iamVjdFwiKS50eXBlID09XG4gICAgICAgIE1lc3NhZ2VQYW5lbFNlcnZpY2UuVFlQRS5JVEVNU19ERUxFVEVEKSB7XG4gICAgICBpZiAodGhpcy5fZGlzbWlzc1RpbWVvdXRJZCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fZGlzbWlzc1RpbWVvdXRJZCk7XG4gICAgICB9XG4gICAgICB0aGlzLl9kaXNtaXNzVGltZW91dElkID0gc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy5fZGlzbWlzc1RpbWVvdXRJZCA9IG51bGw7XG4gICAgICAgIHRoaXMuZGlzbWlzcygpO1xuICAgICAgfS5iaW5kKHRoaXMpLCBNZXNzYWdlUGFuZWwuX1RJTUVPVVRfREVMRVRFRF9JVEVNUyk7XG4gICAgfVxuICB9LFxuXG4gIGFkZE1lc3NhZ2UgOiBmdW5jdGlvbihhVHlwZSwgYU9iaikge1xuICAgIE1lc3NhZ2VQYW5lbFNlcnZpY2UuYWRkTWVzc2FnZShhVHlwZSwgYU9iaik7XG4gIH0sXG5cbiAgX3Nob3cgOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgbWVzc2FnZXMgPSBNZXNzYWdlUGFuZWxTZXJ2aWNlLmdldE1lc3NhZ2VzKCk7XG4gICAgaWYgKG1lc3NhZ2VzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHZhciBtZXNzYWdlID0gbWVzc2FnZXNbMF07XG4gICAgdmFyIHBhbmVsID0gJChcIiNtZXNzYWdlLXBhbmVsXCIpO1xuXG4gICAgaWYgKHBhbmVsLmlzKFwiOnZpc2libGVcIikgJiYgcGFuZWwuZGF0YShcIm1lc3NhZ2VPYmplY3RcIikudHlwZSA9PSBtZXNzYWdlLnR5cGUpIHtcbiAgICAgIHRoaXMuX3NldERpc21pc3NUaW1lb3V0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdmFyIG1lc3NhZ2VCb2R5ID0gJChcIiNtZXNzYWdlLXBhbmVsLW1lc3NhZ2UtYm9keVwiKTtcbiAgICB2YXIgYWN0aW9uQnV0dG9uID0gJChcIiNtZXNzYWdlLXBhbmVsLWFjdGlvbi1idXR0b24tbGFiZWxcIik7XG4gICAgdmFyIGRpc21pc3NUaW1lO1xuICAgIHZhciBzdHI7XG5cbiAgICBpZiAoIXBhbmVsLmlzKFwiOnZpc2libGVcIikpIHtcbiAgICAgIHBhbmVsLnNsaWRlRG93bihcImZhc3RcIik7XG4gICAgfVxuXG4gICAgc3dpdGNoIChtZXNzYWdlLnR5cGUpIHtcbiAgICAgIGNhc2UgTWVzc2FnZVBhbmVsU2VydmljZS5UWVBFLkxFQVZFX0ZFRURCQUNLOlxuICAgICAgICBkaXNtaXNzVGltZSA9IE1lc3NhZ2VQYW5lbC5fVElNRU9VVF9CRVRBX0FDVElPTlM7XG4gICAgICAgIHN0ciA9ICQuaTE4bi5nZXRTdHJpbmcoXCJtZXNzYWdlLmxlYXZlRmVlZGJhY2tcIik7XG4gICAgICAgIG1lc3NhZ2UudXJsID1cbiAgICAgICAgICBSb3ZlclVybEhlbHBlci5nZXRVcmwoeyBzcmNBcmVhTmFtZTogXCJ1bndyYXBwZWRMaW5rXCIsIHRlbXBsYXRlTmFtZTogXCJhcHBGZWVkYmFja1wiIH0pO1xuICAgICAgICBwYW5lbC5yZW1vdmVDbGFzcyhcIndpdGgtYWN0aW9uLWJ1dHRvblwiKTtcbiAgICAgICAgbWVzc2FnZUJvZHkuYXBwZW5kKHRoaXMuX2NvbnZlcnRTdHJpbmdUb0xpbmsoc3RyKSk7XG4gICAgICAgIHBhbmVsLmRhdGEoXCJtZXNzYWdlT2JqZWN0XCIsIG1lc3NhZ2UpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgTWVzc2FnZVBhbmVsU2VydmljZS5UWVBFLkJFVEFfQVBQX1VQREFURUQ6XG4gICAgICAgIGRpc21pc3NUaW1lID0gTWVzc2FnZVBhbmVsLl9USU1FT1VUX0JFVEFfQUNUSU9OUztcbiAgICAgICAgc3RyID0gJC5pMThuLmdldFN0cmluZyhcIm1lc3NhZ2UuYmV0YUFwcFVwZGF0ZWRcIik7XG4gICAgICAgIG1lc3NhZ2UudXJsID1cbiAgICAgICAgICBSb3ZlclVybEhlbHBlci5nZXRVcmwoeyBzcmNBcmVhTmFtZTogXCJ1bndyYXBwZWRMaW5rXCIsIHRlbXBsYXRlTmFtZTogXCJhcHBGZWVkYmFja1wiIH0pO1xuICAgICAgICBwYW5lbC5yZW1vdmVDbGFzcyhcIndpdGgtYWN0aW9uLWJ1dHRvblwiKTtcbiAgICAgICAgbWVzc2FnZUJvZHkuYXBwZW5kKHRoaXMuX2NvbnZlcnRTdHJpbmdUb0xpbmsoc3RyKSk7XG4gICAgICAgIHBhbmVsLmRhdGEoXCJtZXNzYWdlT2JqZWN0XCIsIG1lc3NhZ2UpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgTWVzc2FnZVBhbmVsU2VydmljZS5UWVBFLklURU1TX0RFTEVURUQ6XG4gICAgICAgIGRpc21pc3NUaW1lID0gTWVzc2FnZVBhbmVsLl9USU1FT1VUX0RFTEVURURfSVRFTVM7XG4gICAgICAgIHZhciBzdHJLZXkgPVxuICAgICAgICAgIG1lc3NhZ2UuZGF0YS5pdGVtTnVtID09IDEgPyBcIm1lc3NhZ2UuaXRlbURlbGV0ZWQuZnJvbVwiIDogXCJtZXNzYWdlLml0ZW1zRGVsZXRlZC5mcm9tXCI7XG4gICAgICAgIHN0ciA9ICQuaTE4bi5nZXRTdHJpbmcoc3RyS2V5ICsgbWVzc2FnZS5kYXRhLml0ZW1UeXBlLCBbbWVzc2FnZS5kYXRhLml0ZW1OdW1dKTtcbiAgICAgICAgaWYgKCFwYW5lbC5oYXNDbGFzcyhcIndpdGgtYWN0aW9uLWJ1dHRvblwiKSkge1xuICAgICAgICAgIHBhbmVsLmFkZENsYXNzKFwid2l0aC1hY3Rpb24tYnV0dG9uXCIpO1xuICAgICAgICB9XG4gICAgICAgIG1lc3NhZ2VCb2R5LnRleHQoc3RyKTtcbiAgICAgICAgcGFuZWwuZGF0YShcIm1lc3NhZ2VPYmplY3RcIiwgbWVzc2FnZSk7XG4gICAgICAgIGFjdGlvbkJ1dHRvbi50ZXh0KCQuaTE4bi5nZXRTdHJpbmcoXCJtZXNzYWdlLml0ZW1zRGVsZXRlZC51bmRvXCIpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIE1lc3NhZ2VQYW5lbFNlcnZpY2UuVFlQRS5DT05ORUNUX0VSUk9SOlxuICAgICAgICBzdHIgPSAkLmkxOG4uZ2V0U3RyaW5nKFwibWVzc2FnZS5jb25uZWN0RXJyb3JcIik7XG4gICAgICAgIGlmICghcGFuZWwuaGFzQ2xhc3MoXCJ3aXRoLWFjdGlvbi1idXR0b25cIikpIHtcbiAgICAgICAgICBwYW5lbC5hZGRDbGFzcyhcIndpdGgtYWN0aW9uLWJ1dHRvblwiKTtcbiAgICAgICAgfVxuICAgICAgICBtZXNzYWdlQm9keS50ZXh0KHN0cik7XG4gICAgICAgIHBhbmVsLmRhdGEoXCJtZXNzYWdlT2JqZWN0XCIsIG1lc3NhZ2UpO1xuICAgICAgICBhY3Rpb25CdXR0b24udGV4dCgkLmkxOG4uZ2V0U3RyaW5nKFwibWVzc2FnZS5va1wiKSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpZiAoZGlzbWlzc1RpbWUpIHtcbiAgICAgIHRoaXMuX2Rpc21pc3NUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLl9kaXNtaXNzVGltZW91dElkID0gbnVsbDtcbiAgICAgICAgdGhpcy5kaXNtaXNzKCk7XG4gICAgICB9LmJpbmQodGhpcyksIGRpc21pc3NUaW1lKTtcbiAgICB9XG4gIH0sXG5cbiAgX2NvbnZlcnRTdHJpbmdUb0xpbmsgOiBmdW5jdGlvbihhU3RyaW5nKSB7XG4gICAgcmV0dXJuIGFTdHJpbmcucmVwbGFjZSgvXFxbXFxkKyAoLio/KVxcXS9nLCBcIjxhIGhyZWY9JyMnPiQxPC9hPlwiKTtcbiAgfSxcblxuICBkaXNtaXNzIDogZnVuY3Rpb24oYVRhYkNoYW5nZSwgYVNraXBEZWxldGluZykge1xuICAgIHZhciBwYW5lbCA9ICQoXCIjbWVzc2FnZS1wYW5lbFwiKTtcbiAgICBpZiAoIXBhbmVsLmlzKFwiOnZpc2libGVcIikpIHtcbiAgICAgIHRoaXMuX3Nob3coKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB2YXIgbWVzc2FnZU9iaiA9IHBhbmVsLmRhdGEoXCJtZXNzYWdlT2JqZWN0XCIpO1xuICAgIHZhciB0YWJDaGFuZ2VEaXNtaXNzVHlwZXMgPSBbXG4gICAgICBNZXNzYWdlUGFuZWxTZXJ2aWNlLlRZUEUuSVRFTVNfREVMRVRFRCxcbiAgICAgIE1lc3NhZ2VQYW5lbFNlcnZpY2UuVFlQRS5DT05ORUNUX0VSUk9SXG4gICAgXTtcbiAgICAvLyBvbmx5IGRpc21pc3MgaXRlbSB1bmRvIG1lc3NhZ2UgYW5kIGVycm9yIG1lc3NhZ2Ugb24gdGFiIGNoYW5nZVxuICAgIGlmIChhVGFiQ2hhbmdlICYmIHRhYkNoYW5nZURpc21pc3NUeXBlcy5pbmRleE9mKG1lc3NhZ2VPYmoudHlwZSkgPT0gLTEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAobWVzc2FnZU9iai50eXBlID09IE1lc3NhZ2VQYW5lbFNlcnZpY2UuVFlQRS5JVEVNU19ERUxFVEVEKSB7XG4gICAgICBzd2l0Y2ggKG1lc3NhZ2VPYmouZGF0YS5pdGVtVHlwZSkge1xuICAgICAgICBjYXNlIEl0ZW0uVFlQRVMuV0FUQ0hJTkc6XG4gICAgICAgICAgaWYgKCFhU2tpcERlbGV0aW5nKSB7XG4gICAgICAgICAgICBQYW5lbFdhdGNoaW5nLmRlbGV0ZUl0ZW1zKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIEl0ZW0uVFlQRVMuV09OOlxuICAgICAgICBjYXNlIEl0ZW0uVFlQRVMuTE9TVDpcbiAgICAgICAgICBQYW5lbEJ1eWluZy5kZWxldGVJdGVtcygpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIEl0ZW0uVFlQRVMuU09MRDpcbiAgICAgICAgY2FzZSBJdGVtLlRZUEVTLlVOU09MRDpcbiAgICAgICAgICBQYW5lbFNlbGxpbmcuZGVsZXRlSXRlbXMoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5fZGlzbWlzc1RpbWVvdXRJZCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2Rpc21pc3NUaW1lb3V0SWQpO1xuICAgICAgdGhpcy5fZGlzbWlzc1RpbWVvdXRJZCA9IG51bGw7XG4gICAgfVxuICAgIE1lc3NhZ2VQYW5lbFNlcnZpY2UuZGlzbWlzc01lc3NhZ2UobWVzc2FnZU9iai50eXBlKTtcbiAgfSxcblxuICAvLyBvbmx5IGV4ZWN1dGUgd2hlbiB0aGUgb2JzZXJ2ZXIgcmVjaWV2ZXMgYSB0b3BpYy5cbiAgX2hpZGUgOiBmdW5jdGlvbigpIHtcbiAgICBpZiAoTWVzc2FnZVBhbmVsU2VydmljZS5nZXRNZXNzYWdlcygpLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuX3Nob3coKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFyIHBhbmVsID0gJChcIiNtZXNzYWdlLXBhbmVsXCIpO1xuICAgICAgaWYgKHBhbmVsLmlzKFwiOnZpc2libGVcIikpIHtcbiAgICAgICAgcGFuZWwuc2xpZGVVcChcImZhc3RcIik7XG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIG9ic2VydmUgOiBmdW5jdGlvbihhVG9waWMsIGFEYXRhKSB7XG4gICAgc3dpdGNoIChhVG9waWMpIHtcbiAgICAgIGNhc2UgVG9waWNzLk1FU1NBR0VfUEFORUxfU0hPVzpcbiAgICAgICAgLy8gdXNlIGRlbGF5IGluaXQgdG8gYXZvaWQgaXNzdWVzIGF0IHN0YXJ0dXBcbiAgICAgICAgaWYgKHRoaXMuX2RlbGF5SW5pdCkge1xuICAgICAgICAgIHRoaXMuX3Nob3coKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgVG9waWNzLk1FU1NBR0VfUEFORUxfRElTTUlTUzpcbiAgICAgICAgLy8gdXNlIGRlbGF5IGluaXQgdG8gYXZvaWQgaXNzdWVzIGF0IHN0YXJ0dXBcbiAgICAgICAgaWYgKHRoaXMuX2RlbGF5SW5pdCkge1xuICAgICAgICAgIHRoaXMuX2hpZGUoKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cbn07XG5cbiQod2luZG93KS51bmxvYWQoZnVuY3Rpb24oKSB7IE1lc3NhZ2VQYW5lbC51bmluaXQoKTsgfSk7XG4iXX0=