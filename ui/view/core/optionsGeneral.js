/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var GeneralPane = {
    _CHECKBOX_PROPERTY_NAMES: [
        "PROP_AUTO_CONNECT",
    ],
    _activeAccount: null,
    _homeSite: null,
    get activeAccount() {
        if (!this._activeAccount) {
            this._activeAccount = Account.getAccount();
        }
        return this._activeAccount;
    },
    get homeSite() {
        var homeSite = null;
        if (!this._homeSite) {
            if (Configs.BROWSER === "sf") {
                homeSite = UtilityHelper.getURLParameter(location.href, PropertyDAO.PROP_HOME_SITE);
            }
            else {
                homeSite = Site.getHomeSite();
            }
            if (homeSite !== null && homeSite != "null") {
                this._homeSite = homeSite;
            }
        }
        return this._homeSite;
    },
    set homeSite(aValue) {
        this._homeSite = aValue;
    },
    init: function () {
        $("[rel^=i18n]").i18n();
        this._populateSites();
        var activeAccount = this.activeAccount;
        if (activeAccount) {
            this._populateProperties();
            this._updateSections(true);
        }
        else {
            this._updateSections(false);
        }
        this._addEventListeners();
        this._toggleSurveyLink();
    },
    _updateSections: function (aSignedIn) {
        if (aSignedIn) {
            $(".general-security-title").show();
            $(".general-security-content-section").show();
        }
        else {
            $(".general-security-title").hide();
            $(".general-security-content-section").hide();
        }
    },
    _populateProperties: function () {
        $.each(this._CHECKBOX_PROPERTY_NAMES, function () {
            $("input[ebayproperty=" + this + "]").prop("checked", PropertyDAO.get(PropertyDAO[this]));
        });
    },
    _populateSites: function () {
        var propValue = PropertyDAO.get(PropertyDAO.PROP_CHOSEN_SITE);
        var list = $("#general-preferred-site-list");
        if (!propValue) {
            list.prop("disabled", true);
            $("#general-auto-detect-site").prop("checked", true);
        }
        this._updateEbaySiteText(propValue);
        list.empty();
        list.append("<option value='' disabled='true'>" + $.i18n.getString("general.country.select") + "</option>");
        var displaySites = [];
        $.each(Configs.ALL_COUNTRIES_DATA, function (aSite, aData) {
            var text = $.i18n.getString("general.country." + aSite.replace(/_/g, "."));
            displaySites.push({ site: aSite, label: text });
        });
        displaySites.sort(function (a, b) {
            var labelA = a.label.toLowerCase();
            var labelB = b.label.toLowerCase();
            if (labelA < labelB) {
                return -1;
            }
            if (labelA > labelB) {
                return 1;
            }
            return 0;
        });
        $.each(displaySites, function (aIndex, aData) {
            list.append("<option value='" + aData.site + "'>" + aData.label + "</option>");
        });
        list.val(propValue);
    },
    setProperty: function (aElement) {
        var element = $(aElement);
        var propName = PropertyDAO[$(aElement).attr("ebayproperty")];
        var propValue;
        if (element.attr("type") != "checkbox") {
            propValue = element.val();
            if (propName == PropertyDAO.PROP_CHOSEN_SITE) {
                this._updateEbaySiteText(propValue);
                if (Configs.BROWSER === "sf") {
                    safari.self.tab.dispatchMessage("resetSelectedTab", null);
                    safari.self.tab.dispatchMessage("forceUpdate", null);
                }
                else {
                    UpdateController.resetForceUpdateTime();
                }
            }
            PropertyDAO.set(propName, propValue);
        }
        else {
            if (propName == PropertyDAO.PROP_CHOSEN_SITE) {
                if (element.prop("checked")) {
                    $("#general-preferred-site-list").prop("disabled", true).val("");
                    propValue = "";
                }
                else {
                    propValue = PropertyDAO.get(PropertyDAO.PROP_CHOSEN_SITE);
                    if (!propValue) {
                        propValue = this.homeSite;
                    }
                    $("#general-preferred-site-list").prop("disabled", false).val(propValue);
                }
                PropertyDAO.set(propName, propValue);
                this._updateEbaySiteText(propValue);
                if (Configs.BROWSER === "sf") {
                    safari.self.tab.dispatchMessage("forceUpdate", null);
                }
                else {
                    UpdateController.resetForceUpdateTime();
                }
            }
            else {
                propValue = element.prop("checked");
                PropertyDAO.set(propName, propValue);
            }
        }
        this._toggleSurveyLink();
    },
    _updateEbaySiteText: function (aPropValue) {
        if (!aPropValue) {
            aPropValue = this.homeSite;
        }
        var flagName = Site.flagForSite(aPropValue);
        $("#general-preferred-site").text($.i18n.getString("general.country." + aPropValue.replace(/_/g, ".")));
        $("#general-preferred-site-flag").attr("src", flagName);
    },
    _addEventListeners: function () {
        $(".general-pane-content .content-section input:checkbox").click(function () {
            GeneralPane.setProperty(this);
        });
        $("#general-preferred-site-list").change(function () {
            GeneralPane.setProperty(this);
        });
        $("#general-feedback-link").click(function (aEvent) {
            if (Configs.BROWSER === "sf") {
                var url = RoverUrlHelper.getUrl({
                    srcAreaName: "preferences", templateName: "appFeedback",
                    homeSite: this.homeSite, activeAccount: this.activeAccount
                });
                window.open(url);
            }
            else {
                RoverUrlHelper.loadPage("appFeedback", "preferences", { forceNewTab: true, }, aEvent);
            }
        }).bind(this);
    },
    _toggleSurveyLink: function () {
        var chosenSite = PropertyDAO.get(PropertyDAO.PROP_CHOSEN_SITE);
        if (!chosenSite || chosenSite.length === 0) {
            chosenSite = this.homeSite;
        }
        if (Site.canDisplaySurvey(chosenSite)) {
            $(".general-feedback-section").show();
        }
        else {
            $(".general-feedback-section").hide();
        }
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3B0aW9uc0dlbmVyYWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi91aS92aWV3L2NvcmUvb3B0aW9uc0dlbmVyYWwuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0dBRUc7QUFLSCxJQUFJLFdBQVcsR0FBRztJQUNoQix3QkFBd0IsRUFBRztRQUN6QixtQkFBbUI7S0FDcEI7SUFDRCxjQUFjLEVBQUcsSUFBSTtJQUNyQixTQUFTLEVBQUcsSUFBSTtJQUVoQixJQUFJLGFBQWE7UUFDZixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLElBQUksQ0FBQyxjQUFjLEdBQUcsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQzdDLENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUM3QixDQUFDO0lBRUQsSUFBSSxRQUFRO1FBQ1YsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUM3QixRQUFRLEdBQUcsYUFBYSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUN0RixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNoQyxDQUFDO1lBRUQsRUFBRSxDQUFDLENBQUMsUUFBUSxLQUFLLElBQUksSUFBSSxRQUFRLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDNUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUM7WUFDNUIsQ0FBQztRQUNILENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSxD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RCxpQkFBaUIsRUFBRztRQUVsQixJQUFJLFVBQVUsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQy9ELEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxJQUFJLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUM3QixDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0QyxDQUFDLENBQUMsMkJBQTJCLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN4QyxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixDQUFDLENBQUMsMkJBQTJCLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN4QyxDQUFDO0lBQ0gsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIENvcHlyaWdodCAoQykgMjAwNy0yMDE1IGVCYXkgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICovXG5cbi8qKlxuICogR2VuZXJhbCBQYW5lIENsYXNzLlxuICovXG52YXIgR2VuZXJhbFBhbmUgPSB7XG4gIF9DSEVDS0JPWF9QUk9QRVJUWV9OQU1FUyA6IFtcbiAgICBcIlBST1BfQVVUT19DT05ORUNUXCIsXG4gIF0sXG4gIF9hY3RpdmVBY2NvdW50IDogbnVsbCxcbiAgX2hvbWVTaXRlIDogbnVsbCxcblxuICBnZXQgYWN0aXZlQWNjb3VudCgpIHtcbiAgICBpZiAoIXRoaXMuX2FjdGl2ZUFjY291bnQpIHtcbiAgICAgIHRoaXMuX2FjdGl2ZUFjY291bnQgPSBBY2NvdW50LmdldEFjY291bnQoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fYWN0aXZlQWNjb3VudDtcbiAgfSxcblxuICBnZXQgaG9tZVNpdGUoKSB7XG4gICAgdmFyIGhvbWVTaXRlID0gbnVsbDtcbiAgICBpZiAoIXRoaXMuX2hvbWVTaXRlKSB7XG4gICAgICBpZiAoQ29uZmlncy5CUk9XU0VSID09PSBcInNmXCIpIHtcbiAgICAgICAgaG9tZVNpdGUgPSBVdGlsaXR5SGVscGVyLmdldFVSTFBhcmFtZXRlcihsb2NhdGlvbi5ocmVmLCBQcm9wZXJ0eURBTy5QUk9QX0hPTUVfU0lURSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBob21lU2l0ZSA9IFNpdGUuZ2V0SG9tZVNpdGUoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGhvbWVTaXRlICE9PSBudWxsICYmIGhvbWVTaXRlICE9IFwibnVsbFwiKSB7XG4gICAgICAgIHRoaXMuX2hvbWVTaXRlID0gaG9tZVNpdGU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX2hvbWVTaXRlO1xuICB9LFxuXG4gIHNldCBob21lU2l0ZShhVmFsdWUpIHtcbiAgICB0aGlzLl9ob21lU2l0ZSA9IGFWYWx1ZTtcbiAgfSxcbiAgLyoqXG4gICAqIEluaXRpYWxpemVzIHRoZSBvYmplY3QuXG4gICAqL1xuICBpbml0IDogZnVuY3Rpb24oKSB7XG4gICAgXG4gICAgLy8gc2V0IHRoZSBsb2NhbGUgYW5kIGFwcGx5IHRoZW0gdG8gdGhlIHJlbGV2YW50IG5vZGVzLlxuICAgICQoXCJbcmVsXj1pMThuXVwiKS5pMThuKCk7XG5cbiAgICB0aGlzLl9wb3B1bGF0ZVNpdGVzKCk7XG5cbiAgICB2YXIgYWN0aXZlQWNjb3VudCA9IHRoaXMuYWN0aXZlQWNjb3VudDtcbiAgICBpZiAoYWN0aXZlQWNjb3VudCkge1xuICAgICAgdGhpcy5fcG9wdWxhdGVQcm9wZXJ0aWVzKCk7XG4gICAgICB0aGlzLl91cGRhdGVTZWN0aW9ucyh0cnVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fdXBkYXRlU2VjdGlvbnMoZmFsc2UpO1xuICAgIH1cbiAgICB0aGlzLl9hZGRFdmVudExpc3RlbmVycygpO1xuXG4gICAgdGhpcy5fdG9nZ2xlU3VydmV5TGluaygpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBTaG93IGFuZCBoaWRlIHNlY3Rpb25zIGJhc2VkIG9uIHNpZ25lZCBpbiBzdGF0ZS5cbiAgICovXG4gIF91cGRhdGVTZWN0aW9ucyA6IGZ1bmN0aW9uKGFTaWduZWRJbikge1xuICAgIFxuICAgIGlmIChhU2lnbmVkSW4pIHtcbiAgICAgICQoXCIuZ2VuZXJhbC1zZWN1cml0eS10aXRsZVwiKS5zaG93KCk7XG4gICAgICAkKFwiLmdlbmVyYWwtc2VjdXJpdHktY29udGVudC1zZWN0aW9uXCIpLnNob3coKTtcbiAgICB9IGVsc2Uge1xuICAgICAgJChcIi5nZW5lcmFsLXNlY3VyaXR5LXRpdGxlXCIpLmhpZGUoKTtcbiAgICAgICQoXCIuZ2VuZXJhbC1zZWN1cml0eS1jb250ZW50LXNlY3Rpb25cIikuaGlkZSgpO1xuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICogUG9wdWxhdGVzIHByb3BlcnRpZXMuXG4gICAqL1xuICBfcG9wdWxhdGVQcm9wZXJ0aWVzIDogZnVuY3Rpb24oKSB7XG4gICAgXG4gICAgJC5lYWNoKHRoaXMuX0NIRUNLQk9YX1BST1BFUlRZX05BTUVTLCBmdW5jdGlvbigpIHtcbiAgICAgICQoXCJpbnB1dFtlYmF5cHJvcGVydHk9XCIgKyB0aGlzICsgXCJdXCIpLnByb3AoXG4gICAgICAgIFwiY2hlY2tlZFwiLCBQcm9wZXJ0eURBTy5nZXQoUHJvcGVydHlEQU9bdGhpc10pKTtcbiAgICB9KTtcbiAgfSxcblxuICAvKipcbiAgICogUG9wdWxhdGVzIHRoZSBwcmVmZXJyZWQtc2l0ZSBkcm9wZG93biBib3guXG4gICAqL1xuICBfcG9wdWxhdGVTaXRlcyA6IGZ1bmN0aW9uKCkge1xuICAgIFxuICAgIHZhciBwcm9wVmFsdWUgPSBQcm9wZXJ0eURBTy5nZXQoUHJvcGVydHlEQU8uUFJPUF9DSE9TRU5fU0lURSk7XG4gICAgdmFyIGxpc3QgPSAkKFwiI2dlbmVyYWwtcHJlZmVycmVkLXNpdGUtbGlzdFwiKTtcblxuICAgIGlmICghcHJvcFZhbHVlKSB7XG4gICAgICBsaXN0LnByb3AoXCJkaXNhYmxlZFwiLCB0cnVlKTtcbiAgICAgICQoXCIjZ2VuZXJhbC1hdXRvLWRldGVjdC1zaXRlXCIpLnByb3AoXCJjaGVja2VkXCIsIHRydWUpO1xuICAgIH1cbiAgICB0aGlzLl91cGRhdGVFYmF5U2l0ZVRleHQocHJvcFZhbHVlKTtcblxuICAgIGxpc3QuZW1wdHkoKTtcbiAgICBsaXN0LmFwcGVuZChcIjxvcHRpb24gdmFsdWU9JycgZGlzYWJsZWQ9J3RydWUnPlwiICsgJC5pMThuLmdldFN0cmluZyhcImdlbmVyYWwuY291bnRyeS5zZWxlY3RcIikgKyBcIjwvb3B0aW9uPlwiKTtcblxuICAgIHZhciBkaXNwbGF5U2l0ZXMgPSBbXTtcbiAgICAvLyBzb3J0IHRoZSBzaXRlcyBieSBsYWJlbHNcbiAgICAkLmVhY2goQ29uZmlncy5BTExfQ09VTlRSSUVTX0RBVEEsIGZ1bmN0aW9uKGFTaXRlLCBhRGF0YSkge1xuICAgICAgdmFyIHRleHQgPSAkLmkxOG4uZ2V0U3RyaW5nKFwiZ2VuZXJhbC5jb3VudHJ5LlwiICsgYVNpdGUucmVwbGFjZSgvXy9nLFwiLlwiKSk7XG4gICAgICBkaXNwbGF5U2l0ZXMucHVzaCh7IHNpdGU6IGFTaXRlLCBsYWJlbDogdGV4dCB9KTtcbiAgICB9KTtcbiAgICBkaXNwbGF5U2l0ZXMuc29ydChmdW5jdGlvbihhLCBiKSB7XG4gICAgIHZhciBsYWJlbEEgPSBhLmxhYmVsLnRvTG93ZXJDYXNlKCk7XG4gICAgIHZhciBsYWJlbEIgPSBiLmxhYmVsLnRvTG93ZXJDYXNlKCk7XG4gICAgIGlmIChsYWJlbEEgPCBsYWJlbEIpIHsgLy9zb3J0IHN0cmluZyBhc2NlbmRpbmdcbiAgICAgICByZXR1cm4gLTE7XG4gICAgIH1cbiAgICAgaWYgKGxhYmVsQSA+IGxhYmVsQikge1xuICAgICAgIHJldHVybiAxO1xuICAgICB9XG4gICAgIHJldHVybiAwOyAvL2RlZmF1bHQgcmV0dXJuIHZhbHVlIChubyBzb3J0aW5nKVxuICAgIH0pO1xuICAgICQuZWFjaChkaXNwbGF5U2l0ZXMsIGZ1bmN0aW9uKGFJbmRleCwgYURhdGEpIHtcbiAgICAgIGxpc3QuYXBwZW5kKFwiPG9wdGlvbiB2YWx1ZT0nXCIgKyBhRGF0YS5zaXRlICsgXCInPlwiICsgYURhdGEubGFiZWwgKyBcIjwvb3B0aW9uPlwiKTtcbiAgICB9KTtcblxuICAgIC8vIHNlbGVjdCB0aGUgc3RvcmVkIG9wdGlvbi5cbiAgICBsaXN0LnZhbChwcm9wVmFsdWUpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBTZXRzIHByb3BlcnR5LlxuICAgKiBAcGFyYW0gYUVsZW1lbnQgdGhlIGVsZW1lbnQuXG4gICAqL1xuICBzZXRQcm9wZXJ0eSA6IGZ1bmN0aW9uKGFFbGVtZW50KSB7XG4gICAgXG4gICAgdmFyIGVsZW1lbnQgPSAkKGFFbGVtZW50KTtcbiAgICB2YXIgcHJvcE5hbWUgPSBQcm9wZXJ0eURBT1skKGFFbGVtZW50KS5hdHRyKFwiZWJheXByb3BlcnR5XCIpXTtcbiAgICB2YXIgcHJvcFZhbHVlO1xuXG4gICAgaWYgKGVsZW1lbnQuYXR0cihcInR5cGVcIikgIT0gXCJjaGVja2JveFwiKSB7XG4gICAgICBwcm9wVmFsdWUgPSBlbGVtZW50LnZhbCgpO1xuICAgICAgaWYgKHByb3BOYW1lID09IFByb3BlcnR5REFPLlBST1BfQ0hPU0VOX1NJVEUpIHtcbiAgICAgICAgdGhpcy5fdXBkYXRlRWJheVNpdGVUZXh0KHByb3BWYWx1ZSk7XG4gICAgICAgIC8vIHJlc2V0IGZvcmNlIHVwZGF0ZSB0aW1lIHNvIHRoZSBsaXN0IGdldHMgdXBkYXRlIHdoZW4gdGhlIGFwcCB3aW5kb3cgaXMgb3BlblxuICAgICAgICBpZiAoQ29uZmlncy5CUk9XU0VSID09PSBcInNmXCIpIHtcbiAgICAgICAgICBzYWZhcmkuc2VsZi50YWIuZGlzcGF0Y2hNZXNzYWdlKFwicmVzZXRTZWxlY3RlZFRhYlwiLCBudWxsKTtcbiAgICAgICAgICBzYWZhcmkuc2VsZi50YWIuZGlzcGF0Y2hNZXNzYWdlKFwiZm9yY2VVcGRhdGVcIiwgbnVsbCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgVXBkYXRlQ29udHJvbGxlci5yZXNldEZvcmNlVXBkYXRlVGltZSgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBQcm9wZXJ0eURBTy5zZXQocHJvcE5hbWUsIHByb3BWYWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChwcm9wTmFtZSA9PSBQcm9wZXJ0eURBTy5QUk9QX0NIT1NFTl9TSVRFKSB7XG4gICAgICAgIGlmIChlbGVtZW50LnByb3AoXCJjaGVja2VkXCIpKSB7XG4gICAgICAgICAgJChcIiNnZW5lcmFsLXByZWZlcnJlZC1zaXRlLWxpc3RcIikucHJvcChcImRpc2FibGVkXCIsIHRydWUpLnZhbChcIlwiKTtcbiAgICAgICAgICBwcm9wVmFsdWUgPSBcIlwiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHByb3BWYWx1ZSA9IFByb3BlcnR5REFPLmdldChQcm9wZXJ0eURBTy5QUk9QX0NIT1NFTl9TSVRFKTtcbiAgICAgICAgICBpZiAoIXByb3BWYWx1ZSkge1xuICAgICAgICAgICAgcHJvcFZhbHVlID0gdGhpcy5ob21lU2l0ZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAkKFwiI2dlbmVyYWwtcHJlZmVycmVkLXNpdGUtbGlzdFwiKS5wcm9wKFwiZGlzYWJsZWRcIiwgZmFsc2UpLnZhbChwcm9wVmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIFByb3BlcnR5REFPLnNldChwcm9wTmFtZSwgcHJvcFZhbHVlKTtcbiAgICAgICAgdGhpcy5fdXBkYXRlRWJheVNpdGVUZXh0KHByb3BWYWx1ZSk7XG4gICAgICAgIC8vIHJlc2V0IGZvcmNlIHVwZGF0ZSB0aW1lIHNvIHRoZSBsaXN0IGdldHMgdXBkYXRlIHdoZW4gdGhlIGFwcCB3aW5kb3cgaXMgb3BlblxuICAgICAgICBpZiAoQ29uZmlncy5CUk9XU0VSID09PSBcInNmXCIpIHtcbiAgICAgICAgICBzYWZhcmkuc2VsZi50YWIuZGlzcGF0Y2hNZXNzYWdlKFwiZm9yY2VVcGRhdGVcIiwgbnVsbCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgVXBkYXRlQ29udHJvbGxlci5yZXNldEZvcmNlVXBkYXRlVGltZSgpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwcm9wVmFsdWUgPSBlbGVtZW50LnByb3AoXCJjaGVja2VkXCIpO1xuICAgICAgICBQcm9wZXJ0eURBTy5zZXQocHJvcE5hbWUsIHByb3BWYWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX3RvZ2dsZVN1cnZleUxpbmsoKTtcbiAgfSxcblxuICBfdXBkYXRlRWJheVNpdGVUZXh0IDogZnVuY3Rpb24oYVByb3BWYWx1ZSkge1xuICAgIGlmICghYVByb3BWYWx1ZSkge1xuICAgICAgYVByb3BWYWx1ZSA9IHRoaXMuaG9tZVNpdGU7XG4gICAgfVxuXG4gICAgdmFyIGZsYWdOYW1lID0gU2l0ZS5mbGFnRm9yU2l0ZShhUHJvcFZhbHVlKTtcblxuICAgICQoXCIjZ2VuZXJhbC1wcmVmZXJyZWQtc2l0ZVwiKS50ZXh0KCQuaTE4bi5nZXRTdHJpbmcoXCJnZW5lcmFsLmNvdW50cnkuXCIgKyBhUHJvcFZhbHVlLnJlcGxhY2UoL18vZyxcIi5cIikpKTtcbiAgICAkKFwiI2dlbmVyYWwtcHJlZmVycmVkLXNpdGUtZmxhZ1wiKS5hdHRyKFwic3JjXCIsIGZsYWdOYW1lKTtcbiAgfSxcblxuICBfYWRkRXZlbnRMaXN0ZW5lcnMgOiBmdW5jdGlvbigpIHtcbiAgICAkKFwiLmdlbmVyYWwtcGFuZS1jb250ZW50IC5jb250ZW50LXNlY3Rpb24gaW5wdXQ6Y2hlY2tib3hcIikuY2xpY2soZnVuY3Rpb24oKSB7XG4gICAgICBHZW5lcmFsUGFuZS5zZXRQcm9wZXJ0eSh0aGlzKTtcbiAgICB9KTtcblxuICAgICQoXCIjZ2VuZXJhbC1wcmVmZXJyZWQtc2l0ZS1saXN0XCIpLmNoYW5nZShmdW5jdGlvbigpIHtcbiAgICAgIEdlbmVyYWxQYW5lLnNldFByb3BlcnR5KHRoaXMpO1xuICAgIH0pO1xuXG4gICAgJChcIiNnZW5lcmFsLWZlZWRiYWNrLWxpbmtcIikuY2xpY2soZnVuY3Rpb24oYUV2ZW50KSB7XG4gICAgICBpZiAoQ29uZmlncy5CUk9XU0VSID09PSBcInNmXCIpIHtcbiAgICAgICAgdmFyIHVybCA9IFJvdmVyVXJsSGVscGVyLmdldFVybCh7XG4gICAgICAgICAgc3JjQXJlYU5hbWU6IFwicHJlZmVyZW5jZXNcIiwgdGVtcGxhdGVOYW1lOiBcImFwcEZlZWRiYWNrXCIsXG4gICAgICAgICAgaG9tZVNpdGU6IHRoaXMuaG9tZVNpdGUsIGFjdGl2ZUFjY291bnQ6IHRoaXMuYWN0aXZlQWNjb3VudFxuICAgICAgICB9KTtcbiAgICAgICAgd2luZG93Lm9wZW4odXJsKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIFJvdmVyVXJsSGVscGVyLmxvYWRQYWdlKFwiYXBwRmVlZGJhY2tcIiwgXCJwcmVmZXJlbmNlc1wiLFxuICAgICAgICAgIHtmb3JjZU5ld1RhYjogdHJ1ZSx9LFxuICAgICAgICAgIGFFdmVudCk7XG4gICAgICB9XG4gICAgfSkuYmluZCh0aGlzKTtcbiAgfSxcblxuICBfdG9nZ2xlU3VydmV5TGluayA6IGZ1bmN0aW9uKCkge1xuICAgIC8vWFhYOiBkaXNwbGF5IHRoZSBzdXJ2ZXkgbGluayBvbmx5IGlmIHdlIGFyZSBvbiBFbmdsaXNoIGxhbmd1YWdlLlxuICAgIHZhciBjaG9zZW5TaXRlID0gUHJvcGVydHlEQU8uZ2V0KFByb3BlcnR5REFPLlBST1BfQ0hPU0VOX1NJVEUpO1xuICAgIGlmICghY2hvc2VuU2l0ZSB8fCBjaG9zZW5TaXRlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY2hvc2VuU2l0ZSA9IHRoaXMuaG9tZVNpdGU7XG4gICAgfVxuICAgIGlmIChTaXRlLmNhbkRpc3BsYXlTdXJ2ZXkoY2hvc2VuU2l0ZSkpIHtcbiAgICAgICQoXCIuZ2VuZXJhbC1mZWVkYmFjay1zZWN0aW9uXCIpLnNob3coKTtcbiAgICB9IGVsc2Uge1xuICAgICAgJChcIi5nZW5lcmFsLWZlZWRiYWNrLXNlY3Rpb25cIikuaGlkZSgpO1xuICAgIH1cbiAgfVxufTtcbiJdfQ==