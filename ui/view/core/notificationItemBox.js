/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var NotificationItemBox = {
    _notificationItemBoxTemplate: null,
    MESSAGE_RECEIVED: "MESSAGE_RECEIVED",
    init: function () {
        this._loadNotificationItemBoxTemplate();
    },
    _loadNotificationItemBoxTemplate: function () {
        var that = this;
        $.ajax({
            url: "core/notificationItemBox.html",
            dataType: "text",
            success: function (aData, aStatus) {
                that._notificationItemBoxTemplate = $(aData);
            }
        });
    },
    _getTimeLeftInfo: function (aItem) {
        var timeLabel = "0";
        var endSoon = false;
        var endTime = null;
        var endTimeTimestamp = null;
        var eBayTime = null;
        if (aItem && aItem.subject && aItem.subject.listing && aItem.subject.listing.scheduledEndDate &&
            aItem.subject.listing.scheduledEndDate.value) {
            endTime = aItem.subject.listing.scheduledEndDate.value;
        }
        if (endTime) {
            eBayTime = CommonService.geteBayTime().getTime();
            endTimeTimestamp = UtilityHelper.dateFromIso8601(endTime).getTime();
            timeLeft = Math.max(0, endTimeTimestamp - eBayTime);
            if (timeLeft > 0) {
                if (timeLeft < 1000) {
                    timeLabel = "0";
                }
                else {
                    if (timeLeft < 86400000) {
                        endSoon = true;
                    }
                    timeLabel = UtilityHelper.timeLeftAsString(timeLeft);
                }
            }
            else {
                timeLabel = "0";
            }
        }
        return { label: timeLabel, endSoon: endSoon };
    },
    createNotificationItemBox: function (aNotificationObject) {
        var notificationItemBox = $("<a></a>").attr({
            "href": "#",
            "class": "notification-item-container",
            "data-update-tooltip": "true"
        }).append(this._notificationItemBoxTemplate.clone());
        var notificationURL;
        var shortTitle;
        var actionName;
        var action;
        var group;
        var content;
        notificationItemBox.click(function (aEvent) {
            aEvent.preventDefault();
            var eventLabel = Sidebar.getGATabTrackingName(TabContainer.getDefaultTab());
            EventAnalytics.push({
                key: "SignedInExit",
                action: "ClickItem",
                label: eventLabel
            });
            var notificationContainer = $(aEvent.target).parents(".notification-item-box");
            var notificationObject = notificationItemBox.data("notificationObject");
            var notificationId = notificationObject.notificationId;
            var parameters = {};
            parameters.forceNewTab = true;
            if ($(aEvent.target).closest(".notification-item-close").length > 0) {
                EventAnalytics.push({
                    key: "SignedInExit",
                    action: "ClickSymbanNotification",
                    label: "NotificationDelete"
                });
                notificationContainer.remove();
                SymbanService.removeNotification(notificationId);
            }
            else {
                SymbanService.markNotificationAsRead(notificationId);
                if (notificationObject.name == NotificationItemBox.MESSAGE_RECEIVED) {
                    parameters.msgid =
                        notificationObject.subject.message.messageId;
                    RoverUrlHelper.loadPage("notifications_MSGM2MMSGHDR", "recentAlertClick", parameters, aEvent);
                }
                else {
                    var itemId = notificationObject.subject.listing.listingId;
                    var transactionId = notificationObject.subject.listing.transactionId;
                    var pageName = "notifications_" + notificationObject.mdnsName;
                    var chosenSite = PropertyDAO.get(PropertyDAO.PROP_CHOSEN_SITE);
                    var chosenSiteISO = Site.siteDataForCountries(chosenSite).iso;
                    parameters.itemid = itemId;
                    switch (notificationObject.mdnsName) {
                        case "ITMWON":
                        case "COCMPLT":
                        case "ITMSHPD":
                        case "BOACCPTD":
                        case "COACCPTED":
                            if (transactionId) {
                                parameters.transid = transactionId;
                            }
                            else {
                                parameters.transid = "";
                            }
                            break;
                    }
                    if (notificationObject.mdnsName == "ITMSHPD") {
                        if ($.inArray(chosenSiteISO, ["US", "GB", "DE"]) >= 0) {
                            pageName += "_1";
                        }
                        else {
                            pageName += "_2";
                        }
                    }
                    if (notificationObject.mdnsName == "COCMPLT") {
                        if ($.inArray(chosenSiteISO, ["US", "GB", "DE"]) >= 0 && transactionId) {
                            pageName += "_1";
                        }
                        else {
                            pageName += "_2";
                        }
                    }
                    if (notificationObject.mdnsName == "CNTROFFR" ||
                        notificationObject.mdnsName == "COACCPTED" ||
                        notificationObject.mdnsName == "CODECLND") {
                        if (MyEbayService.getItemFromList(TradingApi.BEST_OFFER_LIST, itemId) !== null) {
                            pageName += "_BUYER";
                        }
                        else {
                            if (MyEbayService.getItemFromList(TradingApi.SELLING_OFFER_LIST, itemId) !== null) {
                                pageName += "_SELLER";
                            }
                        }
                    }
                    if (pageName in Configs.URLS) {
                        RoverUrlHelper.loadPage(pageName, "recentAlertClick", parameters, aEvent);
                    }
                    else {
                        RoverUrlHelper.loadPage("listing2", "recentAlertClick", { "itemid": itemId,
                            "forceNewTab": true
                        }, aEvent);
                    }
                }
            }
        }.bind(this));
        if ("Window" == UtilityHelper.getClient().os) {
            notificationItemBox.focus(function (aEvent) {
                var previousSibling = $(aEvent.target).prev("a");
                if (0 < previousSibling.length) {
                    $(previousSibling[0]).attr("tabindex", "0");
                }
                var nextSibling = $(aEvent.target).next("a");
                if (0 < nextSibling.length) {
                    $(nextSibling[0]).attr("tabindex", "0");
                }
            });
        }
        notificationURL = aNotificationObject.notificationURL ? aNotificationObject.notificationURL : "";
        notificationItemBox.find(".notification-item-image").css("background-image", "url(\"" + notificationURL + "\")");
        shortTitle = aNotificationObject.shortTitle && aNotificationObject.shortTitle.content ?
            aNotificationObject.shortTitle.content : "";
        notificationItemBox.find(".notification-item-title").text(shortTitle);
        actionName = aNotificationObject.action && aNotificationObject.action.name ?
            aNotificationObject.action.name : "";
        notificationItemBox.find(".notification-item-title").addClass(actionName);
        action = aNotificationObject.name ? aNotificationObject.name : "";
        notificationItemBox.find(".notification-item-title").addClass(action);
        group = aNotificationObject.group ? aNotificationObject.group : "";
        notificationItemBox.find(".notification-item-title").addClass(group);
        content = aNotificationObject.content ? aNotificationObject.content : "";
        notificationItemBox.find(".notification-item-description").text(content);
        if (aNotificationObject.name && aNotificationObject.name == NotificationItemBox.MESSAGE_RECEIVED &&
            "undefined" == typeof (aNotificationObject.subject.message.listingId)) {
            notificationItemBox.find(".notification-item-image").addClass("notification-message-image");
        }
        else {
            notificationItemBox.find(".notification-item-image").removeClass("notification-message-image");
        }
        notificationItemBox.data("notificationObject", aNotificationObject);
        if ("status" in aNotificationObject) {
            notificationItemBox.addClass("notification-item-container-" + (aNotificationObject.status).toLowerCase());
        }
        NotificationItemBox.updateTimeLeft(notificationItemBox);
        return notificationItemBox;
    },
    updateTimeLeft: function (aBox) {
        $("[rel^=i18n]").i18n();
        var itemObject = aBox.data("notificationObject");
        var itemTimeLabel = aBox.find(".item-time-label");
        var itemTime = aBox.find(".item-time");
        var timeLeft = this._getTimeLeftInfo(itemObject);
        if (itemObject.mdnsName == "WATCHITM" || itemObject.mdnsName == "OUTBID") {
            if (timeLeft.endSoon) {
                if (!itemTime.hasClass("endSoon")) {
                    itemTime.addClass("endSoon");
                }
            }
            else {
                itemTime.removeClass("endSoon");
            }
            if (timeLeft.label != "0") {
                itemTime.text(timeLeft.label);
                itemTimeLabel.show();
            }
            else {
                itemTime.text("");
                itemTimeLabel.hide();
            }
        }
    }
};
$(document).ready(function () { NotificationItemBox.init(); });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uSXRlbUJveC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3VpL3ZpZXcvY29yZS9ub3RpZmljYXRpb25JdGVtQm94LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBS0gsSUFBSSxtQkFBbUIsR0FBRztJQUN4Qiw0QkFBNEIsRUFBRyxJQUFJO0lBQ25DLGdCQUFnQixFQUFHLGtCQUFrQjtJQUtyQyxJQUFJLEVBQUc7UUFDTCxJQUFJLENBQUMsZ0NBQWdDLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBTUQsZ0NBQWdDLEVBQUc7UUFDakMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDTCxHQUFHLEVBQUUsK0JBQStCO1lBQ3BDLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLE9BQU8sRUFBRSxVQUFTLEtBQUssRUFBRSxPQUFPO2dCQUM5QixJQUFJLENBQUMsNEJBQTRCLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQy9DLENBQUM7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsZ0JBQWdCLEVBQUcsVUFBUyxLQUFLO1FBRS9CLElBQUksU0FBUyxHQUFHLEdBQUcsQ0FBQztRQUNwQixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDcEIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ25CLElBQUksZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1FBQzVCLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQztRQUVwQixFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0I7WUFDM0YsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZ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TixRQUFRLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2xDLENBQUM7WUFFRCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzFCLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUM5QixhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDdkIsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ2xCLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUN2QixDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFDO0FBRUYsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssQ0FBQyxjQUFhLG1CQUFtQixDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIENvcHlyaWdodCAoQykgMjAwNy0yMDE1IGVCYXkgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICovXG5cbi8qKlxuICogTm90aWZpY2F0aW9uIEJveCBDbGFzcy5cbiAqL1xudmFyIE5vdGlmaWNhdGlvbkl0ZW1Cb3ggPSB7XG4gIF9ub3RpZmljYXRpb25JdGVtQm94VGVtcGxhdGUgOiBudWxsLFxuICBNRVNTQUdFX1JFQ0VJVkVEIDogXCJNRVNTQUdFX1JFQ0VJVkVEXCIsXG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemVzIHRoZSBvYmplY3QuXG4gICAqL1xuICBpbml0IDogZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fbG9hZE5vdGlmaWNhdGlvbkl0ZW1Cb3hUZW1wbGF0ZSgpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBMb2FkcyB0aGUgbm90aWZpY2F0aW9uIGl0ZW0gYm94IHRlbXBsYXRlLCB3aGljaCBpcyBhbiBIVE1MIHRlbXBsYXRlIHRvIGJlXG4gICAqIGZpbGxlZCB3aXRoIHRoZSBjb250ZW50cyBvZiBhIG5vdGlmaWNhdGlvbiBpdGVtLlxuICAgKi9cbiAgX2xvYWROb3RpZmljYXRpb25JdGVtQm94VGVtcGxhdGUgOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgJC5hamF4KHtcbiAgICAgIHVybDogXCJjb3JlL25vdGlmaWNhdGlvbkl0ZW1Cb3guaHRtbFwiLFxuICAgICAgZGF0YVR5cGU6IFwidGV4dFwiLFxuICAgICAgc3VjY2VzczogZnVuY3Rpb24oYURhdGEsIGFTdGF0dXMpIHtcbiAgICAgICAgdGhhdC5fbm90aWZpY2F0aW9uSXRlbUJveFRlbXBsYXRlID0gJChhRGF0YSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sXG5cbiAgX2dldFRpbWVMZWZ0SW5mbyA6IGZ1bmN0aW9uKGFJdGVtKSB7XG4gICAgXG4gICAgdmFyIHRpbWVMYWJlbCA9IFwiMFwiO1xuICAgIHZhciBlbmRTb29uID0gZmFsc2U7XG4gICAgdmFyIGVuZFRpbWUgPSBudWxsO1xuICAgIHZhciBlbmRUaW1lVGltZXN0YW1wID0gbnVsbDtcbiAgICB2YXIgZUJheVRpbWUgPSBudWxsO1xuXG4gICAgaWYgKGFJdGVtICYmIGFJdGVtLnN1YmplY3QgJiYgYUl0ZW0uc3ViamVjdC5saXN0aW5nICYmIGFJdGVtLnN1YmplY3QubGlzdGluZy5zY2hlZHVsZWRFbmREYXRlICYmXG4gICAgICBhSXRlbS5zdWJqZWN0Lmxpc3Rpbmcuc2NoZWR1bGVkRW5kRGF0ZS52YWx1ZSkge1xuICAgICAgZW5kVGltZSA9IGFJdGVtLnN1YmplY3QubGlzdGluZy5zY2hlZHVsZWRFbmREYXRlLnZhbHVlIDtcbiAgICB9XG5cbiAgICBpZiAoZW5kVGltZSkge1xuICAgICAgZUJheVRpbWUgPSBDb21tb25TZXJ2aWNlLmdldGVCYXlUaW1lKCkuZ2V0VGltZSgpO1xuICAgICAgZW5kVGltZVRpbWVzdGFtcCA9IFV0aWxpdHlIZWxwZXIuZGF0ZUZyb21Jc284NjAxKGVuZFRpbWUpLmdldFRpbWUoKTtcbiAgICAgIHRpbWVMZWZ0ID0gTWF0aC5tYXgoMCwgZW5kVGltZVRpbWVzdGFtcCAtIGVCYXlUaW1lKTtcblxuICAgICAgaWYgKHRpbWVMZWZ0ID4gMCkge1xuICAgICAgICBpZiAodGltZUxlZnQgPCAxMDAwKSB7XG4gICAgICAgICAgLy90aW1lTGFiZWwgPSAkLmkxOG4uZ2V0U3RyaW5nKFwiaXRlbS50aW1lbGVmdC5lbmRlZC5sYWJlbFwiKTtcbiAgICAgICAgICB0aW1lTGFiZWwgPSBcIjBcIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodGltZUxlZnQgPCA4NjQwMDAwMCkgeyAvLyBsZXNzIHRoYW4gMjQgaG91cnNcbiAgICAgICAgICAgIGVuZFNvb24gPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aW1lTGFiZWwgPSBVdGlsaXR5SGVscGVyLnRpbWVMZWZ0QXNTdHJpbmcodGltZUxlZnQpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvL3RpbWVMYWJlbCA9ICQuaTE4bi5nZXRTdHJpbmcoXCJpdGVtLnRpbWVsZWZ0LmVuZGVkLmxhYmVsXCIpO1xuICAgICAgICB0aW1lTGFiZWwgPSBcIjBcIjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyBsYWJlbDogdGltZUxhYmVsLCBlbmRTb29uOiBlbmRTb29uIH07XG4gIH0sXG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBub3RpZmljYXRpb24gaXRlbSBib3gsIHdoaWNoIGlzIGFuIERJViBub2RlIHdpdGggdGhlIGNvbnRlbnRzXG4gICAqIG9mIGEgbm90aWZpY2F0aW9uIGl0ZW0uXG4gICAqIEBwYXJhbSBhTm90aWZpY2F0aW9uT2JqZWN0IGEgSlNPTiBvYmplY3QgcmVsYXRlZCB0byBhIG5vdGlmaWNhdGlvbiBpdGVtXG4gICAqIGZyb20gYSBjYWxsIHRvIHRoZSBTeW1iYW4gQXBpLlxuICAgKi9cbiAgY3JlYXRlTm90aWZpY2F0aW9uSXRlbUJveCA6IGZ1bmN0aW9uKGFOb3RpZmljYXRpb25PYmplY3QpIHtcbiAgICB2YXIgbm90aWZpY2F0aW9uSXRlbUJveCA9XG4gICAgICAkKFwiPGE+PC9hPlwiKS5hdHRyKHtcbiAgICAgICAgXCJocmVmXCI6IFwiI1wiLFxuICAgICAgICBcImNsYXNzXCI6IFwibm90aWZpY2F0aW9uLWl0ZW0tY29udGFpbmVyXCIsXG4gICAgICAgIFwiZGF0YS11cGRhdGUtdG9vbHRpcFwiIDogXCJ0cnVlXCJcbiAgICAgIH0pLmFwcGVuZCh0aGlzLl9ub3RpZmljYXRpb25JdGVtQm94VGVtcGxhdGUuY2xvbmUoKSk7XG5cbiAgICB2YXIgbm90aWZpY2F0aW9uVVJMO1xuICAgIHZhciBzaG9ydFRpdGxlO1xuICAgIHZhciBhY3Rpb25OYW1lO1xuICAgIHZhciBhY3Rpb247XG4gICAgdmFyIGdyb3VwO1xuICAgIHZhciBjb250ZW50O1xuXG4gICAgbm90aWZpY2F0aW9uSXRlbUJveC5jbGljayhmdW5jdGlvbihhRXZlbnQpIHtcbiAgICAgIC8vIFByZXZlbnQgU2FmYXJpIGZyb20gc2VuZGluZyBkZWZhdWx0IHJlcXVlc3RzIG9uIGl0ZW0gY2xpY2suXG4gICAgICBhRXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgdmFyIGV2ZW50TGFiZWwgPSBTaWRlYmFyLmdldEdBVGFiVHJhY2tpbmdOYW1lKFRhYkNvbnRhaW5lci5nZXREZWZhdWx0VGFiKCkpO1xuXG4gICAgICBFdmVudEFuYWx5dGljcy5wdXNoKHtcbiAgICAgICAga2V5OiBcIlNpZ25lZEluRXhpdFwiLFxuICAgICAgICBhY3Rpb246IFwiQ2xpY2tJdGVtXCIsXG4gICAgICAgIGxhYmVsOiBldmVudExhYmVsXG4gICAgICB9KTtcblxuICAgICAgdmFyIG5vdGlmaWNhdGlvbkNvbnRhaW5lciA9ICQoYUV2ZW50LnRhcmdldCkucGFyZW50cyhcIi5ub3RpZmljYXRpb24taXRlbS1ib3hcIik7XG4gICAgICB2YXIgbm90aWZpY2F0aW9uT2JqZWN0ID0gbm90aWZpY2F0aW9uSXRlbUJveC5kYXRhKFwibm90aWZpY2F0aW9uT2JqZWN0XCIpO1xuICAgICAgdmFyIG5vdGlmaWNhdGlvbklkID0gbm90aWZpY2F0aW9uT2JqZWN0Lm5vdGlmaWNhdGlvbklkO1xuICAgICAgdmFyIHBhcmFtZXRlcnMgPSB7fTtcblxuICAgICAgLy9sZXQncyBvcGVuIGFsbCB0aGUgbm90aWZpY2F0aW9ucyBpbiBhIG5ldyB0YWIuXG4gICAgICBwYXJhbWV0ZXJzLmZvcmNlTmV3VGFiID0gdHJ1ZTtcblxuICAgICAgaWYgKCQoYUV2ZW50LnRhcmdldCkuY2xvc2VzdChcIi5ub3RpZmljYXRpb24taXRlbS1jbG9zZVwiKS5sZW5ndGggPiAwKSB7XG4gICAgICAgIEV2ZW50QW5hbHl0aWNzLnB1c2goe1xuICAgICAgICAgIGtleTogXCJTaWduZWRJbkV4aXRcIixcbiAgICAgICAgICBhY3Rpb246IFwiQ2xpY2tTeW1iYW5Ob3RpZmljYXRpb25cIixcbiAgICAgICAgICBsYWJlbDogXCJOb3RpZmljYXRpb25EZWxldGVcIlxuICAgICAgICB9KTtcbiAgICAgICAgbm90aWZpY2F0aW9uQ29udGFpbmVyLnJlbW92ZSgpO1xuICAgICAgICBTeW1iYW5TZXJ2aWNlLnJlbW92ZU5vdGlmaWNhdGlvbihub3RpZmljYXRpb25JZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBTeW1iYW5TZXJ2aWNlLm1hcmtOb3RpZmljYXRpb25Bc1JlYWQobm90aWZpY2F0aW9uSWQpO1xuXG4gICAgICAgIGlmIChub3RpZmljYXRpb25PYmplY3QubmFtZSA9PSBOb3RpZmljYXRpb25JdGVtQm94Lk1FU1NBR0VfUkVDRUlWRUQpIHtcbiAgICAgICAgICBwYXJhbWV0ZXJzLm1zZ2lkID1cbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbk9iamVjdC5zdWJqZWN0Lm1lc3NhZ2UubWVzc2FnZUlkO1xuICAgICAgICAgIFJvdmVyVXJsSGVscGVyLmxvYWRQYWdlKFwibm90aWZpY2F0aW9uc19NU0dNMk1NU0dIRFJcIixcbiAgICAgICAgICAgIFwicmVjZW50QWxlcnRDbGlja1wiLCBwYXJhbWV0ZXJzLCBhRXZlbnQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHZhciBpdGVtSWQgPSBub3RpZmljYXRpb25PYmplY3Quc3ViamVjdC5saXN0aW5nLmxpc3RpbmdJZDtcbiAgICAgICAgICB2YXIgdHJhbnNhY3Rpb25JZCA9IG5vdGlmaWNhdGlvbk9iamVjdC5zdWJqZWN0Lmxpc3RpbmcudHJhbnNhY3Rpb25JZDtcbiAgICAgICAgICB2YXIgcGFnZU5hbWUgPSBcIm5vdGlmaWNhdGlvbnNfXCIgKyBub3RpZmljYXRpb25PYmplY3QubWRuc05hbWU7XG4gICAgICAgICAgdmFyIGNob3NlblNpdGUgPSBQcm9wZXJ0eURBTy5nZXQoUHJvcGVydHlEQU8uUFJPUF9DSE9TRU5fU0lURSk7XG4gICAgICAgICAgdmFyIGNob3NlblNpdGVJU08gPSBTaXRlLnNpdGVEYXRhRm9yQ291bnRyaWVzKGNob3NlblNpdGUpLmlzbztcblxuICAgICAgICAgIHBhcmFtZXRlcnMuaXRlbWlkID0gaXRlbUlkO1xuXG4gICAgICAgICAgc3dpdGNoIChub3RpZmljYXRpb25PYmplY3QubWRuc05hbWUpIHtcbiAgICAgICAgICAgIGNhc2UgXCJJVE1XT05cIjpcbiAgICAgICAgICAgIGNhc2UgXCJDT0NNUExUXCI6XG4gICAgICAgICAgICBjYXNlIFwiSVRNU0hQRFwiOlxuICAgICAgICAgICAgLy9idXllclxuICAgICAgICAgICAgY2FzZSBcIkJPQUNDUFREXCI6XG4gICAgICAgICAgICBjYXNlIFwiQ09BQ0NQVEVEXCI6XG4gICAgICAgICAgICAgIGlmICh0cmFuc2FjdGlvbklkKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1ldGVycy50cmFuc2lkID0gdHJhbnNhY3Rpb25JZDtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzLnRyYW5zaWQgPSBcIlwiO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChub3RpZmljYXRpb25PYmplY3QubWRuc05hbWUgPT0gXCJJVE1TSFBEXCIpIHtcbiAgICAgICAgICAgIGlmICgkLmluQXJyYXkoY2hvc2VuU2l0ZUlTTywgW1wiVVNcIiwgXCJHQlwiLCBcIkRFXCJdKSA+PSAwKSB7XG4gICAgICAgICAgICAgIHBhZ2VOYW1lICs9IFwiXzFcIjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHBhZ2VOYW1lICs9IFwiXzJcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAobm90aWZpY2F0aW9uT2JqZWN0Lm1kbnNOYW1lID09IFwiQ09DTVBMVFwiKSB7XG4gICAgICAgICAgICBpZiAoJC5pbkFycmF5KGNob3NlblNpdGVJU08sIFtcIlVTXCIsIFwiR0JcIiwgXCJERVwiXSkgPj0gMCAmJiB0cmFuc2FjdGlvbklkKSB7XG4gICAgICAgICAgICAgIHBhZ2VOYW1lICs9IFwiXzFcIjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHBhZ2VOYW1lICs9IFwiXzJcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAobm90aWZpY2F0aW9uT2JqZWN0Lm1kbnNOYW1lID09IFwiQ05UUk9GRlJcIiB8fFxuICAgICAgICAgICAgbm90aWZpY2F0aW9uT2JqZWN0Lm1kbnNOYW1lID09IFwiQ09BQ0NQVEVEXCIgfHxcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbk9iamVjdC5tZG5zTmFtZSA9PSBcIkNPREVDTE5EXCIpIHtcbiAgICAgICAgICAgIGlmIChNeUViYXlTZXJ2aWNlLmdldEl0ZW1Gcm9tTGlzdChcbiAgICAgICAgICAgICAgVHJhZGluZ0FwaS5CRVNUX09GRkVSX0xJU1QsIGl0ZW1JZCkgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcGFnZU5hbWUgKz0gXCJfQlVZRVJcIjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmIChNeUViYXlTZXJ2aWNlLmdldEl0ZW1Gcm9tTGlzdChcbiAgICAgICAgICAgICAgICBUcmFkaW5nQXBpLlNFTExJTkdfT0ZGRVJfTElTVCwgaXRlbUlkKSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHBhZ2VOYW1lICs9IFwiX1NFTExFUlwiO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHBhZ2VOYW1lIGluIENvbmZpZ3MuVVJMUykge1xuICAgICAgICAgICAgUm92ZXJVcmxIZWxwZXIubG9hZFBhZ2UocGFnZU5hbWUsIFwicmVjZW50QWxlcnRDbGlja1wiLFxuICAgICAgICAgICAgcGFyYW1ldGVycywgYUV2ZW50KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgUm92ZXJVcmxIZWxwZXIubG9hZFBhZ2UoXCJsaXN0aW5nMlwiLCBcInJlY2VudEFsZXJ0Q2xpY2tcIixcbiAgICAgICAgICAgICAgeyBcIml0ZW1pZFwiOiBpdGVtSWQsXG4gICAgICAgICAgICAgICAgXCJmb3JjZU5ld1RhYlwiOiB0cnVlXG4gICAgICAgICAgICAgIH0sIGFFdmVudCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfS5iaW5kKHRoaXMpKTtcblxuICAgIC8vT24gV2luZG93cywgdGhlIHRhYiBmdW5jdGlvbnMgZGlmZmVyZW50IHRoYW4gT1NYLiBXZSB3b3VsZCBuZWVkIHRvIHJlbW92ZSB0aGUgdGFiaW5kZXggaW4gdGhlIHBhcmVudCA8YT4gbm9kZSwgc28gdGhlXG4gICAgLy9jdXJzb3IgZG9lc24ndCBnZXQgc3R1Y2sgb24gdGhlIFggZWxlbWVudCB0byBkZWxldGUgYSBOb3RpZmljYXRpb24uIFRoaXMgcGllY2Ugb2YgY29kZSByZXN0YWJsaXNoZWQgdGhlIHRhYmluZGV4IGF0dHJpYnV0ZVxuICAgIC8vaW4gdGhlIHByZXZpb3VzIGFuZCBuZXh0IHNpbWJsaW5nIGl0ZW0gZWxlbWVudHMgZm9yIHRoZSBjdXJyZW50IGZvY3VzZWQgaXRlbSBlbGVtZW50LlxuICAgIGlmIChcIldpbmRvd1wiID09IFV0aWxpdHlIZWxwZXIuZ2V0Q2xpZW50KCkub3MpIHtcbiAgICAgIG5vdGlmaWNhdGlvbkl0ZW1Cb3guZm9jdXMoZnVuY3Rpb24oYUV2ZW50KSB7XG4gICAgICAgIHZhciBwcmV2aW91c1NpYmxpbmcgPSAkKGFFdmVudC50YXJnZXQpLnByZXYoXCJhXCIpO1xuICAgICAgICBpZiAoMCA8IHByZXZpb3VzU2libGluZy5sZW5ndGgpIHtcbiAgICAgICAgICAkKHByZXZpb3VzU2libGluZ1swXSkuYXR0cihcInRhYmluZGV4XCIsIFwiMFwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBuZXh0U2libGluZyA9ICQoYUV2ZW50LnRhcmdldCkubmV4dChcImFcIik7XG4gICAgICAgIGlmICgwIDwgbmV4dFNpYmxpbmcubGVuZ3RoKSB7XG4gICAgICAgICAgJChuZXh0U2libGluZ1swXSkuYXR0cihcInRhYmluZGV4XCIsIFwiMFwiKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbm90aWZpY2F0aW9uVVJMID0gYU5vdGlmaWNhdGlvbk9iamVjdC5ub3RpZmljYXRpb25VUkwgPyBhTm90aWZpY2F0aW9uT2JqZWN0Lm5vdGlmaWNhdGlvblVSTCA6IFwiXCI7XG4gICAgbm90aWZpY2F0aW9uSXRlbUJveC5maW5kKFwiLm5vdGlmaWNhdGlvbi1pdGVtLWltYWdlXCIpLmNzcyhcbiAgICAgIFwiYmFja2dyb3VuZC1pbWFnZVwiLCBcInVybChcXFwiXCIgKyBub3RpZmljYXRpb25VUkwgKyBcIlxcXCIpXCIpO1xuXG4gICAgc2hvcnRUaXRsZSA9IGFOb3RpZmljYXRpb25PYmplY3Quc2hvcnRUaXRsZSAmJiBhTm90aWZpY2F0aW9uT2JqZWN0LnNob3J0VGl0bGUuY29udGVudCA/XG4gICAgICBhTm90aWZpY2F0aW9uT2JqZWN0LnNob3J0VGl0bGUuY29udGVudCA6IFwiXCI7XG4gICAgbm90aWZpY2F0aW9uSXRlbUJveC5maW5kKFwiLm5vdGlmaWNhdGlvbi1pdGVtLXRpdGxlXCIpLnRleHQoc2hvcnRUaXRsZSk7XG5cbiAgICBhY3Rpb25OYW1lID0gYU5vdGlmaWNhdGlvbk9iamVjdC5hY3Rpb24gJiYgYU5vdGlmaWNhdGlvbk9iamVjdC5hY3Rpb24ubmFtZSA/XG4gICAgICBhTm90aWZpY2F0aW9uT2JqZWN0LmFjdGlvbi5uYW1lIDogXCJcIjtcbiAgICBub3RpZmljYXRpb25JdGVtQm94LmZpbmQoXCIubm90aWZpY2F0aW9uLWl0ZW0tdGl0bGVcIikuYWRkQ2xhc3MoYWN0aW9uTmFtZSk7XG5cbiAgICBhY3Rpb24gPSBhTm90aWZpY2F0aW9uT2JqZWN0Lm5hbWUgPyBhTm90aWZpY2F0aW9uT2JqZWN0Lm5hbWUgOiBcIlwiO1xuICAgIG5vdGlmaWNhdGlvbkl0ZW1Cb3guZmluZChcIi5ub3RpZmljYXRpb24taXRlbS10aXRsZVwiKS5hZGRDbGFzcyhhY3Rpb24pO1xuXG4gICAgZ3JvdXAgPSBhTm90aWZpY2F0aW9uT2JqZWN0Lmdyb3VwID8gYU5vdGlmaWNhdGlvbk9iamVjdC5ncm91cCA6IFwiXCI7XG4gICAgbm90aWZpY2F0aW9uSXRlbUJveC5maW5kKFwiLm5vdGlmaWNhdGlvbi1pdGVtLXRpdGxlXCIpLmFkZENsYXNzKGdyb3VwKTtcblxuICAgIGNvbnRlbnQgPSBhTm90aWZpY2F0aW9uT2JqZWN0LmNvbnRlbnQgPyBhTm90aWZpY2F0aW9uT2JqZWN0LmNvbnRlbnQgOiBcIlwiO1xuICAgIG5vdGlmaWNhdGlvbkl0ZW1Cb3guZmluZChcIi5ub3RpZmljYXRpb24taXRlbS1kZXNjcmlwdGlvblwiKS50ZXh0KGNvbnRlbnQpO1xuXG4gICAgLy9Gb3IgcHJpdmF0ZSBtZXNzYWdlcyByZWxhdGVkIHRvIGFuIGl0ZW0sIGRpc3BsYXkgdGhlIGl0ZW0gaW1hZ2UgYXMgYSBzcXVhcmUuIEZvciBwcml2YXRlIG1lc3NhZ2VzIGZyb20gdXNlciB0byB1c2VyXG4gICAgLy93aXRob3V0IGEgcmVsYXRlZCBpdGVtLCBkaXNwbGF5ZSB0aGUgdXNlcidzIGF2YXRhciBhcyBhIGNpcmNsZS5cbiAgICBpZiAoYU5vdGlmaWNhdGlvbk9iamVjdC5uYW1lICYmIGFOb3RpZmljYXRpb25PYmplY3QubmFtZSA9PSBOb3RpZmljYXRpb25JdGVtQm94Lk1FU1NBR0VfUkVDRUlWRUQgJiZcbiAgICAgIFwidW5kZWZpbmVkXCIgPT0gdHlwZW9mKGFOb3RpZmljYXRpb25PYmplY3Quc3ViamVjdC5tZXNzYWdlLmxpc3RpbmdJZCkpIHtcbiAgICAgIG5vdGlmaWNhdGlvbkl0ZW1Cb3guZmluZChcIi5ub3RpZmljYXRpb24taXRlbS1pbWFnZVwiKS5hZGRDbGFzcyhcbiAgICAgICAgXCJub3RpZmljYXRpb24tbWVzc2FnZS1pbWFnZVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbm90aWZpY2F0aW9uSXRlbUJveC5maW5kKFwiLm5vdGlmaWNhdGlvbi1pdGVtLWltYWdlXCIpLnJlbW92ZUNsYXNzKFxuICAgICAgICBcIm5vdGlmaWNhdGlvbi1tZXNzYWdlLWltYWdlXCIpO1xuICAgIH1cblxuICAgIG5vdGlmaWNhdGlvbkl0ZW1Cb3guZGF0YShcIm5vdGlmaWNhdGlvbk9iamVjdFwiLCBhTm90aWZpY2F0aW9uT2JqZWN0KTtcblxuICAgIC8vIHNldCB0aGUgc3RhdHVzIGFzIGNsYXNzIGZvciBzdHlsaW5nXG4gICAgaWYgKFwic3RhdHVzXCIgaW4gYU5vdGlmaWNhdGlvbk9iamVjdCkge1xuICAgICAgbm90aWZpY2F0aW9uSXRlbUJveC5hZGRDbGFzcyhcbiAgICAgICAgXCJub3RpZmljYXRpb24taXRlbS1jb250YWluZXItXCIgKyAoYU5vdGlmaWNhdGlvbk9iamVjdC5zdGF0dXMpLnRvTG93ZXJDYXNlKCkpO1xuICAgIH1cblxuICAgIE5vdGlmaWNhdGlvbkl0ZW1Cb3gudXBkYXRlVGltZUxlZnQobm90aWZpY2F0aW9uSXRlbUJveCk7XG5cbiAgICByZXR1cm4gbm90aWZpY2F0aW9uSXRlbUJveDtcbiAgfSxcblxuICB1cGRhdGVUaW1lTGVmdCA6IGZ1bmN0aW9uKGFCb3gpIHtcbiAgICBcbiAgICAkKFwiW3JlbF49aTE4bl1cIikuaTE4bigpO1xuICAgIHZhciBpdGVtT2JqZWN0ID0gYUJveC5kYXRhKFwibm90aWZpY2F0aW9uT2JqZWN0XCIpO1xuICAgIHZhciBpdGVtVGltZUxhYmVsID0gYUJveC5maW5kKFwiLml0ZW0tdGltZS1sYWJlbFwiKTtcbiAgICB2YXIgaXRlbVRpbWUgPSBhQm94LmZpbmQoXCIuaXRlbS10aW1lXCIpO1xuICAgIHZhciB0aW1lTGVmdCA9IHRoaXMuX2dldFRpbWVMZWZ0SW5mbyhpdGVtT2JqZWN0KTtcblxuICAgIC8vZGlzcGxheSBvbmx5IHRpbWUgbGVmdCBmb3IgV2F0Y2hpbmcgZW5kaW5nIHNvb24gb3Igb3V0YmlkIG5vdGlmaWNhdGlvbnNcbiAgICBpZiAoaXRlbU9iamVjdC5tZG5zTmFtZSA9PSBcIldBVENISVRNXCIgfHwgaXRlbU9iamVjdC5tZG5zTmFtZSA9PSBcIk9VVEJJRFwiICkge1xuICAgICAgaWYgKHRpbWVMZWZ0LmVuZFNvb24pIHtcbiAgICAgICAgaWYgKCFpdGVtVGltZS5oYXNDbGFzcyhcImVuZFNvb25cIikpIHtcbiAgICAgICAgICBpdGVtVGltZS5hZGRDbGFzcyhcImVuZFNvb25cIik7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGl0ZW1UaW1lLnJlbW92ZUNsYXNzKFwiZW5kU29vblwiKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRpbWVMZWZ0LmxhYmVsICE9IFwiMFwiKSB7XG4gICAgICAgIGl0ZW1UaW1lLnRleHQodGltZUxlZnQubGFiZWwpO1xuICAgICAgICBpdGVtVGltZUxhYmVsLnNob3coKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGl0ZW1UaW1lLnRleHQoXCJcIik7XG4gICAgICAgIGl0ZW1UaW1lTGFiZWwuaGlkZSgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufTtcblxuJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7IE5vdGlmaWNhdGlvbkl0ZW1Cb3guaW5pdCgpOyB9KTtcbiJdfQ==