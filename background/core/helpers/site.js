var Site = {
    openRawURL: function (url, event, forceNewTab) {
        if (event) {
            event.preventDefault();
        }
        if (forceNewTab) {
            UtilityHelper.openLinkIn(url, "tab");
        }
        else {
            var where = UtilityHelper.findWhereToOpenLink(event);
            UtilityHelper.openLinkIn(url, where);
        }
    },
    findSiteBy: function (property, value) {
        var site = null;
        _.each(Configs.SUPPORTED_SITES_DATA, function (currentSite) {
            if (currentSite[property] === value) {
                site = currentSite;
            }
        });
        return site;
    },
    siteDataForSite: function (siteName) {
        return _.get(Configs.SUPPORTED_SITES_DATA, siteName, Configs.SUPPORTED_SITES_DATA["US"]);
    },
    siteDataForCountries: function (siteName) {
        return _.get(Configs.ALL_COUNTRIES_DATA, siteName, Configs.ALL_COUNTRIES_DATA["US"]);
    },
    siteIdForSite: function (siteName) {
        return this.siteDataForCountries(siteName).num;
    },
    siteForLocale: function (locale) {
        var site;
        var lcLocale = locale.toLowerCase();
        site = this.findSiteBy("locale", lcLocale);
        if (!site) {
            var shortLocale = lcLocale.split("-")[0];
            site = this.findSiteBy("locale", shortLocale);
        }
        if (!site) {
            site = Configs.SUPPORTED_SITES_DATA["US"];
        }
        return site;
    },
    getDealsDomain: function () {
        var dealsDomain = "ebay.com";
        var homeSite = this.getHomeSite();
        var siteData = this.siteDataForSite(homeSite);
        if (siteData.eBayDeals) {
            dealsDomain = siteData.domain;
        }
        return dealsDomain;
    },
    siteHasDeals: function () {
        var hasDeals = false;
        var homeSite = this.getHomeSite();
        var siteData = Configs.SUPPORTED_SITES_DATA[homeSite];
        if (siteData) {
            hasDeals = siteData.eBayDeals;
        }
        return hasDeals;
    },
    isSupportedSite: function () {
        var isSupportedSite = false;
        var homeSite = this.getHomeSite();
        if (Configs.SUPPORTED_SITES_DATA[homeSite]) {
            isSupportedSite = true;
        }
        return isSupportedSite;
    },
    addCurrencySymbol: function (value, currency) {
        var homeSite = this.getHomeSite();
        var siteData = this.siteDataForSite(homeSite);
        var nativeCurrency = siteData.currency;
        var ret;
        if (currency === nativeCurrency) {
            var node = document.createElement("div");
            var symbol = void 0;
            node.innerHTML = siteData.currencySymbol;
            symbol = node.innerHTML;
            ret = symbol.replace("*", value);
        }
        else {
            ret = currency + " " + value;
        }
        return ret;
    },
    getGlobalId: function () {
        var globalId;
        var homeSite = this.getHomeSite();
        var site = this.findSiteBy("name", homeSite);
        if (site) {
            globalId = site.globalId;
        }
        else {
            globalId = "EBAY-US";
        }
        return globalId;
    },
    canDisplaySurvey: function (chosenSite) {
        var canDisplaySurvey = false;
        var allowedCountries = ["Australia", "Canada", "US", "UK"];
        if (UtilityHelper.getBrowserLanguage().indexOf("en") === 0 &&
            _.includes(allowedCountries, chosenSite)) {
            canDisplaySurvey = true;
        }
        return canDisplaySurvey;
    },
    flagForSite: function (countryName) {
        var flagName;
        var country = Configs.ALL_COUNTRIES_DATA[countryName];
        if (country) {
            var iso = country.iso.toLowerCase();
            if (BrowserHelper.isRetinaDisplay()) {
                flagName = iso + "-flag@2x.png";
            }
            else {
                flagName = iso + "-flag.png";
            }
        }
        return Configs.FLAGS_LOCATION + flagName;
    },
    getRedirectUrl: function (callback, firstRun) {
        var site = null;
        var templateName = "homePage";
        if (firstRun) {
            templateName = "firstRun";
        }
        var redirect = function (site) {
            var url = RoverUrlHelper.getUrl({
                srcAreaName: "postSignIn",
                templateName: templateName,
                args: { domain: site.domain }
            });
            callback(url);
        };
        var getSite = function (isoCountryCode) {
            if (!_.has(isoCountryCode, "message")) {
                site = Site.findSiteBy("iso", isoCountryCode);
            }
            if (!site) {
                site = Site.siteForLocale(UtilityHelper.getBrowserLanguage());
            }
            if (!site) {
                site = Configs.SUPPORTED_SITES_DATA["US"];
            }
            redirect(site);
        };
        var account = Account.getAccount();
        if (account) {
            var shippingCountry = account.get("shippingCountry");
            if (shippingCountry) {
                site = Site.findSiteBy("iso", shippingCountry);
            }
            if (!site) {
                site = Site.findSiteBy("name", account.get("registrationSite"));
            }
        }
        if (site) {
            redirect(site);
        }
        else {
            AuthenticationService.getApplicationToken(function (token) {
                Location.getLocation(token, Configs)
                    .then(getSite)
                    .catch(function (reason) {
                    console.log(reason);
                });
            });
        }
    },
    getHomeSite: function (includeUnsitedCountry) {
        var siteName = PropertyDAO.get(PropertyDAO.PROP_CHOSEN_SITE);
        if (!siteName) {
            var account_1 = Account.getAccount();
            if (account_1) {
                var shippingCountry = account_1.get("shippingCountry");
                if (shippingCountry) {
                    siteName = this.findSiteBy("iso", shippingCountry).name;
                }
                if (!siteName) {
                    siteName = account_1.get("registrationSite");
                }
            }
            if (!siteName || !Configs.SUPPORTED_SITES_DATA[siteName]) {
                siteName = this.siteForLocale(UtilityHelper.getBrowserLanguage()).name;
            }
        }
        if (!siteName) {
            siteName = "US";
        }
        else {
            if (includeUnsitedCountry) {
                if (!Configs.ALL_COUNTRIES_DATA[siteName]) {
                    siteName = "US";
                }
            }
            else if (!Configs.SUPPORTED_SITES_DATA[siteName]) {
                siteName = "US";
            }
        }
        return siteName;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2l0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2JhY2tncm91bmQvY29yZS9oZWxwZXJzL3NpdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsSUFBTSxJQUFJLEdBQUc7SUFPWCxVQUFVLEVBQUUsVUFBUyxHQUFXLEVBQUUsS0FBVyxFQUFFLFdBQXFCO1FBRWxFLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDVixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDekIsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDaEIsYUFBYSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdkMsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sSUFBSSxLQUFLLEdBQUcsYUFBYSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3JELGFBQWEsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7SUFDSCxDQUFDO0lBUUQsVUFBVSxFQUFFLFVBQVMsUUFBZ0IsRUFBRSxLQUFnQztRQUNyRSxJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFFaEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsb0JBQW9CLEVBQUUsVUFBUyxXQUFXO1lBQ3ZELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNwQyxJQUFJLEdBQUcsV0FBVyxDQUFDO1lBQ3JCLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsZUFBZSxFQUFFLFVBQVMsUUFBZ0I7UUFDeEMsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLG9CQUFvQixFQUFFLFFBQVEs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R0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7Z0JBQzdDLENBQUM7WUFDSCxDQUFDO1lBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLElBQUksQ0FBQyxPQUFPLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN6RCxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUN6RSxDQUFDO1FBQ0gsQ0FBQztRQUlELEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNkLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDbEIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sRUFBRSxDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzFDLFFBQVEsR0FBRyxJQUFJLENBQUM7Z0JBQ2xCLENBQUM7WUFDSCxDQUFDO1lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbkQsUUFBUSxHQUFHLElBQUksQ0FBQztZQUNsQixDQUFDO1FBQ0gsQ0FBQztRQUVELE1BQU0sQ0FBQyxRQUFRLENBQUM7SUFDbEIsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJkZWNsYXJlIGxldCBVdGlsaXR5SGVscGVyOiBhbnk7XG5cblxuY29uc3QgU2l0ZSA9IHtcbiAgLyoqXG4gICAqIE9wZW5zIHRoZSBnaXZlbiBVUkwuXG4gICAqIEBwYXJhbSB1cmwgdGhlIHVybCB0byBiZSBvcGVuZWQuXG4gICAqIEBwYXJhbSBldmVudCB0aGUgZXZlbnQgb2JqZWN0LlxuICAgKiBAcGFyYW0gZm9yY2VOZXdUYWIgdHJ1ZSBpZiBmb3JjZSB0byBvcGVuIGluIGEgbmV3IHRhYi5cbiAgICovXG4gIG9wZW5SYXdVUkw6IGZ1bmN0aW9uKHVybDogc3RyaW5nLCBldmVudD86IGFueSwgZm9yY2VOZXdUYWI/OiBib29sZWFuKTogdm9pZCB7XG5cbiAgICBpZiAoZXZlbnQpIHtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuXG4gICAgaWYgKGZvcmNlTmV3VGFiKSB7XG4gICAgICBVdGlsaXR5SGVscGVyLm9wZW5MaW5rSW4odXJsLCBcInRhYlwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHdoZXJlID0gVXRpbGl0eUhlbHBlci5maW5kV2hlcmVUb09wZW5MaW5rKGV2ZW50KTtcbiAgICAgIFV0aWxpdHlIZWxwZXIub3BlbkxpbmtJbih1cmwsIHdoZXJlKTtcbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqIEZpbmRzIGEgc2l0ZSBzcGVjaWZpZWQgYnkgdGhlIHByb3BlcnR5IGFuZCB0aGUgdmFsdWVcbiAgICogQHBhcmFtIHByb3BlcnR5IHRoZSBwcm9wZXJ0eSB0byBsb29rIGZvci5cbiAgICogQHBhcmFtIHZhbHVlIHRoZSB2YWx1ZSBvZiB0aGUgcHJvcGVydHkuXG4gICAqIEByZXR1cm5zIHNpdGVcbiAgICovXG4gIGZpbmRTaXRlQnk6IGZ1bmN0aW9uKHByb3BlcnR5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuKTogU3VwcG9ydGVkU2l0ZSB8IG51bGwge1xuICAgIGxldCBzaXRlID0gbnVsbDtcblxuICAgIF8uZWFjaChDb25maWdzLlNVUFBPUlRFRF9TSVRFU19EQVRBLCBmdW5jdGlvbihjdXJyZW50U2l0ZSkge1xuICAgICAgaWYgKGN1cnJlbnRTaXRlW3Byb3BlcnR5XSA9PT0gdmFsdWUpIHtcbiAgICAgICAgc2l0ZSA9IGN1cnJlbnRTaXRlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHNpdGU7XG4gIH0sXG5cbiAgc2l0ZURhdGFGb3JTaXRlOiBmdW5jdGlvbihzaXRlTmFtZTogc3RyaW5nKTogU3VwcG9ydGVkU2l0ZSB7XG4gICAgcmV0dXJuIF8uZ2V0KENvbmZpZ3MuU1VQUE9SVEVEX1NJVEVTX0RBVEEsIHNpdGVOYW1lLCBDb25maWdzLlNVUFBPUlRFRF9TSVRFU19EQVRBW1wiVVNcIl0pO1xuICB9LFxuXG4gIHNpdGVEYXRhRm9yQ291bnRyaWVzOiBmdW5jdGlvbihzaXRlTmFtZTogc3RyaW5nKTogU2l0ZSB7XG4gICAgcmV0dXJuIF8uZ2V0KENvbmZpZ3MuQUxMX0NPVU5UUklFU19EQVRBLCBzaXRlTmFtZSwgQ29uZmlncy5BTExfQ09VTlRSSUVTX0RBVEFbXCJVU1wiXSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFByb3ZpZGVzIGEgbnVtZXJpYyBTaXRlSWQgZnJvbSBhIHNpdGUgbmFtZS5cbiAgICogQHBhcmFtIHNpdGVOYW1lIHRoZSBzaXRlIHN0cmluZy5cbiAgICogQHJldHVybiBzaXRlIGlkLlxuICAgKi9cbiAgc2l0ZUlkRm9yU2l0ZTogZnVuY3Rpb24oc2l0ZU5hbWU6IHN0cmluZyk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuc2l0ZURhdGFGb3JDb3VudHJpZXMoc2l0ZU5hbWUpLm51bTtcbiAgfSxcblxuICAvKipcbiAgICogUHJvdmlkZXMgc2l0ZSBmb3IgbG9jYWxlLlxuICAgKiBAcGFyYW0gbG9jYWxlIHRoZSBsb2NhbGUuXG4gICAqIEByZXR1cm4gdGhlIHNpdGUgc3RyaW5nLlxuICAgKi9cbiAgc2l0ZUZvckxvY2FsZTogZnVuY3Rpb24obG9jYWxlOiBzdHJpbmcpOiBTdXBwb3J0ZWRTaXRlIHtcblxuICAgIGxldCBzaXRlO1xuICAgIGxldCBsY0xvY2FsZSA9IGxvY2FsZS50b0xvd2VyQ2FzZSgpO1xuICAgIHNpdGUgPSB0aGlzLmZpbmRTaXRlQnkoXCJsb2NhbGVcIiwgbGNMb2NhbGUpO1xuXG4gICAgaWYgKCFzaXRlKSB7XG4gICAgICAvLyBpZiB0aGF0IGRvZXNuJ3Qgd29yaywgdHJ5IHVzaW5nIHRoZSBmaXJzdCBwYXJ0IG9mIGl0XG4gICAgICBsZXQgc2hvcnRMb2NhbGUgPSBsY0xvY2FsZS5zcGxpdChcIi1cIilbMF07XG4gICAgICBzaXRlID0gdGhpcy5maW5kU2l0ZUJ5KFwibG9jYWxlXCIsIHNob3J0TG9jYWxlKTtcbiAgICB9XG5cbiAgICBpZiAoIXNpdGUpIHtcbiAgICAgIHNpdGUgPSBDb25maWdzLlNVUFBPUlRFRF9TSVRFU19EQVRBW1wiVVNcIl0gYXMgU3VwcG9ydGVkU2l0ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2l0ZTtcbiAgfSxcblxuICBnZXREZWFsc0RvbWFpbjogZnVuY3Rpb24oKTogc3RyaW5nIHtcbiAgICBsZXQgZGVhbHNEb21haW4gPSBcImViYXkuY29tXCI7XG4gICAgbGV0IGhvbWVTaXRlID0gdGhpcy5nZXRIb21lU2l0ZSgpO1xuICAgIGxldCBzaXRlRGF0YSA9IHRoaXMuc2l0ZURhdGFGb3JTaXRlKGhvbWVTaXRlKTtcblxuICAgIGlmIChzaXRlRGF0YS5lQmF5RGVhbHMpIHtcbiAgICAgIGRlYWxzRG9tYWluID0gc2l0ZURhdGEuZG9tYWluO1xuICAgIH1cblxuICAgIHJldHVybiBkZWFsc0RvbWFpbjtcbiAgfSxcblxuICBzaXRlSGFzRGVhbHM6IGZ1bmN0aW9uKCk6IGJvb2xlYW4ge1xuICAgIGxldCBoYXNEZWFscyA9IGZhbHNlO1xuICAgIGxldCBob21lU2l0ZSA9IHRoaXMuZ2V0SG9tZVNpdGUoKTtcbiAgICBsZXQgc2l0ZURhdGEgPSBDb25maWdzLlNVUFBPUlRFRF9TSVRFU19EQVRBW2hvbWVTaXRlXTtcblxuICAgIGlmIChzaXRlRGF0YSkge1xuICAgICAgaGFzRGVhbHMgPSBzaXRlRGF0YS5lQmF5RGVhbHM7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhhc0RlYWxzO1xuICB9LFxuXG4gIGlzU3VwcG9ydGVkU2l0ZTogZnVuY3Rpb24oKTogYm9vbGVhbiB7XG4gICAgbGV0IGlzU3VwcG9ydGVkU2l0ZSA9IGZhbHNlO1xuICAgIGxldCBob21lU2l0ZSA9IHRoaXMuZ2V0SG9tZVNpdGUoKTtcblxuICAgIGlmIChDb25maWdzLlNVUFBPUlRFRF9TSVRFU19EQVRBW2hvbWVTaXRlXSkge1xuICAgICAgaXNTdXBwb3J0ZWRTaXRlID0gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gaXNTdXBwb3J0ZWRTaXRlO1xuICB9LFxuXG4gIC8qKlxuICAgKiBHaXZlbiBhIG1vbmV0YXJ5IHZhbHVlIGFuZCBpdHMgYXNzb2NpYXRlZCBjdXJyZW5jeSBJRCwgcmV0dXJuIGEgc3RyaW5nXG4gICAqIHRoYXQgd2lsbCBtYWtlIHNlbnNlIHRvIHRoZSB1c2VyLiAgRm9yIGluc3RhbmNlLCBhIFVLIHVzZXIgbWlnaHQgc2VlIFwiwqMxMFwiLFxuICAgKiB3aGVyZWFzIGEgVVMgdXNlciB3b3VsZCBzZWUgXCJHQlAgMTBcIi5cbiAgICogQHBhcmFtIHZhbHVlIHRoZSB2YWx1ZS5cbiAgICogQHBhcmFtIGN1cnJlbmN5IHRoZSBjdXJyZW5jeS5cbiAgICogQHJldHVybiBjdXJyZW5jeSBzeW1ib2wuXG4gICAqL1xuICBhZGRDdXJyZW5jeVN5bWJvbDogZnVuY3Rpb24odmFsdWU6IHN0cmluZywgY3VycmVuY3k6IHN0cmluZyk6IHN0cmluZyB7XG5cbiAgICBsZXQgaG9tZVNpdGUgPSB0aGlzLmdldEhvbWVTaXRlKCk7XG4gICAgbGV0IHNpdGVEYXRhID0gdGhpcy5zaXRlRGF0YUZvclNpdGUoaG9tZVNpdGUpO1xuICAgIGxldCBuYXRpdmVDdXJyZW5jeSA9IHNpdGVEYXRhLmN1cnJlbmN5O1xuICAgIGxldCByZXQ7XG5cbiAgICBpZiAoY3VycmVuY3kgPT09IG5hdGl2ZUN1cnJlbmN5KSB7XG4gICAgICAvLyByZXBsYWNlIHRoZSBwbGFjZWhvbGRlciB3aXRoIHRoZSBnaXZlbiB2YWx1ZVxuICAgICAgLy8gWFhYIDogbmVlZCB0byBjb252ZXJ0IHRoZSB1bmljb2RlIGNoYXIgdG8gdGhlIHN5bWJvbCBmaXJzdC5cbiAgICAgIGxldCBub2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgIGxldCBzeW1ib2w7XG5cbiAgICAgIG5vZGUuaW5uZXJIVE1MID0gc2l0ZURhdGEuY3VycmVuY3lTeW1ib2w7XG4gICAgICBzeW1ib2wgPSBub2RlLmlubmVySFRNTDtcbiAgICAgIHJldCA9IHN5bWJvbC5yZXBsYWNlKFwiKlwiLCB2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldCA9IGN1cnJlbmN5ICsgXCIgXCIgKyB2YWx1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmV0O1xuICB9LFxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBnbG9iYWwgaWQuXG4gICAqIEByZXR1cm4gdGhlIGdsb2JhbCBpZC5cbiAgICovXG4gIGdldEdsb2JhbElkOiBmdW5jdGlvbigpOiBzdHJpbmcge1xuICAgIGxldCBnbG9iYWxJZDtcbiAgICBsZXQgaG9tZVNpdGUgPSB0aGlzLmdldEhvbWVTaXRlKCk7XG5cbiAgICBsZXQgc2l0ZSA9IHRoaXMuZmluZFNpdGVCeShcIm5hbWVcIiwgaG9tZVNpdGUpO1xuICAgIGlmIChzaXRlKSB7XG4gICAgICBnbG9iYWxJZCA9IHNpdGUuZ2xvYmFsSWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGdsb2JhbElkID0gXCJFQkFZLVVTXCI7XG4gICAgfVxuXG4gICAgcmV0dXJuIGdsb2JhbElkO1xuICB9LFxuXG4gIC8qKlxuICAgKiBEZXRlcm1pbmVzIGlmIHdlIGNhbiBkaXNwbGF5IHRoZSBzdXJ2ZXkgbGlua3MgYmFzZWQgb246XG4gICAqIC0gdGhlIENocm9tZSBCcm93c2VyIGFuZCB0aGUgZXh0ZW5zaW9uIFVJIGFuZFxuICAgKiAtIHRoZSBzZWxlY3RlZCBlQmF5IGNvdW50cnlcbiAgICovXG4gIGNhbkRpc3BsYXlTdXJ2ZXk6IGZ1bmN0aW9uKGNob3NlblNpdGU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGxldCBjYW5EaXNwbGF5U3VydmV5ID0gZmFsc2U7XG4gICAgbGV0IGFsbG93ZWRDb3VudHJpZXMgPSBbXCJBdXN0cmFsaWFcIiwgXCJDYW5hZGFcIiwgXCJVU1wiLCBcIlVLXCJdO1xuXG4gICAgaWYgKFV0aWxpdHlIZWxwZXIuZ2V0QnJvd3Nlckxhbmd1YWdlKCkuaW5kZXhPZihcImVuXCIpID09PSAwICYmXG4gICAgICBfLmluY2x1ZGVzKGFsbG93ZWRDb3VudHJpZXMsIGNob3NlblNpdGUpKSB7XG4gICAgICBjYW5EaXNwbGF5U3VydmV5ID0gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2FuRGlzcGxheVN1cnZleTtcbiAgfSxcblxuICBmbGFnRm9yU2l0ZTogZnVuY3Rpb24oY291bnRyeU5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgbGV0IGZsYWdOYW1lO1xuICAgIGxldCBjb3VudHJ5ID0gQ29uZmlncy5BTExfQ09VTlRSSUVTX0RBVEFbY291bnRyeU5hbWVdO1xuXG4gICAgaWYgKGNvdW50cnkpIHtcbiAgICAgIGxldCBpc28gPSBjb3VudHJ5Lmlzby50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICBpZiAoQnJvd3NlckhlbHBlci5pc1JldGluYURpc3BsYXkoKSkge1xuICAgICAgICBmbGFnTmFtZSA9IGlzbyArIFwiLWZsYWdAMngucG5nXCI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmbGFnTmFtZSA9IGlzbyArIFwiLWZsYWcucG5nXCI7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIENvbmZpZ3MuRkxBR1NfTE9DQVRJT04gKyBmbGFnTmFtZTtcbiAgfSxcblxuICAvKipcbiAgICogR2V0cyBhIHJlZGlyZWN0IFVSTCBhZnRlciB0aGUgdXNlciBoYXMgc2lnbmVkIGluIG9yIGFmdGVyIHRoZSBmaXJzdCBpbnN0YWxsLiBUaGUgcmVkaXJlY3QgVVJMXG4gICAqIHdpbGwgYmUgZGV0ZXJtaW5lZCBieTpcbiAgICogMS4gR2V0IHRoZSByZWRpcmVjdCBzaXRlIGZyb20gdGhlIHVzZXIncyBzaGlwcGluZyBjb3VudHJ5LiBJZiB0aGVyZSdzIG5vIHNoaXBwaW5nIGNvdW50cnkgb24gdGhlIHVzZXIncyBpbmZvLCB0aGVuXG4gICAqIDIuIEdldCB0aGUgcmVkaXJlY3Qgc2l0ZSBmcm9tIHRoZSB1c2VyJ3MgcmVnaXN0ZXJlZCBzaXRlLiBJZiB0aGVyZSdzIG5vIHJlZ2lzdGVyZWQgc2l0ZSBvbiB0aGUgdXNlcidzIGluZm8sIHRoZW5cbiAgICogMy4gR2V0IHRoZSB1c2VyJ3MgSVAgbG9jYXRpb24gdG8gZ2V0IHRoZSByZWRpcmVjdCBzaXRlLiBJZiB3ZSBjYW4ndCBnZXQgdGhlIHVzZXIncyBsb2NhdGlvbiB2aWEgSVAgYWRkcmVzc1xuICAgKiBvciB0aGUgc2l0ZSB3aGVyZSB0aGUgdXNlciBpcyBpbiBpcyBhbiB1bi1zaXRlZCBjb3VudHJ5IChmb3IgZXhhbXBsZSwgaWYgdGhlIHVzZXIgaXMgaW4gQ29zdGEgUmljYSksIHRoZW5cbiAgICogNC4gR2V0IHRoZSBicm93c2VyIGxhbmd1YWdlIHRvIGdldCB0aGUgcmVkaXJlY3Qgc2l0ZS4gSW4gY2FzZSB3ZSBhcmUgbm90IGFibGUgdG8gZ2V0IHRoZSBzaXRlIHJlbGF0ZWQgdG8gdGhlIHVzZXIncyBicm93c2VyIGxhbmd1YWdlLCB0aGVuXG4gICAqIDUuIFVzZSBVUyBhcyB0aGUgZGVmYXVsdCBzaXRlXG4gICAqIElmIHRoZSB1c2VyIGhhcyBqdXN0IGluc3RhbGxlZCB0aGUgZXh0ZW5zaW9uLCB0aGVuIHRoZSBsb2dpYyB3aWxsIHBlcmZvcm0gZnJvbSBzdGVwcyAzIHRvIDUgKHNpZ25lZCBvdXQgaGllcmFyY2h5KS5cbiAgICogSWYgdGhlIHVzZXIgaXMgc2lnbmluZyBpbiwgdGhlbiB0aGUgbG9naWMgd2lsbCBwZXJmb3JtIGZyb20gc3RlcHMgMSB0byA1IChzaWduZWQgaW4gaGllcmFyY2h5KS5cbiAgICogQHBhcmFtIGNhbGxiYWNrIHRoZSBjYWxsYmFjayB0byBjYWxsIGFmdGVyIGRldGVybWluaW5nIHdoaWNoIGlzIHRoZSB1cmwgdG8gcmVkaXJlY3QgdGhlIHVzZXIuXG4gICAqIEBwYXJhbSBmaXJzdFJ1biBpbmRpY2F0ZXMgaWYgdGhpcyBpcyB0aGUgZmlyc3QgZXh0ZW5zaW9uIHVzZSAoYWZ0ZXIgdGhlIGZpcnN0IGluc3RhbGwpLlxuICAgKi9cbiAgZ2V0UmVkaXJlY3RVcmw6IGZ1bmN0aW9uKGNhbGxiYWNrOiAodXJsOiBzdHJpbmcpID0+IHZvaWQsIGZpcnN0UnVuOiBib29sZWFuKTogdm9pZCB7XG4gICAgbGV0IHNpdGU6IFN1cHBvcnRlZFNpdGUgfCBudWxsID0gbnVsbDtcbiAgICBsZXQgdGVtcGxhdGVOYW1lID0gXCJob21lUGFnZVwiO1xuXG4gICAgaWYgKGZpcnN0UnVuKSB7XG4gICAgICB0ZW1wbGF0ZU5hbWUgPSBcImZpcnN0UnVuXCI7XG4gICAgfVxuXG4gICAgbGV0IHJlZGlyZWN0ID0gZnVuY3Rpb24oc2l0ZTogU3VwcG9ydGVkU2l0ZSk6IHZvaWQge1xuICAgICAgbGV0IHVybCA9IFJvdmVyVXJsSGVscGVyLmdldFVybCh7XG4gICAgICAgIHNyY0FyZWFOYW1lOiBcInBvc3RTaWduSW5cIixcbiAgICAgICAgdGVtcGxhdGVOYW1lOiB0ZW1wbGF0ZU5hbWUsXG4gICAgICAgIGFyZ3M6IHsgZG9tYWluOiBzaXRlLmRvbWFpbiB9XG4gICAgICB9KTtcblxuICAgICAgY2FsbGJhY2sodXJsKTtcbiAgICB9O1xuXG4gICAgbGV0IGdldFNpdGUgPSBmdW5jdGlvbihpc29Db3VudHJ5Q29kZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAvLyBJZiBpdCBoYXMgYSBtZXNzYWdlLCBpdCdzIGFuIGV4Y2VwdGlvblxuICAgICAgaWYgKCFfLmhhcyhpc29Db3VudHJ5Q29kZSwgXCJtZXNzYWdlXCIpKSB7XG4gICAgICAgIHNpdGUgPSBTaXRlLmZpbmRTaXRlQnkoXCJpc29cIiwgaXNvQ291bnRyeUNvZGUpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXNpdGUpIHtcbiAgICAgICAgLy8gNC4gR2V0IHRoZSBzaXRlIGZyb20gdGhlIGJyb3dzZXIgbGFuZ3VhZ2VcbiAgICAgICAgc2l0ZSA9IFNpdGUuc2l0ZUZvckxvY2FsZShVdGlsaXR5SGVscGVyLmdldEJyb3dzZXJMYW5ndWFnZSgpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFzaXRlKSB7XG4gICAgICAgIC8vIDUuIFVzZSBVUyBhcyB0aGUgZGVmYXVsdCBzaXRlO1xuICAgICAgICBzaXRlID0gQ29uZmlncy5TVVBQT1JURURfU0lURVNfREFUQVtcIlVTXCJdIGFzIFN1cHBvcnRlZFNpdGU7XG4gICAgICB9XG5cbiAgICAgIHJlZGlyZWN0KHNpdGUpO1xuICAgIH07XG5cbiAgICBsZXQgYWNjb3VudCA9IChBY2NvdW50IGFzIGFueSkuZ2V0QWNjb3VudCgpO1xuICAgIGlmIChhY2NvdW50KSB7XG4gICAgICAvLyAxLiBHZXQgdGhlIHNpdGUgZnJvbSB0aGUgdXNlcidzIHNoaXBwaW5nIGNvdW50cnlcbiAgICAgIGxldCBzaGlwcGluZ0NvdW50cnkgPSBhY2NvdW50LmdldChcInNoaXBwaW5nQ291bnRyeVwiKTtcblxuICAgICAgaWYgKHNoaXBwaW5nQ291bnRyeSkge1xuICAgICAgICAvLyAyLiBHZXQgdGhlIHNpdGUgZnJvbSB0aGUgdXNlcidzIHJlZ2lzdGVyZWQgc2l0ZVxuICAgICAgICBzaXRlID0gU2l0ZS5maW5kU2l0ZUJ5KFwiaXNvXCIsIHNoaXBwaW5nQ291bnRyeSk7XG4gICAgICB9XG4gICAgICBpZiAoIXNpdGUpIHtcbiAgICAgICAgc2l0ZSA9IFNpdGUuZmluZFNpdGVCeShcIm5hbWVcIiwgYWNjb3VudC5nZXQoXCJyZWdpc3RyYXRpb25TaXRlXCIpKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoc2l0ZSkge1xuICAgICAgcmVkaXJlY3Qoc2l0ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIDMuIEdldCB0aGUgdXNlcidzIElQIGxvY2F0aW9uIHRvIGdldCB0aGUgc2l0ZVxuICAgICAgQXV0aGVudGljYXRpb25TZXJ2aWNlLmdldEFwcGxpY2F0aW9uVG9rZW4oZnVuY3Rpb24odG9rZW46IHN0cmluZyk6IHZvaWQge1xuICAgICAgICAoTG9jYXRpb24gYXMgYW55KS5nZXRMb2NhdGlvbih0b2tlbiwgQ29uZmlncylcbiAgICAgICAgICAudGhlbihnZXRTaXRlKVxuICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihyZWFzb246IGFueSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2cocmVhc29uKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgSUQgb2YgdGhlIGVCYXkgc2l0ZSB0aGF0IGlzIHVzZWQgZm9yIHVzZXIgaW50ZXJhY3Rpb24uXG4gICAqIEByZXR1cm4gdGhlIGhvbWUgc2l0ZS5cbiAgICovXG4gIGdldEhvbWVTaXRlOiBmdW5jdGlvbihpbmNsdWRlVW5zaXRlZENvdW50cnk6IGJvb2xlYW4pOiBzdHJpbmcge1xuICAgIGxldCBzaXRlTmFtZSA9IFByb3BlcnR5REFPLmdldChQcm9wZXJ0eURBTy5QUk9QX0NIT1NFTl9TSVRFKTtcblxuICAgIC8vIDEuIENoZWNrIHRoZSBjaG9zZW4gc2l0ZS5cbiAgICAvLyAxYS4gSWYgaXQncyBlbXB0eSBhbmQgdXNlciBpcyBzaWduZWQgaW4sIHVzZSB0aGUgc2hpcHBpbmcgYWRkcmVzcyBhcyB0aGUgaG9tZSBzaXRlLlxuICAgIC8vIDFiLiBJZiBpdCdzIGVtcHR5IGFuZCB1c2VyIGlzIHNpZ25lZCBpbiwgdXNlIHRoZSByZWdpc3RyYXRpb24gc2l0ZSBhcyB0aGUgaG9tZSBzaXRlLlxuICAgIC8vIDFjLiBJZiBpdCdzIGVtcHR5IGFuZCB1c2VyIGlzIHNpZ25lZCBvdXQsIHVzZSB0aGUgbG9jYWxlIHRvIGd1ZXNzIHRoZSBob21lIHNpdGUuXG4gICAgLy8gMWQuIElmIGl0J3MgYXZhaWxhYmxlLCB1c2UgdGhlIGNob3NlbiBvbmUgYXMgdGhlIGhvbWUgc2l0ZS5cbiAgICAvLyAyLiBTZWxlY3QgVVMgaWYgbm90aGluZyBpcyBzcGVjaWZpZWQuXG4gICAgaWYgKCFzaXRlTmFtZSkge1xuICAgICAgbGV0IGFjY291bnQgPSAoQWNjb3VudCBhcyBhbnkpLmdldEFjY291bnQoKTtcbiAgICAgIGlmIChhY2NvdW50KSB7XG4gICAgICAgIGxldCBzaGlwcGluZ0NvdW50cnkgPSBhY2NvdW50LmdldChcInNoaXBwaW5nQ291bnRyeVwiKTtcblxuICAgICAgICBpZiAoc2hpcHBpbmdDb3VudHJ5KSB7XG4gICAgICAgICAgc2l0ZU5hbWUgPSB0aGlzLmZpbmRTaXRlQnkoXCJpc29cIiwgc2hpcHBpbmdDb3VudHJ5KS5uYW1lO1xuICAgICAgICB9XG4gICAgICAgIGlmICghc2l0ZU5hbWUpIHtcbiAgICAgICAgICBzaXRlTmFtZSA9IGFjY291bnQuZ2V0KFwicmVnaXN0cmF0aW9uU2l0ZVwiKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFzaXRlTmFtZSB8fCAhQ29uZmlncy5TVVBQT1JURURfU0lURVNfREFUQVtzaXRlTmFtZV0pIHtcbiAgICAgICAgc2l0ZU5hbWUgPSB0aGlzLnNpdGVGb3JMb2NhbGUoVXRpbGl0eUhlbHBlci5nZXRCcm93c2VyTGFuZ3VhZ2UoKSkubmFtZTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gWFhYOiBvbiAxMS8zMC8yMDExIHdlIGZvdW5kIG91dCBzb21lIHVzZXJzIG1pZ2h0IGhhdmUgZUJheU1vdG9yc1xuICAgIC8vIGFzIHRoZWlyIHJlZ2lzdHJhdGlvbiBzaXRlLCBzbyB3ZSBzaG91bGQgZGVmYXVsdCB0byBVUyBpbiB0aGF0IGNhc2VcbiAgICAvLyB0byBwcmV2ZW50IGEgY2hhaW4gb2YgbWFqb3IgaXNzdWVzXG4gICAgaWYgKCFzaXRlTmFtZSkge1xuICAgICAgc2l0ZU5hbWUgPSBcIlVTXCI7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChpbmNsdWRlVW5zaXRlZENvdW50cnkpIHtcbiAgICAgICAgaWYgKCFDb25maWdzLkFMTF9DT1VOVFJJRVNfREFUQVtzaXRlTmFtZV0pIHtcbiAgICAgICAgICBzaXRlTmFtZSA9IFwiVVNcIjtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICghQ29uZmlncy5TVVBQT1JURURfU0lURVNfREFUQVtzaXRlTmFtZV0pIHtcbiAgICAgICAgc2l0ZU5hbWUgPSBcIlVTXCI7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHNpdGVOYW1lO1xuICB9XG59O1xuIl19