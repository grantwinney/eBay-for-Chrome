/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var RoverUrlHelper = {
    _roverUrlTemplate: null,
    getUrl: function (aInfoObj) {
        var urlTemplate;
        var template;
        var homeSite;
        var domain;
        urlTemplate = Configs.URLS[aInfoObj.templateName];
        if (!urlTemplate) {
            Logger.error("Bad URL Template name: '" + aInfoObj.templateName + "'");
            return null;
        }
        template = new UrlTemplate(urlTemplate);
        homeSite =
            ("homeSite" in aInfoObj) ? aInfoObj.homeSite : Site.getHomeSite();
        if (aInfoObj.args && aInfoObj.args.domain) {
            domain = aInfoObj.args.domain;
        }
        else {
            domain = Site.siteDataForSite(homeSite).domain;
        }
        template.setArg("DOMAIN", domain);
        if ("args" in aInfoObj && aInfoObj.args) {
            $.each(aInfoObj.args, function (aArg, aValue) {
                template.setArg(aArg, aValue);
            });
        }
        return this.getRoverUrl({ url: template.url(), homeSite: homeSite, srcAreaName: aInfoObj.srcAreaName, activeAccount: aInfoObj.activeAccount });
    },
    getRoverUrl: function (aInfoObj) {
        var roverAreaName;
        var processedUrl;
        roverAreaName = Configs.ROVER_NAMES[aInfoObj.srcAreaName];
        if (!roverAreaName || roverAreaName == "NOTWRAPPED") {
            processedUrl = aInfoObj.url;
        }
        else {
            if (!this._roverUrlTemplate) {
                this._roverUrlTemplate = Configs.URLS["roverTrack"];
            }
            var locale = Configs.SUPPORTED_SITES_DATA[aInfoObj.homeSite].locale;
            var roverId = Configs.ROVER_IDS[locale];
            var roverTemplate = new UrlTemplate(this._roverUrlTemplate);
            roverTemplate.setArg("ROVID", roverId).
                setArg("AREA", this.getRoverTrackingInfo(aInfoObj)).
                setArg("URL", encodeURIComponent(aInfoObj.url)).
                setArg("MPT", $.now());
            processedUrl = roverTemplate.url();
        }
        return processedUrl;
    },
    performSearch: function (aKeywords, aSourceArea, aEvent, aType, aId) {
        var url;
        var roverObj = { srcAreaName: aSourceArea };
        var keywords = encodeURIComponent(aKeywords);
        if (!aType || aType == "keyword") {
            roverObj.templateName = "search";
            roverObj.args = { "query": keywords };
        }
        else if (aType == "category") {
            roverObj.templateName = "category";
            roverObj.args = { "query": keywords, "categoryId": encodeURIComponent(aId) };
        }
        else {
            roverObj.templateName = "catalog";
            roverObj.args = { "prodId": encodeURIComponent(aId) };
        }
        url = this.getUrl(roverObj);
        Site.openRawURL(url, aEvent, true);
    },
    loadPage: function (aUrlTemplate, aSourceArea, aArguments, aEvent) {
        var forceNewTab = false;
        var url = RoverUrlHelper.getUrl({ srcAreaName: aSourceArea,
            templateName: aUrlTemplate,
            args: aArguments });
        if (aArguments && aArguments.forceNewTab) {
            forceNewTab = true;
        }
        Site.openRawURL(url, aEvent, forceNewTab);
    },
    sendTrackingRequest: function (aType) {
        if (PropertyDAO.get(PropertyDAO.PROP_INSTALLATION_TRACKED) &&
            aType === "install") {
            return;
        }
        var locale;
        var homeSite = Site.getHomeSite();
        var site = Configs.SUPPORTED_SITES_DATA[homeSite];
        if (site) {
            locale = site.locale;
        }
        else {
            locale = "en-us";
        }
        var trackTag = Configs.INSTALL_TRACK_TAGS[locale];
        var time = Date.now();
        var random = String(Math.random()).split(".")[1];
        var uniqueId = time + random;
        var args = {
            tracktag: trackTag,
            mfe: aType,
            uniqueid: uniqueId
        };
        var url = RoverUrlHelper.getUrl({ srcAreaName: "installTracker",
            templateName: "installTrack",
            args: args });
        $.ajax({
            type: "GET",
            url: url,
            success: function (aData, aTextStatus) {
                PropertyDAO.set(PropertyDAO.PROP_INSTALLATION_TRACKED, true);
            },
            error: function (aXHR, aTextStatus, aError) {
                Logger.error("Error loading tracking pixel: " + url);
            }
        });
    },
    getRoverTrackingInfo: function (aExtraInfo) {
        var activeAccount = Account.getAccount();
        var site = Site.getHomeSite();
        var iso = Site.siteDataForCountries(site).iso;
        var signedInStr = activeAccount ? "si" : "so";
        var lang = UtilityHelper.getBrowserLanguage().substring(0, 2);
        var infoArr = [signedInStr, lang + "-" + iso];
        if (aExtraInfo.srcAreaName) {
            infoArr.push(aExtraInfo.srcAreaName);
        }
        return infoArr.join("_");
    }
};
function UrlTemplate(aUrl) {
    this._url = aUrl;
}
UrlTemplate.prototype = {
    url: function () {
        if (this.requiredArgs().length > 0) {
            Logger.warn("Returning UrlTemplate with unresolved placeholders:");
        }
        return this._url;
    },
    requiredArgs: function () {
        var argsRE = /#{(.*?)}/g;
        var result;
        var args = [];
        while (result = argsRE.exec(this._url)) {
            args.push(result[1]);
        }
        return args;
    },
    setArg: function (aArg, aValue) {
        if (typeof (aValue) == "undefined" || aValue === null) {
            Logger.warn("Undefined value passed for placeholder '" + aArg + "'.");
            aValue = "";
        }
        var argRE = new RegExp("#{" + aArg + "}", "gi");
        this._url = this._url.replace(argRE, aValue);
        return this;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm92ZXJVcmxIZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9iYWNrZ3JvdW5kL2NvcmUvaGVscGVycy9yb3ZlclVybEhlbHBlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQVNILElBQUksY0FBYyxHQUFHO0lBQ25CLGlCQUFpQixFQUFHLElBQUk7SUFPeEIsTUFBTSxFQUFHLFVBQVMsUUFBUTtRQUV4QixJQUFJLFdBQVcsQ0FBQztRQUNoQixJQUFJLFFBQVEsQ0FBQztRQUNiLElBQUksUUFBUSxDQUFDO1FBQ2IsSUFBSSxNQUFNLENBQUM7UUFFWCxXQUFXLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDbEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLE1BQU0sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEdBQUcsUUFBUSxDQUFDLFlBQVksR0FBRyxHQUFHLENBQUMsQ0FBQztZQUN2RSxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELFFBQVEsR0FBRyxJQUFJLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN4QyxRQUFRO1lBQ04sQ0FBQyxVQUFVLElBQUksUUFBUSxDQUFDLEdBQUcsUUFBUSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFcEUsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDMUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ2hDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNqRCxDQUFDO1FBQ0QsUUFBUSxD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QUFxRCxDQUFDLENBQUM7UUFDckUsQ0FBQztRQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFNRCxZQUFZLEVBQUc7UUFFYixJQUFJLE1BQU0sR0FBRyxXQUFXLENBQUM7UUFDekIsSUFBSSxNQUFNLENBQUM7UUFDWCxJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7UUFFZCxPQUFPLE1BQU0sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkIsQ0FBQztRQUVELE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBS0QsTUFBTSxFQUFHLFVBQVMsSUFBSSxFQUFFLE1BQU07UUFFNUIsRUFBRSxDQUFDLENBQUMsT0FBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLFdBQVcsSUFBSSxNQUFNLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNyRCxNQUFNLENBQUMsSUFBSSxDQUFDLDBDQUEwQyxHQUFHLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQztZQUN0RSxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ2QsQ0FBQztRQUNELElBQUksS0FBSyxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRTdDLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0NBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQ29weXJpZ2h0IChDKSAyMDA3LTIwMTUgZUJheSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKi9cblxuLypcbiAgdmFyIENvbmZpZ3MgPSByZXF1aXJlKFwiY29yZS9jb25maWdzL2luaXRcIikuQ29uZmlncztcbiAgdmFyIEFjY291bnQgPSByZXF1aXJlKFwiY29yZS9vYmplY3RzL2FjY291bnRcIikuQWNjb3VudDtcbiAgdmFyIExvZ2dlciA9IHJlcXVpcmUoXCJoZWxwZXJzL2xvZ2dlclwiKS5Mb2dnZXI7XG4gIHZhciBQcm9wZXJ0eURBTyA9IHJlcXVpcmUoXCJzdG9yYWdlL3Byb3BlcnR5REFPXCIpLlByb3BlcnR5REFPO1xuKi9cblxudmFyIFJvdmVyVXJsSGVscGVyID0ge1xuICBfcm92ZXJVcmxUZW1wbGF0ZSA6IG51bGwsXG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSB1cmwgZnJvbSBvdXIgdXJsIHRlbXBsYXRlIGFycmF5LlxuICAgKiBAcGFyYW0gYUluZm9PYmogeyBzcmNBcmVhTmFtZTogXCJcIiwgdGVtcGxhdGVOYW1lOiBcIlwiLCBob21lU2l0ZTogXCIob3B0aW9uYWwpXCIsIGFyZ3M6IFwiKG9wdGlvbmFsKVwiIH1cbiAgICogQHJldHVybiByb3ZlciB1cmwuXG4gICAqL1xuICBnZXRVcmwgOiBmdW5jdGlvbihhSW5mb09iaikge1xuXG4gICAgdmFyIHVybFRlbXBsYXRlO1xuICAgIHZhciB0ZW1wbGF0ZTtcbiAgICB2YXIgaG9tZVNpdGU7XG4gICAgdmFyIGRvbWFpbjtcblxuICAgIHVybFRlbXBsYXRlID0gQ29uZmlncy5VUkxTW2FJbmZvT2JqLnRlbXBsYXRlTmFtZV07XG4gICAgaWYgKCF1cmxUZW1wbGF0ZSkge1xuICAgICAgTG9nZ2VyLmVycm9yKFwiQmFkIFVSTCBUZW1wbGF0ZSBuYW1lOiAnXCIgKyBhSW5mb09iai50ZW1wbGF0ZU5hbWUgKyBcIidcIik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB0ZW1wbGF0ZSA9IG5ldyBVcmxUZW1wbGF0ZSh1cmxUZW1wbGF0ZSk7XG4gICAgaG9tZVNpdGUgPVxuICAgICAgKFwiaG9tZVNpdGVcIiBpbiBhSW5mb09iaikgPyBhSW5mb09iai5ob21lU2l0ZSA6IFNpdGUuZ2V0SG9tZVNpdGUoKTtcblxuICAgIGlmIChhSW5mb09iai5hcmdzICYmIGFJbmZvT2JqLmFyZ3MuZG9tYWluKSB7XG4gICAgICBkb21haW4gPSBhSW5mb09iai5hcmdzLmRvbWFpbjtcbiAgICB9IGVsc2Uge1xuICAgICAgZG9tYWluID0gU2l0ZS5zaXRlRGF0YUZvclNpdGUoaG9tZVNpdGUpLmRvbWFpbjtcbiAgICB9XG4gICAgdGVtcGxhdGUuc2V0QXJnKFwiRE9NQUlOXCIsIGRvbWFpbik7XG5cbiAgICBpZiAoXCJhcmdzXCIgaW4gYUluZm9PYmogJiYgYUluZm9PYmouYXJncykge1xuICAgICAgJC5lYWNoKGFJbmZvT2JqLmFyZ3MsIGZ1bmN0aW9uKGFBcmcsIGFWYWx1ZSkge1xuICAgICAgICB0ZW1wbGF0ZS5zZXRBcmcoYUFyZywgYVZhbHVlKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmdldFJvdmVyVXJsKHsgdXJsOiB0ZW1wbGF0ZS51cmwoKSwgaG9tZVNpdGU6IGhvbWVTaXRlLCBzcmNBcmVhTmFtZTogYUluZm9PYmouc3JjQXJlYU5hbWUsIGFjdGl2ZUFjY291bnQ6IGFJbmZvT2JqLmFjdGl2ZUFjY291bnQgfSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFBlcmZvcm1zIFVSTCByb3ZlciB3cmFwcGluZyBpZiBuZWNlc3NhcnkuXG4gICAqIEBwYXJhbSBhSW5mb09iaiB7IHVybDogXCJcIiwgc3JjQXJlYU5hbWU6IFwiXCIsIGhvbWVTaXRlOiBcIlwiIH1cbiAgICogQHJldHVybiByb3ZlciB1cmwuXG4gICAqL1xuICBnZXRSb3ZlclVybCA6IGZ1bmN0aW9uKGFJbmZvT2JqKSB7XG4gICAgdmFyIHJvdmVyQXJlYU5hbWU7XG4gICAgdmFyIHByb2Nlc3NlZFVybDtcblxuICAgIHJvdmVyQXJlYU5hbWUgPSBDb25maWdzLlJPVkVSX05BTUVTW2FJbmZvT2JqLnNyY0FyZWFOYW1lXTtcbiAgICBpZiAoIXJvdmVyQXJlYU5hbWUgfHwgcm92ZXJBcmVhTmFtZSA9PSBcIk5PVFdSQVBQRURcIikge1xuICAgICAgcHJvY2Vzc2VkVXJsID0gYUluZm9PYmoudXJsO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIXRoaXMuX3JvdmVyVXJsVGVtcGxhdGUpIHtcbiAgICAgICAgdGhpcy5fcm92ZXJVcmxUZW1wbGF0ZSA9IENvbmZpZ3MuVVJMU1tcInJvdmVyVHJhY2tcIl07XG4gICAgICB9XG5cbiAgICAgIHZhciBsb2NhbGUgPSBDb25maWdzLlNVUFBPUlRFRF9TSVRFU19EQVRBW2FJbmZvT2JqLmhvbWVTaXRlXS5sb2NhbGU7XG4gICAgICB2YXIgcm92ZXJJZCA9IENvbmZpZ3MuUk9WRVJfSURTW2xvY2FsZV07XG4gICAgICB2YXIgcm92ZXJUZW1wbGF0ZSA9IG5ldyBVcmxUZW1wbGF0ZSh0aGlzLl9yb3ZlclVybFRlbXBsYXRlKTtcbiAgICAgIHJvdmVyVGVtcGxhdGUuc2V0QXJnKFwiUk9WSURcIiwgcm92ZXJJZCkuXG4gICAgICAgICAgICAgICAgICAgIHNldEFyZyhcIkFSRUFcIiwgdGhpcy5nZXRSb3ZlclRyYWNraW5nSW5mbyhhSW5mb09iaikpLlxuICAgICAgICAgICAgICAgICAgICBzZXRBcmcoXCJVUkxcIiwgZW5jb2RlVVJJQ29tcG9uZW50KGFJbmZvT2JqLnVybCkpLlxuICAgICAgICAgICAgICAgICAgICAvL1hYWDogbGV0J3MgYWRkIGEgdGltZXN0YW1wIG9uIHRoZSBVUkwgc28gYWxsIHJlcXVlc3RzIHRvIHJvdmVyIGFyZSBkaWZmZXJlbnQgKG5vdCBjYWNoZWQpLlxuICAgICAgICAgICAgICAgICAgICBzZXRBcmcoXCJNUFRcIiwgJC5ub3coKSk7XG4gICAgICBwcm9jZXNzZWRVcmwgPSByb3ZlclRlbXBsYXRlLnVybCgpO1xuICAgIH1cblxuICAgIHJldHVybiBwcm9jZXNzZWRVcmw7XG4gIH0sXG5cbiAgLyoqXG4gICAqIExvYWRzIHRoZSBzZWFyY2ggcmVzdWx0IHBhZ2Ugd2l0aCB0aGUgZ2l2ZW4ga2V5d29yZHMuXG4gICAqIEBwYXJhbSBhS2V5d29yZHMgdGhlIGtleXdvcmRzLlxuICAgKiBAcGFyYW0gYVNvdXJjZUFyZWEgdGhlIHNvdXJjZSBhcmVhLlxuICAgKiBAcGFyYW0gYUV2ZW50IHRoZSBldmVudC5cbiAgICogQHBhcmFtIGFUeXBlIHRoZSB0eXBlLlxuICAgKiBAcGFyYW0gYUlkIHRoZSBpZC5cbiAgICovXG4gIHBlcmZvcm1TZWFyY2ggOiBmdW5jdGlvbihhS2V5d29yZHMsIGFTb3VyY2VBcmVhLCBhRXZlbnQsIGFUeXBlLCBhSWQpIHtcblxuICAgIHZhciB1cmw7XG4gICAgdmFyIHJvdmVyT2JqID0geyBzcmNBcmVhTmFtZTogYVNvdXJjZUFyZWEgfTtcbiAgICB2YXIga2V5d29yZHMgPSBlbmNvZGVVUklDb21wb25lbnQoYUtleXdvcmRzKTtcblxuICAgIGlmICghYVR5cGUgfHwgYVR5cGUgPT0gXCJrZXl3b3JkXCIpIHtcbiAgICAgIHJvdmVyT2JqLnRlbXBsYXRlTmFtZSA9IFwic2VhcmNoXCI7XG4gICAgICByb3Zlck9iai5hcmdzID0geyBcInF1ZXJ5XCIgOiBrZXl3b3JkcyB9O1xuICAgIH0gZWxzZSBpZiAoYVR5cGUgPT0gXCJjYXRlZ29yeVwiKSB7XG4gICAgICByb3Zlck9iai50ZW1wbGF0ZU5hbWUgPSBcImNhdGVnb3J5XCI7XG4gICAgICByb3Zlck9iai5hcmdzID0geyBcInF1ZXJ5XCIgOiBrZXl3b3JkcywgXCJjYXRlZ29yeUlkXCIgOiBlbmNvZGVVUklDb21wb25lbnQoYUlkKSB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByb3Zlck9iai50ZW1wbGF0ZU5hbWUgPSBcImNhdGFsb2dcIjtcbiAgICAgIHJvdmVyT2JqLmFyZ3MgPSB7IFwicHJvZElkXCIgOiBlbmNvZGVVUklDb21wb25lbnQoYUlkKSB9O1xuICAgIH1cblxuICAgIHVybCA9IHRoaXMuZ2V0VXJsKHJvdmVyT2JqKTtcbiAgICBTaXRlLm9wZW5SYXdVUkwodXJsLCBhRXZlbnQsIHRydWUpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBMb2FkcyBhIHBhZ2UuXG4gICAqIEBwYXJhbSBhVXJsVGVtcGxhdGUgdGhlIHVybCB0ZW1wbGF0ZS5cbiAgICogQHBhcmFtIGFTb3VyY2VBcmVhIHRoZSBzb3VyY2UgYXJlYS5cbiAgICogQHBhcmFtIGFBcmd1bWVudHMgdGhlIGFyZ3VtZW50cy5cbiAgICogQHBhcmFtIGFFdmVudCB0aGUgZXZlbnQuXG4gICAqL1xuICBsb2FkUGFnZSA6IGZ1bmN0aW9uKGFVcmxUZW1wbGF0ZSwgYVNvdXJjZUFyZWEsIGFBcmd1bWVudHMsIGFFdmVudCkge1xuXG4gICAgdmFyIGZvcmNlTmV3VGFiID0gZmFsc2U7XG4gICAgdmFyIHVybCA9IFJvdmVyVXJsSGVscGVyLmdldFVybCh7IHNyY0FyZWFOYW1lOiBhU291cmNlQXJlYSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVOYW1lOiBhVXJsVGVtcGxhdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3M6IGFBcmd1bWVudHMgfSk7XG4gICAgaWYgKGFBcmd1bWVudHMgJiYgYUFyZ3VtZW50cy5mb3JjZU5ld1RhYikge1xuICAgICAgZm9yY2VOZXdUYWIgPSB0cnVlO1xuICAgIH1cblxuICAgIFNpdGUub3BlblJhd1VSTCh1cmwsIGFFdmVudCwgZm9yY2VOZXdUYWIpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBTZW5kcyBhIChzaWxlbnQpIHRyYWNraW5nIHJlcXVlc3QgdXNpbmcgY2xpZW50LXNwZWNpZmljIHJvdmVyIGlkcyB3aGVuXG4gICAqIGF2YWlsYWJsZSwgb3IgZGVmYXVsdCBvbmVzIG90aGVyd2lzZS5cbiAgICogQHBhcmFtIGFUeXBlIGluc3RhbGwgb3IgYWN0aXZhdGUgdmFsdWVzIHRvIHNlbmQgaW5zdGFsbGF0aW9uIG9yXG4gICAqIGZpcnN0IHNpZ24gaW4gdHJhY2tpbmcgcmVxdWVzdC5cbiAgICovXG4gIHNlbmRUcmFja2luZ1JlcXVlc3QgOiBmdW5jdGlvbihhVHlwZSkge1xuICAgIGlmIChQcm9wZXJ0eURBTy5nZXQoUHJvcGVydHlEQU8uUFJPUF9JTlNUQUxMQVRJT05fVFJBQ0tFRCkgJiZcbiAgICAgICAgYVR5cGUgPT09IFwiaW5zdGFsbFwiKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdmFyIGxvY2FsZTtcbiAgICB2YXIgaG9tZVNpdGUgPSBTaXRlLmdldEhvbWVTaXRlKCk7XG5cbiAgICB2YXIgc2l0ZSA9IENvbmZpZ3MuU1VQUE9SVEVEX1NJVEVTX0RBVEFbaG9tZVNpdGVdO1xuICAgIGlmIChzaXRlKSB7XG4gICAgICBsb2NhbGUgPSBzaXRlLmxvY2FsZTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9jYWxlID0gXCJlbi11c1wiO1xuICAgIH1cbiAgICB2YXIgdHJhY2tUYWcgPSBDb25maWdzLklOU1RBTExfVFJBQ0tfVEFHU1tsb2NhbGVdO1xuXG4gICAgLy8gR2VuZXJhdGUgdW5pcXVlIElEIHRvIHByZXZlbnQgY2FjaGluZ1xuICAgIHZhciB0aW1lID0gRGF0ZS5ub3coKTtcbiAgICB2YXIgcmFuZG9tID0gU3RyaW5nKE1hdGgucmFuZG9tKCkpLnNwbGl0KFwiLlwiKVsxXTtcbiAgICB2YXIgdW5pcXVlSWQgPSB0aW1lICsgcmFuZG9tO1xuXG4gICAgdmFyIGFyZ3MgPSB7XG4gICAgICB0cmFja3RhZyA6IHRyYWNrVGFnLFxuICAgICAgbWZlIDogYVR5cGUsXG4gICAgICB1bmlxdWVpZCA6IHVuaXF1ZUlkXG4gICAgfTtcbiAgICB2YXIgdXJsID0gUm92ZXJVcmxIZWxwZXIuZ2V0VXJsKHsgc3JjQXJlYU5hbWU6IFwiaW5zdGFsbFRyYWNrZXJcIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVOYW1lOiBcImluc3RhbGxUcmFja1wiLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBhcmdzIH0pO1xuICAgICQuYWpheCh7XG4gICAgICB0eXBlOiBcIkdFVFwiLFxuICAgICAgdXJsOiB1cmwsXG4gICAgICBzdWNjZXNzOiBmdW5jdGlvbihhRGF0YSwgYVRleHRTdGF0dXMpIHtcbiAgICAgICAgUHJvcGVydHlEQU8uc2V0KFByb3BlcnR5REFPLlBST1BfSU5TVEFMTEFUSU9OX1RSQUNLRUQsIHRydWUpO1xuICAgICAgfSxcbiAgICAgIGVycm9yOiBmdW5jdGlvbihhWEhSLCBhVGV4dFN0YXR1cywgYUVycm9yKSB7XG4gICAgICAgIExvZ2dlci5lcnJvcihcIkVycm9yIGxvYWRpbmcgdHJhY2tpbmcgcGl4ZWw6IFwiICsgdXJsKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSxcblxuICBnZXRSb3ZlclRyYWNraW5nSW5mbzogZnVuY3Rpb24oYUV4dHJhSW5mbykge1xuICAgIHZhciBhY3RpdmVBY2NvdW50ID0gQWNjb3VudC5nZXRBY2NvdW50KCk7XG4gICAgdmFyIHNpdGUgPSBTaXRlLmdldEhvbWVTaXRlKCk7XG5cbiAgICB2YXIgaXNvID0gU2l0ZS5zaXRlRGF0YUZvckNvdW50cmllcyhzaXRlKS5pc287XG4gICAgdmFyIHNpZ25lZEluU3RyID0gYWN0aXZlQWNjb3VudCA/IFwic2lcIiA6IFwic29cIjtcbiAgICB2YXIgbGFuZyA9IFV0aWxpdHlIZWxwZXIuZ2V0QnJvd3Nlckxhbmd1YWdlKCkuc3Vic3RyaW5nKDAsIDIpO1xuXG4gICAgdmFyIGluZm9BcnIgPSBbc2lnbmVkSW5TdHIsIGxhbmcgKyBcIi1cIiArIGlzb107XG4gICAgaWYgKGFFeHRyYUluZm8uc3JjQXJlYU5hbWUpIHtcbiAgICAgIGluZm9BcnIucHVzaChhRXh0cmFJbmZvLnNyY0FyZWFOYW1lKTtcbiAgICB9XG4gICAgcmV0dXJuIGluZm9BcnIuam9pbihcIl9cIik7XG4gIH1cbn07XG5cbi8qKlxuICogVGhpcyBvYmplY3QgaXMgdXNlZCB0byBtYW5hZ2UgVVJMc1xuICovXG5mdW5jdGlvbiBVcmxUZW1wbGF0ZShhVXJsKSB7XG4gIHRoaXMuX3VybCA9IGFVcmw7XG59XG5cblVybFRlbXBsYXRlLnByb3RvdHlwZSA9IHtcbiAgLyoqXG4gICAqIEdldHRlclxuICAgKi9cbiAgdXJsIDogZnVuY3Rpb24oKSB7XG4gICAgXG4gICAgaWYgKHRoaXMucmVxdWlyZWRBcmdzKCkubGVuZ3RoID4gMCkge1xuICAgICAgTG9nZ2VyLndhcm4oXCJSZXR1cm5pbmcgVXJsVGVtcGxhdGUgd2l0aCB1bnJlc29sdmVkIHBsYWNlaG9sZGVyczpcIik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX3VybDtcbiAgfSxcblxuICAvKipcbiAgICogUmV0dXJucyBhbiBhcnJheSBjb250YWluaW5nIHRoZSBuYW1lcyBvZiB0aGUgYXJndW1lbnRzIHRoYXQgc3RpbGwgbmVlZCB0b1xuICAgKiBiZSBwYXNzZWRcbiAgICovXG4gIHJlcXVpcmVkQXJncyA6IGZ1bmN0aW9uKCkge1xuICAgIFxuICAgIHZhciBhcmdzUkUgPSAvI3soLio/KX0vZztcbiAgICB2YXIgcmVzdWx0O1xuICAgIHZhciBhcmdzID0gW107XG5cbiAgICB3aGlsZSAocmVzdWx0ID0gYXJnc1JFLmV4ZWModGhpcy5fdXJsKSkge1xuICAgICAgYXJncy5wdXNoKHJlc3VsdFsxXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFyZ3M7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFJlc29sdmVzIGEgcGxhY2Vob2xkZXIgd2l0aCBhbiBhcmd1bWVudFxuICAgKi9cbiAgc2V0QXJnIDogZnVuY3Rpb24oYUFyZywgYVZhbHVlKSB7XG4gICAgXG4gICAgaWYgKHR5cGVvZihhVmFsdWUpID09IFwidW5kZWZpbmVkXCIgfHwgYVZhbHVlID09PSBudWxsKSB7XG4gICAgICBMb2dnZXIud2FybihcIlVuZGVmaW5lZCB2YWx1ZSBwYXNzZWQgZm9yIHBsYWNlaG9sZGVyICdcIiArIGFBcmcgKyBcIicuXCIpO1xuICAgICAgYVZhbHVlID0gXCJcIjtcbiAgICB9XG4gICAgdmFyIGFyZ1JFID0gbmV3IFJlZ0V4cChcIiN7XCIgKyBhQXJnICsgXCJ9XCIsIFwiZ2lcIik7XG4gICAgdGhpcy5fdXJsID0gdGhpcy5fdXJsLnJlcGxhY2UoYXJnUkUsIGFWYWx1ZSk7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxufTtcbiJdfQ==