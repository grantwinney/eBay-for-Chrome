/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var SymbanApi = {
    REQUEST_TYPES: {
        PUBLISH: "publish",
        PULL: "pull",
        UPDATE: "update"
    },
    UPDATES: {
        READ: 1,
        READ_ALL: 2,
        DELETE: 3,
        DELETE_ALL: 4
    },
    callSymbanApi: function (aRequestName, aParameters, aCallback) {
        var initialTimestamp = $.now();
        var finalTimestamp = 0;
        var elapsedTime = 0;
        var callback = function (aResponse) {
            var result = null;
            finalTimestamp = $.now();
            elapsedTime = (finalTimestamp - initialTimestamp) / 1000;
            if (PropertyDAO.get(PropertyDAO.PROP_DISPLAY_LOGS)) {
                console.log("Response Symban", aResponse);
                console.log("elapsed time (in seconds): " + elapsedTime);
                console.log("--- end response Symban ---\n");
            }
            if (aResponse) {
                result = aResponse;
            }
            if (aCallback) {
                aCallback(result);
            }
        };
        request = this._doCall(aRequestName, aParameters, callback);
        return request;
    },
    _validateResponse: function (aResponse) {
        if (!aResponse) {
            Logger.error("SymbanApi Error: no response!");
            return false;
        }
        if (aResponse.errorMessage && aResponse.errorMessage.error) {
            $.each(aResponse.errorMessage.error, function () {
                Logger.error("SymbanApi Error: " + this.errorId + " - " + this.longMessage);
            });
        }
        return true;
    },
    _flattenParameters: function (aParameters) {
        var unflattened = [];
        var parameterString = "";
        $.each(aParameters, function (aName, aValue) {
            unflattened.push({ name: aName, value: aValue });
        });
        while (unflattened.length > 0) {
            var entry = unflattened.shift();
            if (typeof (entry.value) != "object") {
                parameterString += "&" + entry.name +
                    "=" + encodeURIComponent(entry.value);
            }
            else {
                if ($.isArray(entry.value)) {
                    $.each(entry.value, function (aIndex, aNewEntryValue) {
                        var newEntry = {};
                        newEntry.name = entry.name + "(" + aIndex + ")";
                        newEntry.value = aNewEntryValue;
                        unflattened.splice(aIndex, 0, newEntry);
                    });
                }
                else {
                    var i = 0;
                    $.each(entry.value, function (aNewEntryName, aNewEntryValue) {
                        var newEntry = {};
                        newEntry.name = entry.name + "." + aNewEntryName;
                        newEntry.value = aNewEntryValue;
                        unflattened.splice(i++, 0, newEntry);
                    });
                }
            }
        }
        return parameterString;
    },
    _createPutParametersString: function (aParameters) {
        var params;
        var type = aParameters.type;
        switch (type) {
            case this.UPDATES.READ:
                params = {
                    notification: [
                        {
                            notificationId: aParameters.notificationId,
                            status: "READ"
                        }
                    ]
                };
                break;
            case this.UPDATES.READ_ALL:
                params = {
                    extension: [],
                    notification: [],
                    markAllRead: true
                };
                break;
            case this.UPDATES.DELETE:
                params = {
                    notification: [
                        {
                            notificationId: aParameters.notificationId,
                            status: "DELETED"
                        }
                    ]
                };
                break;
            case this.UPDATES.DELETE_ALL:
                params = {
                    extension: [],
                    notification: [],
                    markAllDelete: true
                };
                break;
        }
        params.lastRetrievalTime = aParameters.lastRetrievalTime;
        return JSON.stringify(params);
    },
    _checkTokenExpired: function (aXHR) {
        if (aXHR && aXHR.responseJSON) {
            if ((aXHR.responseJSON.errorMessage &&
                aXHR.responseJSON.errorMessage.error[0] &&
                aXHR.responseJSON.errorMessage.error[0].errorId &&
                aXHR.responseJSON.errorMessage.error[0].errorId.toString() == "1001") ||
                (aXHR.responseJSON.error_code &&
                    aXHR.responseJSON.error_code == "invalid_token")) {
                ObserverHelper.notify(Topics.USER_TOKEN_EXPIRED, null);
            }
        }
    },
    _doCall: function (aRequestName, aParameters, aCallback) {
        var url = ApiHelper.getEndPoint("symbanApi");
        var that = this;
        var account = Account.getAccount();
        var parameterString;
        var request;
        var requestType;
        switch (aRequestName) {
            case SymbanApi.REQUEST_TYPES.PUBLISH:
                requestType = "POST";
                parameterString = this._flattenParameters(aParameters);
                break;
            case SymbanApi.REQUEST_TYPES.UPDATE:
                requestType = "PUT";
                parameterString = this._createPutParametersString(aParameters);
                break;
            case SymbanApi.REQUEST_TYPES.PULL:
            default:
                requestType = "GET";
                if (aParameters && "apiPath" in aParameters) {
                    var arr = url.split("/");
                    url = arr[0] + "//" + arr[2] + aParameters.apiPath;
                    delete aParameters.apiPath;
                }
                parameterString = this._flattenParameters(aParameters);
                break;
        }
        request =
            $.ajax({
                beforeSend: function (aXHR) {
                    aXHR.setRequestHeader("Content-Type", "application/json");
                    aXHR.setRequestHeader("Accept", "application/json");
                    aXHR.setRequestHeader("Accept-Language", UtilityHelper.getBrowserLanguage());
                    if (account && account.get("token")) {
                        aXHR.setRequestHeader("Authorization", "bearer " + account.get("token"));
                    }
                },
                type: requestType,
                url: url,
                data: parameterString,
                dataType: "json",
                jsonp: false,
                timeout: PropertyDAO.get(PropertyDAO.PROP_API_TIMEOUT),
                success: function (aData, aTextStatus) {
                    try {
                        if (!that._validateResponse(aData)) {
                            aData = null;
                        }
                        else {
                            MessagePanelService.dismissMessage(MessagePanelService.TYPE.CONNECT_ERROR);
                        }
                        if (aCallback) {
                            aCallback(aData);
                        }
                    }
                    catch (e) {
                        UtilityHelper.handleError("SymbanApi", aRequestName, e.message, aCallback);
                    }
                },
                error: function (aXHR, aTextStatus, aError) {
                    SymbanApi._checkTokenExpired(aXHR);
                    UtilityHelper.handleError("SymbanApi", aRequestName, aXHR.responseText, aCallback);
                }
            });
        ApiHelper.addPendingRequest(request, aRequestName, Topics.SYMBAN_DATA_UPDATED);
        return request;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ltYmFuQXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vYmFja2dyb3VuZC9jb3JlL2FwaXMvc3ltYmFuQXBpLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBZ0JILElBQUksU0FBUyxHQUFHO0lBUWQsYUFBYSxFQUFHO1FBQ2QsT0FBTyxFQUFHLFNBQVM7UUFDbkIsSUFBSSxFQUFHLE1BQU07UUFDYixNQUFNLEVBQUcsUUFBUTtLQUNsQjtJQUVELE9BQU8sRUFBRztRQUNSLElBQUksRUFBRyxDQUFDO1FBQ1IsUUFBUSxFQUFHLENBQUM7UUFDWixNQUFNLEVBQUcsQ0FBQztRQUNWLFVBQVUsRUFBRyxDQUFDO0tBQ2Y7SUFTRCxhQUFhLEVBQUcsVUFBUyxZQUFZLEVBQUUsV0FBVyxFQUFFLFNBQVM7UUFHM0QsSUFBSSxnQkFBZ0IsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDL0IsSUFBSSxjQUFjLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksV0FBVyxHQUFHLENBQUMsQ0FBQztRQUdwQixJQUFJLFFBQVEsR0FBRyxVQUFTLFNBQVM7WUFDL0IsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO1lBR2xCLGNBQWMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDekIsV0FBVyxHQUFHLENBQUMsY0FBYyxHQUFHLGdCQUFnQixDQUFDLEdBQUcsSUFBSSxDQUFDO1lBQ3pELEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNuRCxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUMxQyxPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixHQUFHLFdBQVcsQ0FBQyxDQUFDO2dCQUN6RCxPQUFPLENBQUMsR0FBRyxDQUFDLCtCQUErQixDQUFDLENBQUM7WUFDL0Ms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Q0FBQztvQkFDSCxDQUFDO29CQUFDLEtBQUssQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ1YsYUFBYSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUM7b0JBQzdFLENBQUM7Z0JBQ0gsQ0FBQztnQkFDRCxLQUFLLEVBQUUsVUFBUyxJQUFJLEVBQUUsV0FBVyxFQUFFLE1BQU07b0JBRXZDLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDbkMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsU0FBUyxDQUFDLENBQUM7Z0JBQ3JGLENBQUM7YUFDRixDQUFDLENBQUM7UUFLTCxTQUFTLENBQUMsaUJBQWlCLENBQUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUUvRSxNQUFNLENBQUMsT0FBTyxDQUFDO0lBQ2pCLENBQUM7Q0FDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBDb3B5cmlnaHQgKEMpIDIwMDctMjAxNSBlQmF5IEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqL1xuXG4vKlxuICB2YXIgQWNjb3VudCA9IHJlcXVpcmUoXCJjb3JlL29iamVjdHMvYWNjb3VudFwiKS5BY2NvdW50O1xuICB2YXIgTG9nZ2VyID0gcmVxdWlyZShcImhlbHBlcnMvbG9nZ2VyXCIpLkxvZ2dlcjtcbiAgdmFyIFRvcGljcyA9IHJlcXVpcmUoXCJoZWxwZXJzL29ic2VydmVySGVscGVyXCIpLlRvcGljcztcbiAgdmFyIE9ic2VydmVySGVscGVyID0gcmVxdWlyZShcImhlbHBlcnMvb2JzZXJ2ZXJIZWxwZXJcIikuT2JzZXJ2ZXJIZWxwZXI7XG4gIHZhciBVdGlsaXR5SGVscGVyID0gcmVxdWlyZShcImhlbHBlcnMvdXRpbGl0eUhlbHBlclwiKS5VdGlsaXR5SGVscGVyO1xuICB2YXIgQXBpSGVscGVyID0gcmVxdWlyZShcImNvcmUvaGVscGVycy9hcGlIZWxwZXJcIikuQXBpSGVscGVyO1xuICB2YXIgTWVzc2FnZVBhbmVsU2VydmljZSA9IHJlcXVpcmUoXCJjb3JlL3NlcnZpY2VzL21lc3NhZ2VQYW5lbFNlcnZpY2VcIikuTWVzc2FnZVBhbmVsU2VydmljZTtcbiAgdmFyIFByb3BlcnR5REFPID0gcmVxdWlyZShcInN0b3JhZ2UvcHJvcGVydHlEQU9cIikuUHJvcGVydHlEQU87XG4qL1xuXG4vKipcbiAqIFN5bWJhbiBBUEkuXG4gKi9cbnZhciBTeW1iYW5BcGkgPSB7XG5cbiAgLyoqXG4gICAqIFJlcXVlc3QgdHlwZXM6XG4gICAqIHB1Ymxpc2ggdXNlcyBQT1NUXG4gICAqIHB1bGwgdXNlcyBHRVRcbiAgICogdXBkYXRlIHVzZXMgUFVUXG4gICAqL1xuICBSRVFVRVNUX1RZUEVTIDoge1xuICAgIFBVQkxJU0ggOiBcInB1Ymxpc2hcIixcbiAgICBQVUxMIDogXCJwdWxsXCIsXG4gICAgVVBEQVRFIDogXCJ1cGRhdGVcIlxuICB9LFxuXG4gIFVQREFURVMgOiB7XG4gICAgUkVBRCA6IDEsXG4gICAgUkVBRF9BTEwgOiAyLFxuICAgIERFTEVURSA6IDMsXG4gICAgREVMRVRFX0FMTCA6IDRcbiAgfSxcblxuICAvKipcbiAgICogQ2FsbHMgdGhlIFN5bWJhbiBBUEkuXG4gICAqIEBwYXJhbSBhUmVxdWVzdE5hbWUgdGhlIG5hbWUgb2YgdGhlIHJlcXVlc3Q6IHB1bGwgfCBwdWJsaXNoIHwgdXBkYXRlLlxuICAgKiBAcGFyYW0gYVBhcmFtZXRlcnMgdGhlIHBhcmFtZXRlcnMgdG8gc2VuZCBpbiB0aGUgcmVxdWVzdC5cbiAgICogQHBhcmFtIGFDYWxsYmFjayB0aGUgY2FsbGJhY2sgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIHN5bWJhbiByZXF1ZXN0XG4gICAqIHJldHVybnMuXG4gICAqL1xuICBjYWxsU3ltYmFuQXBpIDogZnVuY3Rpb24oYVJlcXVlc3ROYW1lLCBhUGFyYW1ldGVycywgYUNhbGxiYWNrKSB7XG4gICAgXG4gICAgLy9YWFg6IHRoaXMgaXMganVzdCBmb3IgdGVzdC4gUmVtb3ZlIHdoZW4gbm90IG5lZWRlZC5cbiAgICB2YXIgaW5pdGlhbFRpbWVzdGFtcCA9ICQubm93KCk7XG4gICAgdmFyIGZpbmFsVGltZXN0YW1wID0gMDtcbiAgICB2YXIgZWxhcHNlZFRpbWUgPSAwO1xuXG4gICAgLy8gZG8gdGhlIGNhbGxcbiAgICB2YXIgY2FsbGJhY2sgPSBmdW5jdGlvbihhUmVzcG9uc2UpIHtcbiAgICAgIHZhciByZXN1bHQgPSBudWxsO1xuXG4gICAgICAvL1hYWDogdGhpcyBpcyBqdXN0IGZvciB0ZXN0LiBSZW1vdmUgd2hlbiBub3QgbmVlZGVkLlxuICAgICAgZmluYWxUaW1lc3RhbXAgPSAkLm5vdygpO1xuICAgICAgZWxhcHNlZFRpbWUgPSAoZmluYWxUaW1lc3RhbXAgLSBpbml0aWFsVGltZXN0YW1wKSAvIDEwMDA7XG4gICAgICBpZiAoUHJvcGVydHlEQU8uZ2V0KFByb3BlcnR5REFPLlBST1BfRElTUExBWV9MT0dTKSkge1xuICAgICAgICBjb25zb2xlLmxvZyhcIlJlc3BvbnNlIFN5bWJhblwiLCBhUmVzcG9uc2UpO1xuICAgICAgICBjb25zb2xlLmxvZyhcImVsYXBzZWQgdGltZSAoaW4gc2Vjb25kcyk6IFwiICsgZWxhcHNlZFRpbWUpO1xuICAgICAgICBjb25zb2xlLmxvZyhcIi0tLSBlbmQgcmVzcG9uc2UgU3ltYmFuIC0tLVxcblwiKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGFSZXNwb25zZSkge1xuICAgICAgICAvL1RPRE86IGRlZmluZSBob3cgd2Ugc2hvdWxkIHBhcnNlIHRoZSByZXNwb25zZSBmcm9tIFN5bWJhbiBBUEkuXG4gICAgICAgIHJlc3VsdCA9IGFSZXNwb25zZTtcbiAgICAgIH1cbiAgICAgIGlmIChhQ2FsbGJhY2spIHtcbiAgICAgICAgYUNhbGxiYWNrKHJlc3VsdCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHJlcXVlc3QgPSB0aGlzLl9kb0NhbGwoYVJlcXVlc3ROYW1lLCBhUGFyYW1ldGVycywgY2FsbGJhY2spO1xuXG4gICAgcmV0dXJuIHJlcXVlc3Q7XG4gIH0sXG5cblxuICAvKipcbiAgICogUmVwb3J0cyBhbnkgZXJyb3IgbWVzc2FnZXMgaW4gdGhlIEFQSSByZXNwb25zZS5cbiAgICogQHBhcmFtIGFSZXNwb25zZSB0aGUgQVBJIHJlc3BvbnNlLlxuICAgKiBAcmV0dXJuIGJvb2xlYW4gaW5kaWNhdGVzIHdoZXRoZXIgdGhlIHJlc3BvbnNlIGNvbnRhaW5zIGVycm9yIG9yIG5vdC5cbiAgICovXG4gIF92YWxpZGF0ZVJlc3BvbnNlIDogZnVuY3Rpb24oYVJlc3BvbnNlKSB7XG4gICAgXG4gICAgaWYgKCFhUmVzcG9uc2UpIHtcbiAgICAgIExvZ2dlci5lcnJvcihcIlN5bWJhbkFwaSBFcnJvcjogbm8gcmVzcG9uc2UhXCIpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGlmIChhUmVzcG9uc2UuZXJyb3JNZXNzYWdlICYmIGFSZXNwb25zZS5lcnJvck1lc3NhZ2UuZXJyb3IpIHtcbiAgICAgICQuZWFjaChhUmVzcG9uc2UuZXJyb3JNZXNzYWdlLmVycm9yLCBmdW5jdGlvbigpIHtcbiAgICAgICAgTG9nZ2VyLmVycm9yKFwiU3ltYmFuQXBpIEVycm9yOiBcIiArIHRoaXMuZXJyb3JJZCArIFwiIC0gXCIgKyB0aGlzLmxvbmdNZXNzYWdlKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9LFxuXG5cbiAgLyoqXG4gICAqIEZsYXR0ZW5zIHRoZSBwYXJhbWV0ZXJzIHRvIGJlIGluY2x1ZGVkIG9uIHRoZSByZXF1ZXN0LlxuICAgKiBAcGFyYW0gYVBhcmFtZXRlcnMgdGhlIG9iamVjdCB3aXRoIHRoZSBwYXJhbWV0ZXJzIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgX2ZsYXR0ZW5QYXJhbWV0ZXJzIDogZnVuY3Rpb24oYVBhcmFtZXRlcnMpIHtcbiAgICB2YXIgdW5mbGF0dGVuZWQgPSBbXTtcbiAgICB2YXIgcGFyYW1ldGVyU3RyaW5nID0gXCJcIjtcblxuICAgIC8vIGZsYXR0ZW4gdGhlIHBhcmFtZXRlcnMgb2JqZWN0IGludG8gYSBzdHJpbmcgZm9yIGluY2x1c2lvbiBpbiB0aGUgVVJJXG4gICAgJC5lYWNoKGFQYXJhbWV0ZXJzLCBmdW5jdGlvbihhTmFtZSwgYVZhbHVlKSB7XG4gICAgICB1bmZsYXR0ZW5lZC5wdXNoKHsgbmFtZTogYU5hbWUsIHZhbHVlOiBhVmFsdWV9KTtcbiAgICB9KTtcbiAgICB3aGlsZSAodW5mbGF0dGVuZWQubGVuZ3RoID4gMCkge1xuICAgICAgdmFyIGVudHJ5ID0gdW5mbGF0dGVuZWQuc2hpZnQoKTtcbiAgICAgIGlmICh0eXBlb2YoZW50cnkudmFsdWUpICE9IFwib2JqZWN0XCIpIHtcbiAgICAgICAgLy8gQmFzZSB0eXBlXG4gICAgICAgIHBhcmFtZXRlclN0cmluZyArPSBcIiZcIiArIGVudHJ5Lm5hbWUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgXCI9XCIgKyBlbmNvZGVVUklDb21wb25lbnQoZW50cnkudmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKCQuaXNBcnJheShlbnRyeS52YWx1ZSkpIHtcbiAgICAgICAgICAvLyBhcnJheVxuICAgICAgICAgICQuZWFjaChlbnRyeS52YWx1ZSwgZnVuY3Rpb24oYUluZGV4LCBhTmV3RW50cnlWYWx1ZSkge1xuICAgICAgICAgICAgdmFyIG5ld0VudHJ5ID0ge307XG4gICAgICAgICAgICBuZXdFbnRyeS5uYW1lID0gZW50cnkubmFtZSArIFwiKFwiICsgYUluZGV4ICsgXCIpXCI7XG4gICAgICAgICAgICBuZXdFbnRyeS52YWx1ZSA9IGFOZXdFbnRyeVZhbHVlO1xuICAgICAgICAgICAgdW5mbGF0dGVuZWQuc3BsaWNlKGFJbmRleCwgMCwgbmV3RW50cnkpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIE9iamVjdFxuICAgICAgICAgIHZhciBpID0gMDtcbiAgICAgICAgICAkLmVhY2goZW50cnkudmFsdWUsIGZ1bmN0aW9uKGFOZXdFbnRyeU5hbWUsIGFOZXdFbnRyeVZhbHVlKSB7XG4gICAgICAgICAgICB2YXIgbmV3RW50cnkgPSB7fTtcbiAgICAgICAgICAgIG5ld0VudHJ5Lm5hbWUgPSBlbnRyeS5uYW1lICsgXCIuXCIgKyBhTmV3RW50cnlOYW1lO1xuICAgICAgICAgICAgbmV3RW50cnkudmFsdWUgPSBhTmV3RW50cnlWYWx1ZTtcbiAgICAgICAgICAgIHVuZmxhdHRlbmVkLnNwbGljZShpKyssIDAsIG5ld0VudHJ5KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBwYXJhbWV0ZXJTdHJpbmc7XG4gIH0sXG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBwYXJhbWV0ZXJzIHN0cmluZyB0byBiZSBzZW50IHRvIHRoZSBhamF4IFBVVCByZXF1ZXN0IHNvIHdlIGNhblxuICAgKiBtYXJrIGFzIHJlYWQgdGhlIG5vdGlmaWNhdGlvbiB3aXRoIG5vdGlmaWNhdGlvbklkLlxuICAgKiBAcGFyYW0gYVBhcmFtZXRlcnMgdGhlIHBhcmFtZXRlcnMgZm9yIHRoZSByZXF1ZXN0LlxuICAgKi9cbiAgX2NyZWF0ZVB1dFBhcmFtZXRlcnNTdHJpbmcgOiBmdW5jdGlvbihhUGFyYW1ldGVycykge1xuICAgIHZhciBwYXJhbXM7XG4gICAgdmFyIHR5cGUgPSBhUGFyYW1ldGVycy50eXBlO1xuXG4gICAgc3dpdGNoKHR5cGUpIHtcbiAgICBjYXNlIHRoaXMuVVBEQVRFUy5SRUFEOlxuICAgICAgICBwYXJhbXMgPSB7XG4gICAgICAgICAgbm90aWZpY2F0aW9uOiBbXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIG5vdGlmaWNhdGlvbklkOiBhUGFyYW1ldGVycy5ub3RpZmljYXRpb25JZCxcbiAgICAgICAgICAgICAgc3RhdHVzOiBcIlJFQURcIlxuICAgICAgICAgICAgfVxuICAgICAgICAgIF1cbiAgICAgICAgfTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHRoaXMuVVBEQVRFUy5SRUFEX0FMTDpcbiAgICAgICAgcGFyYW1zID0ge1xuICAgICAgICAgIGV4dGVuc2lvbjogW10sXG4gICAgICAgICAgbm90aWZpY2F0aW9uOiBbXSxcbiAgICAgICAgICBtYXJrQWxsUmVhZDogdHJ1ZVxuICAgICAgICB9O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgdGhpcy5VUERBVEVTLkRFTEVURTpcbiAgICAgICAgcGFyYW1zID0ge1xuICAgICAgICAgIG5vdGlmaWNhdGlvbjogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBub3RpZmljYXRpb25JZDogYVBhcmFtZXRlcnMubm90aWZpY2F0aW9uSWQsXG4gICAgICAgICAgICAgIHN0YXR1czogXCJERUxFVEVEXCJcbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdXG4gICAgICAgIH07XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSB0aGlzLlVQREFURVMuREVMRVRFX0FMTDpcbiAgICAgICAgcGFyYW1zID0ge1xuICAgICAgICAgIGV4dGVuc2lvbjogW10sXG4gICAgICAgICAgbm90aWZpY2F0aW9uOiBbXSxcbiAgICAgICAgICBtYXJrQWxsRGVsZXRlOiB0cnVlXG4gICAgICAgIH07XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICAvLyBQYXJhbWV0ZXIgdXNlZCBieSBhbGwgcmVxdWVzdHMuXG4gICAgcGFyYW1zLmxhc3RSZXRyaWV2YWxUaW1lID0gYVBhcmFtZXRlcnMubGFzdFJldHJpZXZhbFRpbWU7XG5cbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkocGFyYW1zKTtcbiAgfSxcblxuICAvKioqXG4gICAqIENoZWNrcyBpZiB0aGUgdXNlciB0b2tlbiBoYXMgZXhwaXJlZC5cbiAgICogQHBhcmFtIGFYSFIgdGhlIHJlc3BvbnNlIGZyb20gdGhlIGFwaSBjYWxsLlxuICAgKi9cbiAgX2NoZWNrVG9rZW5FeHBpcmVkIDogZnVuY3Rpb24oYVhIUikge1xuICAgIGlmIChhWEhSICYmIGFYSFIucmVzcG9uc2VKU09OKSB7XG4gICAgICBpZigoYVhIUi5yZXNwb25zZUpTT04uZXJyb3JNZXNzYWdlICYmXG4gICAgICAgIGFYSFIucmVzcG9uc2VKU09OLmVycm9yTWVzc2FnZS5lcnJvclswXSAmJlxuICAgICAgICBhWEhSLnJlc3BvbnNlSlNPTi5lcnJvck1lc3NhZ2UuZXJyb3JbMF0uZXJyb3JJZCAmJlxuICAgICAgICBhWEhSLnJlc3BvbnNlSlNPTi5lcnJvck1lc3NhZ2UuZXJyb3JbMF0uZXJyb3JJZC50b1N0cmluZygpID09IFwiMTAwMVwiKSB8fFxuICAgICAgICAoYVhIUi5yZXNwb25zZUpTT04uZXJyb3JfY29kZSAmJlxuICAgICAgICBhWEhSLnJlc3BvbnNlSlNPTi5lcnJvcl9jb2RlID09IFwiaW52YWxpZF90b2tlblwiKSkge1xuICAgICAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoVG9waWNzLlVTRVJfVE9LRU5fRVhQSVJFRCwgbnVsbCk7XG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKiBQZXJmb3JtcyBTeW1iYW4gQVBJIGNhbGwuXG4gICAqIEBwYXJhbSBhUmVxdWVzdE5hbWUgdGhlIG5hbWUgb2YgdGhlIHJlcXVlc3Q6IHB1bGwgfCBwdWJsaXNoIHwgdXBkYXRlLlxuICAgKiBAcGFyYW0gYVBhcmFtZXRlcnMgb2JqZWN0IHdpdGggcGFyYW1ldGVycyB0byBhZGQgdG8gdGhlIGNhbGwuXG4gICAqIEBwYXJhbSBhQ2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uLlxuICAgKiBAcmV0dXJucyByZXF1ZXN0IG9iamVjdC5cbiAgICovXG4gIF9kb0NhbGwgOiBmdW5jdGlvbihhUmVxdWVzdE5hbWUsIGFQYXJhbWV0ZXJzLCBhQ2FsbGJhY2spIHtcbiAgICBcbiAgICB2YXIgdXJsID0gQXBpSGVscGVyLmdldEVuZFBvaW50KFwic3ltYmFuQXBpXCIpO1xuICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICB2YXIgYWNjb3VudCA9IEFjY291bnQuZ2V0QWNjb3VudCgpO1xuICAgIHZhciBwYXJhbWV0ZXJTdHJpbmc7XG4gICAgdmFyIHJlcXVlc3Q7XG4gICAgdmFyIHJlcXVlc3RUeXBlO1xuXG4gICAgc3dpdGNoKGFSZXF1ZXN0TmFtZSkge1xuICAgICAgY2FzZSBTeW1iYW5BcGkuUkVRVUVTVF9UWVBFUy5QVUJMSVNIOlxuICAgICAgICByZXF1ZXN0VHlwZSA9IFwiUE9TVFwiO1xuICAgICAgICBwYXJhbWV0ZXJTdHJpbmcgPSB0aGlzLl9mbGF0dGVuUGFyYW1ldGVycyhhUGFyYW1ldGVycyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBTeW1iYW5BcGkuUkVRVUVTVF9UWVBFUy5VUERBVEU6XG4gICAgICAgIHJlcXVlc3RUeXBlID0gXCJQVVRcIjtcbiAgICAgICAgcGFyYW1ldGVyU3RyaW5nID0gdGhpcy5fY3JlYXRlUHV0UGFyYW1ldGVyc1N0cmluZyhhUGFyYW1ldGVycyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBTeW1iYW5BcGkuUkVRVUVTVF9UWVBFUy5QVUxMOlxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmVxdWVzdFR5cGUgPSBcIkdFVFwiO1xuICAgICAgICBpZiAoYVBhcmFtZXRlcnMgJiYgXCJhcGlQYXRoXCIgaW4gYVBhcmFtZXRlcnMpIHtcbiAgICAgICAgICB2YXIgYXJyID0gdXJsLnNwbGl0KFwiL1wiKTtcbiAgICAgICAgICB1cmwgPSBhcnJbMF0gKyBcIi8vXCIgKyBhcnJbMl0gKyAgYVBhcmFtZXRlcnMuYXBpUGF0aDtcbiAgICAgICAgICBkZWxldGUgYVBhcmFtZXRlcnMuYXBpUGF0aDtcbiAgICAgICAgfVxuICAgICAgICBwYXJhbWV0ZXJTdHJpbmcgPSB0aGlzLl9mbGF0dGVuUGFyYW1ldGVycyhhUGFyYW1ldGVycyk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHJlcXVlc3QgPVxuICAgICAgJC5hamF4KHtcbiAgICAgICAgYmVmb3JlU2VuZDogZnVuY3Rpb24oYVhIUikge1xuICAgICAgICAgIGFYSFIuc2V0UmVxdWVzdEhlYWRlcihcbiAgICAgICAgICAgIFwiQ29udGVudC1UeXBlXCIsIFwiYXBwbGljYXRpb24vanNvblwiKTtcbiAgICAgICAgICBhWEhSLnNldFJlcXVlc3RIZWFkZXIoXG4gICAgICAgICAgICBcIkFjY2VwdFwiLCBcImFwcGxpY2F0aW9uL2pzb25cIik7XG4gICAgICAgICAgYVhIUi5zZXRSZXF1ZXN0SGVhZGVyKFwiQWNjZXB0LUxhbmd1YWdlXCIsXG4gICAgICAgICAgICBVdGlsaXR5SGVscGVyLmdldEJyb3dzZXJMYW5ndWFnZSgpKTtcbiAgICAgICAgICBpZiAoYWNjb3VudCAmJiBhY2NvdW50LmdldChcInRva2VuXCIpKSB7XG4gICAgICAgICAgICBhWEhSLnNldFJlcXVlc3RIZWFkZXIoXG4gICAgICAgICAgICAgIFwiQXV0aG9yaXphdGlvblwiLCBcImJlYXJlciBcIiArIGFjY291bnQuZ2V0KFwidG9rZW5cIikpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgdHlwZTogcmVxdWVzdFR5cGUsXG4gICAgICAgIHVybDogdXJsLFxuICAgICAgICBkYXRhOiBwYXJhbWV0ZXJTdHJpbmcsXG4gICAgICAgIGRhdGFUeXBlOiBcImpzb25cIixcbiAgICAgICAganNvbnA6IGZhbHNlLFxuICAgICAgICB0aW1lb3V0OiBQcm9wZXJ0eURBTy5nZXQoUHJvcGVydHlEQU8uUFJPUF9BUElfVElNRU9VVCksXG4gICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGFEYXRhLCBhVGV4dFN0YXR1cykge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoIXRoYXQuX3ZhbGlkYXRlUmVzcG9uc2UoYURhdGEpKSB7XG4gICAgICAgICAgICAgIGFEYXRhID0gbnVsbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIE1lc3NhZ2VQYW5lbFNlcnZpY2UuZGlzbWlzc01lc3NhZ2UoTWVzc2FnZVBhbmVsU2VydmljZS5UWVBFLkNPTk5FQ1RfRVJST1IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFDYWxsYmFjaykge1xuICAgICAgICAgICAgICBhQ2FsbGJhY2soYURhdGEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICAgICAgVXRpbGl0eUhlbHBlci5oYW5kbGVFcnJvcihcIlN5bWJhbkFwaVwiLCBhUmVxdWVzdE5hbWUsIGUubWVzc2FnZSwgYUNhbGxiYWNrKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yOiBmdW5jdGlvbihhWEhSLCBhVGV4dFN0YXR1cywgYUVycm9yKSB7XG4gICAgICAgICAgLy9jaGVjayBpZiB0aGUgdG9rZW4gaGFzIGV4cGlyZWQuIFNpZ24gb3V0IHRoZSB1c2VyIGlmIHllcy5cbiAgICAgICAgICBTeW1iYW5BcGkuX2NoZWNrVG9rZW5FeHBpcmVkKGFYSFIpO1xuICAgICAgICAgIFV0aWxpdHlIZWxwZXIuaGFuZGxlRXJyb3IoXCJTeW1iYW5BcGlcIiwgYVJlcXVlc3ROYW1lLCBhWEhSLnJlc3BvbnNlVGV4dCwgYUNhbGxiYWNrKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAvLyBhZGQgcGVuZGluZyByZXF1ZXN0IHRvIGEgbGlzdCBzbyBwZW5kaW5nIHJlcXVlc3Qgd291bGQgYmUgY2FuY2VsbGVkIGZvclxuICAgIC8vIGEgbG9uZyBwZXJpb2Qgb2YgdGltZSBhbmQgYWxzbyBhbGwgcGVuZGluZyByZXF1ZXN0cyBjYW4gYmUgYWJvcnRlZCB3aGVuXG4gICAgLy8gdXNlciBzaWducyBvdXQuXG4gICAgQXBpSGVscGVyLmFkZFBlbmRpbmdSZXF1ZXN0KHJlcXVlc3QsIGFSZXF1ZXN0TmFtZSwgVG9waWNzLlNZTUJBTl9EQVRBX1VQREFURUQpO1xuXG4gICAgcmV0dXJuIHJlcXVlc3Q7XG4gIH1cbn07XG4iXX0=