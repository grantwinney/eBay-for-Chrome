/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var MyEbayApplicationApi = {
    _XML_HEADER: "<?xml version=\"1.0\" encoding=\"utf-8\"?>",
    _XML_NAMESPACE: "xmlns=\"http://www.ebay.com/marketplace/mobile/v1/services\"",
    removeFromDidntWinList: function (aToken, aItems, aSiteId, aCallback) {
        if (!aToken) {
            Logger.error("Attempt to make MyEbayApplication API " +
                "removeFromDidntWinList call when no account is active.");
            return;
        }
        var wrappedBody;
        var localCallback;
        var request;
        var innerBody = "";
        $.each(aItems, function (aIndex, aItem) {
            innerBody += "<itemID>" + aItem.itemId + "</itemID>";
        });
        wrappedBody = this._wrapCall("removeFromDidntWinList", innerBody);
        localCallback = function (aResponse) {
            var result = {};
            try {
                if (aCallback) {
                    if (!aResponse) {
                        result.errors = true;
                    }
                    aCallback(result);
                }
            }
            catch (e) {
                Logger.error("MyEbayApplicationApi.removeFromDidntWinList Error: " + e.message);
            }
        };
        request = this._doCall(wrappedBody, aSiteId, localCallback, aToken);
        return request;
    },
    removeFromWonList: function (aToken, aItems, aSiteId, aCallback) {
        if (!aToken) {
            Logger.error("Attempt to make MyEbayApplication API removeFromWonList " +
                "call when no account is active.");
            return;
        }
        var wrappedBody;
        var localCallback;
        var request;
        var innerBody = "";
        $.each(aItems, function (aIndex, aItem) {
            innerBody +=
                "<item>" +
                    "<itemID>" + aItem.itemId + "</itemID>" +
                    "<transactionID>" + aItem.transactionId + "</transactionID>" +
                    "</item>";
        });
        wrappedBody = this._wrapCall("removeFromWonList", innerBody);
        localCallback = function (aResponse) {
            var result = {};
            try {
                if (aCallback) {
                    if (!aResponse) {
                        result.errors = true;
                    }
                    aCallback(result);
                }
            }
            catch (e) {
                Logger.error("MyEbayApplicationApi.removeFromWonList Error: " + e.message);
            }
        };
        request = this._doCall(wrappedBody, aSiteId, localCallback, aToken);
        return request;
    },
    removeFromUnsoldList: function (aToken, aItems, aSiteId, aCallback) {
        if (!aToken) {
            Logger.error("Attempt to make MyEbayApplication API " +
                "removeFromUnsoldList call when no account is active.");
            return;
        }
        var wrappedBody;
        var localCallback;
        var request;
        var innerBody = "";
        $.each(aItems, function (aIndex, aItem) {
            innerBody += "<itemID>" + aItem.itemId + "</itemID>";
        });
        wrappedBody = this._wrapCall("removeFromUnsoldList", innerBody);
        localCallback = function (aResponse) {
            var result = {};
            try {
                if (aCallback) {
                    if (!aResponse) {
                        result.errors = true;
                    }
                    aCallback(result);
                }
            }
            catch (e) {
                Logger.error("MyEbayApplicationApi.removeFromUnsoldList Error: " + e.message);
            }
        };
        request = this._doCall(wrappedBody, aSiteId, localCallback, aToken);
        return request;
    },
    removeFromSoldList: function (aToken, aItems, aSiteId, aCallback) {
        if (!aToken) {
            Logger.error("Attempt to make MyEbayApplication API removeFromSoldList " +
                "call when no account is active.");
            return;
        }
        var wrappedBody;
        var localCallback;
        var request;
        var innerBody = "";
        $.each(aItems, function (aIndex, aItem) {
            innerBody +=
                "<item>" +
                    "<itemID>" + aItem.itemId + "</itemID>" +
                    "<transactionID>" + aItem.transactionId + "</transactionID>" +
                    "</item>";
        });
        wrappedBody = this._wrapCall("removeFromSoldList", innerBody, aToken);
        localCallback = function (aResponse) {
            var result = {};
            try {
                if (aCallback) {
                    if (!aResponse) {
                        result.errors = true;
                    }
                    aCallback(result);
                }
            }
            catch (e) {
                Logger.error("MyEbayApplicationApi.removeFromSoldList Error: " + e.message);
            }
        };
        request = this._doCall(wrappedBody, aSiteId, localCallback, aToken);
        return request;
    },
    _validateResponse: function (aResponse) {
        if (!aResponse) {
            Logger.error("MyEbayApplicationApi error (no reponse document!)");
            return false;
        }
        var node = $(aResponse).find("Ack");
        if (!node) {
            Logger.error("MyEbayApplicationApi error (no Ack node!)");
            return false;
        }
        if ($(node).text() != "Success") {
            $.each($(aResponse).find("error"), function () {
                var errorCode = Number($(this).find("errorId").text());
                var severity = String($(this).find("severity").text());
                if (severity.indexOf("Error") != -1) {
                    Logger.error("MyEbayApplication API Error:\n" + "Error Code: " +
                        errorCode + "\Message: " +
                        String($(this).find("message").text()) +
                        "\nSeverity: " + severity +
                        "\nError category: " +
                        String($(this).find("category").text()) + "\n");
                    var responseName = "";
                    try {
                        responseName = $(aResponse).children(":first").prop("tagName");
                        responseName = /(.*)Response/.exec(responseName)[1];
                    }
                    catch (e) { }
                }
                return false;
            });
        }
        return true;
    },
    _wrapCall: function (aRequestName, aInnerBody) {
        var wrappedBody = this._XML_HEADER +
            "<" + aRequestName + "Request " + this._XML_NAMESPACE + ">" +
            aInnerBody +
            "</" + aRequestName + "Request>";
        return wrappedBody;
    },
    _doCall: function (aRequestBody, aSiteId, aCallback, aToken) {
        var that = this;
        var requestName;
        var request;
        try {
            requestName = /><(.*?)Request/.exec(aRequestBody)[1];
        }
        catch (e) {
            Logger.error("MyEbayApplication API request will not be sent, as it is" +
                " badly-formed. \n" + aRequestBody);
            return null;
        }
        request =
            $.ajax({
                beforeSend: function (aXHR) {
                    aXHR.setRequestHeader("X-EBAY-SOA-SERVICE-NAME", "MyEbayApplicationService");
                    aXHR.setRequestHeader("X-EBAY-SOA-OPERATION-NAME", requestName);
                    aXHR.setRequestHeader("X-EBAY-SOA-SECURITY-TOKEN", aToken);
                    aXHR.setRequestHeader("X-EBAY-SOA-SECURITY-APPNAME", ApiHelper.getEndPoint("clientId"));
                    aXHR.setRequestHeader("X-EBAY-SIDEBAR-VERSION", BrowserHelper.getExtensionVersion());
                },
                type: "POST",
                contentType: "text/xml",
                url: ApiHelper.getEndPoint("myeBayApplicationApi"),
                data: aRequestBody,
                dataType: "xml",
                jsonp: false,
                timeout: PropertyDAO.get(PropertyDAO.PROP_API_TIMEOUT),
                success: function (aData, aTextStatus) {
                    try {
                        if (aTextStatus == "success") {
                            if (!that._validateResponse(aData)) {
                                aData = null;
                            }
                            else {
                                MessagePanelService.dismissMessage(MessagePanelService.TYPE.CONNECT_ERROR);
                            }
                            if (aCallback) {
                                aCallback(aData);
                            }
                        }
                    }
                    catch (e) {
                        UtilityHelper.handleError("MyEbayApplicationApi", requestName, e.message, aCallback);
                    }
                },
                error: function (aXHR, aTextStatus, aError) {
                    UtilityHelper.handleError("MyEbayApplicationApi", requestName, aXHR.responseText, aCallback);
                }
            });
        ApiHelper.addPendingRequest(request, requestName);
        return request;
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXlFYmF5QXBwbGljYXRpb25BcGkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9iYWNrZ3JvdW5kL2NvcmUvYXBpcy9teUViYXlBcHBsaWNhdGlvbkFwaS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQWNILElBQUksb0JBQW9CLEdBQUc7SUFDekIsV0FBVyxFQUFHLDRDQUE0QztJQUMxRCxjQUFjLEVBQUcsOERBQThEO0lBVS9FLHNCQUFzQixFQUFHLFVBQVMsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsU0FBUztRQUVsRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDWixNQUFNLENBQUMsS0FBSyxDQUFDLHdDQUF3QztnQkFDeEMsd0RBQXdELENBQUMsQ0FBQztZQUN2RSxNQUFNLENBQUM7UUFDVCxDQUFDO1FBRUQsSUFBSSxXQUFXLENBQUM7UUFDaEIsSUFBSSxhQUFhLENBQUM7UUFDbEIsSUFBSSxPQUFPLENBQUM7UUFDWixJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFFbkIsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsVUFBUyxNQUFNLEVBQUUsS0FBSztZQUNuQyxTQUFTLElBQUksVUFBVSxHQUFHLEtBQUssQ0FBQyxNQUFNLEdBQUcsV0FBVyxDQUFDO1FBQ3ZELENBQUMsQ0FBQyxDQUFDO1FBR0gsV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsd0JBQXdCLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDbEUsYUFBYSxHQUFHLFVBQVMsU0FBUztZQUNoQyxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7WUFFaEIsSUFBSSxDQUFDO2dCQUNILEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7b0JBQ2QsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO3dCQUNmLE1BQU0sQ0FBQyxNQUFNLEdBQUcsSUFBSSxD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LENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDOzRCQUM3RSxDQUFDOzRCQUNELEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0NBQ2QsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDOzRCQUNuQixDQUFDO3dCQUNILENBQUM7b0JBQ0gsQ0FBQztvQkFBQyxLQUFLLENBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUNWLGFBQWEsQ0FBQyxXQUFXLENBQUMsc0JBQXNCLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUM7b0JBQ3ZGLENBQUM7Z0JBQ0gsQ0FBQztnQkFDRCxLQUFLLEVBQUUsVUFBUyxJQUFJLEVBQUUsV0FBVyxFQUFFLE1BQU07b0JBQ3ZDLGFBQWEsQ0FBQyxXQUFXLENBQUMsc0JBQXNCLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsU0FBUyxDQUFDLENBQUM7Z0JBQy9GLENBQUM7YUFDRixDQUFDLENBQUM7UUFLTCxTQUFTLENBQUMsaUJBQWlCLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBRWxELE1BQU0sQ0FBQyxPQUFPLENBQUM7SUFDakIsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIENvcHlyaWdodCAoQykgMjAwNy0yMDE1IGVCYXkgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICovXG5cbi8qXG4gIHZhciBMb2dnZXIgPSByZXF1aXJlKFwiaGVscGVycy9sb2dnZXJcIikuTG9nZ2VyO1xuICB2YXIgQnJvd3NlckhlbHBlciA9IHJlcXVpcmUoXCJjb3JlL2hlbHBlcnMvYnJvd3NlckhlbHBlclwiKS5Ccm93c2VySGVscGVyO1xuICB2YXIgVXRpbGl0eUhlbHBlciA9IHJlcXVpcmUoXCJoZWxwZXJzL3V0aWxpdHlIZWxwZXJcIikuVXRpbGl0eUhlbHBlcjtcbiAgdmFyIEFwaUhlbHBlciA9IHJlcXVpcmUoXCJjb3JlL2hlbHBlcnMvYXBpSGVscGVyXCIpLkFwaUhlbHBlcjtcbiAgdmFyIE1lc3NhZ2VQYW5lbFNlcnZpY2UgPSByZXF1aXJlKFwiY29yZS9zZXJ2aWNlcy9tZXNzYWdlUGFuZWxTZXJ2aWNlXCIpLk1lc3NhZ2VQYW5lbFNlcnZpY2U7XG4gIHZhciBQcm9wZXJ0eURBTyA9IHJlcXVpcmUoXCJzdG9yYWdlL3Byb3BlcnR5REFPXCIpLlByb3BlcnR5REFPO1xuKi9cblxuLyoqXG4gKiBNeUViYXlBcHBsaWNhdGlvbiBBUEkgYWN0aW9uc1xuICovXG52YXIgTXlFYmF5QXBwbGljYXRpb25BcGkgPSB7XG4gIF9YTUxfSEVBREVSIDogXCI8P3htbCB2ZXJzaW9uPVxcXCIxLjBcXFwiIGVuY29kaW5nPVxcXCJ1dGYtOFxcXCI/PlwiLFxuICBfWE1MX05BTUVTUEFDRSA6IFwieG1sbnM9XFxcImh0dHA6Ly93d3cuZWJheS5jb20vbWFya2V0cGxhY2UvbW9iaWxlL3YxL3NlcnZpY2VzXFxcIlwiLFxuXG4gIC8qKlxuICAgKiBNeUViYXlBcHBsaWNhdGlvbiBBUEkgcmVtb3ZlRnJvbURpZG50V2luTGlzdFxuICAgKiBAcGFyYW0gYVRva2VuIHRoZSB0b2tlbiB0byB1c2UgaW4gdGhlIHJlcXVlc3QuXG4gICAqIEBwYXJhbSBhSXRlbXMgdGhlIGFycmF5IG9mIGl0ZW1zIHRvIGJlIHJlbW92ZWQuXG4gICAqIEBwYXJhbSBhU2l0ZUlkIFRoZSBzaXRlIGlkXG4gICAqIEBwYXJhbSBhQ2FsbGJhY2suXG4gICAqIEByZXR1cm5zIHJlcXVlc3Qgb2JqZWN0XG4gICAqL1xuICByZW1vdmVGcm9tRGlkbnRXaW5MaXN0IDogZnVuY3Rpb24oYVRva2VuLCBhSXRlbXMsIGFTaXRlSWQsIGFDYWxsYmFjaykge1xuICAgIFxuICAgIGlmICghYVRva2VuKSB7XG4gICAgICBMb2dnZXIuZXJyb3IoXCJBdHRlbXB0IHRvIG1ha2UgTXlFYmF5QXBwbGljYXRpb24gQVBJIFwiICtcbiAgICAgICAgICAgICAgICAgICBcInJlbW92ZUZyb21EaWRudFdpbkxpc3QgY2FsbCB3aGVuIG5vIGFjY291bnQgaXMgYWN0aXZlLlwiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB2YXIgd3JhcHBlZEJvZHk7XG4gICAgdmFyIGxvY2FsQ2FsbGJhY2s7XG4gICAgdmFyIHJlcXVlc3Q7XG4gICAgdmFyIGlubmVyQm9keSA9IFwiXCI7XG5cbiAgICAkLmVhY2goYUl0ZW1zLCBmdW5jdGlvbihhSW5kZXgsIGFJdGVtKSB7XG4gICAgICBpbm5lckJvZHkgKz0gXCI8aXRlbUlEPlwiICsgYUl0ZW0uaXRlbUlkICsgXCI8L2l0ZW1JRD5cIjtcbiAgICB9KTtcblxuICAgIC8vIGRvIHRoZSBjYWxsXG4gICAgd3JhcHBlZEJvZHkgPSB0aGlzLl93cmFwQ2FsbChcInJlbW92ZUZyb21EaWRudFdpbkxpc3RcIiwgaW5uZXJCb2R5KTtcbiAgICBsb2NhbENhbGxiYWNrID0gZnVuY3Rpb24oYVJlc3BvbnNlKSB7XG4gICAgICB2YXIgcmVzdWx0ID0ge307XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGlmIChhQ2FsbGJhY2spIHtcbiAgICAgICAgICBpZiAoIWFSZXNwb25zZSkge1xuICAgICAgICAgICAgcmVzdWx0LmVycm9ycyA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGFDYWxsYmFjayhyZXN1bHQpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIExvZ2dlci5lcnJvcihcIk15RWJheUFwcGxpY2F0aW9uQXBpLnJlbW92ZUZyb21EaWRudFdpbkxpc3QgRXJyb3I6IFwiICsgZS5tZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgcmVxdWVzdCA9IHRoaXMuX2RvQ2FsbCh3cmFwcGVkQm9keSwgYVNpdGVJZCwgbG9jYWxDYWxsYmFjaywgYVRva2VuKTtcblxuICAgIHJldHVybiByZXF1ZXN0O1xuICB9LFxuXG4gIC8qKlxuICAgKiBNeUViYXlBcHBsaWNhdGlvbkFwaSBBUEkgcmVtb3ZlRnJvbVdvbkxpc3RcbiAgICogQHBhcmFtIGFUb2tlbiB0aGUgdG9rZW4gdG8gdXNlIGluIHRoZSByZXF1ZXN0XG4gICAqIEBwYXJhbSBhSXRlbXMgdGhlIGFycmF5IG9mIGl0ZW1zIHRvIGJlIHJlbW92ZWQuXG4gICAqIEBwYXJhbSBhU2l0ZUlkIFRoZSBzaXRlIGlkXG4gICAqIEBwYXJhbSBhQ2FsbGJhY2tcbiAgICogQHJldHVybnMgcmVxdWVzdCBvYmplY3RcbiAgICovXG4gIHJlbW92ZUZyb21Xb25MaXN0IDogZnVuY3Rpb24oYVRva2VuLCBhSXRlbXMsIGFTaXRlSWQsIGFDYWxsYmFjaykge1xuICAgIFxuICAgIGlmICghYVRva2VuKSB7XG4gICAgICBMb2dnZXIuZXJyb3IoXCJBdHRlbXB0IHRvIG1ha2UgTXlFYmF5QXBwbGljYXRpb24gQVBJIHJlbW92ZUZyb21Xb25MaXN0IFwiICtcbiAgICAgICAgICAgICAgICAgICBcImNhbGwgd2hlbiBubyBhY2NvdW50IGlzIGFjdGl2ZS5cIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdmFyIHdyYXBwZWRCb2R5O1xuICAgIHZhciBsb2NhbENhbGxiYWNrO1xuICAgIHZhciByZXF1ZXN0O1xuICAgIHZhciBpbm5lckJvZHkgPSBcIlwiO1xuXG4gICAgJC5lYWNoKGFJdGVtcywgZnVuY3Rpb24oYUluZGV4LCBhSXRlbSkge1xuICAgICAgaW5uZXJCb2R5ICs9XG4gICAgICAgIFwiPGl0ZW0+XCIgK1xuICAgICAgICBcIjxpdGVtSUQ+XCIgKyBhSXRlbS5pdGVtSWQgKyBcIjwvaXRlbUlEPlwiICtcbiAgICAgICAgXCI8dHJhbnNhY3Rpb25JRD5cIiArIGFJdGVtLnRyYW5zYWN0aW9uSWQgKyBcIjwvdHJhbnNhY3Rpb25JRD5cIiArXG4gICAgICAgIFwiPC9pdGVtPlwiO1xuICAgIH0pO1xuXG4gICAgLy8gZG8gdGhlIGNhbGxcbiAgICB3cmFwcGVkQm9keSA9IHRoaXMuX3dyYXBDYWxsKFwicmVtb3ZlRnJvbVdvbkxpc3RcIiwgaW5uZXJCb2R5KTtcbiAgICBsb2NhbENhbGxiYWNrID0gZnVuY3Rpb24oYVJlc3BvbnNlKSB7XG4gICAgICB2YXIgcmVzdWx0ID0ge307XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGlmIChhQ2FsbGJhY2spIHtcbiAgICAgICAgICBpZiAoIWFSZXNwb25zZSkge1xuICAgICAgICAgICAgcmVzdWx0LmVycm9ycyA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGFDYWxsYmFjayhyZXN1bHQpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIExvZ2dlci5lcnJvcihcIk15RWJheUFwcGxpY2F0aW9uQXBpLnJlbW92ZUZyb21Xb25MaXN0IEVycm9yOiBcIiArIGUubWVzc2FnZSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHJlcXVlc3QgPSB0aGlzLl9kb0NhbGwod3JhcHBlZEJvZHksIGFTaXRlSWQsIGxvY2FsQ2FsbGJhY2ssIGFUb2tlbik7XG5cbiAgICByZXR1cm4gcmVxdWVzdDtcbiAgfSxcblxuXG4gIC8qKlxuICAgKiBNeUViYXlBcHBsaWNhdGlvbiBBUEkgcmVtb3ZlRnJvbVVuc29sZExpc3RcbiAgICogQHBhcmFtIGFUb2tlbiB0aGUgdG9rZW4gdG8gdXNlIGluIHRoZSByZXF1ZXN0XG4gICAqIEBwYXJhbSBhSXRlbXMgdGhlIGFycmF5IG9mIGl0ZW1zIHRvIGJlIHJlbW92ZWQuXG4gICAqIEBwYXJhbSBhU2l0ZUlkIFRoZSBzaXRlIGlkXG4gICAqIEBwYXJhbSBhQ2FsbGJhY2suXG4gICAqIEByZXR1cm5zIHJlcXVlc3Qgb2JqZWN0XG4gICAqL1xuICByZW1vdmVGcm9tVW5zb2xkTGlzdCA6IGZ1bmN0aW9uKGFUb2tlbiwgYUl0ZW1zLCBhU2l0ZUlkLCBhQ2FsbGJhY2spIHtcbiAgICBcbiAgICBpZiAoIWFUb2tlbikge1xuICAgICAgTG9nZ2VyLmVycm9yKFwiQXR0ZW1wdCB0byBtYWtlIE15RWJheUFwcGxpY2F0aW9uIEFQSSBcIiArXG4gICAgICAgICAgICAgICAgICAgXCJyZW1vdmVGcm9tVW5zb2xkTGlzdCBjYWxsIHdoZW4gbm8gYWNjb3VudCBpcyBhY3RpdmUuXCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHZhciB3cmFwcGVkQm9keTtcbiAgICB2YXIgbG9jYWxDYWxsYmFjaztcbiAgICB2YXIgcmVxdWVzdDtcbiAgICB2YXIgaW5uZXJCb2R5ID0gXCJcIjtcblxuICAgICQuZWFjaChhSXRlbXMsIGZ1bmN0aW9uKGFJbmRleCwgYUl0ZW0pIHtcbiAgICAgIGlubmVyQm9keSArPSBcIjxpdGVtSUQ+XCIgKyBhSXRlbS5pdGVtSWQgKyBcIjwvaXRlbUlEPlwiO1xuICAgIH0pO1xuXG4gICAgLy8gZG8gdGhlIGNhbGxcbiAgICB3cmFwcGVkQm9keSA9IHRoaXMuX3dyYXBDYWxsKFwicmVtb3ZlRnJvbVVuc29sZExpc3RcIiwgaW5uZXJCb2R5KTtcbiAgICBsb2NhbENhbGxiYWNrID0gZnVuY3Rpb24oYVJlc3BvbnNlKSB7XG4gICAgICB2YXIgcmVzdWx0ID0ge307XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGlmIChhQ2FsbGJhY2spIHtcbiAgICAgICAgICBpZiAoIWFSZXNwb25zZSkge1xuICAgICAgICAgICAgcmVzdWx0LmVycm9ycyA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGFDYWxsYmFjayhyZXN1bHQpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIExvZ2dlci5lcnJvcihcIk15RWJheUFwcGxpY2F0aW9uQXBpLnJlbW92ZUZyb21VbnNvbGRMaXN0IEVycm9yOiBcIiArIGUubWVzc2FnZSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHJlcXVlc3QgPSB0aGlzLl9kb0NhbGwod3JhcHBlZEJvZHksIGFTaXRlSWQsIGxvY2FsQ2FsbGJhY2ssIGFUb2tlbik7XG5cbiAgICByZXR1cm4gcmVxdWVzdDtcbiAgfSxcblxuICAvKipcbiAgICogTXlFYmF5QXBwbGljYXRpb25BcGkgQVBJIHJlbW92ZUZyb21Tb2xkTGlzdFxuICAgKiBAcGFyYW0gYVRva2VuIHRoZSB0b2tlbiB0byB1c2UgaW4gdGhlIHJlcXVlc3RcbiAgICogQHBhcmFtIGFJdGVtcyB0aGUgYXJyYXkgb2YgaXRlbXMgdG8gYmUgcmVtb3ZlZC5cbiAgICogQHBhcmFtIGFTaXRlSWQgVGhlIHNpdGUgaWRcbiAgICogQHBhcmFtIGFDYWxsYmFja1xuICAgKiBAcmV0dXJucyByZXF1ZXN0IG9iamVjdFxuICAgKi9cbiAgcmVtb3ZlRnJvbVNvbGRMaXN0IDogZnVuY3Rpb24oYVRva2VuLCBhSXRlbXMsIGFTaXRlSWQsIGFDYWxsYmFjaykge1xuICAgIFxuICAgIGlmICghYVRva2VuKSB7XG4gICAgICBMb2dnZXIuZXJyb3IoXCJBdHRlbXB0IHRvIG1ha2UgTXlFYmF5QXBwbGljYXRpb24gQVBJIHJlbW92ZUZyb21Tb2xkTGlzdCBcIiArXG4gICAgICAgICAgICAgICAgICAgXCJjYWxsIHdoZW4gbm8gYWNjb3VudCBpcyBhY3RpdmUuXCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHZhciB3cmFwcGVkQm9keTtcbiAgICB2YXIgbG9jYWxDYWxsYmFjaztcbiAgICB2YXIgcmVxdWVzdDtcbiAgICB2YXIgaW5uZXJCb2R5ID0gXCJcIjtcblxuICAgICQuZWFjaChhSXRlbXMsIGZ1bmN0aW9uKGFJbmRleCwgYUl0ZW0pIHtcbiAgICAgIGlubmVyQm9keSArPVxuICAgICAgICBcIjxpdGVtPlwiICtcbiAgICAgICAgXCI8aXRlbUlEPlwiICsgYUl0ZW0uaXRlbUlkICsgXCI8L2l0ZW1JRD5cIiArXG4gICAgICAgIFwiPHRyYW5zYWN0aW9uSUQ+XCIgKyBhSXRlbS50cmFuc2FjdGlvbklkICsgXCI8L3RyYW5zYWN0aW9uSUQ+XCIgK1xuICAgICAgICBcIjwvaXRlbT5cIjtcbiAgICB9KTtcblxuICAgIC8vIGRvIHRoZSBjYWxsXG4gICAgd3JhcHBlZEJvZHkgPSB0aGlzLl93cmFwQ2FsbChcInJlbW92ZUZyb21Tb2xkTGlzdFwiLCBpbm5lckJvZHksIGFUb2tlbik7XG4gICAgbG9jYWxDYWxsYmFjayA9IGZ1bmN0aW9uKGFSZXNwb25zZSkge1xuICAgICAgdmFyIHJlc3VsdCA9IHt9O1xuXG4gICAgICB0cnkge1xuICAgICAgICBpZiAoYUNhbGxiYWNrKSB7XG4gICAgICAgICAgaWYgKCFhUmVzcG9uc2UpIHtcbiAgICAgICAgICAgIHJlc3VsdC5lcnJvcnMgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBhQ2FsbGJhY2socmVzdWx0KTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBMb2dnZXIuZXJyb3IoXCJNeUViYXlBcHBsaWNhdGlvbkFwaS5yZW1vdmVGcm9tU29sZExpc3QgRXJyb3I6IFwiICsgZS5tZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgcmVxdWVzdCA9IHRoaXMuX2RvQ2FsbCh3cmFwcGVkQm9keSwgYVNpdGVJZCwgbG9jYWxDYWxsYmFjaywgYVRva2VuKTtcblxuICAgIHJldHVybiByZXF1ZXN0O1xuICB9LFxuXG4gIC8qKlxuICAgKiBSZXBvcnRzIGFueSBlcnJvciBtZXNzYWdlcyBpbiB0aGUgQVBJIHJlc3BvbnNlLlxuICAgKiBAcGFyYW0gYVJlc3BvbnNlIHRoZSBBUEkgcmVzcG9uc2UuXG4gICAqIEByZXR1cm4gYm9vbGVhbiBpbmRpY2F0ZXMgd2hldGhlciB0aGUgcmVzcG9uc2UgaGFzIGVycm9yIG9yIG5vdC5cbiAgICovXG4gIF92YWxpZGF0ZVJlc3BvbnNlIDogZnVuY3Rpb24oYVJlc3BvbnNlKSB7XG4gICAgXG4gICAgaWYgKCFhUmVzcG9uc2UpIHtcbiAgICAgIExvZ2dlci5lcnJvcihcIk15RWJheUFwcGxpY2F0aW9uQXBpIGVycm9yIChubyByZXBvbnNlIGRvY3VtZW50ISlcIik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgdmFyIG5vZGUgPSAkKGFSZXNwb25zZSkuZmluZChcIkFja1wiKTtcbiAgICBpZiAoIW5vZGUpIHtcbiAgICAgIExvZ2dlci5lcnJvcihcIk15RWJheUFwcGxpY2F0aW9uQXBpIGVycm9yIChubyBBY2sgbm9kZSEpXCIpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGlmICgkKG5vZGUpLnRleHQoKSAhPSBcIlN1Y2Nlc3NcIikge1xuICAgICAgJC5lYWNoKCQoYVJlc3BvbnNlKS5maW5kKFwiZXJyb3JcIiksIGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgZXJyb3JDb2RlID0gTnVtYmVyKCQodGhpcykuZmluZChcImVycm9ySWRcIikudGV4dCgpKTtcbiAgICAgICAgdmFyIHNldmVyaXR5ID0gU3RyaW5nKCQodGhpcykuZmluZChcInNldmVyaXR5XCIpLnRleHQoKSk7XG5cbiAgICAgICAgaWYgKHNldmVyaXR5LmluZGV4T2YoXCJFcnJvclwiKSAhPSAtMSkge1xuICAgICAgICAgIExvZ2dlci5lcnJvcihcIk15RWJheUFwcGxpY2F0aW9uIEFQSSBFcnJvcjpcXG5cIiArIFwiRXJyb3IgQ29kZTogXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICBlcnJvckNvZGUgKyBcIlxcTWVzc2FnZTogXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmcoJCh0aGlzKS5maW5kKFwibWVzc2FnZVwiKS50ZXh0KCkpICtcbiAgICAgICAgICAgICAgICAgICAgICAgXCJcXG5TZXZlcml0eTogXCIgKyBzZXZlcml0eSArXG4gICAgICAgICAgICAgICAgICAgICAgIFwiXFxuRXJyb3IgY2F0ZWdvcnk6IFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nKCQodGhpcykuZmluZChcImNhdGVnb3J5XCIpLnRleHQoKSkgKyBcIlxcblwiKTtcblxuICAgICAgICAgIHZhciByZXNwb25zZU5hbWUgPSBcIlwiO1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXNwb25zZU5hbWUgPSAkKGFSZXNwb25zZSkuY2hpbGRyZW4oXCI6Zmlyc3RcIikucHJvcChcInRhZ05hbWVcIik7XG4gICAgICAgICAgICByZXNwb25zZU5hbWUgPSAvKC4qKVJlc3BvbnNlLy5leGVjKHJlc3BvbnNlTmFtZSlbMV07XG4gICAgICAgICAgfSBjYXRjaCAoZSkge31cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9LFxuXG4gIC8qKlxuICAgKiBXcmFwcyBhbiBYTUwgZnJhZ21lbnQgaW50byBhIE15RWJheUFwcGxpY2F0aW9uIEFQSSBjYWxsXG4gICAqIEBwYXJhbSBhUmVxdWVzdE5hbWUgVGhlIG5hbWUgb2YgdGhlIGNhbGwgKHdpdGhvdXQgXCJSZXF1ZXN0XCIpXG4gICAqIEBwYXJhbSBhSW5uZXJCb2R5IFRoZSBib2R5IG9mIHRoZSBjYWxsXG4gICAqIEByZXR1cm5zIHRoZSBmdWxseS1mb3JtZWQgdGV4dFxuICAgKi9cbiAgX3dyYXBDYWxsIDogZnVuY3Rpb24oYVJlcXVlc3ROYW1lLCBhSW5uZXJCb2R5KSB7XG4gICAgXG4gICAgdmFyIHdyYXBwZWRCb2R5ID1cbiAgICAgIHRoaXMuX1hNTF9IRUFERVIgK1xuICAgICAgXCI8XCIgKyBhUmVxdWVzdE5hbWUgKyBcIlJlcXVlc3QgXCIgKyB0aGlzLl9YTUxfTkFNRVNQQUNFICsgXCI+XCIgK1xuICAgICAgYUlubmVyQm9keSArXG4gICAgICBcIjwvXCIgKyBhUmVxdWVzdE5hbWUgKyBcIlJlcXVlc3Q+XCI7XG5cbiAgICByZXR1cm4gd3JhcHBlZEJvZHk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFBlcmZvcm1zIE15RWJheUFwcGxpY2F0aW9uIEFQSSBjYWxsXG4gICAqIEBwYXJhbSBhUmVxdWVzdEJvZHkgVGhlIGZ1bGwgYm9keSBvZiB0aGUgY2FsbCwgYXMgd2lsbCBiZSBQT1NUZWRcbiAgICogQHBhcmFtIGFTaXRlSWQgVGhlIHNpdGUgaWRcbiAgICogQHBhcmFtIGFDYWxsYmFjayBUaGUgY2FsbGJhY2sgZnVuY3Rpb25cbiAgICogQHBhcmFtIGFUb2tlbiB0aGUgdG9rZW4gdG8gdXNlIGluIHRoZSByZXF1ZXN0XG4gICAqL1xuICBfZG9DYWxsIDogZnVuY3Rpb24oYVJlcXVlc3RCb2R5LCBhU2l0ZUlkLCBhQ2FsbGJhY2ssIGFUb2tlbikge1xuICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICB2YXIgcmVxdWVzdE5hbWU7XG4gICAgdmFyIHJlcXVlc3Q7XG5cbiAgICB0cnkge1xuICAgICAgcmVxdWVzdE5hbWUgPSAvPjwoLio/KVJlcXVlc3QvLmV4ZWMoYVJlcXVlc3RCb2R5KVsxXTtcbiAgICB9IGNhdGNoKGUpIHtcbiAgICAgIExvZ2dlci5lcnJvcihcIk15RWJheUFwcGxpY2F0aW9uIEFQSSByZXF1ZXN0IHdpbGwgbm90IGJlIHNlbnQsIGFzIGl0IGlzXCIgK1xuICAgICAgICAgICAgICAgICAgIFwiIGJhZGx5LWZvcm1lZC4gXFxuXCIgKyBhUmVxdWVzdEJvZHkpO1xuXG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXF1ZXN0ID1cbiAgICAgICQuYWpheCh7XG4gICAgICAgIGJlZm9yZVNlbmQ6IGZ1bmN0aW9uKGFYSFIpIHtcbiAgICAgICAgICBhWEhSLnNldFJlcXVlc3RIZWFkZXIoXG4gICAgICAgICAgICBcIlgtRUJBWS1TT0EtU0VSVklDRS1OQU1FXCIsIFwiTXlFYmF5QXBwbGljYXRpb25TZXJ2aWNlXCIpO1xuICAgICAgICAgIGFYSFIuc2V0UmVxdWVzdEhlYWRlcihcbiAgICAgICAgICAgIFwiWC1FQkFZLVNPQS1PUEVSQVRJT04tTkFNRVwiLCByZXF1ZXN0TmFtZSk7XG4gICAgICAgICAgYVhIUi5zZXRSZXF1ZXN0SGVhZGVyKFxuICAgICAgICAgICAgXCJYLUVCQVktU09BLVNFQ1VSSVRZLVRPS0VOXCIsIGFUb2tlbik7XG4gICAgICAgICAgLy9YWFg6IFRPRE86IHdlIG5lZWQgdG8gY2hlY2sgaWYgdGhpcyBuZXcgQVBQTkFNRSBoZXJlIHdpbGwgd29yay5cbiAgICAgICAgICBhWEhSLnNldFJlcXVlc3RIZWFkZXIoXG4gICAgICAgICAgICBcIlgtRUJBWS1TT0EtU0VDVVJJVFktQVBQTkFNRVwiLCBBcGlIZWxwZXIuZ2V0RW5kUG9pbnQoXCJjbGllbnRJZFwiKSk7XG4gICAgICAgICAgLy8gc2V0IHRoZSBleHRlbnNpb24gdmVyc2lvbiBhcyByZXF1ZXN0IGhlYWRlciAoYXMgc3VnZ2VzdGVkIGJ5IERhbiBQb3dlcilcbiAgICAgICAgICBhWEhSLnNldFJlcXVlc3RIZWFkZXIoXG4gICAgICAgICAgICBcIlgtRUJBWS1TSURFQkFSLVZFUlNJT05cIiwgQnJvd3NlckhlbHBlci5nZXRFeHRlbnNpb25WZXJzaW9uKCkpO1xuICAgICAgICB9LFxuICAgICAgICB0eXBlOiBcIlBPU1RcIixcbiAgICAgICAgY29udGVudFR5cGU6IFwidGV4dC94bWxcIixcbiAgICAgICAgdXJsOiBBcGlIZWxwZXIuZ2V0RW5kUG9pbnQoXCJteWVCYXlBcHBsaWNhdGlvbkFwaVwiKSxcbiAgICAgICAgZGF0YTogYVJlcXVlc3RCb2R5LFxuICAgICAgICBkYXRhVHlwZTogXCJ4bWxcIixcbiAgICAgICAganNvbnA6IGZhbHNlLFxuICAgICAgICB0aW1lb3V0OiBQcm9wZXJ0eURBTy5nZXQoUHJvcGVydHlEQU8uUFJPUF9BUElfVElNRU9VVCksXG4gICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGFEYXRhLCBhVGV4dFN0YXR1cykge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoYVRleHRTdGF0dXMgPT0gXCJzdWNjZXNzXCIpIHtcbiAgICAgICAgICAgICAgaWYgKCF0aGF0Ll92YWxpZGF0ZVJlc3BvbnNlKGFEYXRhKSkge1xuICAgICAgICAgICAgICAgIGFEYXRhID0gbnVsbDtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBNZXNzYWdlUGFuZWxTZXJ2aWNlLmRpc21pc3NNZXNzYWdlKE1lc3NhZ2VQYW5lbFNlcnZpY2UuVFlQRS5DT05ORUNUX0VSUk9SKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoYUNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgYUNhbGxiYWNrKGFEYXRhKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICAgICAgVXRpbGl0eUhlbHBlci5oYW5kbGVFcnJvcihcIk15RWJheUFwcGxpY2F0aW9uQXBpXCIsIHJlcXVlc3ROYW1lLCBlLm1lc3NhZ2UsIGFDYWxsYmFjayk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogZnVuY3Rpb24oYVhIUiwgYVRleHRTdGF0dXMsIGFFcnJvcikge1xuICAgICAgICAgIFV0aWxpdHlIZWxwZXIuaGFuZGxlRXJyb3IoXCJNeUViYXlBcHBsaWNhdGlvbkFwaVwiLCByZXF1ZXN0TmFtZSwgYVhIUi5yZXNwb25zZVRleHQsIGFDYWxsYmFjayk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgLy8gYWRkIHBlbmRpbmcgcmVxdWVzdCB0byBhIGxpc3Qgc28gcGVuZGluZyByZXF1ZXN0IHdvdWxkIGJlIGNhbmNlbGxlZCBmb3JcbiAgICAvLyBhIGxvbmcgcGVyaW9kIG9mIHRpbWUgYW5kIGFsc28gYWxsIHBlbmRpbmcgcmVxdWVzdHMgY2FuIGJlIGFib3J0ZWQgd2hlblxuICAgIC8vIHVzZXIgc2lnbnMgb3V0LlxuICAgIEFwaUhlbHBlci5hZGRQZW5kaW5nUmVxdWVzdChyZXF1ZXN0LCByZXF1ZXN0TmFtZSk7XG5cbiAgICByZXR1cm4gcmVxdWVzdDtcbiAgfVxufTtcbiJdfQ==