/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var RecentSearchMedsService = {
    _recentSearchesCache: null,
    init: function () {
        ObserverHelper.addObserver(this, Topics.ACCOUNT_SIGNED_IN);
        ObserverHelper.addObserver(this, Topics.ACCOUNT_SIGNED_OUT);
    },
    get recentSearches() {
        var recentSearch;
        var plainRecentSearches;
        var convertedRecentSearches = [];
        if (!this._recentSearchesCache) {
            plainRecentSearches = PropertyDAO.get(PropertyDAO.PROP_RECENT_SEARCHES);
            if (plainRecentSearches) {
                for (var i = 0; i < plainRecentSearches.length; i++) {
                    recentSearch = new RecentSearch(plainRecentSearches[i]._userId, plainRecentSearches[i]._searchString);
                    convertedRecentSearches.push(recentSearch);
                }
                this._recentSearchesCache = convertedRecentSearches;
            }
        }
        return this._recentSearchesCache;
    },
    set recentSearches(recentSearches) {
        PropertyDAO.set(PropertyDAO.PROP_RECENT_SEARCHES, recentSearches);
        this._recentSearchesCache = recentSearches;
    },
    addRecentSearch: function (aUserId, aHomeSite, aRecentSearch) {
        var that = this;
        var parameters;
        var callback = function (aResult) {
            if (aResult) {
                that.getRecentSearches(aUserId, aHomeSite);
            }
        };
        parameters = '{"last_queries_used": [{"keywords": ["' + aRecentSearch +
            '"], "spellcheck": false,"recallCount": 0, "department": "Department",' +
            ' "productType": "-1", "aisle": "aisle1","categoryId": 0, "aspects": []' +
            '} ]}';
        MEDSApi.addRecentSearch(aHomeSite, parameters, callback);
    },
    getRecentSearches: function (aUserId, aHomeSite) {
        var that = this;
        var callback = function (aResult) {
            if (aResult && aResult.attributes) {
                var lastQueriesUsed = null;
                var searchString = null;
                var recentSearch;
                var recentSearches = [];
                $.each(aResult.attributes, function (aIndex, aValue) {
                    if ("last_queries_used" == aValue.attributeName) {
                        lastQueriesUsed = aValue.attributeValue.last_queries_used;
                        if (lastQueriesUsed) {
                            $.each(lastQueriesUsed, function (aQueryIndex, aQueryValue) {
                                if (aQueryValue.keywords[0]) {
                                    searchString = aQueryValue.keywords[0];
                                    recentSearch = new RecentSearch(aUserId, searchString);
                                    recentSearches.push(recentSearch);
                                }
                            });
                        }
                    }
                });
                that.recentSearches = recentSearches;
            }
            ObserverHelper.notify(Topics.RECENT_SEARCHES_UPDATED);
        };
        MEDSApi.getRecentSearches(aHomeSite, {}, callback);
    },
    clearRecentSearches: function (aHomeSite, aDeleteFromApi) {
        this.recentSearches = [];
        var callback = function (aResult) {
            if (aResult) {
                ObserverHelper.notify(Topics.RECENT_SEARCHES_UPDATED);
            }
        };
        if (aDeleteFromApi) {
            MEDSApi.clearRecentSearches(aHomeSite, {}, callback);
        }
    },
    observe: function (aTopic, aData) {
        var userId;
        var homeSite;
        switch (aTopic) {
            case Topics.ACCOUNT_SIGNED_IN:
                var account = Account.getAccount();
                userId = account.get("userId");
                homeSite = aData.homeSite;
                this.getRecentSearches(userId, homeSite);
                break;
            case Topics.ACCOUNT_SIGNED_OUT:
                this.clearRecentSearches(null, false);
                break;
        }
    }
};
(function () { this.init(); }).apply(RecentSearchMedsService);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVjZW50U2VhcmNoTWVkc1NlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9iYWNrZ3JvdW5kL2NvcmUvc2VydmljZXMvcmVjZW50U2VhcmNoTWVkc1NlcnZpY2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0dBRUc7QUFlSCxJQUFJLHVCQUF1QixHQUFHO0lBRTVCLG9CQUFvQixFQUFHLElBQUk7SUFLM0IsSUFBSSxFQUFFO1FBQ0osY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDM0QsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDOUQsQ0FBQztJQU1ELElBQUksY0FBYztRQUNoQixJQUFJLFlBQVksQ0FBQztRQUNqQixJQUFJLG1CQUFtQixDQUFDO1FBQ3hCLElBQUksdUJBQXVCLEdBQUcsRUFBRSxDQUFDO1FBRWpDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQztZQUMvQixtQkFBbUIsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1lBRXhFLEVBQUUsQ0FBQyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQztnQkFDeEIsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztvQkFDcEQsWUFBWSxHQUFHLElBQUksWUFBWSxDQUM3QixtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQzlCLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FDckMsQ0FBQztvQkFDRix1QkFBdUIsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQzdDLENBQUM7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QyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNaLGNBQWMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUM7WUFDeEQsQ0FBQztRQUNILENBQUMsQ0FBQztRQUVGLEVBQUUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsT0FBTyxDQUFDLG1CQUFtQixDQUFDLFNBQVMsRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDdkQsQ0FBQztJQUNILENBQUM7SUFPRCxPQUFPLEVBQUcsVUFBUyxNQUFNLEVBQUUsS0FBSztRQUM5QixJQUFJLE1BQU0sQ0FBQztRQUNYLElBQUksUUFBUSxDQUFDO1FBRWIsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNmLEtBQUssTUFBTSxDQUFDLGlCQUFpQjtnQkFDM0IsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUNuQyxNQUFNLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDL0IsUUFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUM7Z0JBQzFCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7Z0JBQ3pDLEtBQUssQ0FBQztZQUNSLEtBQUssTUFBTSxDQUFDLGtCQUFrQjtnQkFHNUIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDdEMsS0FBSyxDQUFDO1FBQ1YsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFDO0FBS0YsQ0FBQyxjQUFhLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBDb3B5cmlnaHQgKEMpIDIwMDctMjAxNSBlQmF5IEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqL1xuXG4vKlxuICB2YXIgTG9nZ2VyID0gcmVxdWlyZShcImhlbHBlcnMvbG9nZ2VyXCIpLkxvZ2dlcjtcbiAgdmFyIFRvcGljcyA9IHJlcXVpcmUoXCJoZWxwZXJzL29ic2VydmVySGVscGVyXCIpLlRvcGljcztcbiAgdmFyIE9ic2VydmVySGVscGVyID0gcmVxdWlyZShcImhlbHBlcnMvb2JzZXJ2ZXJIZWxwZXJcIikuT2JzZXJ2ZXJIZWxwZXI7XG4gIHZhciBBY2NvdW50ID0gcmVxdWlyZShcImNvcmUvb2JqZWN0cy9hY2NvdW50XCIpLkFjY291bnQ7XG4gIHZhciBNRURTQXBpID0gcmVxdWlyZShcImNvcmUvYXBpcy9tZWRzQXBpXCIpLk1FRFNBcGk7XG4gIHZhciBSZWNlbnRTZWFyY2ggPSByZXF1aXJlKFwiY29yZS9vYmplY3RzL3JlY2VudFNlYXJjaFwiKS5SZWNlbnRTZWFyY2g7XG4gIHZhciBQcm9wZXJ0eURBTyA9IHJlcXVpcmUoXCJzdG9yYWdlL3Byb3BlcnR5REFPXCIpLlByb3BlcnR5REFPO1xuKi9cblxuLyoqXG4gKiBSZWNlbnQgU2VhcmNoIFNlcnZpY2UuXG4gKi9cbnZhciBSZWNlbnRTZWFyY2hNZWRzU2VydmljZSA9IHtcbiAgLyogUmVjZW50IHNlYXJjaGVzIGxpc3QgKi9cbiAgX3JlY2VudFNlYXJjaGVzQ2FjaGUgOiBudWxsLFxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyB0aGUgc2VydmljZS5cbiAgICovXG4gIGluaXQ6IGZ1bmN0aW9uKCkge1xuICAgIE9ic2VydmVySGVscGVyLmFkZE9ic2VydmVyKHRoaXMsIFRvcGljcy5BQ0NPVU5UX1NJR05FRF9JTik7XG4gICAgT2JzZXJ2ZXJIZWxwZXIuYWRkT2JzZXJ2ZXIodGhpcywgVG9waWNzLkFDQ09VTlRfU0lHTkVEX09VVCk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIHJlY2VudCBzZWFyY2hlcy5cbiAgICogQHJldHVybiB0aGUgcmVjZW50IHNlYXJjaGVzLlxuICAgKi9cbiAgZ2V0IHJlY2VudFNlYXJjaGVzKCkge1xuICAgIHZhciByZWNlbnRTZWFyY2g7XG4gICAgdmFyIHBsYWluUmVjZW50U2VhcmNoZXM7XG4gICAgdmFyIGNvbnZlcnRlZFJlY2VudFNlYXJjaGVzID0gW107XG5cbiAgICBpZiAoIXRoaXMuX3JlY2VudFNlYXJjaGVzQ2FjaGUpIHtcbiAgICAgIHBsYWluUmVjZW50U2VhcmNoZXMgPSBQcm9wZXJ0eURBTy5nZXQoUHJvcGVydHlEQU8uUFJPUF9SRUNFTlRfU0VBUkNIRVMpO1xuXG4gICAgICBpZiAocGxhaW5SZWNlbnRTZWFyY2hlcykge1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBsYWluUmVjZW50U2VhcmNoZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICByZWNlbnRTZWFyY2ggPSBuZXcgUmVjZW50U2VhcmNoKFxuICAgICAgICAgICAgcGxhaW5SZWNlbnRTZWFyY2hlc1tpXS5fdXNlcklkLFxuICAgICAgICAgICAgcGxhaW5SZWNlbnRTZWFyY2hlc1tpXS5fc2VhcmNoU3RyaW5nXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb252ZXJ0ZWRSZWNlbnRTZWFyY2hlcy5wdXNoKHJlY2VudFNlYXJjaCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fcmVjZW50U2VhcmNoZXNDYWNoZSA9IGNvbnZlcnRlZFJlY2VudFNlYXJjaGVzO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fcmVjZW50U2VhcmNoZXNDYWNoZTtcbiAgfSxcblxuICBzZXQgcmVjZW50U2VhcmNoZXMocmVjZW50U2VhcmNoZXMpIHtcbiAgICBQcm9wZXJ0eURBTy5zZXQoUHJvcGVydHlEQU8uUFJPUF9SRUNFTlRfU0VBUkNIRVMsIHJlY2VudFNlYXJjaGVzKTtcbiAgICB0aGlzLl9yZWNlbnRTZWFyY2hlc0NhY2hlID0gcmVjZW50U2VhcmNoZXM7XG4gIH0sXG5cbiAgLyoqXG4gICAqIEFkZCBhIG5ldyByZWNlbnQgc2VhcmNoIG9uIHRoZSBNRURTIEFwaS5cbiAgICogQHBhcmFtIGFVc2VySWQgdGhlIHVzZXIncyBpZC5cbiAgICogQHBhcmFtIGFIb21lU2l0ZSB0aGUgdXNlcidzIGhvbWUgc2l0ZS5cbiAgICogQHBhcmFtIGFSZWNlbnRTZWFyY2ggdGhlIHN0cmluZyB0aGF0IGNvbnRhaW5zIHRoZSBuZXcgcmVjZW50IHNlYXJjaCBieVxuICAgKiB0aGUgdXNlci5cbiAgICovXG4gIGFkZFJlY2VudFNlYXJjaCA6IGZ1bmN0aW9uKGFVc2VySWQsIGFIb21lU2l0ZSwgYVJlY2VudFNlYXJjaCkge1xuICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICB2YXIgcGFyYW1ldGVycztcblxuICAgIHZhciBjYWxsYmFjayA9IGZ1bmN0aW9uKGFSZXN1bHQpIHtcbiAgICAgIGlmIChhUmVzdWx0KSB7XG4gICAgICAgIHRoYXQuZ2V0UmVjZW50U2VhcmNoZXMoYVVzZXJJZCwgYUhvbWVTaXRlKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgcGFyYW1ldGVycyA9ICd7XCJsYXN0X3F1ZXJpZXNfdXNlZFwiOiBbe1wia2V5d29yZHNcIjogW1wiJyArIGFSZWNlbnRTZWFyY2ggK1xuICAgICAgJ1wiXSwgXCJzcGVsbGNoZWNrXCI6IGZhbHNlLFwicmVjYWxsQ291bnRcIjogMCwgXCJkZXBhcnRtZW50XCI6IFwiRGVwYXJ0bWVudFwiLCcgK1xuICAgICAgJyBcInByb2R1Y3RUeXBlXCI6IFwiLTFcIiwgXCJhaXNsZVwiOiBcImFpc2xlMVwiLFwiY2F0ZWdvcnlJZFwiOiAwLCBcImFzcGVjdHNcIjogW10nICtcbiAgICAgICd9IF19JztcbiAgICBNRURTQXBpLmFkZFJlY2VudFNlYXJjaChhSG9tZVNpdGUsIHBhcmFtZXRlcnMsIGNhbGxiYWNrKTtcbiAgfSxcblxuICAvKipcbiAgICogQ2FsbHMgdGhlIE1FRFMgQXBpIGFuZCBnZXRzIHRoZSByZWNlbnQgc2VhcmNoZXMgZnJvbSBhbiB1c2VyLlxuICAgKiBAcGFyYW0gYVVzZXJJZCB0aGUgdXNlcidzIGlkLlxuICAgKiBAcGFyYW0gYUhvbWVTaXRlIHRoZSB1c2VyJ3MgaG9tZSBzaXRlLlxuICAgKi9cbiAgZ2V0UmVjZW50U2VhcmNoZXMgOiBmdW5jdGlvbihhVXNlcklkLCBhSG9tZVNpdGUpIHtcblxuICAgIHZhciB0aGF0ID0gdGhpcztcblxuICAgIHZhciBjYWxsYmFjayA9IGZ1bmN0aW9uKGFSZXN1bHQpIHtcbiAgICAgIGlmIChhUmVzdWx0ICYmIGFSZXN1bHQuYXR0cmlidXRlcykge1xuICAgICAgICB2YXIgbGFzdFF1ZXJpZXNVc2VkID0gbnVsbDtcbiAgICAgICAgdmFyIHNlYXJjaFN0cmluZyA9IG51bGw7XG4gICAgICAgIHZhciByZWNlbnRTZWFyY2g7XG4gICAgICAgIHZhciByZWNlbnRTZWFyY2hlcyA9IFtdO1xuXG4gICAgICAgICQuZWFjaChhUmVzdWx0LmF0dHJpYnV0ZXMsIGZ1bmN0aW9uKGFJbmRleCwgYVZhbHVlKSB7XG4gICAgICAgICAgaWYgKFwibGFzdF9xdWVyaWVzX3VzZWRcIiA9PSBhVmFsdWUuYXR0cmlidXRlTmFtZSkge1xuICAgICAgICAgICAgbGFzdFF1ZXJpZXNVc2VkID0gYVZhbHVlLmF0dHJpYnV0ZVZhbHVlLmxhc3RfcXVlcmllc191c2VkO1xuICAgICAgICAgICAgaWYgKGxhc3RRdWVyaWVzVXNlZCkge1xuICAgICAgICAgICAgICAkLmVhY2gobGFzdFF1ZXJpZXNVc2VkLCBmdW5jdGlvbihhUXVlcnlJbmRleCwgYVF1ZXJ5VmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAoYVF1ZXJ5VmFsdWUua2V5d29yZHNbMF0pIHtcbiAgICAgICAgICAgICAgICAgIHNlYXJjaFN0cmluZyA9IGFRdWVyeVZhbHVlLmtleXdvcmRzWzBdO1xuICAgICAgICAgICAgICAgICAgcmVjZW50U2VhcmNoID0gbmV3IFJlY2VudFNlYXJjaChhVXNlcklkLCBzZWFyY2hTdHJpbmcpO1xuICAgICAgICAgICAgICAgICAgcmVjZW50U2VhcmNoZXMucHVzaChyZWNlbnRTZWFyY2gpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhhdC5yZWNlbnRTZWFyY2hlcyA9IHJlY2VudFNlYXJjaGVzO1xuICAgICAgfVxuICAgICAgT2JzZXJ2ZXJIZWxwZXIubm90aWZ5KFRvcGljcy5SRUNFTlRfU0VBUkNIRVNfVVBEQVRFRCk7XG4gICAgfTtcblxuICAgIE1FRFNBcGkuZ2V0UmVjZW50U2VhcmNoZXMoYUhvbWVTaXRlLCB7fSwgY2FsbGJhY2spO1xuICB9LFxuXG4gIC8qKlxuICAgKiBDbGVhcnMgdGhlIHJlY2VudCBzZWFyY2hlcyBrZXB0IGluIG1lbW9yeS5cbiAgICogQHBhcmFtIGFIb21lU2l0ZSB0aGUgdXNlcidzIGhvbWUgc2l0ZS5cbiAgICogQHBhcmFtIGFEZWxldGVGcm9tQXBpIGluZGljYXRlcyBpZiByZWNlbnQgc2VhcmNoZXMgc2hvdWxkIGJlIGRlbGV0ZWQgZnJvbVxuICAgKiB0aGUgQXBpLlxuICAgKi9cbiAgY2xlYXJSZWNlbnRTZWFyY2hlczogZnVuY3Rpb24oYUhvbWVTaXRlLCBhRGVsZXRlRnJvbUFwaSkge1xuICAgIHRoaXMucmVjZW50U2VhcmNoZXMgPSBbXTtcblxuICAgIHZhciBjYWxsYmFjayA9IGZ1bmN0aW9uKGFSZXN1bHQpIHtcbiAgICAgIGlmIChhUmVzdWx0KSB7XG4gICAgICAgIE9ic2VydmVySGVscGVyLm5vdGlmeShUb3BpY3MuUkVDRU5UX1NFQVJDSEVTX1VQREFURUQpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBpZiAoYURlbGV0ZUZyb21BcGkpIHtcbiAgICAgIE1FRFNBcGkuY2xlYXJSZWNlbnRTZWFyY2hlcyhhSG9tZVNpdGUsIHt9LCBjYWxsYmFjayk7XG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKiBPYnNlcnZlcyBmb3IgY2hhbmdlcy5cbiAgICogQHBhcmFtIGFUb3BpYyB0aGUgdG9waWMgbmFtZS5cbiAgICogQHBhcmFtIGFEYXRhIHRoZSBkYXRhIHNlbnQuXG4gICAqL1xuICBvYnNlcnZlIDogZnVuY3Rpb24oYVRvcGljLCBhRGF0YSkge1xuICAgIHZhciB1c2VySWQ7XG4gICAgdmFyIGhvbWVTaXRlO1xuXG4gICAgc3dpdGNoIChhVG9waWMpIHtcbiAgICAgIGNhc2UgVG9waWNzLkFDQ09VTlRfU0lHTkVEX0lOOlxuICAgICAgICB2YXIgYWNjb3VudCA9IEFjY291bnQuZ2V0QWNjb3VudCgpO1xuICAgICAgICB1c2VySWQgPSBhY2NvdW50LmdldChcInVzZXJJZFwiKTtcbiAgICAgICAgaG9tZVNpdGUgPSBhRGF0YS5ob21lU2l0ZTtcbiAgICAgICAgdGhpcy5nZXRSZWNlbnRTZWFyY2hlcyh1c2VySWQsIGhvbWVTaXRlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFRvcGljcy5BQ0NPVU5UX1NJR05FRF9PVVQ6XG4gICAgICAgIC8vIFdlIGRvbid0IG5lZWQgdGhlIGhvbWUgc2l0ZSB3aGVuIHNpZ25pbmcgb3V0LCBiZWNhdXNlIHdlIGRvbid0XG4gICAgICAgIC8vIGRlbGV0ZSBzZWFyY2hlcyBmcm9tIHRoZSBBUElcbiAgICAgICAgdGhpcy5jbGVhclJlY2VudFNlYXJjaGVzKG51bGwsIGZhbHNlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG59O1xuXG4vKipcbiAqIENvbnN0cnVjdG9yLlxuICovXG4oZnVuY3Rpb24oKSB7IHRoaXMuaW5pdCgpOyB9KS5hcHBseShSZWNlbnRTZWFyY2hNZWRzU2VydmljZSk7XG4iXX0=