/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var InformationRefreshService = {
    _POLLING_MAX_PERIOD: 300 * 1000,
    _POLLING_MIN_PERIOD: 10 * 1000,
    _POLLING_RATIO: 0.2,
    _POST_ENDED_MIN_POLL_COUNTER_LIMIT: 3,
    _informationRefreshTimer: null,
    _postEndedMinPollCounter: null,
    init: function () {
        ObserverHelper.addObserver(this, Topics.ACCOUNT_SIGNED_IN);
        ObserverHelper.addObserver(this, Topics.ACCOUNT_SIGNED_OUT);
        ObserverHelper.addObserver(this, Topics.ITEM_ENDED);
    },
    _setInformationRefreshTimer: function () {
        var that = this;
        var timerCallback = function () {
            that.getInformationRefreshUpdate();
        };
        var getOptimalPollingCallback = function (aNewPollPeriod) {
            if (that._informationRefreshTimer) {
                that._informationRefreshTimer.cancel();
            }
            that._informationRefreshTimer = new Timer(timerCallback, aNewPollPeriod);
        };
        this._getOptimalPollingPeriodForNextUpdate(getOptimalPollingCallback);
    },
    stopInformationRefresh: function () {
        if (this._informationRefreshTimer) {
            this._informationRefreshTimer.cancel();
            delete this._informationRefreshTimer;
        }
    },
    startInformationRefresh: function () {
        this._setInformationRefreshTimer();
    },
    _getOptimalPollingPeriodForNextUpdate: function (aCallback) {
        var pollPeriod = this._POLLING_MAX_PERIOD;
        var that = this;
        var soonestEndTime = InformationRefreshService.getSoonestEndTime();
        if (soonestEndTime !== null) {
            var ebayTime = CommonService.geteBayTime().getTime();
            var timeLeft = Math.max(0, soonestEndTime - ebayTime);
            pollPeriod = Math.round(timeLeft * that._POLLING_RATIO);
            pollPeriod = Math.max(pollPeriod, that._POLLING_MIN_PERIOD);
            pollPeriod = Math.min(pollPeriod, that._POLLING_MAX_PERIOD);
        }
        var currentPollingPeriod = that._POLLING_MAX_PERIOD;
        if (that._informationRefreshTimer) {
            currentPollingPeriod = that._informationRefreshTimer.interval;
            if (currentPollingPeriod == that._POLLING_MIN_PERIOD &&
                pollPeriod == that._POLLING_MAX_PERIOD) {
                if (that._postEndedMinPollCounter === null) {
                    that._postEndedMinPollCounter = 1;
                }
                else {
                    that._postEndedMinPollCounter = that._postEndedMinPollCounter + 1;
                    if (that._postEndedMinPollCounter > that._POST_ENDED_MIN_POLL_COUNTER_LIMIT) {
                        that._postEndedMinPollCounter = null;
                    }
                }
                if (that._postEndedMinPollCounter !== null) {
                    pollPeriod = that._POLLING_MIN_PERIOD;
                }
            }
        }
        aCallback(pollPeriod);
    },
    getInformationRefreshUpdate: function () {
        if (!SymbanService.isUpdatingData) {
            SymbanService.getBadgeCount();
        }
        var that = this;
        that._setInformationRefreshTimer();
    },
    getSoonestEndTime: function () {
        var soonestEndTime = null;
        var endTime = null;
        var currentList;
        var listNames = [];
        listNames.push(TradingApi.WATCH_LIST);
        listNames.push(TradingApi.BID_LIST);
        listNames.push(TradingApi.BEST_OFFER_LIST);
        listNames.push(TradingApi.ACTIVE_LIST);
        listNames.push(TradingApi.SELLING_OFFER_LIST);
        $.each(listNames, function (aIndex, aListName) {
            currentList = MyEbayService.getList(aListName);
            $.each(currentList, function (aIndex, aItem) {
                if (aItem.get("endTime") && !aItem.isEnded() &&
                    aItem.get("endTime") > CommonService.geteBayTime().getTime()) {
                    endTime = aItem.get("endTime");
                    if (0 < endTime && (!soonestEndTime || endTime < soonestEndTime)) {
                        soonestEndTime = endTime;
                    }
                }
            });
        });
        return soonestEndTime;
    },
    observe: function (aTopic, aData) {
        switch (aTopic) {
            case Topics.ACCOUNT_SIGNED_IN:
                if (Configs.BROWSER !== "cr") {
                    InformationRefreshService.startInformationRefresh();
                }
                break;
            case Topics.ACCOUNT_SIGNED_OUT:
                if (Configs.BROWSER !== "cr") {
                    InformationRefreshService.stopInformationRefresh();
                }
                break;
            case Topics.ITEM_ENDED:
                MyEbayService.updateItemEnded(aData);
                break;
        }
    }
};
(function () { this.init(); }).apply(InformationRefreshService);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5mb3JtYXRpb25SZWZyZXNoU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2JhY2tncm91bmQvY29yZS9zZXJ2aWNlcy9pbmZvcm1hdGlvblJlZnJlc2hTZXJ2aWNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBZ0JILElBQUkseUJBQXlCLEdBQUc7SUFFOUIsbUJBQW1CLEVBQUUsR0FBRyxHQUFHLElBQUk7SUFDL0IsbUJBQW1CLEVBQUUsRUFBRSxHQUFHLElBQUk7SUFDOUIsY0FBYyxFQUFFLEdBQUc7SUFJbkIsa0NBQWtDLEVBQUcsQ0FBQztJQUd0Qyx3QkFBd0IsRUFBRyxJQUFJO0lBSy9CLHdCQUF3QixFQUFHLElBQUk7SUFLL0IsSUFBSSxFQUFFO1FBRUosY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDM0QsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDNUQsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFNRCwyQkFBMkIsRUFBRztRQUU1QixJQUFJLElBQUksR0FBRyxJQUFJLENBQUM7UUFDaEIsSUFBSSxhQUFhLEdBQUc7WUFDbEIsSUFBSSxDQUFDLDJCQUEyQixFQUFFLENBQUM7UUFDckMsQ0FBQyxDQUFDO1FBQ0YsSUFBSSx5QkFBeUIsR0FBRyxVQUFTLGNBQWM7WUFDckQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLENBQUMsQ0FBQztnQkFDbEMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3pDLENBQUM7WUFDRCxJQUFJLENBQUMsd0JBQXdCLEdBQUcsSUFBSSxLQUFLLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FB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QUFPLENBQUM7b0JBQzNCLENBQUM7Z0JBQ0gsQ0FBQztZQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsY0FBYyxDQUFDO0lBQ3hCLENBQUM7SUFPRCxPQUFPLEVBQUcsVUFBUyxNQUFNLEVBQUUsS0FBSztRQUU5QixNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2YsS0FBSyxNQUFNLENBQUMsaUJBQWlCO2dCQUUzQixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQzdCLHlCQUF5QixDQUFDLHVCQUF1QixFQUFFLENBQUM7Z0JBQ3RELENBQUM7Z0JBQ0QsS0FBSyxDQUFDO1lBQ1IsS0FBSyxNQUFNLENBQUMsa0JBQWtCO2dCQUU1QixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQzdCLHlCQUF5QixDQUFDLHNCQUFzQixFQUFFLENBQUM7Z0JBQ3JELENBQUM7Z0JBQ0QsS0FBSyxDQUFDO1lBQ1IsS0FBSyxNQUFNLENBQUMsVUFBVTtnQkFDcEIsYUFBYSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDckMsS0FBSyxDQUFDO1FBQ1YsQ0FBQztJQUNILENBQUM7Q0FFRixDQUFDO0FBS0YsQ0FBQyxjQUFhLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBDb3B5cmlnaHQgKEMpIDIwMDctMjAxNSBlQmF5IEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqL1xuXG4vKlxuICB2YXIgQ29uZmlncyA9IHJlcXVpcmUoXCJjb3JlL2NvbmZpZ3MvaW5pdFwiKS5Db25maWdzO1xuICB2YXIgVG9waWNzID0gcmVxdWlyZShcImhlbHBlcnMvb2JzZXJ2ZXJIZWxwZXJcIikuVG9waWNzO1xuICB2YXIgT2JzZXJ2ZXJIZWxwZXIgPSByZXF1aXJlKFwiaGVscGVycy9vYnNlcnZlckhlbHBlclwiKS5PYnNlcnZlckhlbHBlcjtcbiAgdmFyIFRyYWRpbmdBcGkgPSByZXF1aXJlKFwiY29yZS9hcGlzL3RyYWRpbmdBcGlcIikuVHJhZGluZ0FwaTtcbiAgdmFyIFN5bWJhblNlcnZpY2UgPSByZXF1aXJlKFwiY29yZS9zZXJ2aWNlcy9zeW1iYW5TZXJ2aWNlXCIpLlN5bWJhblNlcnZpY2U7XG4gIHZhciBNeUViYXlTZXJ2aWNlID0gcmVxdWlyZShcImNvcmUvc2VydmljZXMvbXlFYmF5U2VydmljZVwiKS5NeUViYXlTZXJ2aWNlO1xuICB2YXIgQ29tbW9uU2VydmljZSA9IHJlcXVpcmUoXCJjb3JlL3NlcnZpY2VzL2NvbW1vblNlcnZpY2VcIikuQ29tbW9uU2VydmljZTtcbiAgdmFyIFRpbWVyID0gcmVxdWlyZShcImhlbHBlcnMvdGltZXJcIikuVGltZXI7XG4qL1xuXG4vKipcbiAqIEluZm9ybWF0aW9uIFJlZnJlc2ggU2VydmljZS5cbiAqL1xudmFyIEluZm9ybWF0aW9uUmVmcmVzaFNlcnZpY2UgPSB7XG4gIC8qIENvbnN0YW50cyAqL1xuICBfUE9MTElOR19NQVhfUEVSSU9EOiAzMDAgKiAxMDAwLCAvLyAzMDAgc2VjcyAvIDUgbWluXG4gIF9QT0xMSU5HX01JTl9QRVJJT0Q6IDEwICogMTAwMCwgLy8gMTAgc2Vjc1xuICBfUE9MTElOR19SQVRJTzogMC4yLCAvLyBwb2xsIGF0IHRoaXMgcmF0aW8gdG8gcmVtYWluaW5nIHRpbWVcbiAgLy8gdGhpcyBpcyB0aGUgbWF4IG51bWJlciBvZiB0aW1lcyB0aGUgcG9sbGluZyByYXRlIGlzIGtlcHQgaW4gdGhlIG1pbmltdW1cbiAgLy8gYWZ0ZXIgYW4gaXRlbSBmaW5pc2hlcyBhbmQgdGhlIHBvbGxpbmcgcmF0ZSBzaG91bGQgYmUgYWRqdXN0ZWQgdG8gdGhlXG4gIC8vIG1heGltdW0gdmFsdWVcbiAgX1BPU1RfRU5ERURfTUlOX1BPTExfQ09VTlRFUl9MSU1JVCA6IDMsXG5cbiAgLyogSW5mb3JtYXRpb24gcmVmcmVzaCB0aW1lciAqL1xuICBfaW5mb3JtYXRpb25SZWZyZXNoVGltZXIgOiBudWxsLFxuICAvKipcbiAgICogY291bnRlciBmb3IgdGhlIG51bWJlciBvZiB0aW1lcyB0aGUgcG9sbGluZyByYXRlIGlzIGtlcHQgaW4gdGhlIG1pbmltdW1cbiAgICogYWZ0ZXIgaXQgaXMgc3VwcG9zZWQgdG8gYmUgc2V0IHRvIHRoZSBtYXhpbXVtXG4gICAqL1xuICBfcG9zdEVuZGVkTWluUG9sbENvdW50ZXIgOiBudWxsLFxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyB0aGUgc2VydmljZS5cbiAgICovXG4gIGluaXQ6IGZ1bmN0aW9uKCkge1xuICAgIFxuICAgIE9ic2VydmVySGVscGVyLmFkZE9ic2VydmVyKHRoaXMsIFRvcGljcy5BQ0NPVU5UX1NJR05FRF9JTik7XG4gICAgT2JzZXJ2ZXJIZWxwZXIuYWRkT2JzZXJ2ZXIodGhpcywgVG9waWNzLkFDQ09VTlRfU0lHTkVEX09VVCk7XG4gICAgT2JzZXJ2ZXJIZWxwZXIuYWRkT2JzZXJ2ZXIodGhpcywgVG9waWNzLklURU1fRU5ERUQpO1xuICB9LFxuXG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIGluZm9ybWF0aW9uIHJlZnJlc2ggdGltZXIuXG4gICAqL1xuICBfc2V0SW5mb3JtYXRpb25SZWZyZXNoVGltZXIgOiBmdW5jdGlvbigpIHtcbiAgICBcbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgdmFyIHRpbWVyQ2FsbGJhY2sgPSBmdW5jdGlvbigpIHtcbiAgICAgIHRoYXQuZ2V0SW5mb3JtYXRpb25SZWZyZXNoVXBkYXRlKCk7XG4gICAgfTtcbiAgICB2YXIgZ2V0T3B0aW1hbFBvbGxpbmdDYWxsYmFjayA9IGZ1bmN0aW9uKGFOZXdQb2xsUGVyaW9kKSB7XG4gICAgICBpZiAodGhhdC5faW5mb3JtYXRpb25SZWZyZXNoVGltZXIpIHtcbiAgICAgICAgdGhhdC5faW5mb3JtYXRpb25SZWZyZXNoVGltZXIuY2FuY2VsKCk7XG4gICAgICB9XG4gICAgICB0aGF0Ll9pbmZvcm1hdGlvblJlZnJlc2hUaW1lciA9IG5ldyBUaW1lcih0aW1lckNhbGxiYWNrLCBhTmV3UG9sbFBlcmlvZCk7XG4gICAgfTtcbiAgICB0aGlzLl9nZXRPcHRpbWFsUG9sbGluZ1BlcmlvZEZvck5leHRVcGRhdGUoZ2V0T3B0aW1hbFBvbGxpbmdDYWxsYmFjayk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFN0b3BzIHRoZSBpbmZvcm1hdGlvbiByZWZyZXNoLCB3aGljaCB1cGRhdGVzIHRoZSBleHRlbnNpb24gYmFkZ2UuXG4gICAqL1xuICBzdG9wSW5mb3JtYXRpb25SZWZyZXNoIDogZnVuY3Rpb24oKSB7XG4gICAgXG4gICAgaWYgKHRoaXMuX2luZm9ybWF0aW9uUmVmcmVzaFRpbWVyKSB7XG4gICAgICB0aGlzLl9pbmZvcm1hdGlvblJlZnJlc2hUaW1lci5jYW5jZWwoKTtcbiAgICAgIGRlbGV0ZSB0aGlzLl9pbmZvcm1hdGlvblJlZnJlc2hUaW1lcjtcbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqIFN0YXJ0cyB0aGUgaW5mb3JtYXRpb24gcmVmcmVzaCwgd2hpY2ggdXBkYXRlcyB0aGUgZXh0ZW5zaW9uIGJhZGdlLlxuICAgKi9cbiAgc3RhcnRJbmZvcm1hdGlvblJlZnJlc2ggOiBmdW5jdGlvbigpIHtcbiAgICBcbiAgICB0aGlzLl9zZXRJbmZvcm1hdGlvblJlZnJlc2hUaW1lcigpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBvcHRpbWFsIHBlcmlvZCBmb3IgbmV4dCB1cGRhdGUuXG4gICAqIEByZXR1cm4gdGhlIG9wdGltYWwgcGVyaW9kIGZvciBuZXh0IHVwZGF0ZS5cbiAgICogQHBhcmFtIGFDYWxsYmFjayB0aGUgY2FsbGJhY2sgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIHByb2Nlc3MgZmluaXNoZXNcbiAgICovXG4gIF9nZXRPcHRpbWFsUG9sbGluZ1BlcmlvZEZvck5leHRVcGRhdGUgOiBmdW5jdGlvbihhQ2FsbGJhY2spIHtcbiAgICBcbiAgICB2YXIgcG9sbFBlcmlvZCA9IHRoaXMuX1BPTExJTkdfTUFYX1BFUklPRDtcbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgdmFyIHNvb25lc3RFbmRUaW1lID0gSW5mb3JtYXRpb25SZWZyZXNoU2VydmljZS5nZXRTb29uZXN0RW5kVGltZSgpO1xuXG4gICAgaWYgKHNvb25lc3RFbmRUaW1lICE9PSBudWxsKSB7XG4gICAgICB2YXIgZWJheVRpbWUgPSBDb21tb25TZXJ2aWNlLmdldGVCYXlUaW1lKCkuZ2V0VGltZSgpO1xuICAgICAgdmFyIHRpbWVMZWZ0ID0gTWF0aC5tYXgoMCwgc29vbmVzdEVuZFRpbWUgLSBlYmF5VGltZSk7XG4gICAgICAvLyBzdGFydCB3aXRoIHJhdGlvLCB0aGVuIGFwcGx5IGxpbWl0cy5cbiAgICAgIHBvbGxQZXJpb2QgPSBNYXRoLnJvdW5kKHRpbWVMZWZ0ICogdGhhdC5fUE9MTElOR19SQVRJTyk7XG4gICAgICBwb2xsUGVyaW9kID0gTWF0aC5tYXgocG9sbFBlcmlvZCwgdGhhdC5fUE9MTElOR19NSU5fUEVSSU9EKTtcbiAgICAgIHBvbGxQZXJpb2QgPSBNYXRoLm1pbihwb2xsUGVyaW9kLCB0aGF0Ll9QT0xMSU5HX01BWF9QRVJJT0QpO1xuICAgIH1cblxuICAgIHZhciBjdXJyZW50UG9sbGluZ1BlcmlvZCA9IHRoYXQuX1BPTExJTkdfTUFYX1BFUklPRDtcbiAgICBpZiAodGhhdC5faW5mb3JtYXRpb25SZWZyZXNoVGltZXIpIHtcbiAgICAgIGN1cnJlbnRQb2xsaW5nUGVyaW9kID0gdGhhdC5faW5mb3JtYXRpb25SZWZyZXNoVGltZXIuaW50ZXJ2YWw7XG5cbiAgICAgIGlmIChjdXJyZW50UG9sbGluZ1BlcmlvZCA9PSB0aGF0Ll9QT0xMSU5HX01JTl9QRVJJT0QgJiZcbiAgICAgICAgICBwb2xsUGVyaW9kID09IHRoYXQuX1BPTExJTkdfTUFYX1BFUklPRCkge1xuICAgICAgICBpZiAodGhhdC5fcG9zdEVuZGVkTWluUG9sbENvdW50ZXIgPT09IG51bGwpIHtcbiAgICAgICAgICB0aGF0Ll9wb3N0RW5kZWRNaW5Qb2xsQ291bnRlciA9IDE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhhdC5fcG9zdEVuZGVkTWluUG9sbENvdW50ZXIgPSB0aGF0Ll9wb3N0RW5kZWRNaW5Qb2xsQ291bnRlciArIDE7XG4gICAgICAgICAgLy8gaWYgd2UgaGF2ZSByZWFjaGVkIHRoZSBsaW1pdCBvZiB0aW1lcyB0byBrZWVwIHRoZSBwb2xsaW5nIHJhdGUgaW5cbiAgICAgICAgICAvLyBpdHMgbWluaW11bSBhZnRlciBhbiBpdGVtIGZpbmlzaGVzLCB3ZSBzZXQgdGhlIGNvdW50ZXIgdG8gbnVsbFxuICAgICAgICAgIC8vIHNvIHRoZSBwb2xsaW5nIHJhdGUgaXMgc2V0IHRvIHRoZSBtYXggdmFsdWVcbiAgICAgICAgICBpZiAodGhhdC5fcG9zdEVuZGVkTWluUG9sbENvdW50ZXIgPiB0aGF0Ll9QT1NUX0VOREVEX01JTl9QT0xMX0NPVU5URVJfTElNSVQpIHtcbiAgICAgICAgICAgIHRoYXQuX3Bvc3RFbmRlZE1pblBvbGxDb3VudGVyID0gbnVsbDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gaWYgd2UgYXJlIGFib3V0IHRvIHNldCB0aGUgcG9sbGluZyByYXRlIHRvIHRoZSBtYXgsIGJ1dCB0aGUgbWluXG4gICAgICAgIGlmICh0aGF0Ll9wb3N0RW5kZWRNaW5Qb2xsQ291bnRlciAhPT0gbnVsbCkge1xuICAgICAgICAgIHBvbGxQZXJpb2QgPSB0aGF0Ll9QT0xMSU5HX01JTl9QRVJJT0Q7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgYUNhbGxiYWNrKHBvbGxQZXJpb2QpO1xuICB9LFxuXG5cbiAgZ2V0SW5mb3JtYXRpb25SZWZyZXNoVXBkYXRlIDogZnVuY3Rpb24oKSB7XG4gICAgXG4gICAgaWYgKCFTeW1iYW5TZXJ2aWNlLmlzVXBkYXRpbmdEYXRhKSB7XG4gICAgICBTeW1iYW5TZXJ2aWNlLmdldEJhZGdlQ291bnQoKTtcbiAgICB9XG5cbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgLy9kb1doZW5BbGxGaW5pc2hlZFxuICAgIHRoYXQuX3NldEluZm9ybWF0aW9uUmVmcmVzaFRpbWVyKCk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGl0ZW0gd2l0aCB0aGUgZW5kaW5nIHNvb25lc3QgdGltZXN0YW1wIGFuZCByZXR1cm5zIGl0cyB0aW1lc3RhbXAuXG4gICAqIEByZXR1cm5zIHRoZSBpdGVtIHdpdGggdGhlIGVuZGluZyBzb29uZXN0IHRpbWVzdGFtcCBhbmQgcmV0dXJucyBpdHMgdGltZXN0YW1wLlxuICAgKi9cbiAgZ2V0U29vbmVzdEVuZFRpbWUgOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgc29vbmVzdEVuZFRpbWUgPSBudWxsO1xuICAgIHZhciBlbmRUaW1lID0gbnVsbDtcbiAgICB2YXIgY3VycmVudExpc3Q7XG4gICAgdmFyIGxpc3ROYW1lcyA9IFtdO1xuICAgIGxpc3ROYW1lcy5wdXNoKFRyYWRpbmdBcGkuV0FUQ0hfTElTVCk7XG4gICAgbGlzdE5hbWVzLnB1c2goVHJhZGluZ0FwaS5CSURfTElTVCk7XG4gICAgbGlzdE5hbWVzLnB1c2goVHJhZGluZ0FwaS5CRVNUX09GRkVSX0xJU1QpO1xuICAgIGxpc3ROYW1lcy5wdXNoKFRyYWRpbmdBcGkuQUNUSVZFX0xJU1QpO1xuICAgIGxpc3ROYW1lcy5wdXNoKFRyYWRpbmdBcGkuU0VMTElOR19PRkZFUl9MSVNUKTtcblxuICAgICQuZWFjaChsaXN0TmFtZXMsIGZ1bmN0aW9uKGFJbmRleCwgYUxpc3ROYW1lKSB7XG4gICAgICBjdXJyZW50TGlzdCA9IE15RWJheVNlcnZpY2UuZ2V0TGlzdChhTGlzdE5hbWUpO1xuICAgICAgJC5lYWNoKGN1cnJlbnRMaXN0LCBmdW5jdGlvbihhSW5kZXgsIGFJdGVtKSB7XG4gICAgICAgIGlmIChhSXRlbS5nZXQoXCJlbmRUaW1lXCIpICYmICFhSXRlbS5pc0VuZGVkKCkgJiZcbiAgICAgICAgICAgIGFJdGVtLmdldChcImVuZFRpbWVcIikgPiBDb21tb25TZXJ2aWNlLmdldGVCYXlUaW1lKCkuZ2V0VGltZSgpKSB7XG4gICAgICAgICAgZW5kVGltZSA9IGFJdGVtLmdldChcImVuZFRpbWVcIik7XG4gICAgICAgICAgaWYgKDAgPCBlbmRUaW1lICYmICghc29vbmVzdEVuZFRpbWUgfHwgZW5kVGltZSA8IHNvb25lc3RFbmRUaW1lKSkge1xuICAgICAgICAgICAgc29vbmVzdEVuZFRpbWUgPSBlbmRUaW1lO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gc29vbmVzdEVuZFRpbWU7XG4gIH0sXG5cbiAgLyoqXG4gICAqIE9ic2VydmVzIGZvciBjaGFuZ2VzLlxuICAgKiBAcGFyYW0gYVRvcGljIHRoZSB0b3BpYyBuYW1lLlxuICAgKiBAcGFyYW0gYURhdGEgdGhlIGRhdGEgc2VudC5cbiAgICovXG4gIG9ic2VydmUgOiBmdW5jdGlvbihhVG9waWMsIGFEYXRhKSB7XG5cbiAgICBzd2l0Y2ggKGFUb3BpYykge1xuICAgICAgY2FzZSBUb3BpY3MuQUNDT1VOVF9TSUdORURfSU46XG4gICAgICAgIC8vbGV0J3MgZXhlY3V0ZSB0aGUgcG9sbGluZyBsb2dpYyBmb3IgU2FmYXJpLCBGaXJlZm94LCBhbmQgRWRnZS5cbiAgICAgICAgaWYgKENvbmZpZ3MuQlJPV1NFUiAhPT0gXCJjclwiKSB7XG4gICAgICAgICAgSW5mb3JtYXRpb25SZWZyZXNoU2VydmljZS5zdGFydEluZm9ybWF0aW9uUmVmcmVzaCgpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBUb3BpY3MuQUNDT1VOVF9TSUdORURfT1VUOlxuICAgICAgICAvL2xldCdzIGV4ZWN1dGUgdGhlIHBvbGxpbmcgbG9naWMgZm9yIFNhZmFyaSwgRmlyZWZveCwgYW5kIEVkZ2UuXG4gICAgICAgIGlmIChDb25maWdzLkJST1dTRVIgIT09IFwiY3JcIikge1xuICAgICAgICAgIEluZm9ybWF0aW9uUmVmcmVzaFNlcnZpY2Uuc3RvcEluZm9ybWF0aW9uUmVmcmVzaCgpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBUb3BpY3MuSVRFTV9FTkRFRDpcbiAgICAgICAgTXlFYmF5U2VydmljZS51cGRhdGVJdGVtRW5kZWQoYURhdGEpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxufTtcblxuLyoqXG4gKiBDb25zdHJ1Y3Rvci5cbiAqL1xuKGZ1bmN0aW9uKCkgeyB0aGlzLmluaXQoKTsgfSkuYXBwbHkoSW5mb3JtYXRpb25SZWZyZXNoU2VydmljZSk7XG4iXX0=