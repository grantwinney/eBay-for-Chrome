/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var AddressBook = ebay.apis.addressBook;
var Trading = ebay.apis.trading;
var AccountService = {
    _activeAccount: null,
    _loginSessionId: null,
    isUpdatingData: false,
    get activeAccount() {
        if (this._activeAccount === null) {
            this._activeAccount = Account.getAccount();
            Store.dispatch(addAccount(this._activeAccount));
        }
        return this._activeAccount;
    },
    _init: function () {
        ObserverHelper.addObserver(this, Topics.FORCE_ACCOUNT_SIGN_OUT);
        ObserverHelper.addObserver(this, Topics.USER_TOKEN_EXPIRED);
    },
    setUserToken: function (aToken, aCallback) {
        var eventTracker = new EventTracker("Sign In");
        var gotToken = eventTracker.addCallbackEvent();
        var updatedAccount = eventTracker.addCallbackEvent();
        var that = this;
        eventTracker.doWhenAllFinished(aCallback);
        var accountUpdateCallback = function (aNumErrors) {
            that._signedIn();
            updatedAccount();
        };
        var tokenCallback = function (aToken) {
            try {
                var token = aToken;
                if (!token || token === "") {
                    Logger.error("FetchToken returned an empty token (oauth); sign in aborted");
                    return;
                }
                gotToken();
                var getUsername = function (aResult) {
                    if (!aResult.message) {
                        that._activeAccount = new Account(aResult);
                        that._activeAccount.set("token", token);
                        that._activeAccount.set("registrationSite", Site.getHomeSite());
                        that._activeAccount.set("feedbackRating", 0);
                        that._activeAccount.set("numUnreadMessages", 0);
                        Store.dispatch(addAccount(that._activeAccount));
                        that.updateAccount(that._activeAccount.get("userId"), that._activeAccount.get("token"), accountUpdateCallback);
                    }
                };
                var authConfig = {
                    endPoint: ApiHelper.getEndPoint("tradingApi"),
                    extVersion: BrowserHelper.getExtensionVersion(),
                    requestIdentifier: CommonService.getRequestIdentifier(),
                    siteId: Site.siteIdForSite(Site.getHomeSite()),
                    token: { access_token: aToken }
                };
                Trading.getUsername(authConfig)
                    .then(getUsername)
                    .catch(function (reason) {
                    console.log(reason);
                });
            }
            catch (e) {
                Logger.error("AccountService.setUserToken.tokenCallback Error: " + e.message);
            }
        };
        ObserverHelper.notify(Topics.ACCOUNT_SIGNING_IN, null);
        tokenCallback(aToken);
    },
    _signedIn: function () {
        if (PropertyDAO.get(PropertyDAO.PROP_FIRST_SIGNIN)) {
            EventAnalytics.push({ key: "Account", action: "SignIn" });
            RoverUrlHelper.sendTrackingRequest("activate");
        }
        else {
            EventAnalytics.push({ key: "Acquisition", action: "FirstSignIn" });
            EventAnalytics.push({ key: "Account", action: "SignIn" });
            PropertyDAO.set(PropertyDAO.PROP_FIRST_SIGNIN, true);
        }
        var that = this;
        new Timer(function () {
            ObserverHelper.notify(Topics.ACCOUNT_SIGNED_IN, { account: that._activeAccount,
                homeSite: Site.getHomeSite() });
        }, 1000);
    },
    updateAccount: function (aUserId, aToken, aCallback) {
        var that = this;
        var getUser;
        var getAddresses;
        var getUserProfileCallback;
        var siteId = Site.siteIdForSite(Site.getHomeSite());
        var eventTracker = new EventTracker("Account Update");
        eventTracker.doWhenAllFinished(function () {
            aCallback();
        });
        getUser = function (aResult) {
            if (aResult.feedbackRating != that._activeAccount.get("feedbackRating")) {
                that._activeAccount.set("feedbackRating", aResult.feedbackRating);
            }
            if (aResult.registrationSite != that._activeAccount.get("registrationSite")) {
                that._activeAccount.set("registrationSite", aResult.registrationSite);
            }
            if (aResult.email && aResult.email.indexOf("@") != -1 &&
                aResult.email != that._activeAccount.get("email")) {
                that._activeAccount.set("email", aResult.email);
            }
            if (aResult.name &&
                aResult.name != that._activeAccount.get("name")) {
                that._activeAccount.set("name", aResult.name);
            }
        };
        var authConfig = {
            endPoint: ApiHelper.getEndPoint("tradingApi"),
            extVersion: BrowserHelper.getExtensionVersion(),
            requestIdentifier: CommonService.getRequestIdentifier(),
            siteId: Site.siteIdForSite(Site.getHomeSite()),
            token: aToken
        };
        Trading.getUser(aUserId, authConfig)
            .then(getUser)
            .catch(function (reason) {
            console.log(reason);
        });
        getAddresses = function (aResult) {
            if (!aResult || aResult.errors || !that._activeAccount) {
                eventTracker.failRemainingEvents();
                return;
            }
            for (var i = 0; i < aResult.length; i++) {
                var address = aResult[i];
                if (address.type.indexOf("Shipping") === 0 &&
                    address.status.toLowerCase() === "default") {
                    if (address.country !== that._activeAccount.get("shippingCountry")) {
                        that._activeAccount.set("shippingCountry", address.country);
                    }
                    break;
                }
            }
        };
        var site = Site.siteDataForSite(Site.getHomeSite());
        AddressBook.getAddresses(aToken, site, Configs)
            .then(getAddresses)
            .catch(function (error) {
            console.log(error);
        });
        getUserProfileCallback = function (aResult) {
            if (aResult && that._activeAccount &&
                that._activeAccount.get("avatarImage") != aResult.myWorldSmallImage) {
                var info = {};
                that._activeAccount.set("avatarImage", aResult.myWorldSmallImage);
                info.object = that._activeAccount;
                ObserverHelper.notify(Topics.ACCOUNT_AVATAR_IMAGE_CHANGED, info);
            }
        };
        eventTracker.addRequest(ShoppingApi.getUserProfile(that.activeAccount, aUserId, siteId, getUserProfileCallback));
    },
    signOut: function () {
        if (!this.activeAccount) {
            Logger.warn("Attempt to log out when there is no active account.");
            return;
        }
        this.activeAccount.delete();
        this._activeAccount = null;
        Store.dispatch(deleteAccount());
        EventAnalytics.push({ key: "Account", action: "SignOut" });
        ObserverHelper.notify(Topics.ACCOUNT_SIGNED_OUT, null);
    },
    handleUserTokenExpired: function () {
        if (AccountService._userSignOutTimer) {
            AccountService._userSignOutTimer.cancel();
            AccountService._userSignOutTimer = null;
        }
        AccountService._userSignOutTimer = new Timer(function () {
            AccountService.signOut();
        }, 3000, false);
    },
    observe: function (aTopic, aData) {
        switch (aTopic) {
            case Topics.USER_TOKEN_EXPIRED:
                this.handleUserTokenExpired();
                break;
            case Topics.FORCE_ACCOUNT_SIGN_OUT:
                this.signOut();
                break;
        }
    }
};
(function () { this._init(); }).apply(AccountService);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWNjb3VudFNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9iYWNrZ3JvdW5kL2NvcmUvc2VydmljZXMvYWNjb3VudFNlcnZpY2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7O0dBRUc7QUFtQkgsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7QUFDeEMsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7QUFLaEMsSUFBSSxjQUFjLEdBQUc7SUFFbkIsY0FBYyxFQUFHLElBQUk7SUFFckIsZUFBZSxFQUFHLElBQUk7SUFFdEIsY0FBYyxFQUFHLEtBQUs7SUFNdEIsSUFBSSxhQUFhO1FBQ2YsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxjQUFjLEdBQUcsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQzNDLEtBQUssQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO1FBQ2xELENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUM3QixDQUFDO0lBS0QsS0FBSyxFQUFHO1FBRU4sY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFDaEUsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDOUQsQ0FBQztJQU9ELFlBQVksRUFBRyxVQUFTLE1BQU0sRUFBRSxTQUFTO1FBRXZDLElBQUksWUFBWSxHQUFHLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQy9DLElBQUksUUFBUSxHQUFHLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQy9DLElBQUksY0FBYyxHQUFH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QkFDNUIsSUFBSSxDQUFDLHNCQUFzQixFQUFFLENBQUM7Z0JBQzlCLEtBQUssQ0FBQztZQUNSLEtBQUssTUFBTSxDQUFDLHNCQUFzQjtnQkFDaEMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNmLEtBQUssQ0FBQztRQUNWLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQztBQUtGLENBQUMsY0FBYSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIENvcHlyaWdodCAoQykgMjAwNy0yMDE1IGVCYXkgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICovXG5cbi8qXG4gIHZhciBTdG9yZSA9IHJlcXVpcmUoXCJjb3JlL3N0b3JlXCIpLlN0b3JlO1xuICB2YXIgYWRkQWNjb3VudCA9IHJlcXVpcmUoXCJjb3JlL2FjdGlvbnNcIikuYWRkQWNjb3VudDtcbiAgdmFyIGRlbGV0ZUFjY291bnQgPSByZXF1aXJlKFwiY29yZS9hY3Rpb25zXCIpLmRlbGV0ZUFjY291bnQ7XG4gIHZhciBMb2dnZXIgPSByZXF1aXJlKFwiaGVscGVycy9sb2dnZXJcIikuTG9nZ2VyO1xuICB2YXIgVG9waWNzID0gcmVxdWlyZShcImhlbHBlcnMvb2JzZXJ2ZXJIZWxwZXJcIikuVG9waWNzO1xuICB2YXIgT2JzZXJ2ZXJIZWxwZXIgPSByZXF1aXJlKFwiaGVscGVycy9vYnNlcnZlckhlbHBlclwiKS5PYnNlcnZlckhlbHBlcjtcbiAgdmFyIFRpbWVyID0gcmVxdWlyZShcImhlbHBlcnMvdGltZXJcIikuVGltZXI7XG4gIHZhciBSb3ZlclVybEhlbHBlciA9IHJlcXVpcmUoXCJjb3JlL2hlbHBlcnMvcm92ZXJVcmxIZWxwZXJcIikuUm92ZXJVcmxIZWxwZXI7XG4gIHZhciBQcm9wZXJ0eURBTyA9IHJlcXVpcmUoXCJzdG9yYWdlL3Byb3BlcnR5REFPXCIpLlByb3BlcnR5REFPO1xuICB2YXIgRXZlbnRUcmFja2VyID0gcmVxdWlyZShcImNvcmUvaGVscGVycy9ldmVudFRyYWNrZXJcIikuRXZlbnRUcmFja2VyO1xuICB2YXIgQWNjb3VudCA9IHJlcXVpcmUoXCJjb3JlL29iamVjdHMvYWNjb3VudFwiKS5BY2NvdW50O1xuICB2YXIgRXZlbnRBbmFseXRpY3MgPSByZXF1aXJlKFwiY29yZS9oZWxwZXJzL2V2ZW50QW5hbHl0aWNzXCIpLkV2ZW50QW5hbHl0aWNzO1xuICB2YXIgQWRkcmVzc0Jvb2tBcGkgPSByZXF1aXJlKFwiY29yZS9hcGlzL2FkZHJlc3NCb29rQXBpXCIpLkFkZHJlc3NCb29rQXBpO1xuICB2YXIgU2hvcHBpbmdBcGkgPSByZXF1aXJlKFwiY29yZS9hcGlzL3Nob3BwaW5nQXBpXCIpLlNob3BwaW5nQXBpO1xuICB2YXIgVHJhZGluZ0FwaSA9IHJlcXVpcmUoXCJjb3JlL2FwaXMvdHJhZGluZ0FwaVwiKS5UcmFkaW5nQXBpO1xuKi9cbnZhciBBZGRyZXNzQm9vayA9IGViYXkuYXBpcy5hZGRyZXNzQm9vaztcbnZhciBUcmFkaW5nID0gZWJheS5hcGlzLnRyYWRpbmc7XG5cbi8qKlxuICogQWNjb3VudCBTZXJ2aWNlLlxuICovXG52YXIgQWNjb3VudFNlcnZpY2UgPSB7XG4gIC8qIEFjdGl2ZSBhY2NvdW50LiAqL1xuICBfYWN0aXZlQWNjb3VudCA6IG51bGwsXG4gIC8qIGxvZ2luIHNlc3Npb24gaWQuICovXG4gIF9sb2dpblNlc3Npb25JZCA6IG51bGwsXG4gIC8qIGluZGljYXRlcyB3ZSBhcmUgcmV0cmlldmluZyB0aGUgdXNlcidzIGluZm9ybWF0aW9uICovXG4gIGlzVXBkYXRpbmdEYXRhIDogZmFsc2UsXG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGFjdGl2ZSBhY2NvdW50LlxuICAgKiBAcmV0dXJuIHRoZSBhY3RpdmUgYWNjb3VudC5cbiAgICovXG4gIGdldCBhY3RpdmVBY2NvdW50KCkge1xuICAgIGlmICh0aGlzLl9hY3RpdmVBY2NvdW50ID09PSBudWxsKSB7XG4gICAgICB0aGlzLl9hY3RpdmVBY2NvdW50ID0gQWNjb3VudC5nZXRBY2NvdW50KCk7XG4gICAgICBTdG9yZS5kaXNwYXRjaChhZGRBY2NvdW50KHRoaXMuX2FjdGl2ZUFjY291bnQpKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2FjdGl2ZUFjY291bnQ7XG4gIH0sXG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemVzIHRoZSBzZXJ2aWNlLlxuICAgKi9cbiAgX2luaXQgOiBmdW5jdGlvbigpIHtcblxuICAgIE9ic2VydmVySGVscGVyLmFkZE9ic2VydmVyKHRoaXMsIFRvcGljcy5GT1JDRV9BQ0NPVU5UX1NJR05fT1VUKTtcbiAgICBPYnNlcnZlckhlbHBlci5hZGRPYnNlcnZlcih0aGlzLCBUb3BpY3MuVVNFUl9UT0tFTl9FWFBJUkVEKTtcbiAgfSxcblxuICAvKipcbiAgICogQXV0aGVudGljYXRlcyBhIHVzZXJcbiAgICogQHBhcmFtIGFUb2tlbiB0aGUgZUJheSBVc2VyIHRva2VuLlxuICAgKiBAcGFyYW0gYUNhbGxiYWNrIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiBkb25lLlxuICAgKi9cbiAgc2V0VXNlclRva2VuIDogZnVuY3Rpb24oYVRva2VuLCBhQ2FsbGJhY2spIHtcblxuICAgIHZhciBldmVudFRyYWNrZXIgPSBuZXcgRXZlbnRUcmFja2VyKFwiU2lnbiBJblwiKTtcbiAgICB2YXIgZ290VG9rZW4gPSBldmVudFRyYWNrZXIuYWRkQ2FsbGJhY2tFdmVudCgpO1xuICAgIHZhciB1cGRhdGVkQWNjb3VudCA9IGV2ZW50VHJhY2tlci5hZGRDYWxsYmFja0V2ZW50KCk7XG4gICAgdmFyIHRoYXQgPSB0aGlzO1xuXG4gICAgZXZlbnRUcmFja2VyLmRvV2hlbkFsbEZpbmlzaGVkKGFDYWxsYmFjayk7XG5cbiAgICB2YXIgYWNjb3VudFVwZGF0ZUNhbGxiYWNrID0gZnVuY3Rpb24oYU51bUVycm9ycykge1xuICAgICAgdGhhdC5fc2lnbmVkSW4oKTtcbiAgICAgIC8vIGluZm9ybSBldmVudCB0cmFja2VyLlxuICAgICAgdXBkYXRlZEFjY291bnQoKTtcbiAgICB9O1xuXG4gICAgdmFyIHRva2VuQ2FsbGJhY2sgPSBmdW5jdGlvbihhVG9rZW4pIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHZhciB0b2tlbiA9IGFUb2tlbjtcblxuICAgICAgICBpZiAoIXRva2VuIHx8IHRva2VuID09PSBcIlwiKSB7XG4gICAgICAgICAgTG9nZ2VyLmVycm9yKFwiRmV0Y2hUb2tlbiByZXR1cm5lZCBhbiBlbXB0eSB0b2tlbiAob2F1dGgpOyBzaWduIGluIGFib3J0ZWRcIik7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gaW5mb3JtIGV2ZW50IHRyYWNrZXIuXG4gICAgICAgIGdvdFRva2VuKCk7XG5cbiAgICAgICAgdmFyIGdldFVzZXJuYW1lID0gZnVuY3Rpb24oYVJlc3VsdCkge1xuICAgICAgICAgIC8vIElmIGl0IGhhcyBhIG1lc3NhZ2UsIGl0J3MgYW4gZXhjZXB0aW9uXG4gICAgICAgICAgaWYgKCFhUmVzdWx0Lm1lc3NhZ2UpIHtcbiAgICAgICAgICAgIHRoYXQuX2FjdGl2ZUFjY291bnQgPSBuZXcgQWNjb3VudChhUmVzdWx0KTtcbiAgICAgICAgICAgIHRoYXQuX2FjdGl2ZUFjY291bnQuc2V0KFwidG9rZW5cIiwgdG9rZW4pO1xuICAgICAgICAgICAgdGhhdC5fYWN0aXZlQWNjb3VudC5zZXQoXCJyZWdpc3RyYXRpb25TaXRlXCIsIFNpdGUuZ2V0SG9tZVNpdGUoKSk7XG4gICAgICAgICAgICB0aGF0Ll9hY3RpdmVBY2NvdW50LnNldChcImZlZWRiYWNrUmF0aW5nXCIsIDApO1xuICAgICAgICAgICAgdGhhdC5fYWN0aXZlQWNjb3VudC5zZXQoXCJudW1VbnJlYWRNZXNzYWdlc1wiLCAwKTtcblxuICAgICAgICAgICAgU3RvcmUuZGlzcGF0Y2goYWRkQWNjb3VudCh0aGF0Ll9hY3RpdmVBY2NvdW50KSk7XG5cbiAgICAgICAgICAgIHRoYXQudXBkYXRlQWNjb3VudChcbiAgICAgICAgICAgICAgdGhhdC5fYWN0aXZlQWNjb3VudC5nZXQoXCJ1c2VySWRcIiksXG4gICAgICAgICAgICAgIHRoYXQuX2FjdGl2ZUFjY291bnQuZ2V0KFwidG9rZW5cIiksXG4gICAgICAgICAgICAgIGFjY291bnRVcGRhdGVDYWxsYmFjayk7XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB2YXIgYXV0aENvbmZpZyA9IHtcbiAgICAgICAgICBlbmRQb2ludDogQXBpSGVscGVyLmdldEVuZFBvaW50KFwidHJhZGluZ0FwaVwiKSxcbiAgICAgICAgICBleHRWZXJzaW9uOiBCcm93c2VySGVscGVyLmdldEV4dGVuc2lvblZlcnNpb24oKSxcbiAgICAgICAgICByZXF1ZXN0SWRlbnRpZmllcjogQ29tbW9uU2VydmljZS5nZXRSZXF1ZXN0SWRlbnRpZmllcigpLFxuICAgICAgICAgIHNpdGVJZDogU2l0ZS5zaXRlSWRGb3JTaXRlKFNpdGUuZ2V0SG9tZVNpdGUoKSksXG4gICAgICAgICAgdG9rZW46IHsgYWNjZXNzX3Rva2VuOiBhVG9rZW4gfVxuICAgICAgICB9O1xuICAgICAgICBUcmFkaW5nLmdldFVzZXJuYW1lKGF1dGhDb25maWcpXG4gICAgICAgICAgLnRoZW4oZ2V0VXNlcm5hbWUpXG4gICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKHJlYXNvbikge1xuICAgICAgICAgICAgY29uc29sZS5sb2cocmVhc29uKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICBMb2dnZXIuZXJyb3IoXCJBY2NvdW50U2VydmljZS5zZXRVc2VyVG9rZW4udG9rZW5DYWxsYmFjayBFcnJvcjogXCIgKyBlLm1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoVG9waWNzLkFDQ09VTlRfU0lHTklOR19JTiwgbnVsbCk7XG4gICAgdG9rZW5DYWxsYmFjayhhVG9rZW4pO1xuICB9LFxuXG4gIC8qKlxuICAgKiBDYWxscyBvbmNlIGFuIGFjY291bnQgaXMgc2lnbmVkIGluLlxuICAgKi9cbiAgX3NpZ25lZEluIDogZnVuY3Rpb24oKSB7XG5cbiAgICAvLyBSZXBvcnQgaW5zdGFsbGF0aW9uIGlmIHRoaXMgaXMgdGhlIGZpcnN0IHNpZ24gaW5cbiAgICBpZiAoUHJvcGVydHlEQU8uZ2V0KFByb3BlcnR5REFPLlBST1BfRklSU1RfU0lHTklOKSkge1xuICAgICAgRXZlbnRBbmFseXRpY3MucHVzaCh7IGtleTogXCJBY2NvdW50XCIsIGFjdGlvbjogXCJTaWduSW5cIiB9KTtcbiAgICAgIFJvdmVyVXJsSGVscGVyLnNlbmRUcmFja2luZ1JlcXVlc3QoXCJhY3RpdmF0ZVwiKTtcblxuICAgIH0gZWxzZSB7XG4gICAgICBFdmVudEFuYWx5dGljcy5wdXNoKHsga2V5OiBcIkFjcXVpc2l0aW9uXCIsIGFjdGlvbjogXCJGaXJzdFNpZ25JblwiIH0pO1xuICAgICAgRXZlbnRBbmFseXRpY3MucHVzaCh7IGtleTogXCJBY2NvdW50XCIsIGFjdGlvbjogXCJTaWduSW5cIiB9KTtcbiAgICAgIFByb3BlcnR5REFPLnNldChQcm9wZXJ0eURBTy5QUk9QX0ZJUlNUX1NJR05JTiwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgIG5ldyBUaW1lcihmdW5jdGlvbigpIHtcbiAgICAgIE9ic2VydmVySGVscGVyLm5vdGlmeShcbiAgICAgICAgVG9waWNzLkFDQ09VTlRfU0lHTkVEX0lOLFxuICAgICAgICB7IGFjY291bnQgOiB0aGF0Ll9hY3RpdmVBY2NvdW50LFxuICAgICAgICAgIGhvbWVTaXRlIDogU2l0ZS5nZXRIb21lU2l0ZSgpIH1cbiAgICAgICk7XG4gICAgfSwgMTAwMCk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgYWNjb3VudC5cbiAgICogQHBhcmFtIGFVc2VySWQgdGhlIGlkIG9mIHRoZSB1c2VyIHRvIHVwZGF0ZSB0aGVpciBpbmZvXG4gICAqIEBwYXJhbSBhVG9rZW4gdGhlIHRva2VuIHRvIGJlIHVzZWQgaW4gdGhlIHJlcXVlc3RcbiAgICogQHBhcmFtIGFDYWxsYmFjayB0aGUgY2FsbGJhY2suXG4gICAqL1xuICB1cGRhdGVBY2NvdW50IDogZnVuY3Rpb24oYVVzZXJJZCwgYVRva2VuLCBhQ2FsbGJhY2spIHtcblxuICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICB2YXIgZ2V0VXNlcjtcbiAgICB2YXIgZ2V0QWRkcmVzc2VzO1xuICAgIHZhciBnZXRVc2VyUHJvZmlsZUNhbGxiYWNrO1xuICAgIHZhciBzaXRlSWQgPSBTaXRlLnNpdGVJZEZvclNpdGUoU2l0ZS5nZXRIb21lU2l0ZSgpKTtcblxuICAgIHZhciBldmVudFRyYWNrZXIgPSBuZXcgRXZlbnRUcmFja2VyKFwiQWNjb3VudCBVcGRhdGVcIik7XG4gICAgZXZlbnRUcmFja2VyLmRvV2hlbkFsbEZpbmlzaGVkKGZ1bmN0aW9uKCkge1xuICAgICAgYUNhbGxiYWNrKCk7XG4gICAgfSk7XG5cbiAgICBnZXRVc2VyID0gZnVuY3Rpb24oYVJlc3VsdCkge1xuICAgICAgaWYgKGFSZXN1bHQuZmVlZGJhY2tSYXRpbmcgIT0gdGhhdC5fYWN0aXZlQWNjb3VudC5nZXQoXCJmZWVkYmFja1JhdGluZ1wiKSkge1xuICAgICAgICB0aGF0Ll9hY3RpdmVBY2NvdW50LnNldChcImZlZWRiYWNrUmF0aW5nXCIsIGFSZXN1bHQuZmVlZGJhY2tSYXRpbmcpO1xuICAgICAgfVxuXG4gICAgICBpZiAoYVJlc3VsdC5yZWdpc3RyYXRpb25TaXRlICE9IHRoYXQuX2FjdGl2ZUFjY291bnQuZ2V0KFwicmVnaXN0cmF0aW9uU2l0ZVwiKSkge1xuICAgICAgICB0aGF0Ll9hY3RpdmVBY2NvdW50LnNldChcInJlZ2lzdHJhdGlvblNpdGVcIiwgYVJlc3VsdC5yZWdpc3RyYXRpb25TaXRlKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGFSZXN1bHQuZW1haWwgJiYgYVJlc3VsdC5lbWFpbC5pbmRleE9mKFwiQFwiKSAhPSAtMSAmJlxuICAgICAgICAgIGFSZXN1bHQuZW1haWwgIT0gdGhhdC5fYWN0aXZlQWNjb3VudC5nZXQoXCJlbWFpbFwiKSkge1xuICAgICAgICB0aGF0Ll9hY3RpdmVBY2NvdW50LnNldChcImVtYWlsXCIsIGFSZXN1bHQuZW1haWwpO1xuICAgICAgfVxuXG4gICAgICBpZiAoYVJlc3VsdC5uYW1lICYmXG4gICAgICAgICAgYVJlc3VsdC5uYW1lICE9IHRoYXQuX2FjdGl2ZUFjY291bnQuZ2V0KFwibmFtZVwiKSkge1xuICAgICAgICB0aGF0Ll9hY3RpdmVBY2NvdW50LnNldChcIm5hbWVcIiwgYVJlc3VsdC5uYW1lKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHZhciBhdXRoQ29uZmlnID0ge1xuICAgICAgZW5kUG9pbnQ6IEFwaUhlbHBlci5nZXRFbmRQb2ludChcInRyYWRpbmdBcGlcIiksXG4gICAgICBleHRWZXJzaW9uOiBCcm93c2VySGVscGVyLmdldEV4dGVuc2lvblZlcnNpb24oKSxcbiAgICAgIHJlcXVlc3RJZGVudGlmaWVyOiBDb21tb25TZXJ2aWNlLmdldFJlcXVlc3RJZGVudGlmaWVyKCksXG4gICAgICBzaXRlSWQ6IFNpdGUuc2l0ZUlkRm9yU2l0ZShTaXRlLmdldEhvbWVTaXRlKCkpLFxuICAgICAgdG9rZW46IGFUb2tlblxuICAgIH07XG4gICAgVHJhZGluZy5nZXRVc2VyKGFVc2VySWQsIGF1dGhDb25maWcpXG4gICAgICAudGhlbihnZXRVc2VyKVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uKHJlYXNvbikge1xuICAgICAgICBjb25zb2xlLmxvZyhyZWFzb24pO1xuICAgICAgfSk7XG5cbiAgICBnZXRBZGRyZXNzZXMgPSBmdW5jdGlvbihhUmVzdWx0KSB7XG4gICAgICBpZiAoIWFSZXN1bHQgfHwgYVJlc3VsdC5lcnJvcnMgfHwgIXRoYXQuX2FjdGl2ZUFjY291bnQpIHtcbiAgICAgICAgZXZlbnRUcmFja2VyLmZhaWxSZW1haW5pbmdFdmVudHMoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBzdG9yZSB0aGUgZGVmYXVsdCBzaGlwcGluZyBhZGRyZXNzXG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFSZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdmFyIGFkZHJlc3MgPSBhUmVzdWx0W2ldO1xuICAgICAgICBpZiAoYWRkcmVzcy50eXBlLmluZGV4T2YoXCJTaGlwcGluZ1wiKSA9PT0gMCAmJlxuICAgICAgICAgICAgYWRkcmVzcy5zdGF0dXMudG9Mb3dlckNhc2UoKSA9PT0gXCJkZWZhdWx0XCIpIHtcbiAgICAgICAgICBpZiAoYWRkcmVzcy5jb3VudHJ5ICE9PSB0aGF0Ll9hY3RpdmVBY2NvdW50LmdldChcInNoaXBwaW5nQ291bnRyeVwiKSkge1xuICAgICAgICAgICAgdGhhdC5fYWN0aXZlQWNjb3VudC5zZXQoXCJzaGlwcGluZ0NvdW50cnlcIiwgYWRkcmVzcy5jb3VudHJ5KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdmFyIHNpdGUgPSBTaXRlLnNpdGVEYXRhRm9yU2l0ZShTaXRlLmdldEhvbWVTaXRlKCkpO1xuICAgIEFkZHJlc3NCb29rLmdldEFkZHJlc3NlcyhhVG9rZW4sIHNpdGUsIENvbmZpZ3MpXG4gICAgICAudGhlbihnZXRBZGRyZXNzZXMpXG4gICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgICAgfSk7XG5cbiAgICBnZXRVc2VyUHJvZmlsZUNhbGxiYWNrID0gZnVuY3Rpb24oYVJlc3VsdCkge1xuICAgICAgaWYgKGFSZXN1bHQgJiYgdGhhdC5fYWN0aXZlQWNjb3VudCAmJlxuICAgICAgICB0aGF0Ll9hY3RpdmVBY2NvdW50LmdldChcImF2YXRhckltYWdlXCIpICE9IGFSZXN1bHQubXlXb3JsZFNtYWxsSW1hZ2UpIHtcbiAgICAgICAgdmFyIGluZm8gPSB7fTtcbiAgICAgICAgdGhhdC5fYWN0aXZlQWNjb3VudC5zZXQoXCJhdmF0YXJJbWFnZVwiLCBhUmVzdWx0Lm15V29ybGRTbWFsbEltYWdlKTtcbiAgICAgICAgaW5mby5vYmplY3QgPSB0aGF0Ll9hY3RpdmVBY2NvdW50O1xuXG4gICAgICAgIE9ic2VydmVySGVscGVyLm5vdGlmeShUb3BpY3MuQUNDT1VOVF9BVkFUQVJfSU1BR0VfQ0hBTkdFRCwgaW5mbyk7XG4gICAgICB9XG4gICAgfTtcbiAgICBldmVudFRyYWNrZXIuYWRkUmVxdWVzdChTaG9wcGluZ0FwaS5nZXRVc2VyUHJvZmlsZShcbiAgICAgIHRoYXQuYWN0aXZlQWNjb3VudCwgYVVzZXJJZCwgc2l0ZUlkLCBnZXRVc2VyUHJvZmlsZUNhbGxiYWNrXG4gICAgKSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIEludmFsaWRhdGVzIHRoZSBhY3RpdmUgYWNjb3VudC5cbiAgICovXG4gIHNpZ25PdXQgOiBmdW5jdGlvbigpIHtcbiAgICBcbiAgICBpZiAoIXRoaXMuYWN0aXZlQWNjb3VudCkge1xuICAgICAgTG9nZ2VyLndhcm4oXCJBdHRlbXB0IHRvIGxvZyBvdXQgd2hlbiB0aGVyZSBpcyBubyBhY3RpdmUgYWNjb3VudC5cIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5hY3RpdmVBY2NvdW50LmRlbGV0ZSgpO1xuICAgIHRoaXMuX2FjdGl2ZUFjY291bnQgPSBudWxsO1xuICAgIFN0b3JlLmRpc3BhdGNoKGRlbGV0ZUFjY291bnQoKSk7XG5cbiAgICBFdmVudEFuYWx5dGljcy5wdXNoKHsga2V5OiBcIkFjY291bnRcIiwgYWN0aW9uOiBcIlNpZ25PdXRcIiB9KTtcbiAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoVG9waWNzLkFDQ09VTlRfU0lHTkVEX09VVCwgbnVsbCk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIEhhbmRsZXMgdGhlIGV2ZW50IHdoZW4gYW4gdXNlciB0b2tlbiBoYXMgZXhwaXJlZC4gV2Ugc2hvdWxkIHNpZ24gb3V0IHRoZVxuICAgKiB1c2VyIHNvIGhlIGNhbiBzaWduIGluIGFnYWluIGFuIG9idGFpbiBhIG5vbiBleHBpcmVkIHRva2VuLlxuICAgKi9cbiAgaGFuZGxlVXNlclRva2VuRXhwaXJlZDogZnVuY3Rpb24oKSB7XG4gICAgaWYgKEFjY291bnRTZXJ2aWNlLl91c2VyU2lnbk91dFRpbWVyKSB7XG4gICAgICBBY2NvdW50U2VydmljZS5fdXNlclNpZ25PdXRUaW1lci5jYW5jZWwoKTtcbiAgICAgIEFjY291bnRTZXJ2aWNlLl91c2VyU2lnbk91dFRpbWVyID0gbnVsbDtcbiAgICB9XG4gICAgQWNjb3VudFNlcnZpY2UuX3VzZXJTaWduT3V0VGltZXIgPSBuZXcgVGltZXIoZnVuY3Rpb24oKSB7XG4gICAgICBBY2NvdW50U2VydmljZS5zaWduT3V0KCk7XG4gICAgfSwgMzAwMCwgZmFsc2UpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBPYnNlcnZlcyBmb3IgY2hhbmdlcy5cbiAgICogQHBhcmFtIGFUb3BpYyB0aGUgdG9waWMgbmFtZS5cbiAgICogQHBhcmFtIGFEYXRhIHRoZSBkYXRhIHNlbnQuXG4gICAqL1xuICBvYnNlcnZlIDogZnVuY3Rpb24oYVRvcGljLCBhRGF0YSkge1xuXG4gICAgc3dpdGNoIChhVG9waWMpIHtcbiAgICAgIGNhc2UgVG9waWNzLlVTRVJfVE9LRU5fRVhQSVJFRDpcbiAgICAgICAgdGhpcy5oYW5kbGVVc2VyVG9rZW5FeHBpcmVkKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBUb3BpY3MuRk9SQ0VfQUNDT1VOVF9TSUdOX09VVDpcbiAgICAgICAgdGhpcy5zaWduT3V0KCk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxufTtcblxuLyoqXG4gKiBDb25zdHJ1Y3Rvci5cbiAqL1xuKGZ1bmN0aW9uKCkgeyB0aGlzLl9pbml0KCk7IH0pLmFwcGx5KEFjY291bnRTZXJ2aWNlKTtcbiJdfQ==