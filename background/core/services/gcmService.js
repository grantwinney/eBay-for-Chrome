/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var GCMService = {
    _deviceToken: null,
    _debugMessagesArray: null,
    _retryTimer: null,
    _RETRY_TIMER_INTERVAL: 5 * 1000,
    _RETRY_ATTEMPTS_LIMIT: 5,
    _retryCount: 0,
    init: function () {
        ObserverHelper.addObserver(this, Topics.DEBUG_MESSAGE);
        this._deviceToken = PropertyDAO.get(PropertyDAO.PROP_GCM_REGISTRATION_ID);
        this._debugMessagesArray = new Array();
        this._retryTimer = {};
        this._retryTimer.callName = null;
        this._retryTimer.timer = null;
    },
    get debugMessagesArray() {
        return this._debugMessagesArray;
    },
    _resetRetryTimer: function () {
        this._retryTimer = {};
        this._retryTimer.callName = null;
        this._retryTimer.timer = null;
        this._retryCount = 0;
    },
    stopService: function (aSignOut) {
        if (aSignOut) {
            var currentAccount = Account.getAccount();
            var token = currentAccount.get("token");
            var userId = currentAccount.get("userId");
            var siteId = Site.siteIdForSite(Site.getHomeSite());
            var globalId = Site.getGlobalId();
            var deviceId = CommonService.getInstanceIdentifier();
            var deactivateCallback = function (aResponse) {
            };
            MDNSApi.deactivateUserOnDevice(token, GCMService._deviceToken, userId, siteId, globalId, deviceId, deactivateCallback);
        }
    },
    startService: function () {
        this._gcmRegister();
    },
    _gcmRegister: function () {
        var senderId = String(ApiHelper.getEndPoint("gcmSenderId"));
        ObserverHelper.notify(Topics.DEBUG_MESSAGE, "Starting Registration Process");
        chrome.gcm.register([senderId], GCMService._registerCallback);
    },
    _registerCallback: function (regId) {
        if (chrome.runtime.lastError) {
            ObserverHelper.notify(Topics.DEBUG_MESSAGE, JSON.stringify(chrome.runtime.lastError.message));
            if (GCMService._retryCount < GCMService._RETRY_ATTEMPTS_LIMIT) {
                GCMService._retryCount++;
                GCMService._retryTimer.callName = "gcmRegister";
                GCMService._retryTimer.timer = new Timer(function () {
                    GCMService.startService();
                }, GCMService._RETRY_TIMER_INTERVAL, false);
            }
            else {
                var errorMsg = "Retry attempts limit reached for call gcmRegister";
                ObserverHelper.notify(Topics.DEBUG_MESSAGE, errorMsg);
            }
            return;
        }
        if (GCMService._retryTimer.callName == "gcmRegister") {
            GCMService._resetRetryTimer();
        }
        ObserverHelper.notify(Topics.DEBUG_MESSAGE, "Got Registration Id");
        PropertyDAO.set(PropertyDAO.PROP_GCM_REGISTRATION_ID, regId);
        GCMService._deviceToken = regId;
        var currentAccount = Account.getAccount();
        var token = currentAccount.get("token");
        var userId = currentAccount.get("userId");
        var siteId = Site.siteIdForSite(Site.getHomeSite());
        var globalId = Site.getGlobalId();
        var deviceId = CommonService.getInstanceIdentifier();
        var getSubscriptionsCallback = function (aResponse) {
            if (PropertyDAO.get(PropertyDAO.PROP_DISPLAY_LOGS)) {
                console.log("GCM subscriptions callback");
                console.log(aResponse);
            }
            if (!aResponse.errors) {
                if (GCMService._retryTimer.callName == "getDeviceNotificationSubscriptions") {
                    GCMService._resetRetryTimer();
                }
                if (aResponse.subscriptions === 0) {
                    ObserverHelper.notify(Topics.DEBUG_MESSAGE, "User not subscribed, subscribing");
                    MDNSApi.setDeviceNotificationSubscriptions(token, GCMService._deviceToken, userId, siteId, globalId, deviceId, GCMService.setDeviceNotificationSubscriptionsCallback);
                }
                else {
                    if (!aResponse.active) {
                        ObserverHelper.notify(Topics.DEBUG_MESSAGE, "User subscribed but inactive, activating");
                        MDNSApi.activateUserOnDevice(token, GCMService._deviceToken, userId, siteId, globalId, deviceId, GCMService.activateUserOnDeviceCallback);
                    }
                    else {
                        ObserverHelper.notify(Topics.DEBUG_MESSAGE, "User was already active, nothing to do");
                    }
                }
            }
            else {
                if (GCMService._retryCount < GCMService._RETRY_ATTEMPTS_LIMIT) {
                    GCMService._retryCount++;
                    GCMService._retryTimer.callName = "getDeviceNotificationSubscriptions";
                    GCMService._retryTimer.timer = new Timer(function () {
                        MDNSApi.getDeviceNotificationSubscriptions(token, GCMService._deviceToken, userId, siteId, globalId, deviceId, getSubscriptionsCallback);
                    }, GCMService._RETRY_TIMER_INTERVAL, false);
                }
                else {
                    var errorMsg = "Retry attempts limit reached for call getDeviceNotificationSubscriptions";
                    ObserverHelper.notify(Topics.DEBUG_MESSAGE, errorMsg);
                }
            }
        };
        MDNSApi.getDeviceNotificationSubscriptions(token, GCMService._deviceToken, userId, siteId, globalId, deviceId, getSubscriptionsCallback);
    },
    setDeviceNotificationSubscriptionsCallback: function (aResult) {
        if (aResult.errors) {
            if (GCMService._retryCount < GCMService._RETRY_ATTEMPTS_LIMIT) {
                GCMService._retryCount++;
                GCMService._retryTimer.callName = "setDeviceNotificationSubscriptions";
                GCMService._retryTimer.timer = new Timer(function () {
                    GCMService.startService();
                }, GCMService._RETRY_TIMER_INTERVAL, false);
            }
            else {
                var errorMsg = "Retry attempts limit reached for call setDeviceNotificationSubscriptions";
                ObserverHelper.notify(Topics.DEBUG_MESSAGE, errorMsg);
            }
        }
        else {
            GCMService._resetRetryTimer();
            ObserverHelper.notify(Topics.DEBUG_MESSAGE, "User subscribed successfully");
        }
    },
    activateUserOnDeviceCallback: function (aResult) {
        if (aResult.errors) {
            if (GCMService._retryCount < GCMService._RETRY_ATTEMPTS_LIMIT) {
                GCMService._retryCount++;
                GCMService._retryTimer.callName = "activateUserOnDevice";
                GCMService._retryTimer.timer = new Timer(function () {
                    GCMService.startService();
                }, GCMService._RETRY_TIMER_INTERVAL, false);
            }
            else {
                var errorMsg = "Retry attempts limit reached for call activateUserOnDevice";
                ObserverHelper.notify(Topics.DEBUG_MESSAGE, errorMsg);
            }
        }
        else {
            GCMService._resetRetryTimer();
            ObserverHelper.notify(Topics.DEBUG_MESSAGE, "User activated successfully");
        }
    },
    _addDebugMsg: function (aData) {
        GCMService._debugMessagesArray.push(aData);
    },
    observe: function (aTopic, aData) {
        switch (aTopic) {
            case Topics.DEBUG_MESSAGE:
                this._addDebugMsg(aData);
                break;
        }
    }
};
(function () { this.init(); }).apply(GCMService);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2NtU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2JhY2tncm91bmQvY29yZS9zZXJ2aWNlcy9nY21TZXJ2aWNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBY0gsSUFBSSxVQUFVLEdBQUc7SUFFZixZQUFZLEVBQUcsSUFBSTtJQUNuQixtQkFBbUIsRUFBRyxJQUFJO0lBQzFCLFdBQVcsRUFBRyxJQUFJO0lBQ2xCLHFCQUFxQixFQUFHLENBQUMsR0FBRyxJQUFJO0lBQ2hDLHFCQUFxQixFQUFHLENBQUM7SUFDekIsV0FBVyxFQUFHLENBQUM7SUFLZixJQUFJLEVBQUc7UUFDTCxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLFlBQVksR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQzFFLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUNqQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7SUFDaEMsQ0FBQztJQUVELElBQUksa0JBQWtCO1FBQ3BCLE1BQU0sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUM7SUFDbEMsQ0FBQztJQUVELGdCQUFnQixFQUFHO1FBQ2pCLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUNqQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDOUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7SUFDdkIs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QUM7Z0JBQ3pCLEtBQUssQ0FBQztRQUNWLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQztBQUtGLENBQUMsY0FBYSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIENvcHlyaWdodCAoQykgMjAwNy0yMDE1IGVCYXkgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICovXG5cbi8qXG4gIHZhciBUb3BpY3MgPSByZXF1aXJlKFwiaGVscGVycy9vYnNlcnZlckhlbHBlclwiKS5Ub3BpY3M7XG4gIHZhciBPYnNlcnZlckhlbHBlciA9IHJlcXVpcmUoXCJoZWxwZXJzL29ic2VydmVySGVscGVyXCIpLk9ic2VydmVySGVscGVyO1xuICB2YXIgQXBpSGVscGVyID0gcmVxdWlyZShcImNvcmUvaGVscGVycy9hcGlIZWxwZXJcIikuQXBpSGVscGVyO1xuICB2YXIgQWNjb3VudCA9IHJlcXVpcmUoXCJjb3JlL29iamVjdHMvYWNjb3VudFwiKS5BY2NvdW50O1xuICB2YXIgQ29tbW9uU2VydmljZSA9IHJlcXVpcmUoXCJjb3JlL3NlcnZpY2VzL2NvbW1vblNlcnZpY2VcIikuQ29tbW9uU2VydmljZTtcbiAgdmFyIE1ETlNBcGkgPSByZXF1aXJlKFwiY29yZS9hcGlzL21kbnNBcGlcIikuTUROU0FwaTtcbiovXG5cbi8qKlxuICogR0NNIHNlcnZpY2UuXG4gKi9cbnZhciBHQ01TZXJ2aWNlID0ge1xuICAvKiBkZXZpY2UgdG9rZW4gcmV0dXJuZWQgYnkgdGhlIHJlZ2lzdHJhdGlvbiBwcm9jZXNzICovXG4gIF9kZXZpY2VUb2tlbiA6IG51bGwsXG4gIF9kZWJ1Z01lc3NhZ2VzQXJyYXkgOiBudWxsLFxuICBfcmV0cnlUaW1lciA6IG51bGwsXG4gIF9SRVRSWV9USU1FUl9JTlRFUlZBTCA6IDUgKiAxMDAwLCAvLyA1IG1pbnNcbiAgX1JFVFJZX0FUVEVNUFRTX0xJTUlUIDogNSxcbiAgX3JldHJ5Q291bnQgOiAwLFxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyB0aGUgc2VydmljZS5cbiAgICovXG4gIGluaXQgOiBmdW5jdGlvbigpIHtcbiAgICBPYnNlcnZlckhlbHBlci5hZGRPYnNlcnZlcih0aGlzLCBUb3BpY3MuREVCVUdfTUVTU0FHRSk7XG4gICAgdGhpcy5fZGV2aWNlVG9rZW4gPSBQcm9wZXJ0eURBTy5nZXQoUHJvcGVydHlEQU8uUFJPUF9HQ01fUkVHSVNUUkFUSU9OX0lEKTtcbiAgICB0aGlzLl9kZWJ1Z01lc3NhZ2VzQXJyYXkgPSBuZXcgQXJyYXkoKTtcbiAgICB0aGlzLl9yZXRyeVRpbWVyID0ge307XG4gICAgdGhpcy5fcmV0cnlUaW1lci5jYWxsTmFtZSA9IG51bGw7XG4gICAgdGhpcy5fcmV0cnlUaW1lci50aW1lciA9IG51bGw7XG4gIH0sXG5cbiAgZ2V0IGRlYnVnTWVzc2FnZXNBcnJheSgpIHtcbiAgICByZXR1cm4gdGhpcy5fZGVidWdNZXNzYWdlc0FycmF5O1xuICB9LFxuXG4gIF9yZXNldFJldHJ5VGltZXIgOiBmdW5jdGlvbigpIHtcbiAgICB0aGlzLl9yZXRyeVRpbWVyID0ge307XG4gICAgdGhpcy5fcmV0cnlUaW1lci5jYWxsTmFtZSA9IG51bGw7XG4gICAgdGhpcy5fcmV0cnlUaW1lci50aW1lciA9IG51bGw7XG4gICAgdGhpcy5fcmV0cnlDb3VudCA9IDA7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFN0b3BzIHRoZSBjbGllbnQgYWxlcnRzLlxuICAgKiBAcGFyYW0gYVNpZ25PdXQgd2hldGhlciB0aGlzIGlzIGEgc2lnbiBvdXQgb3Igbm90XG4gICAqL1xuICBzdG9wU2VydmljZSA6IGZ1bmN0aW9uKGFTaWduT3V0KSB7XG5cbiAgICBpZiAoYVNpZ25PdXQpIHtcbiAgICAgIC8qXG4gICAgICAgIEFjY291bnRTZXJ2aWNlID0gcmVxdWlyZShcImNvcmUvc2VydmljZXMvYWNjb3VudFNlcnZpY2VcIikuQWNjb3VudFNlcnZpY2U7XG4gICAgICAqL1xuICAgICAgdmFyIGN1cnJlbnRBY2NvdW50ID0gQWNjb3VudC5nZXRBY2NvdW50KCk7XG4gICAgICB2YXIgdG9rZW4gPSBjdXJyZW50QWNjb3VudC5nZXQoXCJ0b2tlblwiKTtcbiAgICAgIHZhciB1c2VySWQgPSBjdXJyZW50QWNjb3VudC5nZXQoXCJ1c2VySWRcIik7XG4gICAgICB2YXIgc2l0ZUlkID0gU2l0ZS5zaXRlSWRGb3JTaXRlKFNpdGUuZ2V0SG9tZVNpdGUoKSk7XG4gICAgICB2YXIgZ2xvYmFsSWQgPSBTaXRlLmdldEdsb2JhbElkKCk7XG4gICAgICB2YXIgZGV2aWNlSWQgPSBDb21tb25TZXJ2aWNlLmdldEluc3RhbmNlSWRlbnRpZmllcigpO1xuICAgICAgdmFyIGRlYWN0aXZhdGVDYWxsYmFjayA9IGZ1bmN0aW9uKGFSZXNwb25zZSkge1xuXG4gICAgICB9O1xuICAgICAgTUROU0FwaS5kZWFjdGl2YXRlVXNlck9uRGV2aWNlKHRva2VuLCBHQ01TZXJ2aWNlLl9kZXZpY2VUb2tlbiwgdXNlcklkLCBzaXRlSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsSWQsIGRldmljZUlkLCBkZWFjdGl2YXRlQ2FsbGJhY2spO1xuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICogU3RhcnRzIHRoZSBjbGllbnQgYWxlcnRzLlxuICAgKi9cbiAgc3RhcnRTZXJ2aWNlIDogZnVuY3Rpb24oKSB7XG5cbiAgICAvLyByZWdpc3RlciB3aXRoIHRoZSBHQ00gc2VydmljZVxuICAgIHRoaXMuX2djbVJlZ2lzdGVyKCk7XG5cbiAgfSxcblxuICAvKipcbiAgICogUmVnaXN0ZXJzIHRvIEdDTSBzZXJ2ZXJzXG4gICAqL1xuICBfZ2NtUmVnaXN0ZXIgOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgc2VuZGVySWQgPSBTdHJpbmcoQXBpSGVscGVyLmdldEVuZFBvaW50KFwiZ2NtU2VuZGVySWRcIikpO1xuICAgIE9ic2VydmVySGVscGVyLm5vdGlmeShUb3BpY3MuREVCVUdfTUVTU0FHRSwgXCJTdGFydGluZyBSZWdpc3RyYXRpb24gUHJvY2Vzc1wiKTtcbiAgICBjaHJvbWUuZ2NtLnJlZ2lzdGVyKFtzZW5kZXJJZF0sIEdDTVNlcnZpY2UuX3JlZ2lzdGVyQ2FsbGJhY2spO1xuICB9LFxuXG4gIF9yZWdpc3RlckNhbGxiYWNrIDogZnVuY3Rpb24ocmVnSWQpIHtcbiAgICBpZiAoY2hyb21lLnJ1bnRpbWUubGFzdEVycm9yKSB7XG4gICAgICAvLyBXaGVuIHRoZSByZWdpc3RyYXRpb24gZmFpbHMsIGhhbmRsZSB0aGUgZXJyb3IgYW5kIHJldHJ5IHRoZVxuICAgICAgLy8gcmVnaXN0cmF0aW9uIGxhdGVyLlxuICAgICAgT2JzZXJ2ZXJIZWxwZXIubm90aWZ5KFRvcGljcy5ERUJVR19NRVNTQUdFLCBKU09OLnN0cmluZ2lmeShjaHJvbWUucnVudGltZS5sYXN0RXJyb3IubWVzc2FnZSkpO1xuICAgICAgLy8gaW1wbGVtZW50IGVycm9yIGhhbmRsaW5nXG4gICAgICBpZiAoR0NNU2VydmljZS5fcmV0cnlDb3VudCA8IEdDTVNlcnZpY2UuX1JFVFJZX0FUVEVNUFRTX0xJTUlUKSB7XG4gICAgICAgIEdDTVNlcnZpY2UuX3JldHJ5Q291bnQrKztcbiAgICAgICAgR0NNU2VydmljZS5fcmV0cnlUaW1lci5jYWxsTmFtZSA9IFwiZ2NtUmVnaXN0ZXJcIjtcbiAgICAgICAgR0NNU2VydmljZS5fcmV0cnlUaW1lci50aW1lciA9IG5ldyBUaW1lcihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgR0NNU2VydmljZS5zdGFydFNlcnZpY2UoKTtcbiAgICAgICAgICB9LCBHQ01TZXJ2aWNlLl9SRVRSWV9USU1FUl9JTlRFUlZBTCwgZmFsc2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGVycm9yTXNnID1cbiAgICAgICAgICBcIlJldHJ5IGF0dGVtcHRzIGxpbWl0IHJlYWNoZWQgZm9yIGNhbGwgZ2NtUmVnaXN0ZXJcIjtcbiAgICAgICAgT2JzZXJ2ZXJIZWxwZXIubm90aWZ5KFRvcGljcy5ERUJVR19NRVNTQUdFLCBlcnJvck1zZyk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIHJlc2V0IHRoZSB0aW1lciBvbmx5IGlmIHRoZSBmYWlsZWQgY2FsbCB3YXMgcmVnaXN0ZXJcbiAgICBpZiAoR0NNU2VydmljZS5fcmV0cnlUaW1lci5jYWxsTmFtZSA9PSBcImdjbVJlZ2lzdGVyXCIpIHtcbiAgICAgIEdDTVNlcnZpY2UuX3Jlc2V0UmV0cnlUaW1lcigpO1xuICAgIH1cbiAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoVG9waWNzLkRFQlVHX01FU1NBR0UsIFwiR290IFJlZ2lzdHJhdGlvbiBJZFwiKTtcbiAgICBQcm9wZXJ0eURBTy5zZXQoUHJvcGVydHlEQU8uUFJPUF9HQ01fUkVHSVNUUkFUSU9OX0lELCByZWdJZCk7XG4gICAgR0NNU2VydmljZS5fZGV2aWNlVG9rZW4gPSByZWdJZDtcbiAgICAvKlxuICAgICAgQWNjb3VudFNlcnZpY2UgPSByZXF1aXJlKFwiY29yZS9zZXJ2aWNlcy9hY2NvdW50U2VydmljZVwiKS5BY2NvdW50U2VydmljZTtcbiAgICAqL1xuICAgIHZhciBjdXJyZW50QWNjb3VudCA9IEFjY291bnQuZ2V0QWNjb3VudCgpO1xuICAgIHZhciB0b2tlbiA9IGN1cnJlbnRBY2NvdW50LmdldChcInRva2VuXCIpO1xuICAgIHZhciB1c2VySWQgPSBjdXJyZW50QWNjb3VudC5nZXQoXCJ1c2VySWRcIik7XG4gICAgdmFyIHNpdGVJZCA9IFNpdGUuc2l0ZUlkRm9yU2l0ZShTaXRlLmdldEhvbWVTaXRlKCkpO1xuICAgIHZhciBnbG9iYWxJZCA9IFNpdGUuZ2V0R2xvYmFsSWQoKTtcbiAgICB2YXIgZGV2aWNlSWQgPSBDb21tb25TZXJ2aWNlLmdldEluc3RhbmNlSWRlbnRpZmllcigpO1xuXG4gICAgLy8gZ2V0IHRoZSBzdWJzY3JpcHRpb25zIHRvIHNlZSBpZiB0aGUgZGV2aWNlIHRva2VuIGhhcyBiZWVuIHJlZ2lzdGVyZWRcbiAgICAvLyBiZWZvcmVcbiAgICB2YXIgZ2V0U3Vic2NyaXB0aW9uc0NhbGxiYWNrID0gZnVuY3Rpb24oYVJlc3BvbnNlKSB7XG4gICAgICBpZiAoUHJvcGVydHlEQU8uZ2V0KFByb3BlcnR5REFPLlBST1BfRElTUExBWV9MT0dTKSkge1xuICAgICAgICBjb25zb2xlLmxvZyhcIkdDTSBzdWJzY3JpcHRpb25zIGNhbGxiYWNrXCIpO1xuICAgICAgICBjb25zb2xlLmxvZyhhUmVzcG9uc2UpO1xuICAgICAgfVxuICAgICAgaWYgKCFhUmVzcG9uc2UuZXJyb3JzKSB7XG4gICAgICAgIC8vIHJlc2V0IHRoZSByZXRyeSB0aW1lclxuICAgICAgICBpZiAoR0NNU2VydmljZS5fcmV0cnlUaW1lci5jYWxsTmFtZSA9PSBcImdldERldmljZU5vdGlmaWNhdGlvblN1YnNjcmlwdGlvbnNcIikge1xuICAgICAgICAgIEdDTVNlcnZpY2UuX3Jlc2V0UmV0cnlUaW1lcigpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChhUmVzcG9uc2Uuc3Vic2NyaXB0aW9ucyA9PT0gMCkge1xuICAgICAgICAgIE9ic2VydmVySGVscGVyLm5vdGlmeShUb3BpY3MuREVCVUdfTUVTU0FHRSwgXCJVc2VyIG5vdCBzdWJzY3JpYmVkLCBzdWJzY3JpYmluZ1wiKTtcbiAgICAgICAgICAvL2NhbGwgc2V0RGV2aWNlTm90aWZpY2F0aW9uU3Vic2NyaXB0aW9uc1xuICAgICAgICAgIE1ETlNBcGkuc2V0RGV2aWNlTm90aWZpY2F0aW9uU3Vic2NyaXB0aW9ucyh0b2tlbiwgR0NNU2VydmljZS5fZGV2aWNlVG9rZW4sIHVzZXJJZCwgc2l0ZUlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWxJZCwgZGV2aWNlSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdDTVNlcnZpY2Uuc2V0RGV2aWNlTm90aWZpY2F0aW9uU3Vic2NyaXB0aW9uc0NhbGxiYWNrKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoIWFSZXNwb25zZS5hY3RpdmUpIHtcbiAgICAgICAgICAgIE9ic2VydmVySGVscGVyLm5vdGlmeShUb3BpY3MuREVCVUdfTUVTU0FHRSwgXCJVc2VyIHN1YnNjcmliZWQgYnV0IGluYWN0aXZlLCBhY3RpdmF0aW5nXCIpO1xuICAgICAgICAgICAgLy9jYWxsIGFjdGl2YXRlVXNlck9uRGV2aWNlXG4gICAgICAgICAgICBNRE5TQXBpLmFjdGl2YXRlVXNlck9uRGV2aWNlKHRva2VuLCBHQ01TZXJ2aWNlLl9kZXZpY2VUb2tlbiwgdXNlcklkLCBzaXRlSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsSWQsIGRldmljZUlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEdDTVNlcnZpY2UuYWN0aXZhdGVVc2VyT25EZXZpY2VDYWxsYmFjayk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIE9ic2VydmVySGVscGVyLm5vdGlmeShUb3BpY3MuREVCVUdfTUVTU0FHRSwgXCJVc2VyIHdhcyBhbHJlYWR5IGFjdGl2ZSwgbm90aGluZyB0byBkb1wiKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIGltcGxlbWVudCBlcnJvciBoYW5kbGluZ1xuICAgICAgICBpZiAoR0NNU2VydmljZS5fcmV0cnlDb3VudCA8IEdDTVNlcnZpY2UuX1JFVFJZX0FUVEVNUFRTX0xJTUlUKSB7XG4gICAgICAgICAgR0NNU2VydmljZS5fcmV0cnlDb3VudCsrO1xuICAgICAgICAgIEdDTVNlcnZpY2UuX3JldHJ5VGltZXIuY2FsbE5hbWUgPSBcImdldERldmljZU5vdGlmaWNhdGlvblN1YnNjcmlwdGlvbnNcIjtcbiAgICAgICAgICBHQ01TZXJ2aWNlLl9yZXRyeVRpbWVyLnRpbWVyID0gbmV3IFRpbWVyKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIE1ETlNBcGkuZ2V0RGV2aWNlTm90aWZpY2F0aW9uU3Vic2NyaXB0aW9ucyhcbiAgICAgICAgICAgICAgdG9rZW4sIEdDTVNlcnZpY2UuX2RldmljZVRva2VuLCB1c2VySWQsIHNpdGVJZCwgZ2xvYmFsSWQsXG4gICAgICAgICAgICAgIGRldmljZUlkLCBnZXRTdWJzY3JpcHRpb25zQ2FsbGJhY2spO1xuICAgICAgICAgICAgfSwgR0NNU2VydmljZS5fUkVUUllfVElNRVJfSU5URVJWQUwsIGZhbHNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB2YXIgZXJyb3JNc2cgPVxuICAgICAgICAgICAgXCJSZXRyeSBhdHRlbXB0cyBsaW1pdCByZWFjaGVkIGZvciBjYWxsIGdldERldmljZU5vdGlmaWNhdGlvblN1YnNjcmlwdGlvbnNcIjtcbiAgICAgICAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoVG9waWNzLkRFQlVHX01FU1NBR0UsIGVycm9yTXNnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG4gICAgTUROU0FwaS5nZXREZXZpY2VOb3RpZmljYXRpb25TdWJzY3JpcHRpb25zKHRva2VuLCBHQ01TZXJ2aWNlLl9kZXZpY2VUb2tlbiwgdXNlcklkLCBzaXRlSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbElkLCBkZXZpY2VJZCwgZ2V0U3Vic2NyaXB0aW9uc0NhbGxiYWNrKTtcbiAgfSxcblxuICBzZXREZXZpY2VOb3RpZmljYXRpb25TdWJzY3JpcHRpb25zQ2FsbGJhY2sgOiBmdW5jdGlvbihhUmVzdWx0KSB7XG4gICAgaWYgKGFSZXN1bHQuZXJyb3JzKSB7XG4gICAgICAvLyBpbXBsZW1lbnQgZXJyb3IgaGFuZGxpbmdcbiAgICAgIC8vIGluIHRoaXMgY2FzZSwgaXQncyBlYXNpZXIgdG8gc3RhcnQgb3ZlclxuICAgICAgaWYgKEdDTVNlcnZpY2UuX3JldHJ5Q291bnQgPCBHQ01TZXJ2aWNlLl9SRVRSWV9BVFRFTVBUU19MSU1JVCkge1xuICAgICAgICBHQ01TZXJ2aWNlLl9yZXRyeUNvdW50Kys7XG4gICAgICAgIEdDTVNlcnZpY2UuX3JldHJ5VGltZXIuY2FsbE5hbWUgPSBcInNldERldmljZU5vdGlmaWNhdGlvblN1YnNjcmlwdGlvbnNcIjtcbiAgICAgICAgR0NNU2VydmljZS5fcmV0cnlUaW1lci50aW1lciA9IG5ldyBUaW1lcihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgR0NNU2VydmljZS5zdGFydFNlcnZpY2UoKTtcbiAgICAgICAgICB9LCBHQ01TZXJ2aWNlLl9SRVRSWV9USU1FUl9JTlRFUlZBTCwgZmFsc2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGVycm9yTXNnID1cbiAgICAgICAgICBcIlJldHJ5IGF0dGVtcHRzIGxpbWl0IHJlYWNoZWQgZm9yIGNhbGwgc2V0RGV2aWNlTm90aWZpY2F0aW9uU3Vic2NyaXB0aW9uc1wiO1xuICAgICAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoVG9waWNzLkRFQlVHX01FU1NBR0UsIGVycm9yTXNnKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgR0NNU2VydmljZS5fcmVzZXRSZXRyeVRpbWVyKCk7XG4gICAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoVG9waWNzLkRFQlVHX01FU1NBR0UsIFwiVXNlciBzdWJzY3JpYmVkIHN1Y2Nlc3NmdWxseVwiKTtcbiAgICB9XG4gIH0sXG5cbiAgYWN0aXZhdGVVc2VyT25EZXZpY2VDYWxsYmFjayA6IGZ1bmN0aW9uKGFSZXN1bHQpIHtcbiAgICBpZiAoYVJlc3VsdC5lcnJvcnMpIHtcbiAgICAgIC8vIGltcGxlbWVudCBlcnJvciBoYW5kbGluZ1xuICAgICAgLy8gaW4gdGhpcyBjYXNlLCBpdCdzIGVhc2llciB0byBzdGFydCBvdmVyXG4gICAgICBpZiAoR0NNU2VydmljZS5fcmV0cnlDb3VudCA8IEdDTVNlcnZpY2UuX1JFVFJZX0FUVEVNUFRTX0xJTUlUKSB7XG4gICAgICAgIEdDTVNlcnZpY2UuX3JldHJ5Q291bnQrKztcbiAgICAgICAgR0NNU2VydmljZS5fcmV0cnlUaW1lci5jYWxsTmFtZSA9IFwiYWN0aXZhdGVVc2VyT25EZXZpY2VcIjtcbiAgICAgICAgR0NNU2VydmljZS5fcmV0cnlUaW1lci50aW1lciA9IG5ldyBUaW1lcihmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgR0NNU2VydmljZS5zdGFydFNlcnZpY2UoKTtcbiAgICAgICAgICB9LCBHQ01TZXJ2aWNlLl9SRVRSWV9USU1FUl9JTlRFUlZBTCwgZmFsc2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGVycm9yTXNnID1cbiAgICAgICAgICBcIlJldHJ5IGF0dGVtcHRzIGxpbWl0IHJlYWNoZWQgZm9yIGNhbGwgYWN0aXZhdGVVc2VyT25EZXZpY2VcIjtcbiAgICAgICAgT2JzZXJ2ZXJIZWxwZXIubm90aWZ5KFRvcGljcy5ERUJVR19NRVNTQUdFLCBlcnJvck1zZyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIEdDTVNlcnZpY2UuX3Jlc2V0UmV0cnlUaW1lcigpO1xuICAgICAgT2JzZXJ2ZXJIZWxwZXIubm90aWZ5KFRvcGljcy5ERUJVR19NRVNTQUdFLCBcIlVzZXIgYWN0aXZhdGVkIHN1Y2Nlc3NmdWxseVwiKTtcbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqIEFkZCBkZWJ1ZyBtZXNzYWdlXG4gICAqIEBwYXJhbSBhRGF0YSB0aGUgbWVzc2FnZSBkYXRhXG4gICAqL1xuICBfYWRkRGVidWdNc2cgOiBmdW5jdGlvbihhRGF0YSkge1xuICAgIEdDTVNlcnZpY2UuX2RlYnVnTWVzc2FnZXNBcnJheS5wdXNoKGFEYXRhKTtcbiAgfSxcblxuICAvKipcbiAgICogT2JzZXJ2ZXMgZm9yIGNoYW5nZXMuXG4gICAqIEBwYXJhbSBhVG9waWMgdGhlIHRvcGljIG5hbWUuXG4gICAqIEBwYXJhbSBhRGF0YSB0aGUgZGF0YSBzZW50LlxuICAgKi9cbiAgb2JzZXJ2ZSA6IGZ1bmN0aW9uKGFUb3BpYywgYURhdGEpIHtcblxuICAgIHN3aXRjaCAoYVRvcGljKSB7XG4gICAgICBjYXNlIFRvcGljcy5ERUJVR19NRVNTQUdFOlxuICAgICAgICB0aGlzLl9hZGREZWJ1Z01zZyhhRGF0YSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxufTtcblxuLyoqXG4gKiBDb25zdHJ1Y3Rvci5cbiAqL1xuKGZ1bmN0aW9uKCkgeyB0aGlzLmluaXQoKTsgfSkuYXBwbHkoR0NNU2VydmljZSk7XG4iXX0=