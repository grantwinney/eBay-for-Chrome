/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var SymbanService = {
    _TYPE_READ: "READ",
    _TYPE_NEW: "NEW",
    init: function () {
        ObserverHelper.addObserver(this, Topics.ACCOUNT_SIGNED_IN);
        ObserverHelper.addObserver(this, Topics.ACCOUNT_SIGNED_OUT);
    },
    get userData() {
        return PropertyDAO.get(PropertyDAO.PROP_SYMBAN_DATA);
    },
    get isUpdatingData() {
        return PropertyDAO.get(PropertyDAO.PROP_SYMBAN_DATA_UPDATING);
    },
    _clearSymbanCache: function () {
        PropertyDAO.remove(PropertyDAO.PROP_SYMBAN_DATA);
        PropertyDAO.set(PropertyDAO.PROP_SYMBAN_DATA_UPDATING, false);
        ObserverHelper.notify(Topics.SYMBAN_DATA_REMOVED);
    },
    _lastRetrievalTime: function (aDate) {
        var lastRetrievalTime;
        var dateFormat = "YYYY-MM-DDThh:mm:ss.000Z";
        if (aDate) {
            lastRetrievalTime = aDate;
        }
        else {
            lastRetrievalTime = UtilityHelper.formatDate($.now(), dateFormat);
        }
        return { value: lastRetrievalTime };
    },
    getSymbanData: function (aApiPath) {
        var that = this;
        var badgeCount = 0;
        var params = {};
        var localCallback = function (aResponse) {
            if (aResponse) {
                that.processNotificationsData(aResponse);
                if ("undefined" != typeof (aResponse.badgeCount)) {
                    badgeCount = aResponse.badgeCount;
                }
                ObserverHelper.notify(Topics.UPDATE_BROWSER_ACTION_BADGE, { newMessages: badgeCount });
            }
            PropertyDAO.set(PropertyDAO.PROP_SYMBAN_DATA_UPDATING, false);
            ObserverHelper.notify(Topics.SYMBAN_DATA_UPDATED);
            if (badgeCount > 0) {
                PropertyDAO.set(PropertyDAO.PROP_DEFAULT_TAB, "tab-notification");
            }
        };
        if (aApiPath) {
            params.apiPath = aApiPath;
        }
        if (!PropertyDAO.get(PropertyDAO.PROP_SYMBAN_DATA_UPDATING)) {
            PropertyDAO.set(PropertyDAO.PROP_SYMBAN_DATA_UPDATING, true);
            ObserverHelper.notify(Topics.SYMBAN_DATA_UPDATING);
        }
        SymbanApi.callSymbanApi(SymbanApi.REQUEST_TYPES.PULL, params, localCallback);
    },
    processNotificationsData: function (aData) {
        var badgeCount;
        var notifications;
        var latestNotificationTime;
        var total;
        var notificationId = null;
        var symbanData = {
            badgeCount: 0,
            notifications: {},
            latestNotificationTime: {},
            total: 0,
            prev: null,
            next: null,
            loaded: false
        };
        badgeCount = aData.badgeCount;
        notifications = aData.notifications;
        latestNotificationTime = aData.latestNotificationTime;
        total = aData.total;
        prev = aData.prev;
        next = aData.next;
        if ("undefined" != typeof (notifications)) {
            $.each(notifications, function (aIndex, aNotification) {
                notificationId = aNotification.notificationId;
                if ("undefined" != typeof (notificationId)) {
                    aNotification.notificationURL =
                        ZoomService.getZoomImageforUrl(aNotification.notificationURL, 150);
                    symbanData.notifications[notificationId] = aNotification;
                }
            });
        }
        if ("undefined" != typeof (badgeCount)) {
            symbanData.badgeCount = badgeCount;
        }
        if ("undefined" != typeof (latestNotificationTime)) {
            symbanData.latestNotificationTime = latestNotificationTime;
        }
        if ("undefined" != typeof (total)) {
            symbanData.total = total;
        }
        if ("undefined" != typeof (prev)) {
            symbanData.prev = prev;
        }
        else {
            symbanData.prev = null;
        }
        if ("undefined" != typeof (next)) {
            symbanData.next = next;
        }
        else {
            symbanData.next = null;
        }
        symbanData.loaded = true;
        PropertyDAO.set(PropertyDAO.PROP_SYMBAN_DATA, symbanData);
    },
    markNotificationAsRead: function (aNotificationId) {
        var params;
        var symbanData = PropertyDAO.get(PropertyDAO.PROP_SYMBAN_DATA);
        var notification = symbanData.notifications[aNotificationId];
        if ("undefined" != typeof (notification)) {
            symbanData.badgeCount -= 1;
            if (notification.status == this._TYPE_NEW) {
                notification.status = this._TYPE_READ;
            }
            ObserverHelper.notify(Topics.UPDATE_BROWSER_ACTION_BADGE, { newMessages: symbanData.badgeCount });
            params = {
                notificationId: aNotificationId,
                type: SymbanApi.UPDATES.READ,
                lastRetrievalTime: this._lastRetrievalTime(this.userData.latestNotificationTime.value)
            };
            PropertyDAO.set(PropertyDAO.PROP_SYMBAN_DATA, symbanData);
            SymbanApi.callSymbanApi(SymbanApi.REQUEST_TYPES.UPDATE, params);
        }
    },
    markAllNotificationsAsRead: function () {
        var params;
        var that = this;
        var symbanData = PropertyDAO.get(PropertyDAO.PROP_SYMBAN_DATA);
        var localCallback = function (aResponse) {
            if (aResponse) {
                symbanData.badgeCount = 0;
                $.each(symbanData.notifications, function (aIndex, aNotification) {
                    if (aNotification.status == that._TYPE_NEW) {
                        aNotification.status = that._TYPE_READ;
                    }
                });
                PropertyDAO.set(PropertyDAO.PROP_SYMBAN_DATA, symbanData);
                ObserverHelper.notify(Topics.SYMBAN_DATA_UPDATED);
                ObserverHelper.notify(Topics.UPDATE_BROWSER_ACTION_BADGE, { newMessages: 0 });
            }
        };
        params = {
            type: SymbanApi.UPDATES.READ_ALL,
            lastRetrievalTime: this._lastRetrievalTime(this.userData.latestNotificationTime.value)
        };
        SymbanApi.callSymbanApi(SymbanApi.REQUEST_TYPES.UPDATE, params, localCallback);
    },
    removeNotification: function (aNotificationId) {
        var params;
        var symbanData = PropertyDAO.get(PropertyDAO.PROP_SYMBAN_DATA);
        var localCallback = function (aResponse) {
            if (aResponse) {
                var notification = symbanData.notifications[aNotificationId];
                if ("undefined" != typeof (notification)) {
                    delete symbanData.notifications[aNotificationId];
                    symbanData.badgeCount -= 1;
                    PropertyDAO.set(PropertyDAO.PROP_SYMBAN_DATA, symbanData);
                    ObserverHelper.notify(Topics.UPDATE_BROWSER_ACTION_BADGE, { newMessages: symbanData.badgeCount });
                }
                ObserverHelper.notify(Topics.SYMBAN_DATA_UPDATED);
            }
        };
        params = {
            notificationId: aNotificationId,
            type: SymbanApi.UPDATES.DELETE,
            lastRetrievalTime: this._lastRetrievalTime(this.userData.latestNotificationTime.value)
        };
        SymbanApi.callSymbanApi(SymbanApi.REQUEST_TYPES.UPDATE, params, localCallback);
    },
    getBadgeCount: function () {
        var params = {};
        var badgeCount = 0;
        var localCallback = function (aResponse) {
            if (aResponse) {
                if ("undefined" != typeof (aResponse.badgeCount)) {
                    badgeCount = aResponse.badgeCount;
                }
                ObserverHelper.notify(Topics.UPDATE_BROWSER_ACTION_BADGE, { newMessages: badgeCount });
            }
        };
        params.badgeCountOnly = true;
        SymbanApi.callSymbanApi(SymbanApi.REQUEST_TYPES.PULL, params, localCallback);
    },
    observe: function (aTopic, aData) {
        switch (aTopic) {
            case Topics.ACCOUNT_SIGNED_OUT:
                this._clearSymbanCache();
                break;
        }
    }
};
(function () { this.init(); }).apply(SymbanService);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ltYmFuU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2JhY2tncm91bmQvY29yZS9zZXJ2aWNlcy9zeW1iYW5TZXJ2aWNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBZUgsSUFBSSxhQUFhLEdBQUc7SUFDbEIsVUFBVSxFQUFHLE1BQU07SUFDbkIsU0FBUyxFQUFHLEtBQUs7SUFLakIsSUFBSSxFQUFFO1FBQ0osY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDM0QsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDOUQsQ0FBQztJQU1ELElBQUksUUFBUTtRQUNWLE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFNRCxJQUFJLGNBQWM7UUFDaEIsTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUtELGlCQUFpQixFQUFFO1FBQ2pCLFdBQVcsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDakQsV0FBVyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMseUJBQXlCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDOUQsY0FBYyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBUUQsa0JBQWtCLEVBQUUsVUFBUyxLQUFLO1FBQ2hDLElBQUksaUJBQWlCLENBQUM7UUFDdEIsSUFBSSxVQUFVLEdBQUcsMEJBQTBCLENBQUM7UUFDNUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNWLGlCQUFpQixHQUFHLEtBQUssQ0FBQztRQUM1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SUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7Z0JBQ3pCLEtBQUssQ0FBQztRQUNWLENBQUM7SUFDSCxDQUFDO0NBQ0YsQ0FBQztBQUtGLENBQUMsY0FBYSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIENvcHlyaWdodCAoQykgMjAwNy0yMDE1IGVCYXkgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICovXG5cbi8qXG4gIHZhciBMb2dnZXIgPSByZXF1aXJlKFwiaGVscGVycy9sb2dnZXJcIikuTG9nZ2VyO1xuICB2YXIgVG9waWNzID0gcmVxdWlyZShcImhlbHBlcnMvb2JzZXJ2ZXJIZWxwZXJcIikuVG9waWNzO1xuICB2YXIgT2JzZXJ2ZXJIZWxwZXIgPSByZXF1aXJlKFwiaGVscGVycy9vYnNlcnZlckhlbHBlclwiKS5PYnNlcnZlckhlbHBlcjtcbiAgdmFyIFV0aWxpdHlIZWxwZXIgPSByZXF1aXJlKFwiaGVscGVycy91dGlsaXR5SGVscGVyXCIpLlV0aWxpdHlIZWxwZXI7XG4gIHZhciBTeW1iYW5BcGkgPSByZXF1aXJlKFwiY29yZS9hcGlzL3N5bWJhbkFwaVwiKS5TeW1iYW5BcGk7XG4gIHZhciBab29tU2VydmljZSA9IHJlcXVpcmUoXCJjb3JlL3NlcnZpY2VzL3pvb21TZXJ2aWNlXCIpLlpvb21TZXJ2aWNlO1xuICB2YXIgUHJvcGVydHlEQU8gPSByZXF1aXJlKFwic3RvcmFnZS9wcm9wZXJ0eURBT1wiKS5Qcm9wZXJ0eURBTztcbiovXG5cbi8qKlxuICogU3ltYmFuIFNlcnZpY2UuXG4gKi9cbnZhciBTeW1iYW5TZXJ2aWNlID0ge1xuICBfVFlQRV9SRUFEIDogXCJSRUFEXCIsXG4gIF9UWVBFX05FVyA6IFwiTkVXXCIsXG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemVzIHRoZSBzZXJ2aWNlLlxuICAgKi9cbiAgaW5pdDogZnVuY3Rpb24oKSB7XG4gICAgT2JzZXJ2ZXJIZWxwZXIuYWRkT2JzZXJ2ZXIodGhpcywgVG9waWNzLkFDQ09VTlRfU0lHTkVEX0lOKTtcbiAgICBPYnNlcnZlckhlbHBlci5hZGRPYnNlcnZlcih0aGlzLCBUb3BpY3MuQUNDT1VOVF9TSUdORURfT1VUKTtcbiAgfSxcblxuICAvKipcbiAgICogR2V0cyB0aGUgdXNlciBpbmZvcm1hdGlvbiBmcm9tIFN5bWJhbi5cbiAgICogQHJldHVybiB0aGUgdXNlciBpbmZvcm1hdGlvbiBmcm9tIFN5bWJhbi5cbiAgICovXG4gIGdldCB1c2VyRGF0YSgpIHtcbiAgICByZXR1cm4gUHJvcGVydHlEQU8uZ2V0KFByb3BlcnR5REFPLlBST1BfU1lNQkFOX0RBVEEpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBDaGVja3Mgd2hldGhlciB0aGUgZGF0YSBpcyBiZWluZyB1cGRhdGVkLlxuICAgKiBAcmV0dXJuIHdoZXRoZXIgdGhlIGRhdGEgaXMgYmVpbmcgdXBkYXRlZC5cbiAgICovXG4gIGdldCBpc1VwZGF0aW5nRGF0YSgpIHtcbiAgICByZXR1cm4gUHJvcGVydHlEQU8uZ2V0KFByb3BlcnR5REFPLlBST1BfU1lNQkFOX0RBVEFfVVBEQVRJTkcpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBDbGVhcnMgdGhlIFN5bWJhbiBjYWNoZS5cbiAgICovXG4gIF9jbGVhclN5bWJhbkNhY2hlOiBmdW5jdGlvbigpIHtcbiAgICBQcm9wZXJ0eURBTy5yZW1vdmUoUHJvcGVydHlEQU8uUFJPUF9TWU1CQU5fREFUQSk7XG4gICAgUHJvcGVydHlEQU8uc2V0KFByb3BlcnR5REFPLlBST1BfU1lNQkFOX0RBVEFfVVBEQVRJTkcsIGZhbHNlKTtcbiAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoVG9waWNzLlNZTUJBTl9EQVRBX1JFTU9WRUQpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZXMgYSB0aW1lIGluIHN0cmluZyBmb3JtYXQuXG4gICAqIEBwYXJhbSBhRGF0ZSBhIERhdGUgb2JqZWN0LlxuICAgKiBAcmV0dXJucyB7b2JqZWN0fSBjb250YWlucyBhIGRhdGUgYXMgc3RyaW5nLlxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgX2xhc3RSZXRyaWV2YWxUaW1lOiBmdW5jdGlvbihhRGF0ZSkge1xuICAgIHZhciBsYXN0UmV0cmlldmFsVGltZTtcbiAgICB2YXIgZGF0ZUZvcm1hdCA9IFwiWVlZWS1NTS1ERFRoaDptbTpzcy4wMDBaXCI7XG4gICAgaWYgKGFEYXRlKSB7XG4gICAgICBsYXN0UmV0cmlldmFsVGltZSA9IGFEYXRlO1xuICAgIH0gZWxzZSB7XG4gICAgICBsYXN0UmV0cmlldmFsVGltZSA9IFV0aWxpdHlIZWxwZXIuZm9ybWF0RGF0ZSgkLm5vdygpLCBkYXRlRm9ybWF0KTtcbiAgICB9XG4gICAgcmV0dXJuIHt2YWx1ZTogbGFzdFJldHJpZXZhbFRpbWV9O1xuICB9LFxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBTeW1iYW4gZGF0YS5cbiAgICogQHBhcmFtIGFBcGlQYXRoIHRoZSBBcGkgcGF0aCAob3B0aW9uYWwpLlxuICAgKi9cbiAgZ2V0U3ltYmFuRGF0YTogZnVuY3Rpb24oYUFwaVBhdGgpIHtcbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgdmFyIGJhZGdlQ291bnQgPSAwO1xuICAgIHZhciBwYXJhbXMgPSB7fTtcbiAgICB2YXIgbG9jYWxDYWxsYmFjayA9IGZ1bmN0aW9uKGFSZXNwb25zZSkge1xuXG4gICAgICBpZiAoYVJlc3BvbnNlKSB7XG4gICAgICAgIHRoYXQucHJvY2Vzc05vdGlmaWNhdGlvbnNEYXRhKGFSZXNwb25zZSk7XG5cbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mKGFSZXNwb25zZS5iYWRnZUNvdW50KSkge1xuICAgICAgICAgIGJhZGdlQ291bnQgPSBhUmVzcG9uc2UuYmFkZ2VDb3VudDtcbiAgICAgICAgfVxuICAgICAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoXG4gICAgICAgICAgVG9waWNzLlVQREFURV9CUk9XU0VSX0FDVElPTl9CQURHRSwgeyBuZXdNZXNzYWdlcyA6IGJhZGdlQ291bnQgfSk7XG4gICAgICB9XG5cbiAgICAgIFByb3BlcnR5REFPLnNldChQcm9wZXJ0eURBTy5QUk9QX1NZTUJBTl9EQVRBX1VQREFUSU5HLCBmYWxzZSk7XG4gICAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoVG9waWNzLlNZTUJBTl9EQVRBX1VQREFURUQpO1xuXG4gICAgICBpZiAoYmFkZ2VDb3VudCA+IDApIHtcbiAgICAgICAgUHJvcGVydHlEQU8uc2V0KFByb3BlcnR5REFPLlBST1BfREVGQVVMVF9UQUIsIFwidGFiLW5vdGlmaWNhdGlvblwiKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgaWYgKGFBcGlQYXRoKSB7XG4gICAgICBwYXJhbXMuYXBpUGF0aCA9IGFBcGlQYXRoO1xuICAgIH1cblxuICAgIGlmICghUHJvcGVydHlEQU8uZ2V0KFByb3BlcnR5REFPLlBST1BfU1lNQkFOX0RBVEFfVVBEQVRJTkcpKSB7XG4gICAgICBQcm9wZXJ0eURBTy5zZXQoUHJvcGVydHlEQU8uUFJPUF9TWU1CQU5fREFUQV9VUERBVElORywgdHJ1ZSk7XG4gICAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoVG9waWNzLlNZTUJBTl9EQVRBX1VQREFUSU5HKTtcbiAgICB9XG5cbiAgICBTeW1iYW5BcGkuY2FsbFN5bWJhbkFwaShTeW1iYW5BcGkuUkVRVUVTVF9UWVBFUy5QVUxMLCBwYXJhbXMsIGxvY2FsQ2FsbGJhY2spO1xuICB9LFxuXG4gIC8qKlxuICAgKiBQcm9jZXNzIGEgSlNPTiByZXNwb25zZSBmcm9tIHRoZSBTeW1iYW4gQXBpIGFuZCBzdG9yZXMgdGhlIHJlc3BvbnNlIG9uXG4gICAqIG1lbW9yeS4gVGhlIG5vdGlmaWNhdGlvbnMgYXJyYXkgaXMgaW5kZXhlZCBieSBub3RpZmljYXRpb24gaWQgc28gaXQgaXNcbiAgICogZWFzaWVyIHRvIGZpbmQgYSBzcGVjaWZpYyBub3RpZmljYXRpb24uXG4gICAqIEBwYXJhbSBhRGF0YSB0aGUgSlNPTiByZXNwb25zZSBmcm9tIHRoZSBTeW1iYW4gQXBpIGNvbnRhaW5pbmcgdGhlXG4gICAqIG5vdGlmaWNhdGlvbnMgZm9yIGEgc3BlY2lmaWMgdXNlci5cbiAgICovXG4gIHByb2Nlc3NOb3RpZmljYXRpb25zRGF0YSA6IGZ1bmN0aW9uKGFEYXRhKSB7XG4gICAgdmFyIGJhZGdlQ291bnQ7XG4gICAgdmFyIG5vdGlmaWNhdGlvbnM7XG4gICAgdmFyIGxhdGVzdE5vdGlmaWNhdGlvblRpbWU7XG4gICAgdmFyIHRvdGFsO1xuICAgIHZhciBub3RpZmljYXRpb25JZCA9IG51bGw7XG4gICAgdmFyIHN5bWJhbkRhdGEgPSB7XG4gICAgICBiYWRnZUNvdW50IDogMCxcbiAgICAgIG5vdGlmaWNhdGlvbnMgOiB7fSxcbiAgICAgIGxhdGVzdE5vdGlmaWNhdGlvblRpbWUgOiB7fSxcbiAgICAgIHRvdGFsIDogMCxcbiAgICAgIHByZXYgOiBudWxsLFxuICAgICAgbmV4dCA6IG51bGwsXG4gICAgICBsb2FkZWQ6IGZhbHNlXG4gICAgfTtcblxuICAgIGJhZGdlQ291bnQgPSBhRGF0YS5iYWRnZUNvdW50O1xuICAgIG5vdGlmaWNhdGlvbnMgPSBhRGF0YS5ub3RpZmljYXRpb25zO1xuICAgIGxhdGVzdE5vdGlmaWNhdGlvblRpbWUgPSBhRGF0YS5sYXRlc3ROb3RpZmljYXRpb25UaW1lO1xuICAgIHRvdGFsID0gYURhdGEudG90YWw7XG4gICAgcHJldiA9IGFEYXRhLnByZXY7XG4gICAgbmV4dCA9IGFEYXRhLm5leHQ7XG5cbiAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPSB0eXBlb2Yobm90aWZpY2F0aW9ucykpIHtcbiAgICAgICQuZWFjaChub3RpZmljYXRpb25zLCBmdW5jdGlvbihhSW5kZXgsIGFOb3RpZmljYXRpb24pIHtcbiAgICAgICAgbm90aWZpY2F0aW9uSWQgPSBhTm90aWZpY2F0aW9uLm5vdGlmaWNhdGlvbklkO1xuICAgICAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPSB0eXBlb2Yobm90aWZpY2F0aW9uSWQpKSB7XG4gICAgICAgICAgYU5vdGlmaWNhdGlvbi5ub3RpZmljYXRpb25VUkwgPVxuICAgICAgICAgICAgWm9vbVNlcnZpY2UuZ2V0Wm9vbUltYWdlZm9yVXJsKGFOb3RpZmljYXRpb24ubm90aWZpY2F0aW9uVVJMLCAxNTApO1xuICAgICAgICAgIHN5bWJhbkRhdGEubm90aWZpY2F0aW9uc1tub3RpZmljYXRpb25JZF0gPSBhTm90aWZpY2F0aW9uO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPSB0eXBlb2YoYmFkZ2VDb3VudCkpIHtcbiAgICAgIHN5bWJhbkRhdGEuYmFkZ2VDb3VudCA9IGJhZGdlQ291bnQ7XG4gICAgfVxuXG4gICAgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mKGxhdGVzdE5vdGlmaWNhdGlvblRpbWUpKSB7XG4gICAgICBzeW1iYW5EYXRhLmxhdGVzdE5vdGlmaWNhdGlvblRpbWUgPSBsYXRlc3ROb3RpZmljYXRpb25UaW1lO1xuICAgIH1cblxuICAgIGlmIChcInVuZGVmaW5lZFwiICE9IHR5cGVvZih0b3RhbCkpIHtcbiAgICAgIHN5bWJhbkRhdGEudG90YWwgPSB0b3RhbDtcbiAgICB9XG5cbiAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPSB0eXBlb2YocHJldikpIHtcbiAgICAgIHN5bWJhbkRhdGEucHJldiA9IHByZXY7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN5bWJhbkRhdGEucHJldiA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mKG5leHQpKSB7XG4gICAgICBzeW1iYW5EYXRhLm5leHQgPSBuZXh0O1xuICAgIH0gZWxzZSB7XG4gICAgICBzeW1iYW5EYXRhLm5leHQgPSBudWxsO1xuICAgIH1cblxuICAgIHN5bWJhbkRhdGEubG9hZGVkID0gdHJ1ZTtcblxuICAgIFByb3BlcnR5REFPLnNldChQcm9wZXJ0eURBTy5QUk9QX1NZTUJBTl9EQVRBLCBzeW1iYW5EYXRhKTtcbiAgfSxcblxuICAvKipcbiAgICogTWFya3MgYSBzcGVjaWZpYyBub3RpZmljYXRpb24gYXMgcmVhZCBpbiBtZW1vcnkgYW5kIGFsc28gdXBkYXRlcyB0aGUgVUlcbiAgICogYWNjb3JkaW5nbHksIGJ5IHN1YnN0cmFjdGluZyAxIGZyb20gdGhlIGJhZGdlIGFuZCB1cGRhdGluZyB0aGUgbm90aWZpY2F0aW9uXG4gICAqIGJlbGwgdG9vLlxuICAgKiBAcGFyYW0gYU5vdGlmaWNhdGlvbklkIHRoZSBpZCBvZiB0aGUgbm90aWZpY2F0aW9uIHRvIGJlIHJlbW92ZWQuXG4gICAqL1xuICBtYXJrTm90aWZpY2F0aW9uQXNSZWFkIDogZnVuY3Rpb24oYU5vdGlmaWNhdGlvbklkKSB7XG4gICAgdmFyIHBhcmFtcztcbiAgICB2YXIgc3ltYmFuRGF0YSA9IFByb3BlcnR5REFPLmdldChQcm9wZXJ0eURBTy5QUk9QX1NZTUJBTl9EQVRBKTtcbiAgICB2YXIgbm90aWZpY2F0aW9uID0gc3ltYmFuRGF0YS5ub3RpZmljYXRpb25zW2FOb3RpZmljYXRpb25JZF07XG4gICAgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mKG5vdGlmaWNhdGlvbikpIHtcbiAgICAgIHN5bWJhbkRhdGEuYmFkZ2VDb3VudCAtPSAxO1xuICAgICAgaWYgKG5vdGlmaWNhdGlvbi5zdGF0dXMgPT0gdGhpcy5fVFlQRV9ORVcpIHtcbiAgICAgICAgbm90aWZpY2F0aW9uLnN0YXR1cyA9IHRoaXMuX1RZUEVfUkVBRDtcbiAgICAgIH1cbiAgICAgIE9ic2VydmVySGVscGVyLm5vdGlmeShUb3BpY3MuVVBEQVRFX0JST1dTRVJfQUNUSU9OX0JBREdFLFxuICAgICAgICB7IG5ld01lc3NhZ2VzIDogc3ltYmFuRGF0YS5iYWRnZUNvdW50IH0pO1xuXG4gICAgICBwYXJhbXMgPSB7XG4gICAgICAgIG5vdGlmaWNhdGlvbklkIDogYU5vdGlmaWNhdGlvbklkLFxuICAgICAgICB0eXBlIDogU3ltYmFuQXBpLlVQREFURVMuUkVBRCxcbiAgICAgICAgbGFzdFJldHJpZXZhbFRpbWU6IHRoaXMuX2xhc3RSZXRyaWV2YWxUaW1lKFxuICAgICAgICAgIHRoaXMudXNlckRhdGEubGF0ZXN0Tm90aWZpY2F0aW9uVGltZS52YWx1ZVxuICAgICAgICApXG4gICAgICB9O1xuICAgICAgUHJvcGVydHlEQU8uc2V0KFByb3BlcnR5REFPLlBST1BfU1lNQkFOX0RBVEEsIHN5bWJhbkRhdGEpO1xuICAgICAgU3ltYmFuQXBpLmNhbGxTeW1iYW5BcGkoU3ltYmFuQXBpLlJFUVVFU1RfVFlQRVMuVVBEQVRFLCBwYXJhbXMpO1xuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICogTWFya3MgYWxsIG5vdGlmaWNhdGlvbnMgYXMgcmVhZCBmcm9tIG1lbW9yeSBhbmQgYWxzbyB1cGRhdGVzIHRoZSBVSSBhY2NvcmRpbmdseSxcbiAgICogYnkgc2V0dGluZyB0aGUgYmFnZSBjb3VudCB0byB6ZXJvIGFuZCB1cGRhdGluZyB0aGUgbm90aWZpY2F0aW9uIGJlbGwgdG9vLlxuICAgKi9cbiAgbWFya0FsbE5vdGlmaWNhdGlvbnNBc1JlYWQgOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgcGFyYW1zO1xuICAgIHZhciB0aGF0ID0gdGhpcztcbiAgICB2YXIgc3ltYmFuRGF0YSA9IFByb3BlcnR5REFPLmdldChQcm9wZXJ0eURBTy5QUk9QX1NZTUJBTl9EQVRBKTtcbiAgICB2YXIgbG9jYWxDYWxsYmFjayA9IGZ1bmN0aW9uKGFSZXNwb25zZSkge1xuICAgICAgaWYgKGFSZXNwb25zZSkge1xuICAgICAgICBzeW1iYW5EYXRhLmJhZGdlQ291bnQgPSAwO1xuICAgICAgICAkLmVhY2goc3ltYmFuRGF0YS5ub3RpZmljYXRpb25zLCBmdW5jdGlvbihhSW5kZXgsIGFOb3RpZmljYXRpb24pIHtcbiAgICAgICAgICBpZiAoYU5vdGlmaWNhdGlvbi5zdGF0dXMgPT0gdGhhdC5fVFlQRV9ORVcpIHtcbiAgICAgICAgICAgIGFOb3RpZmljYXRpb24uc3RhdHVzID0gdGhhdC5fVFlQRV9SRUFEO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIFByb3BlcnR5REFPLnNldChQcm9wZXJ0eURBTy5QUk9QX1NZTUJBTl9EQVRBLCBzeW1iYW5EYXRhKTtcbiAgICAgICAgT2JzZXJ2ZXJIZWxwZXIubm90aWZ5KFRvcGljcy5TWU1CQU5fREFUQV9VUERBVEVEKTtcbiAgICAgICAgT2JzZXJ2ZXJIZWxwZXIubm90aWZ5KFxuICAgICAgICAgIFRvcGljcy5VUERBVEVfQlJPV1NFUl9BQ1RJT05fQkFER0UsIHtuZXdNZXNzYWdlcyA6IDB9KTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgcGFyYW1zID0ge1xuICAgICAgdHlwZSA6IFN5bWJhbkFwaS5VUERBVEVTLlJFQURfQUxMLFxuICAgICAgbGFzdFJldHJpZXZhbFRpbWU6IHRoaXMuX2xhc3RSZXRyaWV2YWxUaW1lKFxuICAgICAgICB0aGlzLnVzZXJEYXRhLmxhdGVzdE5vdGlmaWNhdGlvblRpbWUudmFsdWVcbiAgICAgIClcbiAgICB9O1xuICAgIFN5bWJhbkFwaS5jYWxsU3ltYmFuQXBpKFN5bWJhbkFwaS5SRVFVRVNUX1RZUEVTLlVQREFURSwgcGFyYW1zLFxuICAgICAgbG9jYWxDYWxsYmFjayk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgYSBzcGVjaWZpYyBub3RpZmljYXRpb24gZnJvbSBtZW1vcnkgYW5kIGFsc28gdXBkYXRlcyB0aGUgVUlcbiAgICogYWNjb3JkaW5nbHksIGJ5IHN1YnN0cmFjdGluZyAxIGZyb20gdGhlIGJhZGdlIGFuZCB1cGRhdGluZyB0aGUgbm90aWZpY2F0aW9uXG4gICAqIGJlbGwgdG9vLlxuICAgKiBAcGFyYW0gYU5vdGlmaWNhdGlvbklkIHRoZSBpZCBvZiB0aGUgbm90aWZpY2F0aW9uIHRvIGJlIHJlbW92ZWQuXG4gICAqL1xuICByZW1vdmVOb3RpZmljYXRpb24gOiBmdW5jdGlvbihhTm90aWZpY2F0aW9uSWQpIHtcbiAgICB2YXIgcGFyYW1zO1xuICAgIHZhciBzeW1iYW5EYXRhID0gUHJvcGVydHlEQU8uZ2V0KFByb3BlcnR5REFPLlBST1BfU1lNQkFOX0RBVEEpO1xuICAgIHZhciBsb2NhbENhbGxiYWNrID0gZnVuY3Rpb24oYVJlc3BvbnNlKSB7XG4gICAgICBpZiAoYVJlc3BvbnNlKSB7XG4gICAgICAgIHZhciBub3RpZmljYXRpb24gPSBzeW1iYW5EYXRhLm5vdGlmaWNhdGlvbnNbYU5vdGlmaWNhdGlvbklkXTtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mKG5vdGlmaWNhdGlvbikpIHtcbiAgICAgICAgICBkZWxldGUgc3ltYmFuRGF0YS5ub3RpZmljYXRpb25zW2FOb3RpZmljYXRpb25JZF07XG4gICAgICAgICAgc3ltYmFuRGF0YS5iYWRnZUNvdW50IC09IDE7XG4gICAgICAgICAgUHJvcGVydHlEQU8uc2V0KFByb3BlcnR5REFPLlBST1BfU1lNQkFOX0RBVEEsIHN5bWJhbkRhdGEpO1xuICAgICAgICAgIE9ic2VydmVySGVscGVyLm5vdGlmeShUb3BpY3MuVVBEQVRFX0JST1dTRVJfQUNUSU9OX0JBREdFLFxuICAgICAgICAgICAgeyBuZXdNZXNzYWdlcyA6IHN5bWJhbkRhdGEuYmFkZ2VDb3VudCB9KTtcbiAgICAgICAgfVxuICAgICAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoVG9waWNzLlNZTUJBTl9EQVRBX1VQREFURUQpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBwYXJhbXMgPSB7XG4gICAgICBub3RpZmljYXRpb25JZCA6IGFOb3RpZmljYXRpb25JZCxcbiAgICAgIHR5cGUgOiBTeW1iYW5BcGkuVVBEQVRFUy5ERUxFVEUsXG4gICAgICBsYXN0UmV0cmlldmFsVGltZTogdGhpcy5fbGFzdFJldHJpZXZhbFRpbWUodGhpcy51c2VyRGF0YS5sYXRlc3ROb3RpZmljYXRpb25UaW1lLnZhbHVlKVxuICAgIH07XG5cbiAgICBTeW1iYW5BcGkuY2FsbFN5bWJhbkFwaShTeW1iYW5BcGkuUkVRVUVTVF9UWVBFUy5VUERBVEUsIHBhcmFtcyxcbiAgICAgIGxvY2FsQ2FsbGJhY2spO1xuICB9LFxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBiYWRnZSBjb3VudCBhbmQgdXBkYXRlcyB0aGUgYmFkZ2Ugb24gdGhlIGV4dGVuc2lvbiBpY29uLlxuICAgKi9cbiAgZ2V0QmFkZ2VDb3VudCA6IGZ1bmN0aW9uKCkge1xuICAgIHZhciBwYXJhbXMgPSB7fTtcbiAgICB2YXIgYmFkZ2VDb3VudCA9IDA7XG4gICAgdmFyIGxvY2FsQ2FsbGJhY2sgPSBmdW5jdGlvbihhUmVzcG9uc2UpIHtcbiAgICAgIGlmIChhUmVzcG9uc2UpIHtcbiAgICAgICAgaWYgKFwidW5kZWZpbmVkXCIgIT0gdHlwZW9mKGFSZXNwb25zZS5iYWRnZUNvdW50KSkge1xuICAgICAgICAgIGJhZGdlQ291bnQgPSBhUmVzcG9uc2UuYmFkZ2VDb3VudDtcbiAgICAgICAgfVxuICAgICAgICBPYnNlcnZlckhlbHBlci5ub3RpZnkoXG4gICAgICAgICAgVG9waWNzLlVQREFURV9CUk9XU0VSX0FDVElPTl9CQURHRSwgeyBuZXdNZXNzYWdlcyA6IGJhZGdlQ291bnQgfSk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIC8vdGhpcyBpcyBhIGxpZ2h0d2VpZ2h0IGNhbGwuIExldCdzIGdldCBPTkxZIHRoZSBiYWRnZSBjb3VudC5cbiAgICBwYXJhbXMuYmFkZ2VDb3VudE9ubHkgPSB0cnVlO1xuICAgIFN5bWJhbkFwaS5jYWxsU3ltYmFuQXBpKFN5bWJhbkFwaS5SRVFVRVNUX1RZUEVTLlBVTEwsIHBhcmFtcywgbG9jYWxDYWxsYmFjayk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIE9ic2VydmVzIGZvciBjaGFuZ2VzLlxuICAgKiBAcGFyYW0gYVRvcGljIHRoZSB0b3BpYyBuYW1lLlxuICAgKiBAcGFyYW0gYURhdGEgdGhlIGRhdGEgc2VudC5cbiAgICovXG4gIG9ic2VydmU6IGZ1bmN0aW9uKGFUb3BpYywgYURhdGEpIHtcbiAgICBzd2l0Y2ggKGFUb3BpYykge1xuICAgICAgY2FzZSBUb3BpY3MuQUNDT1VOVF9TSUdORURfT1VUOlxuICAgICAgICB0aGlzLl9jbGVhclN5bWJhbkNhY2hlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxufTtcblxuLyoqXG4gKiBDb25zdHJ1Y3Rvci5cbiAqL1xuKGZ1bmN0aW9uKCkgeyB0aGlzLmluaXQoKTsgfSkuYXBwbHkoU3ltYmFuU2VydmljZSk7XG4iXX0=