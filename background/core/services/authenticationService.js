/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var Authentication = ebay.apis.authentication;
var Location = ebay.apis.location;
var AuthenticationService = {
    _RE_EBAY_LOVE_TOKEN: /access_token=(.*?)"/i,
    _applicationToken: null,
    defaultDomain: "ebay.com",
    init: function () {
    },
    get applicationToken() {
        return this._applicationToken;
    },
    set applicationToken(aValue) {
        this._applicationToken = aValue;
    },
    getUserTokenUrl: function (aSourceArea, aCallback) {
        var parameters = {};
        parameters.sourceArea = aSourceArea;
        var url = AuthenticationApi.getAuthenticationUrl("oauthUserToken", parameters);
        if (aCallback) {
            aCallback(url);
        }
    },
    getApplicationToken: function (aCallback) {
        var that = this;
        var setApplicationToken = function (token) {
            if (token.access_token) {
                that.applicationToken = token;
            }
            if (aCallback) {
                aCallback(that.applicationToken);
            }
        };
        Authentication.getApplicationToken(Configs)
            .then(setApplicationToken)
            .catch(function (reason) {
            console.log(reason);
        });
    },
    getEbayLoveToken: function (aCallback, aParameters) {
        var action;
        var handleToken = function (tokenResponse) {
            if (tokenResponse.access_token) {
                console.log("*** GOT TOKEN. BEGIN AUTO SIGN IN ***");
                if (PropertyDAO.get(PropertyDAO.PROP_FIRST_SIGNIN)) {
                    action = "SignInAuto";
                }
                else {
                    action = "FirstSignInAuto";
                }
                EventAnalytics.push({
                    key: "Acquisition",
                    action: action
                });
                AccountService.setUserToken(tokenResponse.access_token, aCallback);
            }
            else {
                console.log("*** COULD NOT GET TOKEN FOR AUTO SIGN IN ***");
                if (aCallback) {
                    aCallback();
                }
            }
        };
        var site = Site.siteDataForSite(Site.getHomeSite());
        Authentication.getEbayLoveToken(site, Configs)
            .then(handleToken)
            .catch(function (reason) {
            console.log(reason);
        });
    },
    autoSignInUser: function () {
        var parameters = {};
        var localCallback = function () {
            AuthenticationService.callEbayLoveWithDefaultDomain();
        };
        var getIsoCountryCode = function (isoCountryCode) {
            if (_.has(isoCountryCode, "message")) {
                AuthenticationService.callEbayLoveWithDefaultDomain();
            }
            else {
                var site = Site.findSiteBy("iso", isoCountryCode);
                if (!site || site.domain === AuthenticationService.defaultDomain) {
                    AuthenticationService.callEbayLoveWithDefaultDomain();
                }
                else {
                    parameters.domain = site.domain;
                    AuthenticationService.getEbayLoveToken(localCallback, parameters);
                }
            }
        };
        if (!Account.getAccount()) {
            this.getApplicationToken(function (token) {
                Location.getLocation(token, Configs)
                    .then(getIsoCountryCode)
                    .catch(function (error) {
                    console.log(error);
                });
            });
        }
        else {
            UtilityHelper.sendUpgradeTrackingRequest();
        }
    },
    sendGoogleAnalyticsTrackingInfo: function (aParameters) {
        if (!Account.getAccount()) {
            AuthenticationService.getEbayLoveToken(function () {
                UtilityHelper.sendUpgradeTrackingRequest();
            }, aParameters);
        }
        else {
            UtilityHelper.sendUpgradeTrackingRequest();
        }
    },
    callEbayLoveWithDefaultDomain: function () {
        var parameters = {};
        parameters.domain = AuthenticationService.defaultDomain;
        AuthenticationService.sendGoogleAnalyticsTrackingInfo(parameters);
    },
    loadAuthPage: function (aSourceArea, aEvent) {
        var getAuthURLCallback = function (aUrl) {
            Site.openRawURL(aUrl, aEvent, false);
            MessagePanelService.dismissMessage(MessagePanelService.TYPE.CONNECT_ERROR);
            UpdateController.updateFinished("Sign in");
        };
        AuthenticationService.getUserTokenUrl(aSourceArea, getAuthURLCallback);
        UpdateController.updateStarted("Sign in");
    }
};
(function () { this.init(); }).apply(AuthenticationService);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aGVudGljYXRpb25TZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vYmFja2dyb3VuZC9jb3JlL3NlcnZpY2VzL2F1dGhlbnRpY2F0aW9uU2VydmljZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7R0FFRztBQWFILElBQUksY0FBYyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDO0FBQzlDLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO0FBS2xDLElBQUkscUJBQXFCLEdBQUc7SUFDMUIsbUJBQW1CLEVBQ2pCLHNCQUFzQjtJQUV4QixpQkFBaUIsRUFBRSxJQUFJO0lBQ3ZCLGFBQWEsRUFBRSxVQUFVO0lBS3pCLElBQUksRUFBRTtJQUNOLENBQUM7SUFNRCxJQUFJLGdCQUFnQjtRQUNsQixNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDO0lBQ2hDLENBQUM7SUFFRCxJQUFJLGdCQUFnQixDQUFDLE1BQU07UUFDekIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLE1BQU0sQ0FBQztJQUNsQyxDQUFDO0lBT0QsZUFBZSxFQUFHLFVBQVMsV0FBVyxFQUFFLFNBQVM7UUFFL0MsSUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLFVBQVUsQ0FBQyxVQUFVLEdBQUcsV0FBVyxDQUFDO1FBQ3BDLElBQUksR0FBRyxHQUFHLGlCQUFpQixDQUFDLG9CQUFvQixDQUFDLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQy9FLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDZCxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakIsQ0FBQztJQUNILENBQUM7SUFNRCxtQkFBbUIsRUFBRSxVQUFTLFNBQVM7UUFFckMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWhCLElBQUksbUJBQW1CLEdBQUcsVUFBUyxLQUFLO1lBQ3RDLEVB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Q0FBQyxVQUFVLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBT0QsWUFBWSxFQUFHLFVBQVMsV0FBVyxFQUFFLE1BQU07UUFFekMsSUFBSSxrQkFBa0IsR0FBRyxVQUFTLElBQUk7WUFDcEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBRXJDLG1CQUFtQixDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDM0UsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzdDLENBQUMsQ0FBQztRQUdGLHFCQUFxQixDQUFDLGVBQWUsQ0FBQyxXQUFXLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztRQUN2RSxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDNUMsQ0FBQztDQUNGLENBQUM7QUFLRixDQUFDLGNBQWEsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqIENvcHlyaWdodCAoQykgMjAwNy0yMDE1IGVCYXkgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICovXG5cbi8qXG4gIHZhciBMb2dnZXIgPSByZXF1aXJlKFwiaGVscGVycy9sb2dnZXJcIikuTG9nZ2VyO1xuICB2YXIgQWNjb3VudCA9IHJlcXVpcmUoXCJjb3JlL29iamVjdHMvYWNjb3VudFwiKS5BY2NvdW50O1xuICB2YXIgVG9waWNzID0gcmVxdWlyZShcImhlbHBlcnMvb2JzZXJ2ZXJIZWxwZXJcIikuVG9waWNzO1xuICB2YXIgT2JzZXJ2ZXJIZWxwZXIgPSByZXF1aXJlKFwiaGVscGVycy9vYnNlcnZlckhlbHBlclwiKS5PYnNlcnZlckhlbHBlcjtcbiAgdmFyIEF1dGhlbnRpY2F0aW9uQXBpID0gcmVxdWlyZShcImNvcmUvYXBpcy9hdXRoZW50aWNhdGlvbkFwaVwiKS5BdXRoZW50aWNhdGlvbkFwaTtcbiAgdmFyIFByb3BlcnR5REFPID0gcmVxdWlyZShcInN0b3JhZ2UvcHJvcGVydHlEQU9cIikuUHJvcGVydHlEQU87XG4gIHZhciBNZXNzYWdlUGFuZWxTZXJ2aWNlID0gcmVxdWlyZShcImNvcmUvc2VydmljZXMvbWVzc2FnZVBhbmVsU2VydmljZVwiKS5NZXNzYWdlUGFuZWxTZXJ2aWNlO1xuICB2YXIgVXBkYXRlQ29udHJvbGxlciA9IHJlcXVpcmUoXCJjb3JlL3VwZGF0ZUNvbnRyb2xsZXJcIikuVXBkYXRlQ29udHJvbGxlcjtcbiovXG5cbnZhciBBdXRoZW50aWNhdGlvbiA9IGViYXkuYXBpcy5hdXRoZW50aWNhdGlvbjtcbnZhciBMb2NhdGlvbiA9IGViYXkuYXBpcy5sb2NhdGlvbjtcblxuLyoqXG4gKiBBdXRoZW50aWNhdGlvbiBTZXJ2aWNlLlxuICovXG52YXIgQXV0aGVudGljYXRpb25TZXJ2aWNlID0ge1xuICBfUkVfRUJBWV9MT1ZFX1RPS0VOIDpcbiAgICAvYWNjZXNzX3Rva2VuPSguKj8pXCIvaSxcblxuICBfYXBwbGljYXRpb25Ub2tlbjogbnVsbCxcbiAgZGVmYXVsdERvbWFpbjogXCJlYmF5LmNvbVwiLFxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyB0aGUgc2VydmljZS5cbiAgICovXG4gIGluaXQ6IGZ1bmN0aW9uKCkge1xuICB9LFxuXG4gIC8qKlxuICAgKiBHZXRzIGFuIGFwcGxpY2F0aW9uIHRva2VuLlxuICAgKiBAcmV0dXJucyBzdHJpbmcgYW4gYXBwbGljYXRpb24gdG9rZW4uXG4gICAqL1xuICBnZXQgYXBwbGljYXRpb25Ub2tlbigpIHtcbiAgICByZXR1cm4gdGhpcy5fYXBwbGljYXRpb25Ub2tlbjtcbiAgfSxcblxuICBzZXQgYXBwbGljYXRpb25Ub2tlbihhVmFsdWUpIHtcbiAgICB0aGlzLl9hcHBsaWNhdGlvblRva2VuID0gYVZhbHVlO1xuICB9LFxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZXMgdGhlIHVybCB0byBnZW4gYW4gdXNlciB0b2tlbiBmcm9tIHRoZSBhdXRoZW50aWNhdGlvbiBBcGkuXG4gICAqIEBwYXJhbSBhU291cmNlQXJlYSB0aGUgYXJlYSBvbiB0aGUgVUkgd2hlcmUgdGhlIHVzZXIgY2xpY2tlZC5cbiAgICogQHBhcmFtIGFDYWxsYmFjayB0aGUgY2FsbGJhY2sgZnVuY3Rpb24uXG4gICAqL1xuICBnZXRVc2VyVG9rZW5VcmwgOiBmdW5jdGlvbihhU291cmNlQXJlYSwgYUNhbGxiYWNrKSB7XG5cbiAgICB2YXIgcGFyYW1ldGVycyA9IHt9O1xuICAgIHBhcmFtZXRlcnMuc291cmNlQXJlYSA9IGFTb3VyY2VBcmVhO1xuICAgIHZhciB1cmwgPSBBdXRoZW50aWNhdGlvbkFwaS5nZXRBdXRoZW50aWNhdGlvblVybChcIm9hdXRoVXNlclRva2VuXCIsIHBhcmFtZXRlcnMpO1xuICAgIGlmIChhQ2FsbGJhY2spIHtcbiAgICAgIGFDYWxsYmFjayh1cmwpO1xuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICogUmV0cmlldmVzIGFuIGFwcGxpY2F0aW9uIHRva2VuIGZyb20gdGhlIGF1dGhlbnRpY2F0aW9uIEFwaS5cbiAgICogQHBhcmFtIGFDYWxsYmFjayB0aGUgY2FsbGJhY2sgZnVuY3Rpb24uXG4gICAqL1xuICBnZXRBcHBsaWNhdGlvblRva2VuOiBmdW5jdGlvbihhQ2FsbGJhY2spIHtcblxuICAgIHZhciB0aGF0ID0gdGhpcztcblxuICAgIHZhciBzZXRBcHBsaWNhdGlvblRva2VuID0gZnVuY3Rpb24odG9rZW4pIHtcbiAgICAgIGlmICh0b2tlbi5hY2Nlc3NfdG9rZW4pIHtcbiAgICAgICAgdGhhdC5hcHBsaWNhdGlvblRva2VuID0gdG9rZW47XG4gICAgICB9XG5cbiAgICAgIGlmIChhQ2FsbGJhY2spIHtcbiAgICAgICAgYUNhbGxiYWNrKHRoYXQuYXBwbGljYXRpb25Ub2tlbik7XG4gICAgICB9XG4gICAgfTtcblxuICAgIEF1dGhlbnRpY2F0aW9uLmdldEFwcGxpY2F0aW9uVG9rZW4oQ29uZmlncylcbiAgICAgIC50aGVuKHNldEFwcGxpY2F0aW9uVG9rZW4pXG4gICAgICAuY2F0Y2goZnVuY3Rpb24ocmVhc29uKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKHJlYXNvbik7XG4gICAgICB9KTtcbiAgfSxcblxuICAvKipcbiAgICogUmV0cmlldmVzIGFuIElBRiB1c2VyIHRva2VuIGZyb20gdGhlIGVCYXkgTG9WZSBBcGkuXG4gICAqIEBwYXJhbSBhQ2FsbGJhY2sgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uLlxuICAgKiBAcGFyYW0gYVBhcmFtZXRlcnMgdGhlIHJlcXVlc3QgcGFyYW1ldGVycy5cbiAgICovXG4gIGdldEViYXlMb3ZlVG9rZW46IGZ1bmN0aW9uKGFDYWxsYmFjaywgYVBhcmFtZXRlcnMpIHtcbiAgICB2YXIgYWN0aW9uO1xuXG4gICAgdmFyIGhhbmRsZVRva2VuID0gZnVuY3Rpb24odG9rZW5SZXNwb25zZSkge1xuICAgICAgaWYgKHRva2VuUmVzcG9uc2UuYWNjZXNzX3Rva2VuKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiKioqIEdPVCBUT0tFTi4gQkVHSU4gQVVUTyBTSUdOIElOICoqKlwiKTtcblxuICAgICAgICBpZiAoUHJvcGVydHlEQU8uZ2V0KFByb3BlcnR5REFPLlBST1BfRklSU1RfU0lHTklOKSkge1xuICAgICAgICAgIGFjdGlvbiA9IFwiU2lnbkluQXV0b1wiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFjdGlvbiA9IFwiRmlyc3RTaWduSW5BdXRvXCI7XG4gICAgICAgIH1cblxuICAgICAgICBFdmVudEFuYWx5dGljcy5wdXNoKHtcbiAgICAgICAgICBrZXk6IFwiQWNxdWlzaXRpb25cIixcbiAgICAgICAgICBhY3Rpb246IGFjdGlvblxuICAgICAgICB9KTtcbiAgICAgICAgQWNjb3VudFNlcnZpY2Uuc2V0VXNlclRva2VuKHRva2VuUmVzcG9uc2UuYWNjZXNzX3Rva2VuLCBhQ2FsbGJhY2spO1xuXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZyhcIioqKiBDT1VMRCBOT1QgR0VUIFRPS0VOIEZPUiBBVVRPIFNJR04gSU4gKioqXCIpO1xuICAgICAgICBpZiAoYUNhbGxiYWNrKSB7XG4gICAgICAgICAgYUNhbGxiYWNrKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdmFyIHNpdGUgPSBTaXRlLnNpdGVEYXRhRm9yU2l0ZShTaXRlLmdldEhvbWVTaXRlKCkpO1xuICAgIEF1dGhlbnRpY2F0aW9uLmdldEViYXlMb3ZlVG9rZW4oc2l0ZSwgQ29uZmlncylcbiAgICAgIC50aGVuKGhhbmRsZVRva2VuKVxuICAgICAgLmNhdGNoKGZ1bmN0aW9uKHJlYXNvbikge1xuICAgICAgICBjb25zb2xlLmxvZyhyZWFzb24pO1xuICAgICAgfSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFNpZ25zIGluIHRoZSB1c2VyIGF1dG9tYXRpY2FsbHkgdG8gdGhlIGV4dGVuc2lvbiwgYnkgZ2V0dGluZyBhbiBlQmF5IExvVmUgdG9rZW4uXG4gICAqIFRoaXMgY29kZSBzaG91bGQgd29yayBsaWtlIHRoaXM6XG4gICAqIC0gR2V0IHRoZSB1c2VyJ3MgbG9jYXRpb24gYmFzZWQgb24gaGlzIElQIGFkZHJlc3MuXG4gICAqIC0gSWYgd2UgY2FuIGdldCB0aGUgbG9jYXRpb24gYW5kIHRoZSBsb2NhdGlvbiBpcyBub3QgcmVsYXRlZCB0byB0aGUgZGVmYXVsdCBlYmF5LmNvbSBkb21haW4gYnV0IHJlbGF0ZWQgdG8gYSBzaXRlZCBjb3VudHJ5XG4gICAqIChzYXkgdGhlIHVzZXIgaXMgaW4gVWsgYW5kIHRoZSBkb21haW4gZm9yIFVLIGlzIGViYXkuY28udWspIGxldCdzIHRyeSBmaXJzdCB0byBnZXQgdGhlIGVCYXkgTG9WZSB0b2tlbiBiYXNlZCBvbiB0aGVcbiAgICogdXNlcidzIGRvbWFpbiAoZWJheS5jby51aykuIElmIHdlIGNhbiBnZXQgdGhlIGVCYXkgTG9WZSB0b2tlbiwgdGhlbiBhdXRvIHNpZ24gaW4gdGhlIHVzZXIuIElmIHdlIGNhbiBub3QgZ2V0IHRoZSBlQmF5IExvVmUgdG9rZW5cbiAgICogZnJvbSB0aGUgdXNlcidzIGRvbWFpbiAoZWJheS5jby51ayksIHRoZW4gbGV0J3MgdHJ5IHRvIGdldCB0aGUgZUJheSBMb1ZlIHRva2VuIGZyb20gdGhlIGRlZmF1bHQgZG9tYWluIChlYmF5LmNvbSkgYW5kXG4gICAqIGF1dG8gc2lnbiBpbiB0aGUgdXNlci5cbiAgICogLSBJZiB3ZSBjYW4gZ2V0IHRoZSBsb2NhdGlvbiBhbmQgdGhlIGxvY2F0aW9uIGlzIHJlbGF0ZWQgdG8gdGhlIGRlZmF1bHQgZWJheS5jb20gZG9tYWluIG9yIHJlbGF0ZWQgdG8gYW4gdW5zaXRlZCBjb3VudHJ5XG4gICAqIChmb3IgZXhhbXBsZSwgdGhlIHVzZXIgaXMgaW4gQ29zdGEgUmljYSksIHRoZW4gbGV0J3MgdHJ5IHRvIGdldCB0aGUgZUJheSBMb1ZlIHRva2VuIGZyb20gdGhlIGRlZmF1bHQgZG9tYWluIChlYmF5LmNvbSkgYW5kXG4gICAqIGF1dG8gc2lnbiBpbiB0aGUgdXNlci5cbiAgICovXG4gIGF1dG9TaWduSW5Vc2VyIDogZnVuY3Rpb24oKSB7XG4gICAgdmFyIHBhcmFtZXRlcnMgPSB7fTtcblxuICAgIHZhciBsb2NhbENhbGxiYWNrID0gZnVuY3Rpb24oKSB7XG4gICAgICBBdXRoZW50aWNhdGlvblNlcnZpY2UuY2FsbEViYXlMb3ZlV2l0aERlZmF1bHREb21haW4oKTtcbiAgICB9O1xuXG4gICAgLy8gV2UgbmVlZCB0byBnZXQgdGhlIGVCYXkgc2l0ZSB0byBnZXQgdGhlIGRvbWFpbi5cbiAgICB2YXIgZ2V0SXNvQ291bnRyeUNvZGUgPSBmdW5jdGlvbihpc29Db3VudHJ5Q29kZSkge1xuICAgICAgaWYgKF8uaGFzKGlzb0NvdW50cnlDb2RlLCBcIm1lc3NhZ2VcIikpIHtcbiAgICAgICAgLy8gV2UgcmVjZWl2ZWQgYW4gRXhjZXB0aW9uLCBzbyB3ZSBjb3VsZCBub3QgcmV0cmlldmUgdGhlIHVzZXIncyBJUCBsb2NhdGlvbi5cbiAgICAgICAgQXV0aGVudGljYXRpb25TZXJ2aWNlLmNhbGxFYmF5TG92ZVdpdGhEZWZhdWx0RG9tYWluKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgc2l0ZSA9IFNpdGUuZmluZFNpdGVCeShcImlzb1wiLCBpc29Db3VudHJ5Q29kZSk7XG5cbiAgICAgICAgaWYgKCFzaXRlIHx8IHNpdGUuZG9tYWluID09PSBBdXRoZW50aWNhdGlvblNlcnZpY2UuZGVmYXVsdERvbWFpbikge1xuICAgICAgICAgIEF1dGhlbnRpY2F0aW9uU2VydmljZS5jYWxsRWJheUxvdmVXaXRoRGVmYXVsdERvbWFpbigpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIFRyeSB0byBnZXQgdGhlIGVCYXkgTG9WZSB0b2tlbiBmcm9tIHRoZSBlYmF5IHdlYnNpdGUgYmFzZWQgb24gdGhlIHVzZXIncyBsb2NhdGlvbi5cbiAgICAgICAgICBwYXJhbWV0ZXJzLmRvbWFpbiA9IHNpdGUuZG9tYWluO1xuICAgICAgICAgIEF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRFYmF5TG92ZVRva2VuKGxvY2FsQ2FsbGJhY2ssIHBhcmFtZXRlcnMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcblxuICAgIC8vIElmIHRoZXJlIGlzIG5vdCBhbiBhY3RpdmUgYWNjb3VudCwgdHJ5IHRvIGF1dG8gc2lnbiBpbiBmaXJzdCAoYW5kIHNlbmQgdGhlIEdBIGV2ZW50KSxcbiAgICAvLyBhbmQgdGhlbiBzZW5kIHRoZSBHQSB1cGdyYWRlIGV2ZW50IGlmIGFwcGxpZXMuXG4gICAgaWYgKCFBY2NvdW50LmdldEFjY291bnQoKSkge1xuICAgICAgLy8gV2UgbmVlZCB0byBkZXRlcm1pbmUgdGhlIHVzZXIncyBsb2NhdGlvbiBmaXJzdCwgdG8gc2VlIGZyb20gd2hpY2ggZG9tYWluXG4gICAgICAvLyB3ZSBhcmUgZ29pbmcgdG8gZ2V0IHRoZSBlQmF5IExvVmUgdXNlciB0b2tlbi5cbiAgICAgIHRoaXMuZ2V0QXBwbGljYXRpb25Ub2tlbihmdW5jdGlvbih0b2tlbikge1xuICAgICAgICBMb2NhdGlvbi5nZXRMb2NhdGlvbih0b2tlbiwgQ29uZmlncylcbiAgICAgICAgICAudGhlbihnZXRJc29Db3VudHJ5Q29kZSlcbiAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBJZiB0aGVyZSBpcyBhbHJlYWR5IGFuIGFjdGl2ZSBhY2NvdW50LCBqdXN0IHNlbmQgdGhlIEdBIHVwZ3JhZGUgZXZlbnQgaWYgYXBwbGllcy5cbiAgICAgIFV0aWxpdHlIZWxwZXIuc2VuZFVwZ3JhZGVUcmFja2luZ1JlcXVlc3QoKTtcbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqIFNlbmRzIGluZm9ybWF0aW9uIHRvIEdvb2dsZSBBbmFseXRpY3MgYWJvdXQgdHdvIGV2ZW50czpcbiAgICogLSBhdXRvbWF0aWMgc2lnbiBpbjogQWNxdWlzaXRpb24gLSBBdXRvU2lnbkluXG4gICAqIC0gZXh0ZW5zaW9uIHVwZ3JhZGVkOiBVcGdyYWRlQXBwIC0gU2lnbmVkSW4gfHwgU2lnbmVkT3V0IC0gVmVyc2lvbk51bWJlci1Ccm93c2VyTmFtclxuICAgKi9cbiAgc2VuZEdvb2dsZUFuYWx5dGljc1RyYWNraW5nSW5mbyA6IGZ1bmN0aW9uKGFQYXJhbWV0ZXJzKSB7XG4gICAgLy9pZiB0aGVyZSBpcyBub3QgYW4gYWN0aXZlIGFjY291bnQsIHRyeSB0byBhdXRvIHNpZ24gaW4gZmlyc3QgKGFuZCBzZW5kIHRoZSBHQSBldmVudCksIGFuZCB0aGVuIHNlbmQgdGhlIEdBIHVwZ3JhZGUgZXZlbnQgaWYgYXBwbGllcy5cbiAgICBpZiAoIUFjY291bnQuZ2V0QWNjb3VudCgpKSB7XG4gICAgICBBdXRoZW50aWNhdGlvblNlcnZpY2UuZ2V0RWJheUxvdmVUb2tlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgIFV0aWxpdHlIZWxwZXIuc2VuZFVwZ3JhZGVUcmFja2luZ1JlcXVlc3QoKTtcbiAgICAgIH0sIGFQYXJhbWV0ZXJzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy9pZiB0aGVyZSBpcyBhbHJlYWR5IGFuIGFjdGl2ZSBhY2NvdW50LCBqdXN0IHNlbmQgdGhlIEdBIHVwZ3JhZGUgZXZlbnQgaWYgYXBwbGllcy5cbiAgICAgIFV0aWxpdHlIZWxwZXIuc2VuZFVwZ3JhZGVUcmFja2luZ1JlcXVlc3QoKTtcbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqIENhbGxzIGVCYXkgTG9WZSB0byByZXRyaWV2ZSBhbiB1c2VyIHRva2VuLCBiYXNlZCBvbiB0aGUgZWJheS5jb20gZG9tYWluLlxuICAgKi9cbiAgY2FsbEViYXlMb3ZlV2l0aERlZmF1bHREb21haW4gOiBmdW5jdGlvbigpIHtcbiAgICB2YXIgcGFyYW1ldGVycyA9IHt9O1xuXG4gICAgcGFyYW1ldGVycy5kb21haW4gPSBBdXRoZW50aWNhdGlvblNlcnZpY2UuZGVmYXVsdERvbWFpbjtcbiAgICBBdXRoZW50aWNhdGlvblNlcnZpY2Uuc2VuZEdvb2dsZUFuYWx5dGljc1RyYWNraW5nSW5mbyhwYXJhbWV0ZXJzKTtcbiAgfSxcblxuICAvKipcbiAgICogTG9hZHMgdGhlIGNvbm5lY3QgdG8gZUJheSBwYWdlLlxuICAgKiBAcGFyYW0gYVNvdXJjZUFyZWEgdGhlIHNvdXJjZSBhcmVhLlxuICAgKiBAcGFyYW0gYUV2ZW50IHRoZSBldmVudC5cbiAgICovXG4gIGxvYWRBdXRoUGFnZSA6IGZ1bmN0aW9uKGFTb3VyY2VBcmVhLCBhRXZlbnQpIHtcblxuICAgIHZhciBnZXRBdXRoVVJMQ2FsbGJhY2sgPSBmdW5jdGlvbihhVXJsKSB7XG4gICAgICBTaXRlLm9wZW5SYXdVUkwoYVVybCwgYUV2ZW50LCBmYWxzZSk7XG5cbiAgICAgIE1lc3NhZ2VQYW5lbFNlcnZpY2UuZGlzbWlzc01lc3NhZ2UoTWVzc2FnZVBhbmVsU2VydmljZS5UWVBFLkNPTk5FQ1RfRVJST1IpO1xuICAgICAgVXBkYXRlQ29udHJvbGxlci51cGRhdGVGaW5pc2hlZChcIlNpZ24gaW5cIik7XG4gICAgfTtcblxuICAgIC8vdXNlIHRoaXMgbWV0aG9kIHRvIGdldCBhbiBvYXV0aCB1c2VyIHRva2VuLlxuICAgIEF1dGhlbnRpY2F0aW9uU2VydmljZS5nZXRVc2VyVG9rZW5VcmwoYVNvdXJjZUFyZWEsIGdldEF1dGhVUkxDYWxsYmFjayk7XG4gICAgVXBkYXRlQ29udHJvbGxlci51cGRhdGVTdGFydGVkKFwiU2lnbiBpblwiKTtcbiAgfVxufTtcblxuLyoqXG4gKiBDb25zdHJ1Y3Rvci5cbiAqL1xuKGZ1bmN0aW9uKCkgeyB0aGlzLmluaXQoKTsgfSkuYXBwbHkoQXV0aGVudGljYXRpb25TZXJ2aWNlKTtcbiJdfQ==