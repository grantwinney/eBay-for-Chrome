/*!
 * Copyright (C) 2007-2015 eBay Inc. All Rights Reserved.
 */
var UpdateController = {
    _REFRESH_THRESHOLD: 30,
    _activeUpdates: {},
    _numActiveUpdates: 0,
    _updatesEnabled: null,
    _updateInProgress: false,
    _forceUpdateTimer: null,
    _updateInProgressTimer: null,
    _hardUpdateTracker: null,
    _getMyeBayBuyingApiCallComplete: null,
    _getMyeBaySellingApiCallComplete: null,
    _SymbanApiCallComplete: null,
    _MedsApiCallComplete: null,
    init: function () {
        ObserverHelper.addObserver(this, Topics.ACCOUNT_SIGNED_IN);
        ObserverHelper.addObserver(this, Topics.ACCOUNT_SIGNED_OUT);
        ObserverHelper.addObserver(this, Topics.MY_BUYING_UPDATED);
        ObserverHelper.addObserver(this, Topics.MY_SELLING_UPDATED);
        ObserverHelper.addObserver(this, Topics.SYMBAN_DATA_UPDATED);
        ObserverHelper.addObserver(this, Topics.RECENT_SEARCHES_UPDATED);
    },
    get updateInProgress() {
        return this._updateInProgress;
    },
    set updateInProgress(aUpdate) {
        this._updateInProgress = aUpdate ? true : false;
    },
    resetNumActiveUpdates: function () {
        this._numActiveUpdates = 0;
    },
    resetForceUpdateTime: function () {
        if (this._forceUpdateTimer) {
            this._forceUpdateTimer.cancel();
            this._forceUpdateTimer = null;
        }
    },
    forceRefresh: function (aForce) {
        if (!Account.getAccount()) {
            Logger.warn("Attempt to call forceRefresh without an active account");
            return;
        }
        if (!UtilityHelper.internetConnectionExists()) {
            Logger.warn("Attempt to call forceRefresh without an active Internet connection");
            return;
        }
        if (!this._forceUpdateTimer || aForce === true) {
            this._forceUpdateTimer = new Timer(function () {
                if (this._forceUpdateTimer) {
                    this._forceUpdateTimer.cancel();
                }
                this._forceUpdateTimer = null;
            }.bind(this), this._REFRESH_THRESHOLD * 1000, false);
            if (!this._updateInProgress) {
                this._updateInProgress = true;
                this.disableUpdates(false);
                this.enableUpdates(true, false);
            }
            if (!this._updateInProgressTimer) {
                this._updateInProgressTimer = new Timer(function () {
                    this._updateInProgress = false;
                    if (this._updateInProgressTimer) {
                        this._updateInProgressTimer.cancel();
                    }
                    this._updateInProgressTimer = null;
                }.bind(this), PropertyDAO.get(PropertyDAO.PROP_API_TIMEOUT), false);
            }
        }
    },
    enableUpdates: function (aIsLocalSignIn, aSignInUpdate) {
        var account = Account.getAccount();
        var that = this;
        try {
            if (!account) {
                this._updateInProgress = false;
                return;
            }
            if (this._updatesEnabled) {
                this.disableUpdates(true);
            }
            this._hardUpdateTracker = new EventTracker("Hard Update");
            this._getMyeBayBuyingApiCallComplete = this._hardUpdateTracker.addCallbackEvent();
            this._getMyeBaySellingApiCallComplete = this._hardUpdateTracker.addCallbackEvent();
            this._SymbanApiCallComplete = this._hardUpdateTracker.addCallbackEvent();
            this._MedsApiCallComplete = this._hardUpdateTracker.addCallbackEvent();
            this._hardUpdateTracker.doWhenAllFinished(function () {
                that._updateInProgress = false;
                if (Configs.BROWSER !== "cr") {
                    InformationRefreshService.startInformationRefresh();
                }
            });
            AccountService.updateAccount(account.get("userId"), account.get("token"), function () { });
            MyEbayService.startService();
            if (Configs.BROWSER === "cr" && aSignInUpdate) {
                GCMService.startService();
            }
            SymbanService.getSymbanData();
            var userId = account.get("userId");
            var homeSite = Site.getHomeSite();
            RecentSearchMedsService.getRecentSearches(userId, homeSite);
            this._updatesEnabled = true;
        }
        catch (e) {
            Logger.error("UpdateController.enableUpdates Error: " + e.message);
        }
    },
    disableUpdates: function (aSignOut) {
        try {
            if (!this._updatesEnabled) {
                return;
            }
            MyEbayService.stopService(aSignOut);
            if (Configs.BROWSER === "cr") {
                GCMService.stopService(aSignOut);
            }
            ApiHelper.abortPendingRequests();
            delete this._updatesEnabled;
            this.resetNumActiveUpdates();
        }
        catch (e) {
            Logger.error("UpdateController.disableUpdates Error: " + e.message);
        }
    },
    updateStarted: function (aUpdateName) {
        var that = this;
        this._numActiveUpdates++;
        if (this._activeUpdates[aUpdateName]) {
            this._activeUpdates[aUpdateName].cancel();
            delete this._activeUpdates[aUpdateName];
        }
        this._activeUpdates[aUpdateName] = new Timer(function () {
            if (that._activeUpdates[aUpdateName]) {
                that.updateFinished(aUpdateName);
            }
        }, PropertyDAO.get(PropertyDAO.PROP_API_TIMEOUT), false);
    },
    updateFinished: function (aUpdateName) {
        if (this._numActiveUpdates > 0) {
            this._numActiveUpdates--;
        }
        if (this._activeUpdates[aUpdateName]) {
            this._activeUpdates[aUpdateName].cancel();
            delete this._activeUpdates[aUpdateName];
        }
        if (aUpdateName == "Hard Update") {
            this._updateInProgress = false;
        }
    },
    observe: function (aTopic, aData) {
        if ("undefined" != typeof (Topics) && null !== Topics) {
            switch (aTopic) {
                case Topics.ACCOUNT_SIGNED_IN:
                    this.enableUpdates(aData.isLocalSignin, true);
                    break;
                case Topics.ACCOUNT_SIGNED_OUT:
                    this.disableUpdates(true);
                    break;
                case Topics.MY_BUYING_UPDATED:
                    if (this._getMyeBayBuyingApiCallComplete) {
                        this._getMyeBayBuyingApiCallComplete();
                    }
                    break;
                case Topics.MY_SELLING_UPDATED:
                    if (this._getMyeBaySellingApiCallComplete) {
                        this._getMyeBaySellingApiCallComplete();
                    }
                    break;
                case Topics.SYMBAN_DATA_UPDATED:
                    if (this._SymbanApiCallComplete) {
                        this._SymbanApiCallComplete();
                    }
                    break;
                case Topics.RECENT_SEARCHES_UPDATED:
                    if (this._MedsApiCallComplete) {
                        this._MedsApiCallComplete();
                    }
                    break;
            }
        }
    }
};
(function () { this.init(); }).apply(UpdateController);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlQ29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2JhY2tncm91bmQvY29yZS91cGRhdGVDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHO0FBbUJILElBQUksZ0JBQWdCLEdBQUc7SUFHckIsa0JBQWtCLEVBQUcsRUFBRTtJQUV2QixjQUFjLEVBQUcsRUFBRTtJQUNuQixpQkFBaUIsRUFBRyxDQUFDO0lBQ3JCLGVBQWUsRUFBRyxJQUFJO0lBQ3RCLGlCQUFpQixFQUFHLEtBQUs7SUFDekIsaUJBQWlCLEVBQUcsSUFBSTtJQUN4QixzQkFBc0IsRUFBRyxJQUFJO0lBQzdCLGtCQUFrQixFQUFHLElBQUk7SUFDekIsK0JBQStCLEVBQUcsSUFBSTtJQUN0QyxnQ0FBZ0MsRUFBRyxJQUFJO0lBQ3ZDLHNCQUFzQixFQUFHLElBQUk7SUFDN0Isb0JBQW9CLEVBQUcsSUFBSTtJQUszQixJQUFJLEVBQUc7UUFDTCxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUMzRCxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUM1RCxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUMzRCxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUM1RCxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUM3RCxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsdUJBQXVCLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRUQsSUFBSSxnQkFBZ0I7UUFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIs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Q0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDO3dCQUM5QixJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztvQkFDOUIsQ0FBQztvQkFDRCxLQUFLLENBQUM7WUFDVixDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRixDQUFDO0FBS0YsQ0FBQyxjQUFhLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyohXG4gKiBDb3B5cmlnaHQgKEMpIDIwMDctMjAxNSBlQmF5IEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqL1xuXG4vKlxuICB2YXIgQ29uZmlncyA9IHJlcXVpcmUoXCJjb3JlL2NvbmZpZ3MvaW5pdFwiKS5Db25maWdzO1xuICB2YXIgTG9nZ2VyID0gcmVxdWlyZShcImhlbHBlcnMvbG9nZ2VyXCIpLkxvZ2dlcjtcbiAgdmFyIFRvcGljcyA9IHJlcXVpcmUoXCJoZWxwZXJzL29ic2VydmVySGVscGVyXCIpLlRvcGljcztcbiAgdmFyIE9ic2VydmVySGVscGVyID0gcmVxdWlyZShcImhlbHBlcnMvb2JzZXJ2ZXJIZWxwZXJcIikuT2JzZXJ2ZXJIZWxwZXI7XG4gIHZhciBVdGlsaXR5SGVscGVyID0gcmVxdWlyZShcImhlbHBlcnMvdXRpbGl0eUhlbHBlclwiKS5VdGlsaXR5SGVscGVyO1xuICB2YXIgQXBpSGVscGVyID0gcmVxdWlyZShcImNvcmUvaGVscGVycy9hcGlIZWxwZXJcIikuQXBpSGVscGVyO1xuICB2YXIgRXZlbnRUcmFja2VyID0gcmVxdWlyZShcImNvcmUvaGVscGVycy9ldmVudFRyYWNrZXJcIikuRXZlbnRUcmFja2VyO1xuICB2YXIgUHJvcGVydHlEQU8gPSByZXF1aXJlKFwic3RvcmFnZS9wcm9wZXJ0eURBT1wiKS5Qcm9wZXJ0eURBTztcbiAgdmFyIEFjY291bnQgPSByZXF1aXJlKFwiY29yZS9vYmplY3RzL2FjY291bnRcIikuQWNjb3VudDtcbiAgdmFyIE15RWJheVNlcnZpY2UgPSByZXF1aXJlKFwiY29yZS9zZXJ2aWNlcy9teUViYXlTZXJ2aWNlXCIpLk15RWJheVNlcnZpY2U7XG4gIHZhciBTeW1iYW5TZXJ2aWNlID0gcmVxdWlyZShcImNvcmUvc2VydmljZXMvc3ltYmFuU2VydmljZVwiKS5TeW1iYW5TZXJ2aWNlO1xuICB2YXIgUmVjZW50U2VhcmNoTWVkc1NlcnZpY2UgPSByZXF1aXJlKFwiY29yZS9zZXJ2aWNlcy9yZWNlbnRTZWFyY2hNZWRzU2VydmljZVwiKS5SZWNlbnRTZWFyY2hNZWRzU2VydmljZTtcbiAgdmFyIEluZm9ybWF0aW9uUmVmcmVzaFNlcnZpY2UgPSByZXF1aXJlKFwiY29yZS9zZXJ2aWNlcy9pbmZvcm1hdGlvblJlZnJlc2hTZXJ2aWNlXCIpLkluZm9ybWF0aW9uUmVmcmVzaFNlcnZpY2U7XG4gIHZhciBUaW1lciA9IHJlcXVpcmUoXCJoZWxwZXJzL3RpbWVyXCIpLlRpbWVyO1xuKi9cblxudmFyIFVwZGF0ZUNvbnRyb2xsZXIgPSB7XG5cbiAgLy9udW1iZXIgb2Ygc2Vjb25kcyB0byB3YWl0IGJldHdlZW4gaGFyZCB1cGRhdGVzXG4gIF9SRUZSRVNIX1RIUkVTSE9MRCA6IDMwLFxuXG4gIF9hY3RpdmVVcGRhdGVzIDoge30sXG4gIF9udW1BY3RpdmVVcGRhdGVzIDogMCxcbiAgX3VwZGF0ZXNFbmFibGVkIDogbnVsbCxcbiAgX3VwZGF0ZUluUHJvZ3Jlc3MgOiBmYWxzZSxcbiAgX2ZvcmNlVXBkYXRlVGltZXIgOiBudWxsLFxuICBfdXBkYXRlSW5Qcm9ncmVzc1RpbWVyIDogbnVsbCxcbiAgX2hhcmRVcGRhdGVUcmFja2VyIDogbnVsbCxcbiAgX2dldE15ZUJheUJ1eWluZ0FwaUNhbGxDb21wbGV0ZSA6IG51bGwsXG4gIF9nZXRNeWVCYXlTZWxsaW5nQXBpQ2FsbENvbXBsZXRlIDogbnVsbCxcbiAgX1N5bWJhbkFwaUNhbGxDb21wbGV0ZSA6IG51bGwsXG4gIF9NZWRzQXBpQ2FsbENvbXBsZXRlIDogbnVsbCxcblxuICAvKipcbiAgICogSW5pdGlhbGl6ZXMgdGhlIHJlc291cmNlLlxuICAgKi9cbiAgaW5pdCA6IGZ1bmN0aW9uKCkge1xuICAgIE9ic2VydmVySGVscGVyLmFkZE9ic2VydmVyKHRoaXMsIFRvcGljcy5BQ0NPVU5UX1NJR05FRF9JTik7XG4gICAgT2JzZXJ2ZXJIZWxwZXIuYWRkT2JzZXJ2ZXIodGhpcywgVG9waWNzLkFDQ09VTlRfU0lHTkVEX09VVCk7XG4gICAgT2JzZXJ2ZXJIZWxwZXIuYWRkT2JzZXJ2ZXIodGhpcywgVG9waWNzLk1ZX0JVWUlOR19VUERBVEVEKTtcbiAgICBPYnNlcnZlckhlbHBlci5hZGRPYnNlcnZlcih0aGlzLCBUb3BpY3MuTVlfU0VMTElOR19VUERBVEVEKTtcbiAgICBPYnNlcnZlckhlbHBlci5hZGRPYnNlcnZlcih0aGlzLCBUb3BpY3MuU1lNQkFOX0RBVEFfVVBEQVRFRCk7XG4gICAgT2JzZXJ2ZXJIZWxwZXIuYWRkT2JzZXJ2ZXIodGhpcywgVG9waWNzLlJFQ0VOVF9TRUFSQ0hFU19VUERBVEVEKTtcbiAgfSxcblxuICBnZXQgdXBkYXRlSW5Qcm9ncmVzcygpIHtcbiAgICByZXR1cm4gdGhpcy5fdXBkYXRlSW5Qcm9ncmVzcztcbiAgfSxcblxuICBzZXQgdXBkYXRlSW5Qcm9ncmVzcyhhVXBkYXRlKSB7XG4gICAgdGhpcy5fdXBkYXRlSW5Qcm9ncmVzcyA9IGFVcGRhdGUgPyB0cnVlIDogZmFsc2U7XG4gIH0sXG5cbiAgLyoqXG4gICAqIHJlc2V0cyB0aGUgbnVtYmVyIG9mIGFjdGl2ZSB1cGRhdGVzIHRvIDBcbiAgICovXG4gIHJlc2V0TnVtQWN0aXZlVXBkYXRlcyA6IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuX251bUFjdGl2ZVVwZGF0ZXMgPSAwO1xuICB9LFxuXG4gIHJlc2V0Rm9yY2VVcGRhdGVUaW1lIDogZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuX2ZvcmNlVXBkYXRlVGltZXIpIHtcbiAgICAgIHRoaXMuX2ZvcmNlVXBkYXRlVGltZXIuY2FuY2VsKCk7XG4gICAgICB0aGlzLl9mb3JjZVVwZGF0ZVRpbWVyID0gbnVsbDtcbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqIEZvcmNlcyBhIHJlbG9hZCBvZiBhbGwgaXRlbXMsIHRyaWdnZXJpbmcgaGFyZCwgc29mdCBhbmQgQ0EgdXBkYXRlLlxuICAgKiBAcGFyYW0gYUZvcmNlIGluZGljYXRlcyBpZiB3ZSBuZWVkIHRvIHNraXAgdGhlIHdhaXRpbmcgdGltZSBiZXR3ZWVuXG4gICAqIHVwZGF0ZXMuIFRoaXMgcGFyYW1ldGVyIHdpbGwgYmUgdHJ1ZSB3aGVuIHdlIGdldCBhIEdDTSBtZXNzYWdlIGFuZCB3ZSBkb24ndFxuICAgKiBoYXZlIHRvIHdhaXQgYW55IHRpbWUgdG8gcmVmcmVzaCB0aGUgaXRlbXMgbGlzdHMuXG4gICAqL1xuICBmb3JjZVJlZnJlc2ggOiBmdW5jdGlvbihhRm9yY2UpIHtcbiAgICBcbiAgICBpZiAoIUFjY291bnQuZ2V0QWNjb3VudCgpKSB7XG4gICAgICBMb2dnZXIud2FybihcIkF0dGVtcHQgdG8gY2FsbCBmb3JjZVJlZnJlc2ggd2l0aG91dCBhbiBhY3RpdmUgYWNjb3VudFwiKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIVV0aWxpdHlIZWxwZXIuaW50ZXJuZXRDb25uZWN0aW9uRXhpc3RzKCkpIHtcbiAgICAgIExvZ2dlci53YXJuKFwiQXR0ZW1wdCB0byBjYWxsIGZvcmNlUmVmcmVzaCB3aXRob3V0IGFuIGFjdGl2ZSBJbnRlcm5ldCBjb25uZWN0aW9uXCIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vdGhlIHRocmVzaG9sZCBvZiAzMCBzZWNvbmRzIHdhaXQgZm9yIGEgcmVmcmVzaCBpcyBub3QgYWN0aXZlXG4gICAgaWYgKCF0aGlzLl9mb3JjZVVwZGF0ZVRpbWVyIHx8IGFGb3JjZSA9PT0gdHJ1ZSkge1xuICAgICAgdGhpcy5fZm9yY2VVcGRhdGVUaW1lciA9IG5ldyBUaW1lcihmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKHRoaXMuX2ZvcmNlVXBkYXRlVGltZXIpIHtcbiAgICAgICAgICB0aGlzLl9mb3JjZVVwZGF0ZVRpbWVyLmNhbmNlbCgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2ZvcmNlVXBkYXRlVGltZXIgPSBudWxsO1xuICAgICAgfS5iaW5kKHRoaXMpLCB0aGlzLl9SRUZSRVNIX1RIUkVTSE9MRCAqIDEwMDAsIGZhbHNlKTtcblxuICAgICAgaWYgKCF0aGlzLl91cGRhdGVJblByb2dyZXNzKSB7XG4gICAgICAgIHRoaXMuX3VwZGF0ZUluUHJvZ3Jlc3MgPSB0cnVlO1xuICAgICAgICAvLyBzdG9wIGN1cnJlbnQgdXBkYXRlIHRpbWVyc1xuICAgICAgICB0aGlzLmRpc2FibGVVcGRhdGVzKGZhbHNlKTtcbiAgICAgICAgLy8gc3RhcnQgdGhlIHRpbWVycyBhZ2FpblxuICAgICAgICB0aGlzLmVuYWJsZVVwZGF0ZXModHJ1ZSwgZmFsc2UpO1xuICAgICAgfVxuXG4gICAgICAvL3RoaXMgaXMgYSBzYWZldHkgY2hlY2sgaW4gY2FzZSB0aGUgZXh0ZW5zaW9uIGdldHMgc3R1Y2suIFdlIHdpbGwgcmVzZXQgdGhlIGZsYWcgXCJfdXBkYXRlSW5Qcm9ncmVzc1wiIGFmdGVyIDYwIHNlY29uZHMuXG4gICAgICBpZiAoIXRoaXMuX3VwZGF0ZUluUHJvZ3Jlc3NUaW1lcikge1xuICAgICAgICB0aGlzLl91cGRhdGVJblByb2dyZXNzVGltZXIgPSBuZXcgVGltZXIoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgdGhpcy5fdXBkYXRlSW5Qcm9ncmVzcyA9IGZhbHNlO1xuICAgICAgICAgIGlmICh0aGlzLl91cGRhdGVJblByb2dyZXNzVGltZXIpIHtcbiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUluUHJvZ3Jlc3NUaW1lci5jYW5jZWwoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5fdXBkYXRlSW5Qcm9ncmVzc1RpbWVyID0gbnVsbDtcbiAgICAgICAgfS5iaW5kKHRoaXMpLCBQcm9wZXJ0eURBTy5nZXQoUHJvcGVydHlEQU8uUFJPUF9BUElfVElNRU9VVCksIGZhbHNlKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqIEVuYWJsZSB1cGRhdGVzLlxuICAgKi9cbiAgZW5hYmxlVXBkYXRlcyA6IGZ1bmN0aW9uKGFJc0xvY2FsU2lnbkluLCBhU2lnbkluVXBkYXRlKSB7XG4gICAgdmFyIGFjY291bnQgPSBBY2NvdW50LmdldEFjY291bnQoKTtcbiAgICB2YXIgdGhhdCA9IHRoaXM7XG4gICAgdHJ5IHtcbiAgICAgIC8qXG4gICAgICAgIEFjY291bnRTZXJ2aWNlID0gcmVxdWlyZShcImNvcmUvc2VydmljZXMvYWNjb3VudFNlcnZpY2VcIikuQWNjb3VudFNlcnZpY2U7XG4gICAgICAqL1xuICAgICAgaWYgKCFhY2NvdW50KSB7XG4gICAgICAgIHRoaXMuX3VwZGF0ZUluUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBkaXNhYmxlIGV4aXN0aW5nIHRpbWVycyBiZWZvcmUgcmVzZXR0aW5nIHRoZW0uXG4gICAgICBpZiAodGhpcy5fdXBkYXRlc0VuYWJsZWQpIHtcbiAgICAgICAgdGhpcy5kaXNhYmxlVXBkYXRlcyh0cnVlKTtcbiAgICAgIH1cblxuICAgICAgLy8gdHJhY2sgZWFjaCBldmVudCBzbyB0aGF0IHdlIGNhbiBrbm93IHdoZW4gd2UncmUgZG9uZSB3aXRoIHRoZSBoYXJkIHVwZGF0ZS5cbiAgICAgIHRoaXMuX2hhcmRVcGRhdGVUcmFja2VyID0gbmV3IEV2ZW50VHJhY2tlcihcIkhhcmQgVXBkYXRlXCIpO1xuICAgICAgdGhpcy5fZ2V0TXllQmF5QnV5aW5nQXBpQ2FsbENvbXBsZXRlID0gdGhpcy5faGFyZFVwZGF0ZVRyYWNrZXIuYWRkQ2FsbGJhY2tFdmVudCgpO1xuICAgICAgdGhpcy5fZ2V0TXllQmF5U2VsbGluZ0FwaUNhbGxDb21wbGV0ZSA9IHRoaXMuX2hhcmRVcGRhdGVUcmFja2VyLmFkZENhbGxiYWNrRXZlbnQoKTtcbiAgICAgIHRoaXMuX1N5bWJhbkFwaUNhbGxDb21wbGV0ZSA9IHRoaXMuX2hhcmRVcGRhdGVUcmFja2VyLmFkZENhbGxiYWNrRXZlbnQoKTtcbiAgICAgIHRoaXMuX01lZHNBcGlDYWxsQ29tcGxldGUgPSB0aGlzLl9oYXJkVXBkYXRlVHJhY2tlci5hZGRDYWxsYmFja0V2ZW50KCk7XG5cbiAgICAgIHRoaXMuX2hhcmRVcGRhdGVUcmFja2VyLmRvV2hlbkFsbEZpbmlzaGVkKGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGF0Ll91cGRhdGVJblByb2dyZXNzID0gZmFsc2U7XG4gICAgICAgIC8vbGV0J3MgZXhlY3V0ZSB0aGUgcG9sbGluZyBsb2dpYyBmb3IgU2FmYXJpLCBGaXJlZm94LCBhbmQgRWRnZS5cbiAgICAgICAgaWYgKENvbmZpZ3MuQlJPV1NFUiAhPT0gXCJjclwiKSB7XG4gICAgICAgICAgSW5mb3JtYXRpb25SZWZyZXNoU2VydmljZS5zdGFydEluZm9ybWF0aW9uUmVmcmVzaCgpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgLy8gWFhYOiB1cGRhdGUgYXZhdGFyIGltYWdlXG4gICAgICBBY2NvdW50U2VydmljZS51cGRhdGVBY2NvdW50KFxuICAgICAgICBhY2NvdW50LmdldChcInVzZXJJZFwiKSxcbiAgICAgICAgYWNjb3VudC5nZXQoXCJ0b2tlblwiKSwgZnVuY3Rpb24oKSB7fSk7XG5cbiAgICAgIC8vIEdNRUIgYW5kIEdNRVMgY2FsbHNcbiAgICAgIE15RWJheVNlcnZpY2Uuc3RhcnRTZXJ2aWNlKCk7XG5cbiAgICAgIC8vIEZvciBDaHJvbWUgT05MWVxuICAgICAgaWYgKENvbmZpZ3MuQlJPV1NFUiA9PT0gXCJjclwiICYmIGFTaWduSW5VcGRhdGUpIHtcbiAgICAgICAgR0NNU2VydmljZS5zdGFydFNlcnZpY2UoKTtcbiAgICAgIH1cblxuICAgICAgLy8gU3ltYmFuIEFQSSBjYWxsc1xuICAgICAgU3ltYmFuU2VydmljZS5nZXRTeW1iYW5EYXRhKCk7XG5cbiAgICAgIC8vIGNhbGwgdGhlIHJlY2VudCBzZWFyY2hlcyBzZXJ2aWNlXG4gICAgICB2YXIgdXNlcklkID0gYWNjb3VudC5nZXQoXCJ1c2VySWRcIik7XG4gICAgICB2YXIgaG9tZVNpdGUgPSBTaXRlLmdldEhvbWVTaXRlKCk7XG4gICAgICBSZWNlbnRTZWFyY2hNZWRzU2VydmljZS5nZXRSZWNlbnRTZWFyY2hlcyh1c2VySWQsIGhvbWVTaXRlKTtcblxuICAgICAgLy8gdXBkYXRlcyBlbmFibGVkLlxuICAgICAgdGhpcy5fdXBkYXRlc0VuYWJsZWQgPSB0cnVlO1xuICAgIH0gY2F0Y2goZSkge1xuICAgICAgTG9nZ2VyLmVycm9yKFwiVXBkYXRlQ29udHJvbGxlci5lbmFibGVVcGRhdGVzIEVycm9yOiBcIiArIGUubWVzc2FnZSk7XG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKiBEaXNhYmxlIHVwZGF0ZXMuXG4gICAqIEBwYXJhbSBhU2lnbk91dCB3aGV0aGVyIHdlIGFyZSBkaXNhYmxpbmcgYmVjYXVzZSBvZiBhIHNpZ24gb3V0IG9yIGJlY2F1c2VcbiAgICogdGhlIHVzZXIgZm9yY2VkIGEgaGFyZCB1cGRhdGVcbiAgICovXG4gIGRpc2FibGVVcGRhdGVzIDogZnVuY3Rpb24oYVNpZ25PdXQpIHtcblxuICAgIHRyeSB7XG4gICAgICAvLyBtYWtlIHN1cmUgdGhlIHRpbWVycyBhcmUgYWN0dWFsbHkgYWN0aXZlLlxuICAgICAgaWYgKCF0aGlzLl91cGRhdGVzRW5hYmxlZCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIE15RWJheVNlcnZpY2Uuc3RvcFNlcnZpY2UoYVNpZ25PdXQpO1xuXG4gICAgICAvLyBGb3IgQ2hyb21lIE9OTFlcbiAgICAgIGlmIChDb25maWdzLkJST1dTRVIgPT09IFwiY3JcIikge1xuICAgICAgICBHQ01TZXJ2aWNlLnN0b3BTZXJ2aWNlKGFTaWduT3V0KTtcbiAgICAgIH1cblxuICAgICAgLy8gZGVsZXRlIGFueSBwZW5kaW5nIHJlcXVlc3RzIHRvIGF2b2lkIGRhdGEgYmVpbmcgdXBkYXRlZCB3aGVuIHRoZXlcbiAgICAgIC8vIHJldHVybi5cbiAgICAgIEFwaUhlbHBlci5hYm9ydFBlbmRpbmdSZXF1ZXN0cygpO1xuXG4gICAgICAvLyB1cGRhdGVzIGRpc2FibGVkLlxuICAgICAgZGVsZXRlIHRoaXMuX3VwZGF0ZXNFbmFibGVkO1xuXG4gICAgICAvLyByZXNldCB0aGUgbnVtYmVyIG9mIGFjdGl2ZSB1cGRhdGVzIHRvIDAgaW4gY2FzZSBpdCBpc24ndFxuICAgICAgdGhpcy5yZXNldE51bUFjdGl2ZVVwZGF0ZXMoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBMb2dnZXIuZXJyb3IoXCJVcGRhdGVDb250cm9sbGVyLmRpc2FibGVVcGRhdGVzIEVycm9yOiBcIiArIGUubWVzc2FnZSk7XG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKiBDYWxsZWQgd2hlbiBhbiB1cGRhdGUgc3RhcnRzLlxuICAgKiBAcGFyYW0gYVVwZGF0ZU5hbWUgdGhlIHVwZGF0ZSBuYW1lLlxuICAgKi9cbiAgdXBkYXRlU3RhcnRlZCA6IGZ1bmN0aW9uKGFVcGRhdGVOYW1lKSB7XG5cbiAgICB2YXIgdGhhdCA9IHRoaXM7XG5cbiAgICB0aGlzLl9udW1BY3RpdmVVcGRhdGVzKys7XG5cbiAgICBpZiAodGhpcy5fYWN0aXZlVXBkYXRlc1thVXBkYXRlTmFtZV0pIHtcbiAgICAgIHRoaXMuX2FjdGl2ZVVwZGF0ZXNbYVVwZGF0ZU5hbWVdLmNhbmNlbCgpO1xuICAgICAgZGVsZXRlIHRoaXMuX2FjdGl2ZVVwZGF0ZXNbYVVwZGF0ZU5hbWVdO1xuICAgIH1cblxuICAgIHRoaXMuX2FjdGl2ZVVwZGF0ZXNbYVVwZGF0ZU5hbWVdID0gbmV3IFRpbWVyKGZ1bmN0aW9uKCkge1xuICAgICAgaWYgKHRoYXQuX2FjdGl2ZVVwZGF0ZXNbYVVwZGF0ZU5hbWVdKSB7XG4gICAgICAgIHRoYXQudXBkYXRlRmluaXNoZWQoYVVwZGF0ZU5hbWUpO1xuICAgICAgfVxuICAgIH0sIFByb3BlcnR5REFPLmdldChQcm9wZXJ0eURBTy5QUk9QX0FQSV9USU1FT1VUKSwgZmFsc2UpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBDYWxsZWQgd2hlbiBhbiB1cGRhdGUgZmluaXNoZWQuXG4gICAqIEBwYXJhbSBhVXBkYXRlTmFtZSB0aGUgdXBkYXRlIG5hbWUuXG4gICAqL1xuICB1cGRhdGVGaW5pc2hlZCA6IGZ1bmN0aW9uKGFVcGRhdGVOYW1lKSB7XG5cbiAgICBpZiAodGhpcy5fbnVtQWN0aXZlVXBkYXRlcyA+IDApIHtcbiAgICAgIHRoaXMuX251bUFjdGl2ZVVwZGF0ZXMtLTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fYWN0aXZlVXBkYXRlc1thVXBkYXRlTmFtZV0pIHtcbiAgICAgIHRoaXMuX2FjdGl2ZVVwZGF0ZXNbYVVwZGF0ZU5hbWVdLmNhbmNlbCgpO1xuICAgICAgZGVsZXRlIHRoaXMuX2FjdGl2ZVVwZGF0ZXNbYVVwZGF0ZU5hbWVdO1xuICAgIH1cbiAgICBpZiAoYVVwZGF0ZU5hbWUgPT0gXCJIYXJkIFVwZGF0ZVwiKSB7XG4gICAgICB0aGlzLl91cGRhdGVJblByb2dyZXNzID0gZmFsc2U7XG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKiBPYnNlcnZlcyBnbG9iYWwgdG9waWMgY2hhbmdlcy5cbiAgICogQHBhcmFtIGFUb3BpYyB0aGUgdG9waWMgYmVpbmcgb2JzZXJ2ZWQuXG4gICAqIEBwYXJhbSBhRGF0YSB0aGUgZGF0YSByZWxhdGluZyB0byB0aGUgY2hhbmdlLlxuICAgKi9cbiAgb2JzZXJ2ZSA6IGZ1bmN0aW9uKGFUb3BpYywgYURhdGEpIHtcbiAgICBpZiAoXCJ1bmRlZmluZWRcIiAhPSB0eXBlb2YoVG9waWNzKSAmJiBudWxsICE9PSBUb3BpY3MpIHtcbiAgICAgIHN3aXRjaCAoYVRvcGljKSB7XG4gICAgICAgIGNhc2UgVG9waWNzLkFDQ09VTlRfU0lHTkVEX0lOOlxuICAgICAgICAgIHRoaXMuZW5hYmxlVXBkYXRlcyhhRGF0YS5pc0xvY2FsU2lnbmluLCB0cnVlKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUb3BpY3MuQUNDT1VOVF9TSUdORURfT1VUOlxuICAgICAgICAgIHRoaXMuZGlzYWJsZVVwZGF0ZXModHJ1ZSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgVG9waWNzLk1ZX0JVWUlOR19VUERBVEVEOlxuICAgICAgICAgIGlmICh0aGlzLl9nZXRNeWVCYXlCdXlpbmdBcGlDYWxsQ29tcGxldGUpIHtcbiAgICAgICAgICAgIHRoaXMuX2dldE15ZUJheUJ1eWluZ0FwaUNhbGxDb21wbGV0ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUb3BpY3MuTVlfU0VMTElOR19VUERBVEVEOlxuICAgICAgICAgIGlmICh0aGlzLl9nZXRNeWVCYXlTZWxsaW5nQXBpQ2FsbENvbXBsZXRlKSB7XG4gICAgICAgICAgICB0aGlzLl9nZXRNeWVCYXlTZWxsaW5nQXBpQ2FsbENvbXBsZXRlKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFRvcGljcy5TWU1CQU5fREFUQV9VUERBVEVEOlxuICAgICAgICAgIGlmICh0aGlzLl9TeW1iYW5BcGlDYWxsQ29tcGxldGUpIHtcbiAgICAgICAgICAgIHRoaXMuX1N5bWJhbkFwaUNhbGxDb21wbGV0ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBUb3BpY3MuUkVDRU5UX1NFQVJDSEVTX1VQREFURUQ6XG4gICAgICAgICAgaWYgKHRoaXMuX01lZHNBcGlDYWxsQ29tcGxldGUpIHtcbiAgICAgICAgICAgIHRoaXMuX01lZHNBcGlDYWxsQ29tcGxldGUoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG59O1xuXG4vKipcbiAqIENvbnN0cnVjdG9yLlxuICovXG4oZnVuY3Rpb24oKSB7IHRoaXMuaW5pdCgpOyB9KS5hcHBseShVcGRhdGVDb250cm9sbGVyKTtcbiJdfQ==